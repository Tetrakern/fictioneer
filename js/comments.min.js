function fcn_addJSTrap(){const e=document.querySelector(".comment-form");e&&e.appendChild(fcn_html`
      <input type="hidden" name="fictioneer_comment_validator" value="299792458">
    `)}function fcn_revealCommentFormInputs(e){e.closest("form").querySelectorAll(".fictioneer-respond__form-actions, .fictioneer-respond__form-bottom").forEach((e=>{e.classList.remove("hidden")}))}function fcn_addCommentFormEvents(){_$(fictioneer_comments.form_selector??"#comment")?.addEventListener("focus",(e=>{fcn_revealCommentFormInputs(e.currentTarget)}),{once:!0})}function fcn_textareaAdjust(e){e&&(e.style.height="auto",e.style.height=`${e.scrollHeight}px`)}function fcn_wrapInTag(e,t,n={}){const o=n.href?' href="'+n.href+'" target="_blank" rel="nofollow noreferrer noopener"':"",a=n.shortcode?["[","]"]:["<",">"],i=e.selectionStart,s=e.selectionEnd,r=a[0]+t+o+a[1],c=a[0]+"/"+t+a[1],m=r+e.value.substring(i,s)+c;e.value=e.value.substring(0,i)+m+e.value.substring(s,e.value.length),e.setSelectionRange(i+r.length,s+r.length),e.focus()}function fcn_bindAJAXCommentSubmit(){fcn_theRoot.dataset.ajaxSubmit&&_$$$("commentform")?.addEventListener("submit",(e=>{if(e.preventDefault(),Date.now()<fcn_pageLoadTimestamp+3e3)return;const t=e.currentTarget,n=new FormData(t),o=Object.fromEntries(n.entries()),a=t.querySelector('[name="submit"]'),i=_$(fictioneer_comments.form_selector??"#comment"),s=t.querySelector('[name="author"]'),r=t.querySelector('[name="email"]'),c=t.querySelector('[name="fictioneer-privacy-policy-consent"]'),m=o.comment_parent??0,l=_$$$(`comment-${m}`),d=t.closest(".fictioneer-comments")?.dataset.order??"desc";let f=!0,u=!0,_=!0;if(u=i.value.length>1,i.classList.toggle("_error",!u),c&&(_=c.checked,c.classList.toggle("_error",!_)),r&&r.value.length>0&&(f=/\S+@\S+\.\S+/.test(r.value),r.classList.toggle("_error",!f)),!u||!_||!f)return!1;t.classList.add("ajax-in-progress"),a.disabled=!0,a.value=a.dataset.disabled;const h={action:"fictioneer_ajax_submit_comment",content:i.value,depth:l?parseInt(l.dataset.depth)+1:1,fcn_fast_comment_ajax:1,...o};r?.value&&(h.email=r?.value),s?.value&&(h.author=s?.value),fcn_ajaxPost(h).then((e=>{if(_$$$("comment-submit-error-notice")?.remove(),e.success&&e.data?.comment){let t=_$(".commentlist"),n="insertBefore";if(t&&!l&&t.firstElementChild){let e=null;if(t.firstElementChild.classList.contains("_sticky"))for(e=t.firstElementChild,t=e,n="insertAfter";e.nextElementSibling&&e.nextElementSibling.classList.contains("_sticky");)e=t.nextElementSibling,t=e}if(t||(t=document.createElement("ol"),t.classList="fictioneer-comments__list commentlist",_$$$("comments").appendChild(t),n="append"),l&&(t=l.querySelector(".children"),n="append",!t)){const e=document.createElement("ol");l.appendChild(e),t=e}let o=document.createElement("div");switch(o.innerHTML=e.data.comment,o=o.firstChild,n){case"append":t.appendChild(o);break;case"insertBefore":t.insertBefore(o,t.firstChild);break;case"insertAfter":t.nextSibling?t.parentNode.insertBefore(o,t.nextSibling):t.parentNode.appendChild(o)}"0"!=_$$$("comment_parent").value&&_$$$("cancel-comment-reply-link").click(),i.value="",i.style.height="";const a=window.location.protocol+"//"+window.location.host+window.location.pathname;("desc"!=d||fcn_urlParams.corder)&&(fcn_urlParams.corder=d),e.data.commentcode&&(fcn_urlParams.commentcode=e.data.commentcode);let s=Object.entries(fcn_urlParams).map((([e,t])=>`${e}=${t}`)).join("&");""!==s&&(s=`?${s}`),history.replaceState({path:a},"",a+s+`#comment-${e.data.comment_id}`),o.scrollIntoView({behavior:"smooth"})}else t.insertBefore(fcn_buildErrorNotice(e.data.failure??e.data.error??fictioneer_tl.notification.error,"comment-submit-error-notice",!1),t.firstChild),e.data.failure&&e.data.error&&console.error("Error:",e.data.error)})).catch((e=>{_$$$("comment-submit-error-notice")?.remove(),t.insertBefore(fcn_buildErrorNotice(`${e.statusText} (${e.status})`,"comment-submit-error-notice"),t.firstChild)})).then((()=>{t.classList.remove("ajax-in-progress"),a.disabled=!1,a.value=a.dataset.enabled}))}))}document.addEventListener("fcnUserDataReady",(()=>{fcn_getUserData().fingerprint==fcn_theRoot.dataset.authorFingerprint&&fcn_theBody.classList.add("is-post-author")})),fcn_addJSTrap(),fcn_addCommentFormEvents(),_$(".comment-section")?.addEventListener("click",(e=>{const t=e.target.closest("[data-bbcode]");t&&fcn_wrapInTag(_$(fictioneer_comments.form_selector??"#comment"),t.dataset.bbcode,{shortcode:!0})})),_$(".comment-section")?.addEventListener("keydown",(e=>{if(_$(".fictioneer-comment-toolbar")&&"TEXTAREA"===document.activeElement.tagName&&(e.ctrlKey||e.metaKey)){const t=e.key.toLowerCase();if(["b","i","s","q","h","l"].includes(t)){e.preventDefault();const n={q:"quote",h:"spoiler",l:"link"};fcn_wrapInTag(document.activeElement,n[t]||t,{shortcode:!0})}}})),fcn_bindAJAXCommentSubmit();const fcn_commentEditActionsTemplate=_$(".comment-edit-actions-template");var fcn_commentEditUndos={};function fcn_triggerInlineCommentEdit(e){const t=e.closest(".fictioneer-comment");if(t){const e=t.querySelector(".fictioneer-comment__content"),n=t.querySelector(".fictioneer-comment__edit"),o=t.querySelector(".comment-inline-edit-content");n.appendChild(fcn_commentEditActionsTemplate.content.cloneNode(!0)),fcn_commentEditUndos[t.id]=o.value,t.classList.add("_editing"),e.hidden=!0,n.hidden=!1,o.style.height=`${o.scrollHeight}px`}}function fcn_submitInlineCommentEdit(e){const t=e.closest(".fictioneer-comment"),n=t.querySelector(".fictioneer-comment__edit"),o=t.querySelector(".comment-inline-edit-content").value;let a=t.querySelector(".fictioneer-comment__edit-note");o!=fcn_commentEditUndos[t.id]?t&&(n.classList.add("ajax-in-progress"),e.innerHTML=e.dataset.disabled,e.disabled=!0,fcn_ajaxPost({action:"fictioneer_ajax_edit_comment",comment_id:t.id.replace("comment-",""),content:o,fcn_fast_comment_ajax:1}).then((e=>{if(e.success){const n=t.querySelector(".fictioneer-comment__content");n.innerHTML=e.data.content,fcn_restoreComment(t,!1,e.data.raw),a||(a=document.createElement("div")),a.classList.add("fictioneer-comment__edit-note"),a.innerHTML=e.data.edited,n.parentNode.appendChild(a)}else fcn_restoreComment(t,!0),fcn_showNotification(e.data.failure??e.data.error??fictioneer_tl.notification.error,5,"warning"),(e.data.failure||e.data.error)&&console.error("Error:",e.data.error??e.data.failure)})).catch((e=>{fcn_restoreComment(t,!0),e.status&&e.statusText&&fcn_showNotification(`${e.statusText} (${e.status})`,5,"warning"),console.error(e)})).then((()=>{n.classList.remove("ajax-in-progress"),e.innerHTML=e.dataset.enabled,e.disabled=!1}))):fcn_restoreComment(t,!0)}function fcn_cancelInlineCommentEdit(e){const t=e.closest(".fictioneer-comment");t&&fcn_restoreComment(t,!0)}function fcn_restoreComment(e,t=!1,n=null){e.querySelector(".fictioneer-comment__content").hidden=!1,e.querySelector(".fictioneer-comment__edit").hidden=!0,e.querySelector(".fictioneer-comment__edit-actions")?.remove(),e.classList.remove("_editing"),t&&fcn_commentEditUndos[e.id]?e.querySelector(".comment-inline-edit-content").value=fcn_commentEditUndos[e.id]:n&&(e.querySelector(".comment-inline-edit-content").value=n)}const fcn_ajaxCommentForm=_$$$("ajax-comment-form-target");function fcn_setupCommentFormObserver(){const e=new IntersectionObserver((([t])=>{t.isIntersecting&&(fcn_getCommentForm(),e.disconnect())}),{rootMargin:"450px",threshold:1});e.observe(fcn_ajaxCommentForm)}function fcn_getCommentForm(){let e;fcn_ajaxGet({action:"fictioneer_ajax_get_comment_form",post_id:_$$$("comments").dataset.postId,fcn_fast_comment_ajax:1}).then((t=>{if(t.success){const e=document.createElement("div");e.innerHTML=t.data.html;const n=e.querySelector("#comment_post_ID"),o=e.querySelector("#cancel-comment-reply-link"),a=e.querySelector(".logout-link");n&&(n.value=t.data.postId),o&&(o.href="#respond"),a&&(a.href=_$$$("comments").dataset.logoutUrl),fcn_ajaxCommentForm.innerHTML=e.innerHTML,e.remove(),fcn_applyCommentStack(),fcn_addCommentFormEvents(),fcn_theRoot.dataset.ajaxSubmit&&fcn_bindAJAXCommentSubmit(),fcn_addNonceHTML(t.data.nonceHtml),fcn_addJSTrap()}else e=fcn_buildErrorNotice(t.data.error)})).catch((t=>{e=fcn_buildErrorNotice(t)})).then((()=>{fcn_ajaxCommentForm.classList.remove("comments-skeleton"),e&&(fcn_ajaxCommentForm.innerHTML="",fcn_ajaxCommentForm.appendChild(e))}))}fcn_ajaxCommentForm&&(fcn_theRoot.dataset.ajaxAuth?document.addEventListener("fcnAuthReady",(()=>{fcn_setupCommentFormObserver()})):fcn_setupCommentFormObserver());var fcn_commentStack=[];function fcn_applyCommentStack(e=null){(e=e??_$(fictioneer_comments.form_selector??"#comment"))&&("TEXTAREA"==e.tagName?(fcn_commentStack.forEach((t=>{e.value+=t})),fcn_textareaAdjust(e)):"DIV"==e.tagName&&fcn_commentStack.forEach((t=>{e.innerHTML+=t})),fcn_commentStack=[])}_$(".fictioneer-comments")?.addEventListener("click",(e=>{const t=e.target.closest("[data-click]");if(t)switch(t?.dataset.click){case"submit-inline-comment-edit":fcn_submitInlineCommentEdit(t);break;case"cancel-inline-comment-edit":fcn_cancelInlineCommentEdit(t);break;case"trigger-inline-comment-edit":fcn_triggerInlineCommentEdit(t)}})),_$(".fictioneer-comments")?.addEventListener("input",(e=>{e.target.matches(".adaptive-textarea")&&fcn_textareaAdjust(e.target),e.target.closest('[name="fictioneer-private-comment-toggle"]')&&_$$$("respond")?.classList.toggle("_private",e.currentTarget.checked)})),application.register("fictioneer-comment",class extends Stimulus.Controller{static targets=["modMenuToggle","modMenu","modIcon","editLink","flagButton","deleteButton","editButton"];static values={id:Number,timestamp:Number,fingerprint:String};connect(){this.comment=this.element.closest(".fictioneer-comment"),this.hasModMenuTarget&&(this.editLink=this.modMenuTarget.dataset.editLink),fcn_getUserData().fingerprint?(this.#e(),this.#t()):document.addEventListener("fcnUserDataReady",(()=>{this.#e(),this.#t()}))}toggle(){this.#n()}approve(){this.#o("approve")}unapprove(){this.#o("unapprove")}offensive(){this.#o("offensive")}unoffensive(){this.#o("unoffensive")}open(){this.#o("open")}close(){this.#o("close")}sticky(){this.#o("sticky")}unsticky(){this.#o("unsticky")}trash(){this.#o("trash")}spam(){this.#o("spam")}mouseLeave(){this.modMenuTarget.querySelector("*")&&(this.#n("close"),fcn_lastClicked?.classList.remove("last-clicked"),fcn_lastClicked=null)}flag(){fcn_isLoggedIn&&this.hasFlagButtonTarget&&(this.comment.classList.contains("ajax-in-progress")||(this.comment.classList.add("ajax-in-progress"),fcn_ajaxPost({action:"fictioneer_ajax_report_comment",id:this.idValue,dubious:this.flagButtonTarget.classList.contains("_dubious"),fcn_fast_comment_ajax:1}).then((e=>{e.success?(this.flagButtonTarget.classList.toggle("on",e.data.flagged),this.flagButtonTarget.classList.remove("_dubious"),e.data.resync&&fcn_showNotification(e.data.resync)):(fcn_showNotification(e.data.failure??e.data.error??fictioneer_tl.notification.error,5,"warning"),console.error("Error:",e.data.error??e.data.failure??"Unknown"))})).catch((e=>{this.#a(e)})).then((()=>{this.comment.classList.remove("ajax-in-progress")}))))}selfDelete(){if(!fcn_isLoggedIn||!this.hasDeleteButtonTarget)return;const e=prompt(this.deleteButtonTarget.dataset.dialogMessage);e&&e.toLowerCase()==this.deleteButtonTarget.dataset.dialogConfirm.toLowerCase()&&(this.comment.classList.contains("ajax-in-progress")||(this.comment.classList.add("ajax-in-progress"),fcn_ajaxPost({action:"fictioneer_ajax_delete_my_comment",comment_id:this.idValue,fcn_fast_comment_ajax:1}).then((e=>{e.success?(this.comment.classList.add("_deleted"),this.element.innerHTML=e.data.html):(fcn_showNotification(e.data.failure??e.data.error??fictioneer_tl.notification.error,5,"warning"),console.error("Error:",e.data.error??e.data.failure??"Unknown"))})).catch((e=>{this.#a(e)})).then((()=>{this.comment.classList.remove("ajax-in-progress")}))))}startEditInline(){console.log("edit inline")}#e(){this.hasDeleteButtonTarget&&this.#i()&&(this.deleteButtonTarget.hidden=!1)}#t(){let e=parseInt(document.documentElement.dataset.editTime);if(e&&(e=e>0?6e4*e:e,this.hasEditButtonTarget&&this.#i())){if(e>0&&parseInt(this.timestampValue)+e<Date.now())return;this.editButtonTarget.hidden=!1}}#i(){const e=fcn_getUserData().fingerprint;return!(!e||!this.hasFingerprintValue)&&e===this.fingerprintValue}#n(e=null){const t=_$$$("template-comment-frontend-moderation-menu").content.cloneNode(!0);t&&this.hasModMenuTarget&&(!this.modMenuTarget.querySelector("*")&&"close"!==e||"open"===e?(this.modMenuTarget.appendChild(t),this.editLinkTarget.href=this.editLink):this.modMenuTarget.innerHTML="")}#s(e){this.modIconTarget.classList="fa-solid fa-triangle-exclamation mod-menu-toggle-icon",this.modIconTarget.style.color="var(--notice-warning-background)",this.modMenuToggleTarget.style.opacity="1",e&&fcn_showNotification(e,5,"warning")}#a(e){e.status&&e.statusText&&fcn_showNotification(`${e.status}: ${e.statusText}`,5,"warning"),console.error("Error:",e)}#o(e){this.comment.classList.contains("ajax-in-progress")||(this.comment.classList.add("ajax-in-progress"),"trash"!=e&&"spam"!=e||(this.comment.style.height=this.comment.clientHeight+"px"),fcn_ajaxPost({action:"fictioneer_ajax_moderate_comment",operation:e,id:this.idValue,fcn_fast_comment_ajax:1}).then((e=>{if(e.success){const t=e.data.operation,n={sticky:{action:"add",className:"_sticky"},unsticky:{action:"remove",className:"_sticky"},offensive:{action:"add",className:"_offensive"},unoffensive:{action:"remove",className:"_offensive"},approve:{action:"remove",className:"_unapproved"},unapprove:{action:"add",className:"_unapproved"},open:{action:"remove",className:"_closed"},close:{action:"add",className:"_closed"}};if(t in n){const{action:e,className:o}=n[t];this.comment.classList[e](o)}else"trash"!==t&&"spam"!==t||(this.comment.style.cssText="overflow: hidden; height: 0; margin: 0; opacity: 0;")}else this.#s(e.data.failure??e.data.error??fictioneer_tl.notification.error)})).catch((e=>{this.#s(e?.status&&e?.statusText?`${e.status}: ${e.statusText}`:e)})).then((()=>{this.comment.classList.remove("ajax-in-progress"),this.#n("close"),fcn_lastClicked?.classList.remove("last-clicked"),fcn_lastClicked=null})))}});