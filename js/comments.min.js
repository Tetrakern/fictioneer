function fcn_wrapInTag(e,t,n={}){const i=n.href?' href="'+n.href+'" target="_blank" rel="nofollow noreferrer noopener"':"",a=n.shortcode?["[","]"]:["<",">"],s=e.selectionStart,o=e.selectionEnd,r=a[0]+t+i+a[1],c=a[0]+"/"+t+a[1],m=r+e.value.substring(s,o)+c;e.value=e.value.substring(0,s)+m+e.value.substring(o,e.value.length),e.setSelectionRange(s+r.length,o+r.length),e.focus()}document.addEventListener("fcnUserDataReady",(()=>{fcn_getUserData().fingerprint==document.documentElement.dataset.authorFingerprint&&fcn_theBody.classList.add("is-post-author")}));const fcn_ajaxCommentForm=_$$$("ajax-comment-form-target");function fcn_setupCommentFormObserver(){const e=new IntersectionObserver((([t])=>{t.isIntersecting&&(fcn_getCommentForm(),e.disconnect())}),{rootMargin:"450px",threshold:1});e.observe(fcn_ajaxCommentForm)}function fcn_getCommentForm(){let e;fcn_ajaxGet({action:"fictioneer_ajax_get_comment_form",post_id:_$$$("comments").dataset.postId,fcn_fast_comment_ajax:1}).then((t=>{if(t.success){const e=document.createElement("div");e.innerHTML=t.data.html;const n=e.querySelector("#comment_post_ID"),i=e.querySelector("#cancel-comment-reply-link"),a=e.querySelector(".logout-link");n&&(n.value=t.data.postId),i&&(i.href="#respond"),a&&(a.href=_$$$("comments").dataset.logoutUrl),fcn_ajaxCommentForm.innerHTML=e.innerHTML,e.remove(),fcn_applyCommentStack(),fcn_addNonceHTML(t.data.nonceHtml)}else e=fcn_buildErrorNotice(t.data.error)})).catch((t=>{e=fcn_buildErrorNotice(t)})).then((()=>{fcn_ajaxCommentForm.classList.remove("comments-skeleton"),e&&(fcn_ajaxCommentForm.innerHTML="",fcn_ajaxCommentForm.appendChild(e))}))}fcn_ajaxCommentForm&&(document.documentElement.dataset.ajaxAuth?document.addEventListener("fcnAuthReady",(()=>{fcn_setupCommentFormObserver()})):fcn_setupCommentFormObserver());var fcn_commentStack=[];function fcn_applyCommentStack(e=null){(e=e??_$(fictioneer_comments.form_selector??"#comment"))&&("TEXTAREA"==e.tagName?(fcn_commentStack.forEach((t=>{e.value+=t})),fcn_adjustTextarea(e)):"DIV"==e.tagName&&fcn_commentStack.forEach((t=>{e.innerHTML+=t})),fcn_commentStack=[])}application.register("fictioneer-comment-form",class extends Stimulus.Controller{initialize(){this.respond=_$$$("respond"),this.order=this.respond.closest(".fictioneer-comments")?.dataset.order??"desc",this.form=this.respond.querySelector("form"),this.textarea=_$(fictioneer_comments.form_selector??"#comment"),this.toolbar=this.respond.querySelector(".fictioneer-comment-toolbar"),this.privateToggle=this.respond.querySelector('[name="fictioneer-private-comment-toggle"]'),this.submit=this.respond.querySelector("#submit"),this.cancel=_$$$("cancel-comment-reply-link"),this.parent=_$$$("comment_parent"),this.author=this.respond.querySelector('[name="author"]'),this.email=this.respond.querySelector('[name="email"]'),this.privacyConsent=this.respond.querySelector('[name="fictioneer-privacy-policy-consent"]'),this.privateToggle.addEventListener("change",(()=>{this.respond.classList.toggle("_private",this.privateToggle.checked)})),this.textarea.classList.contains("adaptive-textarea")&&(this.textarea.addEventListener("input",(()=>{fcn_adjustTextarea(this.textarea)})),this.textarea.addEventListener("keydown",(e=>{this.bbcodes(e)}))),this.toolbar.addEventListener("click",(e=>{const t=e.target.closest("[data-bbcode]");t&&fcn_wrapInTag(_$(fictioneer_comments.form_selector??"#comment"),t.dataset.bbcode,{shortcode:!0})})),this.addJSTrap(),this.textarea.addEventListener("focus",(()=>{this.revealFormInputs()}),{once:!0}),document.documentElement.dataset.ajaxSubmit&&this.bindSubmit()}bbcodes(e){if(_$(".fictioneer-comment-toolbar")&&"TEXTAREA"===document.activeElement.tagName&&(e.ctrlKey||e.metaKey)){const t=e.key.toLowerCase();if(["b","i","s","q","h","l"].includes(t)){e.preventDefault();const n={q:"quote",h:"spoiler",l:"link"};fcn_wrapInTag(document.activeElement,n[t]||t,{shortcode:!0})}}}addJSTrap(){this.form.appendChild(fcn_html`
      <input type="hidden" name="fictioneer_comment_validator" value="299792458">
    `)}revealFormInputs(){this.respond.querySelectorAll(".fictioneer-respond__form-actions, .fictioneer-respond__form-bottom").forEach((e=>{e.classList.remove("hidden")}))}bindSubmit(){document.documentElement.dataset.ajaxSubmit&&this.form.addEventListener("submit",(e=>{if(e.preventDefault(),Date.now()<fcn_pageLoadTimestamp+3e3)return;const t=new FormData(this.form),n=Object.fromEntries(t.entries()),i=n.comment_parent??0,a=_$$$(`comment-${i}`),s=this.textarea.value.length>1;let o=!0,r=!0;if(this.textarea.classList.toggle("_error",!s),this.privacyConsent&&(r=this.privacyConsent.checked,this.privacyConsent.classList.toggle("_error",!r)),this.email?.value.length>0&&(o=/\S+@\S+\.\S+/.test(this.email.value),this.email.classList.toggle("_error",!o)),!s||!r||!o)return!1;this.form.classList.add("ajax-in-progress"),this.submit.disabled=!0,this.submit.value=this.submit.dataset.disabled;const c={action:"fictioneer_ajax_submit_comment",content:this.textarea.value,depth:a?parseInt(a.dataset.depth)+1:1,fcn_fast_comment_ajax:1,...n};this.email?.value&&(c.email=this.email.value),this.author?.value&&(c.author=this.author.value),_$$$("comment-submit-error-notice")?.remove(),fcn_ajaxPost(c).then((e=>{if(e.success&&e.data?.comment){let t=_$(".commentlist"),n="insertBefore";if(t&&!a&&t.firstElementChild){let e=null;if(t.firstElementChild.classList.contains("_sticky"))for(e=t.firstElementChild,t=e,n="insertAfter";e.nextElementSibling&&e.nextElementSibling.classList.contains("_sticky");)e=t.nextElementSibling,t=e}if(t||(t=document.createElement("ol"),t.classList="fictioneer-comments__list commentlist",_$$$("comments").appendChild(t),n="append"),a&&(t=a.querySelector(".children"),n="append",!t)){const e=document.createElement("ol");a.appendChild(e),t=e}let i=document.createElement("div");switch(i.innerHTML=e.data.comment,i=i.firstChild,n){case"append":t.appendChild(i);break;case"insertBefore":t.insertBefore(i,t.firstChild);break;case"insertAfter":t.nextSibling?t.parentNode.insertBefore(i,t.nextSibling):t.parentNode.appendChild(i)}this.textarea.value="",this.textarea.style.height="","0"!=this.parent.value&&this.cancel.click();const s=window.location.protocol+"//"+window.location.host+window.location.pathname;("desc"!=this.order||fcn_urlParams.corder)&&(fcn_urlParams.corder=this.order),e.data.commentcode&&(fcn_urlParams.commentcode=e.data.commentcode);let o=Object.entries(fcn_urlParams).map((([e,t])=>`${e}=${t}`)).join("&");""!==o&&(o=`?${o}`),history.replaceState({path:s},"",s+o+`#comment-${e.data.comment_id}`),i.scrollIntoView({behavior:"smooth"})}else this.form.insertBefore(fcn_buildErrorNotice(e.data.failure??e.data.error??fictioneer_tl.notification.error,"comment-submit-error-notice",!1),this.form.firstChild),console.error("Error:",e.data.error??e.data.failure??"Unknown")})).catch((e=>{this.form.insertBefore(fcn_buildErrorNotice(`${e.statusText} (${e.status})`,"comment-submit-error-notice"),this.form.firstChild)})).then((()=>{this.form.classList.remove("ajax-in-progress"),this.submit.disabled=!1,this.submit.value=this.submit.dataset.enabled}))}))}}),application.register("fictioneer-comment",class extends Stimulus.Controller{static targets=["modMenuToggle","modMenu","modIcon","editLink","flagButton","deleteButton","editButton","content","inlineEditWrapper","inlineEditTextarea","inlineEditButtons","inlineEditSubmit","editNote"];static values={id:Number,timestamp:Number,fingerprint:String};connect(){this.comment=this.element.closest(".fictioneer-comment"),this.hasModMenuTarget&&(this.editLink=this.modMenuTarget.dataset.editLink),fcn_getUserData().fingerprint?(this.#e(),this.#t()):document.addEventListener("fcnUserDataReady",(()=>{this.#e(),this.#t()})),this.hasInlineEditTextareaTarget&&this.inlineEditTextareaTarget.addEventListener("input",(()=>{fcn_adjustTextarea(this.inlineEditTextareaTarget)}))}toggle(){this.#n()}approve(){this.#i("approve")}unapprove(){this.#i("unapprove")}offensive(){this.#i("offensive")}unoffensive(){this.#i("unoffensive")}open(){this.#i("open")}close(){this.#i("close")}sticky(){this.#i("sticky")}unsticky(){this.#i("unsticky")}trash(){this.#i("trash")}spam(){this.#i("spam")}mouseLeave(){this.modMenuTarget.querySelector("*")&&(this.#n("close"),fcn_lastClicked?.classList.remove("last-clicked"),fcn_lastClicked=null)}flag(){fcn_isLoggedIn&&this.hasFlagButtonTarget&&(this.comment.classList.contains("ajax-in-progress")||(this.comment.classList.add("ajax-in-progress"),fcn_ajaxPost({action:"fictioneer_ajax_report_comment",id:this.idValue,dubious:this.flagButtonTarget.classList.contains("_dubious"),fcn_fast_comment_ajax:1}).then((e=>{e.success?(this.flagButtonTarget.classList.toggle("on",e.data.flagged),this.flagButtonTarget.classList.remove("_dubious"),e.data.resync&&fcn_showNotification(e.data.resync)):(fcn_showNotification(e.data.failure??e.data.error??fictioneer_tl.notification.error,5,"warning"),console.error("Error:",e.data.error??e.data.failure??"Unknown"))})).catch((e=>{this.#a(e)})).then((()=>{this.comment.classList.remove("ajax-in-progress")}))))}selfDelete(){if(!fcn_isLoggedIn||!this.hasDeleteButtonTarget)return;const e=prompt(this.deleteButtonTarget.dataset.dialogMessage);e&&e.toLowerCase()==this.deleteButtonTarget.dataset.dialogConfirm.toLowerCase()&&(this.comment.classList.contains("ajax-in-progress")||(this.comment.classList.add("ajax-in-progress"),fcn_ajaxPost({action:"fictioneer_ajax_delete_my_comment",comment_id:this.idValue,fcn_fast_comment_ajax:1}).then((e=>{e.success?(this.comment.classList.add("_deleted"),this.element.innerHTML=e.data.html):(fcn_showNotification(e.data.failure??e.data.error??fictioneer_tl.notification.error,5,"warning"),console.error("Error:",e.data.error??e.data.failure??"Unknown"))})).catch((e=>{this.#a(e)})).then((()=>{this.comment.classList.remove("ajax-in-progress")}))))}startEditInline(){const e=_$$$("template-comment-inline-edit-form")?.content.cloneNode(!0);e&&(this.comment.classList.add("_editing"),this.commentEditUndo=this.inlineEditTextareaTarget.value,this.inlineEditWrapperTarget.appendChild(e),this.contentTarget.hidden=!0,this.inlineEditWrapperTarget.hidden=!1,this.inlineEditTextareaTarget.style.height=`${this.inlineEditTextareaTarget.scrollHeight}px`,fcn_adjustTextarea(this.inlineEditTextareaTarget))}cancelEditInline(){this.#s(!0)}submitEditInline(){this.inlineEditTextareaTarget.value!==this.commentEditUndo?(this.inlineEditWrapperTarget.classList.add("ajax-in-progress"),this.inlineEditSubmitTarget.innerHTML=this.inlineEditSubmitTarget.dataset.disabled,this.inlineEditSubmitTarget.disabled=!0,fcn_ajaxPost({action:"fictioneer_ajax_edit_comment",comment_id:this.idValue,content:this.inlineEditTextareaTarget.value,fcn_fast_comment_ajax:1}).then((e=>{if(e.success){this.contentTarget.innerHTML=e.data.content,this.#s(!1,e.data.raw);let t=this.editNoteTarget;this.hasEditNoteTarget||(t=document.createElement("div")),t.classList.add("fictioneer-comment__edit-note"),t.dataset.fictioneerCommentTarget="editNote",t.innerHTML=e.data.edited,this.contentTarget.parentNode.appendChild(t)}else this.#s(!0),fcn_showNotification(e.data.failure??e.data.error??fictioneer_tl.notification.error,5,"warning"),console.error("Error:",e.data.error??e.data.failure??"Unknown")})).catch((e=>{this.#s(!0),this.#a(e)})).then((()=>{this.inlineEditWrapperTarget.classList.remove("ajax-in-progress"),this.hasInlineEditSubmitTarget&&(this.inlineEditSubmitTarget.innerHTML=this.inlineEditSubmitTarget.dataset.enabled,this.inlineEditSubmitTarget.disabled=!1)}))):this.#s(!0)}bbcodes(e){if(_$(".fictioneer-comment-toolbar")&&"TEXTAREA"===document.activeElement.tagName&&(e.ctrlKey||e.metaKey)){const t=e.key.toLowerCase();if(["b","i","s","q","h","l"].includes(t)){e.preventDefault();const n={q:"quote",h:"spoiler",l:"link"};fcn_wrapInTag(document.activeElement,n[t]||t,{shortcode:!0})}}}#e(){this.hasDeleteButtonTarget&&this.#o()&&(this.deleteButtonTarget.hidden=!1)}#t(){let e=parseInt(document.documentElement.dataset.editTime);if(e&&(e=e>0?6e4*e:e,this.hasEditButtonTarget&&this.#o())){if(e>0&&parseInt(this.timestampValue)+e<Date.now())return;this.editButtonTarget.hidden=!1}}#o(){const e=fcn_getUserData().fingerprint;return!(!e||!this.hasFingerprintValue)&&e===this.fingerprintValue}#s(e=!1,t=null){this.comment.classList.remove("_editing"),this.contentTarget.hidden=!1,this.inlineEditWrapperTarget.hidden=!0,this.hasInlineEditButtonsTarget&&this.inlineEditButtonsTarget.remove(),e&&this.commentEditUndo?this.inlineEditTextareaTarget.value=this.commentEditUndo:t&&(this.inlineEditTextareaTarget.value=t),this.commentEditUndo=null}#n(e=null){const t=_$$$("template-comment-frontend-moderation-menu")?.content.cloneNode(!0);t&&this.hasModMenuTarget&&(!this.modMenuTarget.querySelector("*")&&"close"!==e||"open"===e?(this.modMenuTarget.appendChild(t),this.editLinkTarget.href=this.editLink):this.modMenuTarget.innerHTML="")}#r(e){this.modIconTarget.classList="fa-solid fa-triangle-exclamation mod-menu-toggle-icon",this.modIconTarget.style.color="var(--notice-warning-background)",this.modMenuToggleTarget.style.opacity="1",e&&fcn_showNotification(e,5,"warning")}#a(e){e.status&&e.statusText&&fcn_showNotification(`${e.status}: ${e.statusText}`,5,"warning"),console.error("Error:",e)}#i(e){this.comment.classList.contains("ajax-in-progress")||(this.comment.classList.add("ajax-in-progress"),"trash"!=e&&"spam"!=e||(this.comment.style.height=this.comment.clientHeight+"px"),fcn_ajaxPost({action:"fictioneer_ajax_moderate_comment",operation:e,id:this.idValue,fcn_fast_comment_ajax:1}).then((e=>{if(e.success){const t=e.data.operation,n={sticky:{action:"add",className:"_sticky"},unsticky:{action:"remove",className:"_sticky"},offensive:{action:"add",className:"_offensive"},unoffensive:{action:"remove",className:"_offensive"},approve:{action:"remove",className:"_unapproved"},unapprove:{action:"add",className:"_unapproved"},open:{action:"remove",className:"_closed"},close:{action:"add",className:"_closed"}};if(t in n){const{action:e,className:i}=n[t];this.comment.classList[e](i)}else"trash"!==t&&"spam"!==t||(this.comment.style.cssText="overflow: hidden; height: 0; margin: 0; opacity: 0;")}else this.#r(e.data.failure??e.data.error??fictioneer_tl.notification.error)})).catch((e=>{this.#r(e?.status&&e?.statusText?`${e.status}: ${e.statusText}`:e)})).then((()=>{this.comment.classList.remove("ajax-in-progress"),this.#n("close"),fcn_lastClicked?.classList.remove("last-clicked"),fcn_lastClicked=null})))}});