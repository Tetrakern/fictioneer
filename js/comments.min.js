function fcn_addJSTrap(){const e=document.querySelector(".comment-form");e&&e.appendChild(fcn_html`
      <input type="hidden" name="fictioneer_comment_validator" value="299792458">
    `)}function fcn_revealCommentFormInputs(e){e.closest("form").querySelectorAll(".fictioneer-respond__form-actions, .fictioneer-respond__form-bottom").forEach((e=>{e.classList.remove("hidden")}))}function fcn_addCommentFormEvents(){_$(fictioneer_comments.form_selector??"#comment")?.addEventListener("focus",(e=>{fcn_revealCommentFormInputs(e.currentTarget)}),{once:!0})}function fcn_wrapInTag(e,t,n={}){const a=n.href?' href="'+n.href+'" target="_blank" rel="nofollow noreferrer noopener"':"",i=n.shortcode?["[","]"]:["<",">"],o=e.selectionStart,s=e.selectionEnd,r=i[0]+t+a+i[1],c=i[0]+"/"+t+i[1],m=r+e.value.substring(o,s)+c;e.value=e.value.substring(0,o)+m+e.value.substring(s,e.value.length),e.setSelectionRange(o+r.length,s+r.length),e.focus()}function fcn_bindAJAXCommentSubmit(){fcn_theRoot.dataset.ajaxSubmit&&_$$$("commentform")?.addEventListener("submit",(e=>{if(e.preventDefault(),Date.now()<fcn_pageLoadTimestamp+3e3)return;const t=e.currentTarget,n=new FormData(t),a=Object.fromEntries(n.entries()),i=t.querySelector('[name="submit"]'),o=_$(fictioneer_comments.form_selector??"#comment"),s=t.querySelector('[name="author"]'),r=t.querySelector('[name="email"]'),c=t.querySelector('[name="fictioneer-privacy-policy-consent"]'),m=a.comment_parent??0,d=_$$$(`comment-${m}`),l=t.closest(".fictioneer-comments")?.dataset.order??"desc";let h=!0,u=!0,f=!0;if(u=o.value.length>1,o.classList.toggle("_error",!u),c&&(f=c.checked,c.classList.toggle("_error",!f)),r&&r.value.length>0&&(h=/\S+@\S+\.\S+/.test(r.value),r.classList.toggle("_error",!h)),!u||!f||!h)return!1;t.classList.add("ajax-in-progress"),i.disabled=!0,i.value=i.dataset.disabled;const _={action:"fictioneer_ajax_submit_comment",content:o.value,depth:d?parseInt(d.dataset.depth)+1:1,fcn_fast_comment_ajax:1,...a};r?.value&&(_.email=r?.value),s?.value&&(_.author=s?.value),fcn_ajaxPost(_).then((e=>{if(_$$$("comment-submit-error-notice")?.remove(),e.success&&e.data?.comment){let t=_$(".commentlist"),n="insertBefore";if(t&&!d&&t.firstElementChild){let e=null;if(t.firstElementChild.classList.contains("_sticky"))for(e=t.firstElementChild,t=e,n="insertAfter";e.nextElementSibling&&e.nextElementSibling.classList.contains("_sticky");)e=t.nextElementSibling,t=e}if(t||(t=document.createElement("ol"),t.classList="fictioneer-comments__list commentlist",_$$$("comments").appendChild(t),n="append"),d&&(t=d.querySelector(".children"),n="append",!t)){const e=document.createElement("ol");d.appendChild(e),t=e}let a=document.createElement("div");switch(a.innerHTML=e.data.comment,a=a.firstChild,n){case"append":t.appendChild(a);break;case"insertBefore":t.insertBefore(a,t.firstChild);break;case"insertAfter":t.nextSibling?t.parentNode.insertBefore(a,t.nextSibling):t.parentNode.appendChild(a)}"0"!=_$$$("comment_parent").value&&_$$$("cancel-comment-reply-link").click(),o.value="",o.style.height="";const i=window.location.protocol+"//"+window.location.host+window.location.pathname;("desc"!=l||fcn_urlParams.corder)&&(fcn_urlParams.corder=l),e.data.commentcode&&(fcn_urlParams.commentcode=e.data.commentcode);let s=Object.entries(fcn_urlParams).map((([e,t])=>`${e}=${t}`)).join("&");""!==s&&(s=`?${s}`),history.replaceState({path:i},"",i+s+`#comment-${e.data.comment_id}`),a.scrollIntoView({behavior:"smooth"})}else t.insertBefore(fcn_buildErrorNotice(e.data.failure??e.data.error??fictioneer_tl.notification.error,"comment-submit-error-notice",!1),t.firstChild),e.data.failure&&e.data.error&&console.error("Error:",e.data.error)})).catch((e=>{_$$$("comment-submit-error-notice")?.remove(),t.insertBefore(fcn_buildErrorNotice(`${e.statusText} (${e.status})`,"comment-submit-error-notice"),t.firstChild)})).then((()=>{t.classList.remove("ajax-in-progress"),i.disabled=!1,i.value=i.dataset.enabled}))}))}document.addEventListener("fcnUserDataReady",(()=>{fcn_getUserData().fingerprint==fcn_theRoot.dataset.authorFingerprint&&fcn_theBody.classList.add("is-post-author")})),fcn_addJSTrap(),fcn_addCommentFormEvents(),_$(".comment-section")?.addEventListener("click",(e=>{const t=e.target.closest("[data-bbcode]");t&&fcn_wrapInTag(_$(fictioneer_comments.form_selector??"#comment"),t.dataset.bbcode,{shortcode:!0})})),_$(".comment-section")?.addEventListener("keydown",(e=>{if(_$(".fictioneer-comment-toolbar")&&"TEXTAREA"===document.activeElement.tagName&&(e.ctrlKey||e.metaKey)){const t=e.key.toLowerCase();if(["b","i","s","q","h","l"].includes(t)){e.preventDefault();const n={q:"quote",h:"spoiler",l:"link"};fcn_wrapInTag(document.activeElement,n[t]||t,{shortcode:!0})}}})),fcn_bindAJAXCommentSubmit();const fcn_ajaxCommentForm=_$$$("ajax-comment-form-target");function fcn_setupCommentFormObserver(){const e=new IntersectionObserver((([t])=>{t.isIntersecting&&(fcn_getCommentForm(),e.disconnect())}),{rootMargin:"450px",threshold:1});e.observe(fcn_ajaxCommentForm)}function fcn_getCommentForm(){let e;fcn_ajaxGet({action:"fictioneer_ajax_get_comment_form",post_id:_$$$("comments").dataset.postId,fcn_fast_comment_ajax:1}).then((t=>{if(t.success){const e=document.createElement("div");e.innerHTML=t.data.html;const n=e.querySelector("#comment_post_ID"),a=e.querySelector("#cancel-comment-reply-link"),i=e.querySelector(".logout-link");n&&(n.value=t.data.postId),a&&(a.href="#respond"),i&&(i.href=_$$$("comments").dataset.logoutUrl),fcn_ajaxCommentForm.innerHTML=e.innerHTML,e.remove(),fcn_applyCommentStack(),fcn_addCommentFormEvents(),fcn_theRoot.dataset.ajaxSubmit&&fcn_bindAJAXCommentSubmit(),fcn_addNonceHTML(t.data.nonceHtml),fcn_addJSTrap()}else e=fcn_buildErrorNotice(t.data.error)})).catch((t=>{e=fcn_buildErrorNotice(t)})).then((()=>{fcn_ajaxCommentForm.classList.remove("comments-skeleton"),e&&(fcn_ajaxCommentForm.innerHTML="",fcn_ajaxCommentForm.appendChild(e))}))}fcn_ajaxCommentForm&&(fcn_theRoot.dataset.ajaxAuth?document.addEventListener("fcnAuthReady",(()=>{fcn_setupCommentFormObserver()})):fcn_setupCommentFormObserver());var fcn_commentStack=[];function fcn_applyCommentStack(e=null){(e=e??_$(fictioneer_comments.form_selector??"#comment"))&&("TEXTAREA"==e.tagName?(fcn_commentStack.forEach((t=>{e.value+=t})),fcn_adjustTextarea(e)):"DIV"==e.tagName&&fcn_commentStack.forEach((t=>{e.innerHTML+=t})),fcn_commentStack=[])}_$(".fictioneer-comments")?.addEventListener("input",(e=>{e.target.matches("#respond .adaptive-textarea")&&fcn_adjustTextarea(e.target),e.target.closest('[name="fictioneer-private-comment-toggle"]')&&_$$$("respond")?.classList.toggle("_private",e.currentTarget.checked)})),application.register("fictioneer-comment",class extends Stimulus.Controller{static targets=["modMenuToggle","modMenu","modIcon","editLink","flagButton","deleteButton","editButton","content","inlineEditWrapper","inlineEditTextarea","inlineEditButtons","inlineEditSubmit","editNote"];static values={id:Number,timestamp:Number,fingerprint:String};connect(){this.comment=this.element.closest(".fictioneer-comment"),this.hasModMenuTarget&&(this.editLink=this.modMenuTarget.dataset.editLink),fcn_getUserData().fingerprint?(this.#e(),this.#t()):document.addEventListener("fcnUserDataReady",(()=>{this.#e(),this.#t()})),this.hasInlineEditTextareaTarget&&this.inlineEditTextareaTarget.addEventListener("input",(()=>{fcn_adjustTextarea(this.inlineEditTextareaTarget)}))}toggle(){this.#n()}approve(){this.#a("approve")}unapprove(){this.#a("unapprove")}offensive(){this.#a("offensive")}unoffensive(){this.#a("unoffensive")}open(){this.#a("open")}close(){this.#a("close")}sticky(){this.#a("sticky")}unsticky(){this.#a("unsticky")}trash(){this.#a("trash")}spam(){this.#a("spam")}mouseLeave(){this.modMenuTarget.querySelector("*")&&(this.#n("close"),fcn_lastClicked?.classList.remove("last-clicked"),fcn_lastClicked=null)}flag(){fcn_isLoggedIn&&this.hasFlagButtonTarget&&(this.comment.classList.contains("ajax-in-progress")||(this.comment.classList.add("ajax-in-progress"),fcn_ajaxPost({action:"fictioneer_ajax_report_comment",id:this.idValue,dubious:this.flagButtonTarget.classList.contains("_dubious"),fcn_fast_comment_ajax:1}).then((e=>{e.success?(this.flagButtonTarget.classList.toggle("on",e.data.flagged),this.flagButtonTarget.classList.remove("_dubious"),e.data.resync&&fcn_showNotification(e.data.resync)):(fcn_showNotification(e.data.failure??e.data.error??fictioneer_tl.notification.error,5,"warning"),console.error("Error:",e.data.error??e.data.failure??"Unknown"))})).catch((e=>{this.#i(e)})).then((()=>{this.comment.classList.remove("ajax-in-progress")}))))}selfDelete(){if(!fcn_isLoggedIn||!this.hasDeleteButtonTarget)return;const e=prompt(this.deleteButtonTarget.dataset.dialogMessage);e&&e.toLowerCase()==this.deleteButtonTarget.dataset.dialogConfirm.toLowerCase()&&(this.comment.classList.contains("ajax-in-progress")||(this.comment.classList.add("ajax-in-progress"),fcn_ajaxPost({action:"fictioneer_ajax_delete_my_comment",comment_id:this.idValue,fcn_fast_comment_ajax:1}).then((e=>{e.success?(this.comment.classList.add("_deleted"),this.element.innerHTML=e.data.html):(fcn_showNotification(e.data.failure??e.data.error??fictioneer_tl.notification.error,5,"warning"),console.error("Error:",e.data.error??e.data.failure??"Unknown"))})).catch((e=>{this.#i(e)})).then((()=>{this.comment.classList.remove("ajax-in-progress")}))))}startEditInline(){const e=_$$$("template-comment-inline-edit-form")?.content.cloneNode(!0);e&&(this.comment.classList.add("_editing"),this.commentEditUndo=this.inlineEditTextareaTarget.value,this.inlineEditWrapperTarget.appendChild(e),this.contentTarget.hidden=!0,this.inlineEditWrapperTarget.hidden=!1,this.inlineEditTextareaTarget.style.height=`${this.inlineEditTextareaTarget.scrollHeight}px`,fcn_adjustTextarea(this.inlineEditTextareaTarget))}cancelEditInline(){this.#o(!0)}submitEditInline(){this.inlineEditTextareaTarget.value!==this.commentEditUndo?(this.inlineEditWrapperTarget.classList.add("ajax-in-progress"),this.inlineEditSubmitTarget.innerHTML=this.inlineEditSubmitTarget.dataset.disabled,this.inlineEditSubmitTarget.disabled=!0,fcn_ajaxPost({action:"fictioneer_ajax_edit_comment",comment_id:this.idValue,content:this.inlineEditTextareaTarget.value,fcn_fast_comment_ajax:1}).then((e=>{if(e.success){this.contentTarget.innerHTML=e.data.content,this.#o(!1,e.data.raw);let t=this.editNoteTarget;this.hasEditNoteTarget||(t=document.createElement("div")),t.classList.add("fictioneer-comment__edit-note"),t.dataset.fictioneerCommentTarget="editNote",t.innerHTML=e.data.edited,this.contentTarget.parentNode.appendChild(t)}else this.#o(!0),fcn_showNotification(e.data.failure??e.data.error??fictioneer_tl.notification.error,5,"warning"),console.error("Error:",e.data.error??e.data.failure??"Unknown")})).catch((e=>{this.#o(!0),this.#i(e)})).then((()=>{this.inlineEditWrapperTarget.classList.remove("ajax-in-progress"),this.hasInlineEditSubmitTarget&&(this.inlineEditSubmitTarget.innerHTML=this.inlineEditSubmitTarget.dataset.enabled,this.inlineEditSubmitTarget.disabled=!1)}))):this.#o(!0)}#e(){this.hasDeleteButtonTarget&&this.#s()&&(this.deleteButtonTarget.hidden=!1)}#t(){let e=parseInt(document.documentElement.dataset.editTime);if(e&&(e=e>0?6e4*e:e,this.hasEditButtonTarget&&this.#s())){if(e>0&&parseInt(this.timestampValue)+e<Date.now())return;this.editButtonTarget.hidden=!1}}#s(){const e=fcn_getUserData().fingerprint;return!(!e||!this.hasFingerprintValue)&&e===this.fingerprintValue}#o(e=!1,t=null){this.comment.classList.remove("_editing"),this.contentTarget.hidden=!1,this.inlineEditWrapperTarget.hidden=!0,this.hasInlineEditButtonsTarget&&this.inlineEditButtonsTarget.remove(),e&&this.commentEditUndo?this.inlineEditTextareaTarget.value=this.commentEditUndo:t&&(this.inlineEditTextareaTarget.value=t),this.commentEditUndo=null}#n(e=null){const t=_$$$("template-comment-frontend-moderation-menu")?.content.cloneNode(!0);t&&this.hasModMenuTarget&&(!this.modMenuTarget.querySelector("*")&&"close"!==e||"open"===e?(this.modMenuTarget.appendChild(t),this.editLinkTarget.href=this.editLink):this.modMenuTarget.innerHTML="")}#r(e){this.modIconTarget.classList="fa-solid fa-triangle-exclamation mod-menu-toggle-icon",this.modIconTarget.style.color="var(--notice-warning-background)",this.modMenuToggleTarget.style.opacity="1",e&&fcn_showNotification(e,5,"warning")}#i(e){e.status&&e.statusText&&fcn_showNotification(`${e.status}: ${e.statusText}`,5,"warning"),console.error("Error:",e)}#a(e){this.comment.classList.contains("ajax-in-progress")||(this.comment.classList.add("ajax-in-progress"),"trash"!=e&&"spam"!=e||(this.comment.style.height=this.comment.clientHeight+"px"),fcn_ajaxPost({action:"fictioneer_ajax_moderate_comment",operation:e,id:this.idValue,fcn_fast_comment_ajax:1}).then((e=>{if(e.success){const t=e.data.operation,n={sticky:{action:"add",className:"_sticky"},unsticky:{action:"remove",className:"_sticky"},offensive:{action:"add",className:"_offensive"},unoffensive:{action:"remove",className:"_offensive"},approve:{action:"remove",className:"_unapproved"},unapprove:{action:"add",className:"_unapproved"},open:{action:"remove",className:"_closed"},close:{action:"add",className:"_closed"}};if(t in n){const{action:e,className:a}=n[t];this.comment.classList[e](a)}else"trash"!==t&&"spam"!==t||(this.comment.style.cssText="overflow: hidden; height: 0; margin: 0; opacity: 0;")}else this.#r(e.data.failure??e.data.error??fictioneer_tl.notification.error)})).catch((e=>{this.#r(e?.status&&e?.statusText?`${e.status}: ${e.statusText}`:e)})).then((()=>{this.comment.classList.remove("ajax-in-progress"),this.#n("close"),fcn_lastClicked?.classList.remove("last-clicked"),fcn_lastClicked=null})))}});