application.register("fictioneer-bookmarks",class extends Stimulus.Controller{static get targets(){return[]}timeout=0;chapterId=_$(".chapter__article")?.id;initialize(){fcn()?.userReady||!FcnUtils.loggedIn()?this.#o=!0:document.addEventListener("fcnUserDataReady",(()=>{this.#o=!0,this.refreshView(),this.#e()}))}connect(){window.FictioneerApp.Controllers.fictioneerBookmarks=this,this.#o&&(this.refreshView(),this.#e())}data(){return this.bookmarksCachedData=FcnUtils.loggedIn()?this.#t():this.#a(),this.#r(this.bookmarksCachedData).data}toggle(o,e="none"){if(!this.chapterId)return;this.data()}set(){}refreshView(){console.log(this.data())}#o=!1;#s=!1;#a(){return FcnUtils.parseJSON(localStorage.getItem("fcnChapterBookmarks"))??{data:{}}}#t(){return FcnUtils.parseJSON(FcnUtils.userData()?.bookmarks)??{data:{}}}#r(o){if("object"!=typeof o||!("data"in o)||Array.isArray(o.data)&&0===o.data.length)return{data:{}};const e={};for(const t in o.data)if(t.startsWith("ch-")){const a=this.#n(o.data[t]);a&&(e[t]=a)}return{data:e}}#n(o){const e={},t={"paragraph-id":"",progress:0,date:"",color:"",chapter:"",link:"",thumb:"",image:"",story:"",content:""};for(const a in t){if(typeof o[a]!=typeof t[a])return null;e[a]=o[a]}const a=new Date(e.date);return a&&"[object Date]"===Object.prototype.toString.call(a)&&!isNaN(a)||(e.date=(new Date).toISOString()),("number"!=typeof e.progress||e.progress<0)&&(e.progress=0),e}#c(){return JSON.stringify(this.bookmarksCachedData??0)!==JSON.stringify(this.data())}#i(){this.refreshInterval||(this.refreshInterval=setInterval((()=>{!this.#s&&this.#c()&&this.refreshView()}),3e4+1e3*Math.random()))}#e(){this.#i(),this.visibilityStateCheck=()=>{"visible"===document.visibilityState?(this.#s=!1,this.refreshView(),this.#i()):(this.#s=!0,clearInterval(this.refreshInterval),this.refreshInterval=null)},document.addEventListener("visibilitychange",this.visibilityStateCheck)}});const fcn_jumpToBookmarkButtons=_$$(".button--bookmark"),fcn_mobileBookmarkJump=_$$$("mobile-menu-bookmark-jump"),fcn_mobileBookmarkList=_$(".mobile-menu__bookmark-list"),fcn_bookmarksSmallCardBlock=_$(".bookmarks-block"),fcn_bookmarksSmallCardTemplate=_$(".bookmark-small-card-template");var fcn_bookmarks,fcn_userBookmarksTimeout;function fcn_initializeLocalBookmarks(){fcn_setBookmarks(fcn_bookmarks=fcn_getBookmarks(),!0),fcn_updateBookmarksView()}function fcn_initializeUserBookmarks(o){fcn_setBookmarks(FcnUtils.parseJSON(o.detail.data.bookmarks)??{},!0),fcn_updateBookmarksView()}function fcn_getBookmarks(){let o=FcnUtils.parseJSON(localStorage.getItem("fcnChapterBookmarks"))??{data:{}};return Array.isArray(o.data)&&0===o.data.length&&(o.data={}),o=fcn_fixBookmarks(o),!o||Object.keys(o).length<1?{data:{}}:o}function fcn_fixBookmarks(o){const e={};for(const t in o.data)if(t.startsWith("ch-")){const a=fcn_fixBookmarksNode(o.data[t]);a&&(e[t]=a)}return{data:e}}function fcn_fixBookmarksNode(o){const e={},t={"paragraph-id":"",progress:0,date:"",color:"",chapter:"",link:"",thumb:"",image:"",story:"",content:""};for(const a in t){if(typeof o[a]!=typeof t[a])return null;e[a]=o[a]}const a=new Date(e.date);return a&&"[object Date]"===Object.prototype.toString.call(a)&&!isNaN(a)||(e.date=(new Date).toISOString()),("number"!=typeof e.progress||e.progress<0)&&(e.progress=0),e}function fcn_setBookmarks(o,e=!1){if("object"==typeof o){if(fcn_bookmarks=o,localStorage.setItem("fcnChapterBookmarks",JSON.stringify(o)),FcnUtils.loggedIn()){const e=fcn().userData();e&&(e.bookmarks=JSON.stringify(o),fcn().setUserData(e))}e||fcn_saveUserBookmarks(o)}}function fcn_updateBookmarksView(){if(!fcn_bookmarks||!fcn_bookmarks.data)return;const o=_$(".profile-bookmarks-stats"),e=Object.keys(fcn_bookmarks.data).length;o&&(o.innerHTML=o.innerHTML.replace("%s",e)),e>0&&_$$(".icon-menu-bookmarks").forEach((o=>{o.classList.remove("hidden")})),fcn_showBookmarkCards(),fcn_showChapterBookmark()}function fcn_saveUserBookmarks(o){FcnUtils.loggedIn()&&(clearTimeout(fcn_userBookmarksTimeout),o=fcn_fixBookmarks(o),fcn_userBookmarksTimeout=setTimeout((()=>{FcnUtils.aPost({action:"fictioneer_ajax_save_bookmarks",fcn_fast_ajax:1,bookmarks:JSON.stringify(o)}).then((o=>{o.success||(fcn_showNotification(o.data.failure??o.data.error??fictioneer_tl.notification.error,3,"warning"),(o.data.error||o.data.failure)&&console.error("Error:",o.data.error??o.data.failure))})).catch((o=>{o.status&&o.statusText&&fcn_showNotification(`${o.status}: ${o.statusText}`,3,"warning"),console.error(o)}))}),FcnGlobals.debounceRate))}function fcn_toggleBookmark(o,e="none"){fcn_bookmarks=fcn_getBookmarks();const t=_$(".chapter__article"),a=_$(".current-bookmark");if(!t)return;const r=fcn_bookmarks.data[t.id];if(r&&r["paragraph-id"]==o&&a)"none"!=e&&e!=r.color?(_$(".current-bookmark").dataset.bookmarkColor=e,r.color=e):fcn_removeBookmark(t.id);else{Object.keys(fcn_bookmarks.data).length>=50&&fcn_removeBookmark(Object.keys(fcn_bookmarks.data)[0]);const r=_$(`[data-paragraph-id="${o}"]`),s=_$$$("chapter-bookmark-data").dataset;fcn_bookmarks.data[t.id]={"paragraph-id":o,progress:100*(FcnUtils.offset(r).top-FcnUtils.offset(r.parentElement).top)/r.parentElement.clientHeight,date:(new Date).toISOString(),color:e,chapter:s.title.trim(),link:s.link,thumb:s.thumb,image:s.image,story:s.storyTitle.trim(),content:r.querySelector("span").innerHTML.substring(0,128)+"â€¦"},fcn_jumpToBookmarkButtons.forEach((o=>{o.classList.remove("hidden")})),fcn_mobileBookmarkJump?.removeAttribute("hidden"),a?.classList.remove("current-bookmark"),r.classList.add("current-bookmark"),r.setAttribute("data-bookmark-color",e)}fcn_setBookmarks(fcn_bookmarks)}function fcn_showChapterBookmark(){_$(".current-bookmark")?.classList.remove("current-bookmark");const o=_$(".chapter__article");if(!o||!fcn_bookmarks.data[o.id])return;const e=fcn_bookmarks.data[o.id]["paragraph-id"],t=_$(`[data-paragraph-id="${e}"]`),a=fcn_bookmarks.data[o.id].color??"none";e&&t&&(fcn_jumpToBookmarkButtons.forEach((o=>{o.classList.remove("hidden")})),fcn_mobileBookmarkJump?.removeAttribute("hidden"),t.classList.add("current-bookmark"),t.setAttribute("data-bookmark-color",a))}function fcn_showBookmarkCards(){if(!fcn_bookmarks||!fcn_bookmarksSmallCardBlock||!fcn_bookmarksSmallCardTemplate||Object.keys(fcn_bookmarks.data).length<1||_$(".bookmark-card"))return;fcn_bookmarksSmallCardBlock.classList.remove("hidden"),_$(".bookmarks-block__no-bookmarks")?.remove(),_$$(".show-if-bookmarks").forEach((o=>o.classList.remove("hidden")));let o=parseInt(fcn_bookmarksSmallCardBlock.dataset.count);const e=document.createDocumentFragment();Object.entries(fcn_bookmarks.data).sort(((o,e)=>new Date(e[1].date)-new Date(o[1].date))).forEach((([t,{color:a,progress:r,link:s,chapter:n,"paragraph-id":c,date:i,image:k,thumb:m,content:d}])=>{if(0==o)return;o--;const l=fcn_bookmarksSmallCardTemplate.content.cloneNode(!0),f=new Date(i).toLocaleDateString(navigator.language??"en-US",{year:"2-digit",month:"short",day:"numeric"});k&&l.querySelector(".bookmark-card__image")?(l.querySelector(".bookmark-card__image").href=k,l.querySelector(".bookmark-card__image img").src=m):l.querySelector(".bookmark-card__image")?.remove(),l.querySelector(".bookmark-card__excerpt").innerHTML+=d,l.querySelector(".bookmark-card").classList.add(`bookmark-${t}`),l.querySelector(".bookmark-card").dataset.color=a,l.querySelector(".bookmark-card__title > a").href=`${s}#paragraph-${c}`,l.querySelector(".bookmark-card__title > a").innerText=n,l.querySelector(".bookmark-card__percentage").innerText=`${r.toFixed(1)} %`,l.querySelector(".bookmark-card__progress").style.width=`calc(${r.toFixed(1)}% - var(--bookmark-progress-offset, 0px))`,l.querySelector("time").innerText=f,l.querySelector(".button-delete-bookmark").setAttribute("data-bookmark-id",t),e.appendChild(l)})),fcn_bookmarksSmallCardBlock.querySelector("ul").appendChild(e),fcn_bookmarkDeleteHandler(_$$(".button-delete-bookmark"))}function fcn_bookmarkDeleteHandler(o){("object"==typeof o?o:[o]).forEach((o=>{o.addEventListener("click",(o=>{fcn_removeBookmark(o.currentTarget.dataset.bookmarkId),fcn_setBookmarks(fcn_bookmarks),Object.keys(fcn_bookmarks.data).length<1&&(_$(".bookmarks-block")?.classList.add("hidden"),_$$(".show-if-bookmarks").forEach((o=>{o.classList.add("hidden")})))}))}))}function fcn_removeBookmark(o){const e=_$(".chapter__article"),t=_$(".current-bookmark");delete fcn_bookmarks.data[o],e&&e.id==o&&(fcn_jumpToBookmarkButtons.forEach((o=>{o.classList.add("hidden")})),fcn_mobileBookmarkJump?.setAttribute("hidden",!0),t&&(t.classList.remove("current-bookmark"),t.removeAttribute("data-bookmark-color"))),_$$(`.bookmark-${o}`)?.forEach((o=>{o.remove()}))}fcn_initializeLocalBookmarks(),document.addEventListener("fcnUserDataReady",(o=>{o.detail.data.loggedIn&&fcn_initializeUserBookmarks(o)}));