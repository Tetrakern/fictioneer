application.register("fictioneer-bookmarks",class extends Stimulus.Controller{static get targets(){return["bookmarkScroll","shortcodeBlock","dataCard","overviewPageIconLink","noBookmarksNote"]}timeout=0;chapterId=_$(".chapter__article")?.id;currentBookmark=null;cardTemplate=_$(".bookmark-small-card-template");initialize(){fcn()?.userReady||!FcnUtils.loggedIn()?this.#t=!0:document.addEventListener("fcnUserDataReady",(()=>{this.#t=!0,this.refreshView(),this.#e()}))}connect(){window.FictioneerApp.Controllers.fictioneerBookmarks=this,this.#t&&(this.refreshView(),this.#e())}data(){return this.bookmarksCachedData=FcnUtils.loggedIn()?this.#r():this.#a(),this.#o(this.bookmarksCachedData).data}toggle(t,e="none"){if(!this.chapterId)return;const r=this.data(),a=r[this.chapterId];if(a&&a["paragraph-id"]==t)"none"!==e&&e!==a.color?r[this.chapterId].color=e:delete r[this.chapterId];else{Object.keys(r).length>=50&&delete r[Object.keys(r)[0]];const a=_$(`[data-paragraph-id="${t}"]`),o=_$$$("chapter-bookmark-data").dataset;r[this.chapterId]={"paragraph-id":t,progress:100*(FcnUtils.offset(a).top-FcnUtils.offset(a.parentElement).top)/a.parentElement.clientHeight,date:(new Date).toISOString(),color:e,chapter:o.title.trim(),link:o.link,thumb:o.thumb,image:o.image,story:o.storyTitle.trim(),content:FcnUtils.extractTextNodes(a).substring(0,128)+"â€¦"}}this.set(r),this.refreshView()}remove({params:{id:t}}){const e=this.data();delete e[t],this.set(e),this.refreshView()}clear(){this.set({data:{}}),this.refreshView()}set(t){if("object"!=typeof t)return;t=this.#o({data:t});const e=JSON.stringify(t);if(FcnUtils.loggedIn()){const t=fcn().userData();t&&(t.bookmarks=e,fcn().setUserData(t)),this.#s(e),localStorage.removeItem("fcnChapterBookmarks")}else localStorage.setItem("fcnChapterBookmarks",e)}refreshView(){const t=this.data(),e=Object.keys(t).length;this.hasOverviewPageIconLinkTarget&&this.overviewPageIconLinkTargets.forEach((t=>{t.classList.toggle("hidden",e<1)})),this.refreshChapterBookmark(),this.refreshCards(),this.refreshProfile()}refreshCards(){if(!this.hasShortcodeBlockTarget)return;const t=this.data(),e=Object.keys(t).length<1;this.shortcodeBlockTargets.forEach((t=>{t.classList.toggle("hidden",e)})),_$$(".show-if-bookmarks").forEach((t=>{t.classList.toggle("hidden",e)})),this.hasNoBookmarksNoteTarget&&this.noBookmarksNoteTargets.forEach((t=>{t.classList.toggle("hidden",!e)})),!e&&this.cardTemplate?this.shortcodeBlockTargets.forEach((e=>{const r=e.querySelector("ul"),a=document.createDocumentFragment(),o=Object.entries(t).sort(((t,e)=>new Date(e[1].date)-new Date(t[1].date)));let s=parseInt(e.dataset.count)??8;o.forEach((([t,{color:e,progress:r,link:o,chapter:i,"paragraph-id":c,date:n,image:h,thumb:d,content:l}])=>{if(0==s--)return;const k=this.cardTemplate.content.cloneNode(!0),m=new Date(n).toLocaleDateString(navigator.language??"en-US",{year:"2-digit",month:"short",day:"numeric"});h&&k.querySelector(".bookmark-card__image")?(k.querySelector(".bookmark-card__image").href=h,k.querySelector(".bookmark-card__image img").src=d):k.querySelector(".bookmark-card__image")?.remove(),k.querySelector(".bookmark-card__excerpt").innerHTML+=l,k.querySelector(".bookmark-card").classList.add(`bookmark-${t}`),k.querySelector(".bookmark-card").dataset.color=e,k.querySelector(".bookmark-card__title > a").href=`${o}#paragraph-${c}`,k.querySelector(".bookmark-card__title > a").innerText=i,k.querySelector(".bookmark-card__percentage").innerText=`${r.toFixed(1)} %`,k.querySelector(".bookmark-card__progress").style.width=`calc(${r.toFixed(1)}% - var(--bookmark-progress-offset, 0px))`,k.querySelector("time").innerText=m,k.querySelector(".button-delete-bookmark").setAttribute("data-fictioneer-bookmarks-id-param",t),a.appendChild(k)})),r.innerHTML="",r.appendChild(a)})):this.shortcodeBlockTargets.forEach((t=>{t.querySelector("ul").innerHTML=""}))}refreshProfile(){this.hasDataCardTarget&&(this.dataCardTarget.innerHTML=this.dataCardTarget.innerHTML.replace("%s",Object.keys(this.data()).length))}refreshChapterBookmark(){const t=this.data();if(this.currentBookmark?.classList.remove("current-bookmark"),!this.chapterId||!t[this.chapterId])return;const e=t[this.chapterId]["paragraph-id"],r=_$(`[data-paragraph-id="${e}"]`),a=t[this.chapterId].color??"none";e&&r&&(r.classList.add("current-bookmark"),r.setAttribute("data-bookmark-color",a),this.currentBookmark=r,this.hasBookmarkScrollTarget&&this.bookmarkScrollTargets.forEach((t=>t.removeAttribute("hidden"))))}#t=!1;#i=!1;#a(){return FcnUtils.parseJSON(localStorage.getItem("fcnChapterBookmarks"))??{data:{}}}#r(){return FcnUtils.parseJSON(FcnUtils.userData()?.bookmarks)??{data:{}}}#o(t){if("object"!=typeof t||!("data"in t)||Array.isArray(t.data)&&0===t.data.length)return{data:{}};const e={};for(const r in t.data)if(r.startsWith("ch-")){const a=this.#c(t.data[r]);a&&(e[r]=a)}return{data:e}}#c(t){const e={},r={"paragraph-id":"",progress:0,date:"",color:"",chapter:"",link:"",thumb:"",image:"",story:"",content:""};for(const a in r){if(typeof t[a]!=typeof r[a])return null;e[a]=t[a]}const a=new Date(e.date);return a&&"[object Date]"===Object.prototype.toString.call(a)&&!isNaN(a)||(e.date=(new Date).toISOString()),("number"!=typeof e.progress||e.progress<0)&&(e.progress=0),e}#n(){return JSON.stringify(this.bookmarksCachedData??0)!==JSON.stringify(this.data())}#h(){this.refreshInterval||(this.refreshInterval=setInterval((()=>{!this.#i&&this.#n()&&this.refreshView()}),3e4+1e3*Math.random()))}#e(){this.#h(),this.visibilityStateCheck=()=>{"visible"===document.visibilityState?(this.#i=!1,this.refreshView(),this.#h()):(this.#i=!0,clearInterval(this.refreshInterval),this.refreshInterval=null)},document.addEventListener("visibilitychange",this.visibilityStateCheck)}#s(t){clearTimeout(this.timeout),this.timeout=setTimeout((()=>{FcnUtils.aPost({action:"fictioneer_ajax_save_bookmarks",fcn_fast_ajax:1,bookmarks:t}).then((t=>{t.success||(fcn_showNotification(t.data.failure??t.data.error??fictioneer_tl.notification.error,3,"warning"),(t.data.error||t.data.failure)&&console.error("Error:",t.data.error??t.data.failure))})).catch((t=>{t.status&&t.statusText&&fcn_showNotification(`${t.status}: ${t.statusText}`,3,"warning"),console.error(t)}))}),FcnGlobals.debounceRate)}});