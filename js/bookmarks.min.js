const fcn_jumpToBookmarkButtons=_$$(".button--bookmark"),fcn_mobileBookmarkJump=_$$$("mobile-menu-bookmark-jump"),fcn_mobileBookmarkList=_$(".mobile-menu__bookmark-list"),fcn_bookmarksSmallCardBlock=_$(".bookmarks-block"),fcn_bookmarksSmallCardTemplate=_$(".bookmark-small-card-template");var fcn_bookmarks,fcn_userBookmarksTimeout;function fcn_initializeLocalBookmarks(){fcn_setBookmarks(fcn_bookmarks=fcn_getBookmarks(),!0),fcn_updateBookmarksView()}function fcn_initializeUserBookmarks(o){fcn_setBookmarks(FcnUtils.parseJSON(o.detail.data.bookmarks)??{},!0),fcn_updateBookmarksView()}function fcn_getBookmarks(){let o=FcnUtils.parseJSON(localStorage.getItem("fcnChapterBookmarks"))??{data:{}};return Array.isArray(o.data)&&0===o.data.length&&(o.data={}),o=fcn_fixBookmarks(o),!o||Object.keys(o).length<1?{data:{}}:o}function fcn_fixBookmarks(o){const a={};for(const r in o.data)if(r.startsWith("ch-")){const e=fcn_fixBookmarksNode(o.data[r]);e&&(a[r]=e)}return{data:a}}function fcn_fixBookmarksNode(o){const a={},r={"paragraph-id":"",progress:0,date:"",color:"",chapter:"",link:"",thumb:"",image:"",story:"",content:""};for(const e in r){if(typeof o[e]!=typeof r[e])return null;a[e]=o[e]}const e=new Date(a.date);return e&&"[object Date]"===Object.prototype.toString.call(e)&&!isNaN(e)||(a.date=(new Date).toISOString()),("number"!=typeof a.progress||a.progress<0)&&(a.progress=0),a}function fcn_setBookmarks(o,a=!1){if("object"==typeof o){if(fcn_bookmarks=o,localStorage.setItem("fcnChapterBookmarks",JSON.stringify(o)),FcnUtils.loggedIn()){const a=fcn().userData();a&&(a.bookmarks=JSON.stringify(o),fcn().setUserData(a))}a||fcn_saveUserBookmarks(o)}}function fcn_updateBookmarksView(){if(!fcn_bookmarks||!fcn_bookmarks.data)return;const o=_$(".profile-bookmarks-stats"),a=Object.keys(fcn_bookmarks.data).length;o&&(o.innerHTML=o.innerHTML.replace("%s",a)),a>0&&_$$(".icon-menu-bookmarks").forEach((o=>{o.classList.remove("hidden")})),fcn_showBookmarkCards(),fcn_showChapterBookmark()}function fcn_saveUserBookmarks(o){FcnUtils.loggedIn()&&(clearTimeout(fcn_userBookmarksTimeout),o=fcn_fixBookmarks(o),fcn_userBookmarksTimeout=setTimeout((()=>{FcnUtils.aPost({action:"fictioneer_ajax_save_bookmarks",fcn_fast_ajax:1,bookmarks:JSON.stringify(o)}).then((o=>{o.success||(fcn_showNotification(o.data.failure??o.data.error??fictioneer_tl.notification.error,3,"warning"),(o.data.error||o.data.failure)&&console.error("Error:",o.data.error??o.data.failure))})).catch((o=>{o.status&&o.statusText&&fcn_showNotification(`${o.status}: ${o.statusText}`,3,"warning"),console.error(o)}))}),FcnGlobals.debounceRate))}function fcn_toggleBookmark(o,a="none"){fcn_bookmarks=fcn_getBookmarks();const r=_$(".chapter__article"),e=_$(".current-bookmark");if(!r)return;const t=fcn_bookmarks.data[r.id];if(t&&t["paragraph-id"]==o&&e)"none"!=a&&a!=t.color?(_$(".current-bookmark").dataset.bookmarkColor=a,t.color=a):fcn_removeBookmark(r.id);else{Object.keys(fcn_bookmarks.data).length>=50&&fcn_removeBookmark(Object.keys(fcn_bookmarks.data)[0]);const t=_$(`[data-paragraph-id="${o}"]`),n=_$$$("chapter-bookmark-data").dataset;fcn_bookmarks.data[r.id]={"paragraph-id":o,progress:100*(FcnUtils.offset(t).top-FcnUtils.offset(t.parentElement).top)/t.parentElement.clientHeight,date:(new Date).toISOString(),color:a,chapter:n.title.trim(),link:n.link,thumb:n.thumb,image:n.image,story:n.storyTitle.trim(),content:t.querySelector("span").innerHTML.substring(0,128)+"â€¦"},fcn_jumpToBookmarkButtons.forEach((o=>{o.classList.remove("hidden")})),fcn_mobileBookmarkJump?.removeAttribute("hidden"),e?.classList.remove("current-bookmark"),t.classList.add("current-bookmark"),t.setAttribute("data-bookmark-color",a)}fcn_setBookmarks(fcn_bookmarks)}function fcn_showChapterBookmark(){_$(".current-bookmark")?.classList.remove("current-bookmark");const o=_$(".chapter__article");if(!o||!fcn_bookmarks.data[o.id])return;const a=fcn_bookmarks.data[o.id]["paragraph-id"],r=_$(`[data-paragraph-id="${a}"]`),e=fcn_bookmarks.data[o.id].color??"none";a&&r&&(fcn_jumpToBookmarkButtons.forEach((o=>{o.classList.remove("hidden")})),fcn_mobileBookmarkJump?.removeAttribute("hidden"),r.classList.add("current-bookmark"),r.setAttribute("data-bookmark-color",e))}function fcn_showBookmarkCards(){if(!fcn_bookmarks||!fcn_bookmarksSmallCardBlock||!fcn_bookmarksSmallCardTemplate||Object.keys(fcn_bookmarks.data).length<1||_$(".bookmark-card"))return;fcn_bookmarksSmallCardBlock.classList.remove("hidden"),_$(".bookmarks-block__no-bookmarks")?.remove(),_$$(".show-if-bookmarks").forEach((o=>o.classList.remove("hidden")));let o=parseInt(fcn_bookmarksSmallCardBlock.dataset.count);const a=document.createDocumentFragment();Object.entries(fcn_bookmarks.data).sort(((o,a)=>new Date(a[1].date)-new Date(o[1].date))).forEach((([r,{color:e,progress:t,link:n,chapter:k,"paragraph-id":c,date:s,image:m,thumb:i,content:l}])=>{if(0==o)return;o--;const d=fcn_bookmarksSmallCardTemplate.content.cloneNode(!0),f=new Date(s).toLocaleDateString(navigator.language??"en-US",{year:"2-digit",month:"short",day:"numeric"});m&&d.querySelector(".bookmark-card__image")?(d.querySelector(".bookmark-card__image").href=m,d.querySelector(".bookmark-card__image img").src=i):d.querySelector(".bookmark-card__image")?.remove(),d.querySelector(".bookmark-card__excerpt").innerHTML+=l,d.querySelector(".bookmark-card").classList.add(`bookmark-${r}`),d.querySelector(".bookmark-card").dataset.color=e,d.querySelector(".bookmark-card__title > a").href=`${n}#paragraph-${c}`,d.querySelector(".bookmark-card__title > a").innerText=k,d.querySelector(".bookmark-card__percentage").innerText=`${t.toFixed(1)} %`,d.querySelector(".bookmark-card__progress").style.width=`calc(${t.toFixed(1)}% - var(--bookmark-progress-offset, 0px))`,d.querySelector("time").innerText=f,d.querySelector(".button-delete-bookmark").setAttribute("data-bookmark-id",r),a.appendChild(d)})),fcn_bookmarksSmallCardBlock.querySelector("ul").appendChild(a),fcn_bookmarkDeleteHandler(_$$(".button-delete-bookmark"))}function fcn_bookmarkDeleteHandler(o){("object"==typeof o?o:[o]).forEach((o=>{o.addEventListener("click",(o=>{fcn_removeBookmark(o.currentTarget.dataset.bookmarkId),fcn_setBookmarks(fcn_bookmarks),Object.keys(fcn_bookmarks.data).length<1&&(_$(".bookmarks-block")?.classList.add("hidden"),_$$(".show-if-bookmarks").forEach((o=>{o.classList.add("hidden")})))}))}))}function fcn_removeBookmark(o){const a=_$(".chapter__article"),r=_$(".current-bookmark");delete fcn_bookmarks.data[o],a&&a.id==o&&(fcn_jumpToBookmarkButtons.forEach((o=>{o.classList.add("hidden")})),fcn_mobileBookmarkJump?.setAttribute("hidden",!0),r&&(r.classList.remove("current-bookmark"),r.removeAttribute("data-bookmark-color"))),_$$(`.bookmark-${o}`)?.forEach((o=>{o.remove()}))}fcn_initializeLocalBookmarks(),document.addEventListener("fcnUserDataReady",(o=>{o.detail.data.loggedIn&&fcn_initializeUserBookmarks(o)}));