diff_match_patch.prototype.fcn_prettyHtml=function(t){for(var e=[],i=/&/g,n=/</g,o=/>/g,s=/\n/g,l=0;l<t.length;l++){var a=t[l][0],r=t[l][1].replace(i,"&amp;").replace(n,"&lt;").replace(o,"&gt;").replace(s,"&para;<br>");switch(a){case 1:e[l]=`<ins>${r}</ins>`;break;case-1:e[l]=`<del>${r}</del>`;break;case 0:e[l]=`${r}`}}return e.join("")},application.register("fictioneer-suggestion",class extends Stimulus.Controller{modal=_$$$("suggestions-modal");floatingButton=_$$$("selection-tools");input=_$$$("suggestions-modal-input");current=_$$$("suggestions-modal-original");diff=_$$$("suggestions-modal-diff");reset=_$$$("button-suggestion-reset");submit=_$$$("button-suggestion-submit");original="";suggestion="";text="";open=!1;dmp=new diff_match_patch;initialize(){this.floatingButton&&this.floatingButton.addEventListener("click",(t=>{this.toggleModalViaSelection(t.currentTarget)})),this.input.addEventListener("input",(()=>this.#t())),this.reset.addEventListener("click",(()=>this.#e())),this.submit.addEventListener("click",(()=>this.#i()))}connect(){window.FictioneerApp.Controllers.fictioneerSuggestion=this}clickOutside(){this.open&&this.#n()}toggleModalViaSelection(t){this.toggleModalVisibility(t)}toggleModalViaParagraph(t){this.text=FcnUtils.extractTextNodes(_$(".selected-paragraph")),this.toggleModalVisibility(t.currentTarget)}toggleModalVisibility(t){const e=fcn(),i=window.FictioneerApp.Controllers.fictioneerChapter;e?i?(e.toggleModalVisibility(t,"suggestions-modal"),i.closeTools(),this.#o(),this.original=this.text,this.suggestion=this.text,this.current.innerText=this.text,this.diff.innerText=this.text,this.input.value=this.text,this.input.focus()):fcn_showNotification("Error: Chapter Controller not connected.",3,"warning"):fcn_showNotification("Error: Fictioneer Controller not connected.",3,"warning")}toggleFloatingButton(){FcnGlobals.eSite.classList.contains("transformed-site")||window.getSelection().rangeCount<1||!window.getSelection().getRangeAt(0).startContainer.parentNode.closest(".content-section")||setTimeout((()=>{if(this.text=window.getSelection().toString().replaceAll("\n\n","\n").trim(),""!==this.text){const t=this.#s();this.#l(t.x,t.y)}else this.#n()}),10)}#l(t,e){this.open=!0;const i=document.documentElement.offsetWidth/2+this.floatingButton.offsetWidth,n=_$$$("wpadminbar")?.offsetHeight??0;this.floatingButton.style.transform=t>i?"translate(-100%)":"translate(0)",this.floatingButton.style.top=e+4-n+"px",this.floatingButton.style.left=`${t}px`,this.floatingButton.classList.remove("invisible")}#n(){this.open=!1,this.floatingButton.style.top="0",this.floatingButton.style.left="-1000px",this.floatingButton.classList.add("invisible")}#s(){let t=0,e=0;if(void 0!==window.getSelection){const i=window.getSelection();if(0!==i.rangeCount){let n=i.getRangeAt(0).cloneRange().getClientRects();n=n[n.length-1],n&&(t=n.right+window.scrollX,e=n.bottom+window.scrollY)}}return{x:t,y:e}}#o(){window.getSelection&&(window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges())}#t(){this.suggestion=this.#a(this.original,this.input.value),this.diff.innerHTML=this.suggestion}#e(){this.suggestion=this.original,this.input.value=this.original,this.diff.innerText=this.original}#a(t,e){const i=this.dmp.diff_main(t,e);return this.dmp.diff_cleanupEfficiency(i),this.dmp.fcn_prettyHtml(i)}#i(){}});class FCN_Suggestion{constructor(){this.tools=_$$$("selection-tools"),this.button=_$$$("button-add-suggestion"),this.toolsButton=_$$$("button-tools-add-suggestion"),this.reset=_$$$("button-suggestion-reset"),this.submit=_$$$("button-suggestion-submit"),this.current=_$$$("suggestions-modal-original"),this.input=_$$$("suggestions-modal-input"),this.output=_$$$("suggestions-modal-diff"),this.chapter=_$(".chapter__article"),this.text="",this.original="",this.latest="",this.paragraph=null,this.dmp=new diff_match_patch,this.bindEvents()}getCaretCoordinates(){let t=0,e=0;if(void 0!==window.getSelection){const i=window.getSelection();if(0!==i.rangeCount){let n=i.getRangeAt(0).cloneRange().getClientRects();n=n[n.length-1],n&&(t=n.right+window.scrollX,e=n.bottom+window.scrollY)}}return{x:t,y:e}}getClosestParagraph(){const t=window.getSelection();return t.rangeCount?t.getRangeAt(0).startContainer.parentNode.closest("p"):null}showTools(t,e){const i=document.documentElement.offsetWidth/2+this.tools.offsetWidth,n=_$$$("wpadminbar")?_$$$("wpadminbar").offsetHeight:0;this.tools.style.transform=e>i?"translate(-100%)":"translate(0)",this.tools.style.top=t+4-n+"px",this.tools.style.left=`${e}px`,this.tools.classList.remove("invisible")}hideTools(){this.tools.style.top="0",this.tools.style.left="-1000px",this.tools.classList.add("invisible")}textSelection(){return window.getSelection().toString()}clearSelection(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()}getDiff(t,e){const i=this.dmp.diff_main(t,e);return this.dmp.diff_cleanupEfficiency(i),this.dmp.fcn_prettyHtml(i)}toggleTools(t){FcnGlobals.eSite.classList.contains("transformed-site")||window.getSelection().rangeCount<1||!window.getSelection().getRangeAt(0).startContainer.parentNode.closest(".content-section")||setTimeout((()=>{if(t.text=t.textSelection().replaceAll("\n\n","\n"),""!==t.text){const e=t.getCaretCoordinates();t.showTools(e.y,e.x)}else t.hideTools()}),10)}toggleViaParagraphTools(t){FcnGlobals.eSite.classList.contains("transformed-site")||(t.text=FcnUtils.extractTextNodes(_$(".selected-paragraph")),t.showModal(t))}resizeInput(){this.input.style.height="auto",this.input.style.height=`${FcnUtils.clamp(32,108,this.input.scrollHeight+4)}px`}showModal(t){const e=window.FictioneerApp.Controllers.fictioneerChapter;e&&e.closeTools(),t.original=t.text,t.current.innerHTML=t.text.replaceAll("\n","<br>"),t.input.value=t.text,t.output.innerHTML=t.getDiff(t.original,t.text),t.paragraph=t.getClosestParagraph(),t.clearSelection(),t.hideTools(),t.resizeInput(),t.input.focus()}editSuggestion(t){t.resizeInput(),t.output.innerHTML=t.getDiff(t.original,t.input.value)}resetSuggestion(t){t.input.value=t.original,t.resizeInput(),t.output.innerHTML=t.getDiff(t.original,t.original)}submitSuggestion(t){const e=t.paragraph?.id??null;let i=t.output.innerHTML;[["Â¶","&para;\n"],["<br>","\n"],["<ins>","[ins]"],["</ins>","[/ins]"],["<del>","[del]"],["</del>","[/del]"]].forEach((([t,e])=>{i=i.replaceAll(t,e)})),t.latest=e?`\n[quote]${i} [anchor]${e}[/anchor][/quote]\n`:`\n[quote]${i}[/quote]\n`,FcnUtils.appendToComment(t.latest),fcn_showNotification(fictioneer_tl.notification.suggestionAppendedToComment)}bindEvents(){this.chapter?.addEventListener("mouseup",this.toggleTools.bind(null,this)),this.button?.addEventListener("click",this.showModal.bind(null,this)),this.input?.addEventListener("input",this.editSuggestion.bind(null,this)),this.reset?.addEventListener("click",this.resetSuggestion.bind(null,this)),this.submit?.addEventListener("click",this.submitSuggestion.bind(null,this))}}