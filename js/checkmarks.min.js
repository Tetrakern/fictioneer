var fcn_checkmarks,fcn_userCheckmarksTimeout;function fcn_initializeCheckmarks(a){const e=a.detail.data.checkmarks;!1!==e&&(Array.isArray(e.data)&&0===e.data.length&&(e.data={}),fcn_checkmarks=e,fcn_updateCheckmarksView(),localStorage.removeItem("fcnBookshelfContent"),_$$("button.checkmark").forEach((a=>{a.addEventListener("click",(a=>{fcn_clickCheckmark(a.currentTarget)}))})))}function fcn_toggleCheckmark(a,e,c=null,t=null,r="toggle"){const s=fcn().userData();if(fcn_checkmarks&&s.checkmarks){if(localStorage.removeItem("fcnBookshelfContent"),"toggle"===r&&JSON.stringify(fcn_checkmarks.data[a])!==JSON.stringify(s.checkmarks.data[a]))return fcn_checkmarks=s.checkmarks,fcn_showNotification(fictioneer_tl.notification.checkmarksResynchronized),void fcn_updateCheckmarksView();if(fcn_checkmarks.data[a]||(fcn_checkmarks.data[a]=[]),s.checkmarks.data[a]||(s.checkmarks.data[a]=[]),c&&"progress"===e&&!fcn_checkmarks.data[a].includes(c)&&fcn_checkmarks.data[a].push(c),c&&"chapter"===e)if(!fcn_checkmarks.data[a].includes(c)&&"unset"!==r||"set"===r)fcn_checkmarks.data[a].push(c),t&&(t.classList.add("marked"),t.setAttribute("aria-checked",!0));else{fcn_removeItemOnce(fcn_checkmarks.data[a],c),t&&(t.classList.remove("marked"),t.setAttribute("aria-checked",!1)),fcn_removeItemOnce(fcn_checkmarks.data[a],a);const e=_$('button[data-type="story"]');e&&(e.classList.remove("marked"),e.setAttribute("aria-checked",!1))}if("story"===e){const e=(fcn_checkmarks.data[a].includes(a)||"unset"===r)&&"set"!==r;fcn_checkmarks.data[a]=[],e||(_$$("button.checkmark").forEach((e=>{fcn_checkmarks.data[a].push(parseInt(e.dataset.id))})),fcn_checkmarks.data[a].includes(a)||fcn_checkmarks.data[a].push(a))}fcn_checkmarks.data[a]=fcn_checkmarks.data[a].filter(((a,e,c)=>c.indexOf(a)==e)),s.checkmarks.data[a]=fcn_checkmarks.data[a],s.lastLoaded=0,fcn().setUserData(s),fcn_updateCheckmarksView(),clearTimeout(fcn_userCheckmarksTimeout),fcn_userCheckmarksTimeout=setTimeout((()=>{fcn_updateCheckmarks(a,fcn_checkmarks.data[a])}),fictioneer_ajax.post_debounce_rate)}}function fcn_clickCheckmark(a){fcn_toggleCheckmark(parseInt(a.dataset.storyId),a.dataset.type,parseInt(a.dataset.id),a)}function fcn_updateCheckmarks(a,e=null){e=e||fcn().userData().checkmarks.data[a],fcn_ajaxPost({action:"fictioneer_ajax_set_checkmark",fcn_fast_ajax:1,story_id:a,update:e.join(" ")}).then((a=>{a.success||(fcn_showNotification(a.data.failure??a.data.error??fictioneer_tl.notification.error,3,"warning"),(a.data.error||a.data.failure)&&console.error("Error:",a.data.error??a.data.failure))})).catch((a=>{a.status&&a.statusText&&fcn_showNotification(`${a.status}: ${a.statusText}`,5,"warning"),console.error(a)}))}function fcn_updateCheckmarksView(){const a=fcn().userData(),e=a.checkmarks;if(!e)return;const c=parseInt(document.body.dataset.storyId);if(c){const t=e.data[c]&&e.data[c].includes(c);if(t){let t=!1;_$$("button.checkmark").forEach((a=>{const r=parseInt(a.dataset.id);e.data[c].includes(r)||(e.data[c].push(r),t=!0)})),t&&(a.checkmarks=e,fcn().setUserData(a),fcn_updateCheckmarks(c,e.data[c]))}_$$$("ribbon-read")?.classList.toggle("hidden",!t)}_$$("button.checkmark").forEach((a=>{const c=parseInt(a.dataset.storyId);if(e.data[c]){const t=e.data[c].includes(parseInt(a.dataset.id));a.classList.toggle("marked",t),a.setAttribute("aria-checked",t)}}))}document.addEventListener("fcnUserDataReady",(a=>{fcn_initializeCheckmarks(a)}));