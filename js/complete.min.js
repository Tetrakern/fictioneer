const _$=document.querySelector.bind(document),_$$=document.querySelectorAll.bind(document),_$$$=document.getElementById.bind(document),FcnUtils={userData:()=>({lastLoaded:0,timestamp:0,loggedIn:"pending",follows:!1,reminders:!1,checkmarks:!1,bookmarks:null,likes:null,fingerprint:!1,nonceHtml:"",nonce:"",isAdmin:!1,isModerator:!1,isAuthor:!1,isEditor:!1,...FcnUtils.parseJSON(localStorage.getItem("fcnUserData"))||{}}),resetUserData(){const t=FcnUtils.parseJSON(localStorage.getItem("fcnUserData"))||{};localStorage.setItem("fcnUserData",JSON.stringify({...t,lastLoaded:0,timestamp:0,loggedIn:!1,follows:!1,reminders:!1,checkmarks:!1,likes:null,bookmarks:null,fingerprint:!1,isAdmin:!1,isModerator:!1,isAuthor:!1,isEditor:!1}))},removeUserData(){localStorage.removeItem("fcnUserData")},setUserData(t){localStorage.setItem("fcnUserData",JSON.stringify(t))},loggedIn(){const t=document.cookie.split(";");for(let e=0;e<t.length;e++){if(-1!==t[e].trim().indexOf("fcnLoggedIn="))return!0}return!1},async aGet(t={},e=null,n={}){try{return await fcn_ajaxGet(t,e,n)}catch(t){throw console.error("aGet Error:",t),t}},async aPost(t={},e=null,n={}){try{return await fcn_ajaxPost(t,e,n)}catch(t){throw console.error("aPost Error:",t),t}},parseJSON(t){if(null==t||"string"!=typeof t)return null;try{return JSON.parse(t)}catch(t){return null}},copyToClipboard(t,e=!1){e=e||fictioneer_tl.notification.copiedToClipboard,navigator.clipboard&&(navigator.clipboard.writeText(t),e&&fcn_showNotification(e,2))},clamp:(t,e,n)=>Math.min(Math.max(n,t),e),offset(t){const e=t.getBoundingClientRect();return{top:e.top+window.scrollY,left:e.left+window.scrollX}},throttle(t,e,n){var a,o,s,i=null,r=0;n||(n={});var c=function(){r=!1===n.leading?0:Date.now(),i=null,s=t.apply(a,o),i||(a=o=null)};return function(){var l=Date.now();r||!1!==n.leading||(r=l);var d=e-(l-r);return a=this,o=arguments,d<=0||d>e?(i&&(clearTimeout(i),i=null),r=l,s=t.apply(a,o),i||(a=o=null)):i||!1===n.trailing||(i=setTimeout(c,d)),s}},deleteCookie(t){document.cookie=t+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/"},deleteAllCookies(){localStorage.clear(),document.cookie.split(";").forEach((t=>{document.cookie=t.replace(/^ +/,"").replace(/=.*/,"=;expires="+(new Date).toUTCString()+";path=/")}))},setCookie(t,e,n=30){const a=new Date;a.setTime(a.getTime()+24*n*60*60*1e3);const o="expires="+a.toUTCString();document.cookie=t+"="+encodeURIComponent(e)+";"+o+";SameSite=Strict;path=/"},getCookie(t){const e=t+"=",n=document.cookie.split(";");for(var a=0;a<n.length;a++){const t=n[a].trim();if(0==t.indexOf(e))return decodeURIComponent(t.substring(e.length,t.length))}return null},nonce:()=>_$$$("fictioneer-ajax-nonce")?.value??_$$$("general-fictioneer-nonce")?.value??_$('[name="fictioneer_nonce"]')?.value??0};async function fcn_ajaxPost(t={},e=null,n={}){e&&!e.startsWith("http")&&(e=FcnGlobals.restURL+e),e=e||(fictioneer_ajax.ajax_url??FcnGlobals.ajaxURL);let a={"Content-Type":"application/x-www-form-urlencoded","Cache-Control":"no-cache"};a={...a,...n},t={nonce:FcnUtils.nonce(),...t};const o=await fetch(e,{method:"POST",credentials:"same-origin",headers:a,mode:"same-origin",body:new URLSearchParams(t)});return o.ok?o.json():Promise.reject(o)}async function fcn_ajaxGet(t={},e=null,n={}){e&&!e.startsWith("http")&&(e=FcnGlobals.restURL+e),e=e||(fictioneer_ajax.ajax_url??FcnGlobals.ajaxURL),e=fcn_buildUrl(t={nonce:FcnUtils.nonce(),...t},e);let a={"Content-Type":"application/x-www-form-urlencoded","Cache-Control":"no-cache"};a={...a,...n};const o=await fetch(e,{method:"GET",credentials:"same-origin",headers:a,mode:"same-origin"});return o.ok?o.json():Promise.reject(o)}function fcn_buildUrl(t={},e=null){return e=e?new URL(e):new URL(window.location.protocol+"//"+window.location.host+window.location.pathname),t&&Object.keys(t).forEach((n=>{e.searchParams.append(n,t[n])})),e}function fcn_buildErrorNotice(t,e=!1,n=!0){console.error("Error:",t);const a=document.createElement("div");let o=t;return e&&(a.id=e),a.classList="notice _warning","object"==typeof t&&(o="",t.status&&(o=`${t.status}: `),t.statusText&&(o+=t.statusText),o||(o="Unknown error.")),a.innerHTML=`<i class="fa-solid fa-triangle-exclamation"></i><div>${n?fcn_sanitizeHTML(o):o}</div>`,a}function fcn_sanitizeHTML(t){const e=document.createElement("div");return e.innerText=t instanceof HTMLElement?t.innerHTML:t,e.textContent="string"==typeof t?t:t.textContent,e.innerHTML}function fcn_detectScreenCollision(t){const e=t.getBoundingClientRect(),n=window.innerHeight??document.documentElement.clientHeight,a=window.innerWidth??document.documentElement.clientWidth,o=(t.closest(".popup-menu-toggle")?.clientHeight??32)+16,s=n-e.bottom,i=[];return e.top<=50&&s>50+o&&i.push("top"),e.bottom>=n-50&&e.top>50+o&&i.push("bottom"),e.left<=10&&i.push("left"),e.right>=a-10&&i.push("right"),i}function fcn_scrollTo(t,e=64){window.scrollTo({top:t.getBoundingClientRect().top+window.scrollY-e,behavior:"smooth"})}function fcn_html(...t){const e=document.createElement("template");return e.innerHTML=String.raw(...t).trim(),e.content.firstChild}function fcn_isSearchEngineCrawler(){const t=navigator.userAgent.toLowerCase();return["googlebot","bingbot","slurp","duckduckbot","baiduspider","yandexbot","sogou","exabot","facebot","ia_archiver"].some((e=>t.includes(e)))}function fcn_toggleInProgress(t,e=null){(e=null!==e?e:!t.disabled)?(t.dataset.enableWith=t.innerHTML,t.innerHTML=t.dataset.disableWith??"Processing",t.disabled=!0,t.classList.add("disabled")):(t.innerHTML=t.dataset.enableWith,t.disabled=!1,t.classList.remove("disabled"))}function fcn_adjustTextarea(t){t&&(t.style.height="auto",t.style.height=`${t.scrollHeight}px`)}const FcnGlobals={eSite:_$$$("site"),urlParams:Object.fromEntries(new URLSearchParams(window.location.search).entries()),pageLoadTimestamp:Date.now(),ajaxLimitThreshold:Date.now()-parseInt(fictioneer_ajax.ttl),ajaxURL:fictioneer_ajax.ajax_url,restURL:fictioneer_ajax.rest_url,debounceRate:fictioneer_ajax.post_debounce_rate,fonts:fictioneer_fonts??[],fontColors:fictioneer_font_colors??[],commentFormSelector:fictioneer_comments?.selector??"#comment"};function fcn(){const t=window.FictioneerApp?.Controllers?.fictioneer;return t||{userData:FcnUtils.userData,setUserData:FcnUtils.setUserData,resetUserData:FcnUtils.resetUserData,removeUserData:FcnUtils.removeUserData}}function fcn_getUserData(){return fcn().userData()}function fcn_setUserData(){return fcn().setUserData()}function fcn_cleanUpWebStorage(t=!1){const e=["fcnBookshelfContent"];t||e.push("fcnChapterBookmarks"),e.forEach((t=>localStorage.removeItem(t))),fcn().resetUserData()}function fcn_cleanUpGuestView(){document.body.classList.remove("logged-in","is-admin","is-moderator","is-editor","is-author"),_$$$("fictioneer-ajax-nonce")?.remove(),_$$(".only-moderators, .only-admins, .only-authors, .only-editors, .only-logged-in").forEach((t=>{t.remove()}))}function fcn_setLoggedInState(){const t=fcn().userData();document.body.classList.toggle("logged-in",t.loggedIn),document.body.classList.toggle("is-admin",t.isAdmin),document.body.classList.toggle("is-moderator",t.isModerator),document.body.classList.toggle("is-author",t.isAuthor),document.body.classList.toggle("is-editor",t.isEditor);const e=[];t.loggedIn&&(e.push('label[for="modal-login-toggle"]'),e.push("#modal-login-toggle"),e.push("#login-modal")),t.isAdmin||(e.push(".only-admins"),t.isModerator||e.push(".only-moderators"),t.isAuthor||e.push(".only-authors"),t.isEditor||e.push(".only-editors")),_$$(e.join(", ")).forEach((t=>t.remove()))}function fcn_setAvatar(){const t=fcn().userData()?.avatarUrl;t&&_$$('[data-fictioneer-target="avatarWrapper"]').forEach((e=>{const n=document.createElement("img");n.classList.add("user-profile-image"),n.src=t,e.firstChild.remove(),e.appendChild(n)}))}Object.freeze(FcnGlobals),window.FictioneerApp=window.FictioneerApp||{},window.FictioneerApp.Controllers=window.FictioneerApp.Controllers||{},application.register("fictioneer",class extends Stimulus.Controller{static get targets(){return["avatarWrapper"]}static values={fingerprint:String,ageConfirmation:{type:Boolean,default:!1},ajaxAuth:{type:Boolean,default:!1},ajaxSubmit:{type:Boolean,default:!1},cachingActive:{type:Boolean,default:!1},publicCaching:{type:Boolean,default:!1},forceChildTheme:{type:Boolean,default:!1},editTime:{type:Number,default:15}};userReady=!1;initialize(){if(FcnUtils.loggedIn()||this.ajaxAuthValue)this.fetchUserData();else{const t=new CustomEvent("fcnUserDataReady",{detail:{data:this.userData(),time:new Date,loggedOut:!0},bubbles:!0,cancelable:!1});document.dispatchEvent(t)}}connect(){window.FictioneerApp.Controllers.fictioneer=this}userData(){return FcnUtils.userData()}setUserData(t){FcnUtils.setUserData(t)}resetUserData(){FcnUtils.resetUserData()}removeUserData(){FcnUtils.removeUserData()}fetchUserData(){let t=this.userData();if(FcnUtils.loggedIn()&&!1===t.loggedIn&&(this.removeUserData(),t=this.userData()),FcnGlobals.ajaxLimitThreshold<t.lastLoaded||!1===t.loggedIn){const e=new CustomEvent("fcnUserDataReady",{detail:{data:t,time:new Date,cached:!0},bubbles:!t.loggedIn,cancelable:t.loggedIn});return fcn_setAvatar(),t.nonceHtml&&this.#t(t.nonceHtml),document.dispatchEvent(e),void(this.userReady=!0)}FcnUtils.aGet({action:"fictioneer_ajax_get_user_data",fcn_fast_ajax:1}).then((e=>{if(e.success){let n=this.userData();n=e.data,n.lastLoaded=Date.now(),this.setUserData(n),fcn_setAvatar(),t.nonceHtml&&this.#t(t.nonceHtml);const a=new CustomEvent("fcnUserDataReady",{detail:{data:e.data,time:new Date,cached:!1},bubbles:!0,cancelable:!1});document.dispatchEvent(a)}else{const t=this.userData();t.lastLoaded=Date.now(),t.loggedIn=!1,this.setUserData(t);const n=new CustomEvent("fcnUserDataFailed",{detail:{data:e,time:new Date,cached:!1},bubbles:!0,cancelable:!1});document.dispatchEvent(n)}this.userReady=!0})).catch((t=>{localStorage.removeItem("fcnUserData");const e=new CustomEvent("fcnUserDataError",{detail:{error:t,time:new Date},bubbles:!0,cancelable:!1});document.dispatchEvent(e)}))}#t(t){_$$$("fictioneer-ajax-nonce")?.remove(),document.body.appendChild(fcn_html`${t}`)}}),"function"==typeof fcn_removeQueryArgs&&fcn_removeQueryArgs(),document.addEventListener("fcnUserDataReady",(()=>{fcn().userData().loggedIn||(fcn_cleanUpWebStorage(!0),fcn_cleanUpGuestView())})),_$("#wp-admin-bar-logout a")?.addEventListener("click",(()=>{fcn_cleanUpWebStorage()})),_$$(".subscriber-login, .oauth-login-link, [data-prepare-login]").forEach((t=>{t.addEventListener("click",(()=>{fcn().removeUserData()}))})),document.addEventListener("fcnUserDataReady",(()=>{fcn_setLoggedInState()})),document.addEventListener("fcnUserDataReady",(()=>{fcn_setAvatar()}));var fcn_animFrameEvents=new Map;function fcn_bindEventToAnimationFrame(t,e,n=window){n.addEventListener(t,(function(){fcn_animFrameEvents.get(e)||(fcn_animFrameEvents.set(e,!0),requestAnimationFrame((()=>{n.dispatchEvent(new CustomEvent(e)),fcn_animFrameEvents.set(e,!1)})))}))}function fcn_loadEmbed(t){t.target.parentNode.querySelectorAll("iframe, script")[0].src=t.target.dataset.src,t.target.parentElement.querySelector(".embed-logo")?.remove(),t.target.remove()}function fcn_appendTermMenu(t,e){const n=_$$$(`term-submenu-${t}`);if(!n)return;const a=n.content.cloneNode(!0);e.classList.add("menu-item-has-children"),e.querySelector('[href="#"]').addEventListener("click",(t=>{t.preventDefault()})),e.appendChild(a)}fcn_bindEventToAnimationFrame("scroll","scroll.rAF"),fcn_bindEventToAnimationFrame("resize","resize.rAF"),document.body.addEventListener("click",(t=>{const e=t.target.closest(".page-numbers.dots:not(button)");if(e)return void fcn_jumpPage(e);const n=t.target.closest(".spoiler");if(n)return void n.classList.toggle("_open");const a=t.target.closest("[data-click]"),o=a?.dataset.click;if(o)switch(o){case"copy-to-clipboard":a.select(),FcnUtils.copyToClipboard(a.value,a.dataset.message);break;case"reset-consent":FcnUtils.deleteCookie("fcn_cookie_consent"),location.reload();break;case"clear-cookies":FcnUtils.deleteAllCookies(),alert(a.dataset.message);break;case"logout":fcn_cleanUpWebStorage();break;case"toggle-obfuscation":a.closest("[data-obfuscation-target]").classList.toggle("_obfuscated")}})),document.body.addEventListener("change",(t=>{const e=t.target.closest('[type="checkbox"]');if(!e)return;const n=e.name,a=n?_$$(`label[for="${n}"]`):[],o=e.checked;e.closest("[aria-checked]")?.setAttribute("aria-checked",o),a.forEach((t=>{t.closest("[aria-checked]")?.setAttribute("aria-checked",o)}))})),_$$(".iframe-consent, .twitter-consent").forEach((t=>{t.onclick=t=>{fcn_loadEmbed(t)}})),document.addEventListener("DOMContentLoaded",(()=>{const t=_$("#menu-navigation > .menu-item"),e=_$$$("full-navigation");t&&e&&t.offsetHeight<e.offsetHeight&&e.classList.add("_oversized-navigation"),_$$(".main-navigation .trigger-term-menu-categories").forEach((t=>{fcn_appendTermMenu("category",t)})),_$$(".main-navigation .trigger-term-menu-tags").forEach((t=>{fcn_appendTermMenu("post_tag",t)})),_$$(".main-navigation .trigger-term-menu-genres").forEach((t=>{fcn_appendTermMenu("fcn_genre",t)})),_$$(".main-navigation .trigger-term-menu-fandoms").forEach((t=>{fcn_appendTermMenu("fcn_fandom",t)})),_$$(".main-navigation .trigger-term-menu-characters").forEach((t=>{fcn_appendTermMenu("fcn_character",t)})),_$$(".main-navigation .trigger-term-menu-warnings").forEach((t=>{fcn_appendTermMenu("fcn_content_warning",t)}))})),_$$$("full-navigation")?.addEventListener("mouseover",(()=>{document.dispatchEvent(new CustomEvent("fcnRemoveLastClicked"))}));var fcn_lastScrollTop=0;function fcn_scrollDirection(){if(FcnGlobals.eSite.classList.contains("transformed-scroll"))return;const t="hidden"!==window.getComputedStyle(document.documentElement).overflow?window.scrollY??document.documentElement.scrollTop:document.body.scrollTop??1;document.body.classList.toggle("scrolled-to-top",0===t),t>fcn_lastScrollTop&&Math.abs(fcn_lastScrollTop-t)>=10?(document.body.classList.add("scrolling-down"),document.body.classList.remove("scrolling-up"),fcn_lastScrollTop=Math.max(t,0)):t<fcn_lastScrollTop&&Math.abs(fcn_lastScrollTop-t)>=50&&(document.body.classList.add("scrolling-up"),document.body.classList.remove("scrolling-down"),fcn_lastScrollTop=Math.max(t,0))}function fcn_observe(t,e,n={}){const a=_$(t);if(!a)return null;new IntersectionObserver((t=>e(t[0])),n).observe(a)}function fcn_dragElement(t){const e=t.querySelector(".drag-anchor")??t;let n,a;function o(e){e.preventDefault(),t.style.top=t.offsetTop-(a-e.clientY)+"px",t.style.left=t.offsetLeft-(n-e.clientX)+"px",n=e.clientX,a=e.clientY}function s(){e.onmouseup=null,e.onmousemove=null}e.onmousedown=function(t){t.preventDefault(),n=t.clientX,a=t.clientY,e.onmousemove=o,e.onmouseup=s}}function fcn_showNotification(t,e=3,n="base"){const a=_$("#notifications"),o=document.createElement("div");o.innerHTML=t,o.classList.add("notifications__message",`_${n}`),o.style.opacity=1,o.style.transitionDelay=`${e}s`,a.prepend(o),o.addEventListener("transitionend",(t=>{"opacity"===t.propertyName&&a.removeChild(t.target)})),o.addEventListener("click",(t=>{a.removeChild(t.currentTarget)})),setTimeout((()=>{o.style.opacity=0}),100)}if(window.addEventListener("scroll.rAF",FcnUtils.throttle(fcn_scrollDirection,200)),fcn_scrollDirection(),document.addEventListener("DOMContentLoaded",(()=>{fcn_observe(".main-observer",(t=>{document.body.classList.toggle("is-inside-main",t.intersectionRatio<1&&t.boundingClientRect.top<=0)}),{threshold:[1]}),fcn_observe(".chapter-end",(t=>{document.body.classList.toggle("is-end-of-chapter",t.isIntersecting||t.boundingClientRect.top<0)}),{root:null,threshold:0}),fcn_observe("#nav-observer-sticky",(t=>{_$$$("full-navigation").classList.toggle("is-sticky",t.intersectionRatio<1)}),{threshold:[1]})})),_$$(".modal__header.drag-anchor").forEach((t=>{fcn_dragElement(t.closest(".modal__wrapper"))})),FcnGlobals.urlParams){switch(FcnGlobals.urlParams.failure&&console.error("Failure:",FcnGlobals.urlParams.failure),FcnGlobals.urlParams.failure){case"oauth_email_taken":fcn_showNotification(fictioneer_tl.notification.oauthEmailTaken,5,"warning");break;case"oauth_already_linked":fcn_showNotification(fictioneer_tl.notification.oauthAccountAlreadyLinked,5,"warning")}if("oauth_new"===FcnGlobals.urlParams.success)fcn_showNotification(fictioneer_tl.notification.oauthNew,10);else FcnGlobals.urlParams.success?.startsWith("oauth_merged_")&&fcn_showNotification(fictioneer_tl.notification.oauthAccountLinked,3,"success");if(FcnGlobals.urlParams["fictioneer-notice"]){let t="1"===FcnGlobals.urlParams.failure?"warning":"base";t="1"===FcnGlobals.urlParams.success?"success":t,fcn_showNotification(fcn_sanitizeHTML(FcnGlobals.urlParams["fictioneer-notice"]),3,t)}}function fcn_updateThemeColor(t=!1){const e=fcn_siteSettings.darken?fcn_siteSettings.darken:0,n=fcn_siteSettings.saturation?fcn_siteSettings.saturation:0,a=fcn_siteSettings["hue-rotate"]?fcn_siteSettings["hue-rotate"]:0,o=e>=0?1+e**2:1-e**2,s=n>=0?1+n**2:1-n**2;let i=getComputedStyle(document.documentElement).getPropertyValue("--theme-color-base").trim().split(" ");i=`hsl(${(parseInt(i[0])+a)%360}deg ${(parseInt(i[1])*s).toFixed(2)}% ${(parseInt(i[2])*o).toFixed(2)}%)`,_$("meta[name=theme-color]").setAttribute("content",t||i)}const fcn_settingMinimal=_$$$("site-setting-minimal"),fcn_settingChapterProgressBar=_$$$("site-setting-chapter-progress-bar"),fcn_settingHueRotateRange=_$$$("site-setting-hue-rotate-range"),fcn_settingHueRotateText=_$$$("site-setting-hue-rotate-text"),fcn_settingHueRotateReset=_$$$("site-setting-hue-rotate-reset"),fcn_settingDarkenRanges=_$$(".setting-darken-range"),fcn_settingDarkenTexts=_$$(".setting-darken-text"),fcn_settingDarkenResets=_$$(".setting-darken-reset"),fcn_settingSaturationRanges=_$$(".setting-saturation-range"),fcn_settingSaturationTexts=_$$(".setting-saturation-text"),fcn_settingSaturationResets=_$$(".setting-saturation-reset"),fcn_settingFontLightnessRanges=_$$(".setting-font-lightness-range"),fcn_settingFontLightnessTexts=_$$(".setting-font-lightness-text"),fcn_settingFontLightnessResets=_$$(".setting-font-lightness-reset"),fcn_settingEvents=["nav-sticky","background-textures","polygons","covers","taxonomies","text-shadows","minimal","chapter-progress-bar"];var fcn_siteSettings=fcn_getSiteSettings();function fcn_updateSiteSetting(t,e,n){t.checked=n,fcn_siteSettings[e]=n,fcn_applySiteSettings(fcn_siteSettings)}function fcn_toggleLightMode(){fcn_setLightMode(!(localStorage.getItem("fcnLightmode")?"true"==localStorage.getItem("fcnLightmode"):"light"==document.documentElement.dataset.modeDefault))}function fcn_setLightMode(t,e=!1){localStorage.setItem("fcnLightmode",t),document.documentElement.dataset.mode=t?"light":"dark",_$$(".toggle-light-mode").forEach((e=>{e.closest("[aria-checked]")?.setAttribute("aria-checked",t)})),e||fcn_updateThemeColor()}function fcn_updateFontWeight(){const t="default"!=fcn_siteSettings["font-weight"];_$$(".site-setting-font-weight").forEach((t=>{t.value=fcn_siteSettings["font-weight"]})),_$$(".font-weight-reset").forEach((e=>{e.classList.toggle("_modified",t)}))}function fcn_resetFontWeight(){fcn_siteSettings["font-weight"]="default",document.documentElement.dataset.fontWeight="default",fcn_applySiteSettings(fcn_siteSettings)}function fcn_updateHueRotate(t){t=FcnUtils.clamp(0,360,t??0),fcn_settingHueRotateText.value=t,fcn_settingHueRotateRange.value=t,fcn_settingHueRotateReset.classList.toggle("_modified",0!=t),document.documentElement.style.setProperty("--hue-rotate",`(${t}deg + var(--hue-offset))`),fcn_siteSettings["hue-rotate"]=t,fcn_setSiteSettings(),fcn_updateThemeColor()}function fcn_setHueRotate(){fcn_updateHueRotate(this.value)}function fcn_updateDarken(t=null){t=FcnUtils.clamp(-1,1,t??fcn_siteSettings.darken),t=Math.round(100*(t+Number.EPSILON))/100,fcn_settingDarkenResets.forEach((e=>{e.classList.toggle("_modified",0!=t)})),fcn_settingDarkenRanges.forEach((e=>{e.value=t})),fcn_settingDarkenTexts.forEach((e=>{e.value=parseInt(100*t)}));const e=t>=0?1+t**2:1-t**2;document.documentElement.style.setProperty("--darken",`(${e} + var(--lightness-offset))`),fcn_siteSettings.darken=t,fcn_setSiteSettings(),fcn_updateThemeColor()}function fcn_setDarkenFromRange(){fcn_updateDarken(this.value)}function fcn_setDarkenFromText(){"-"!=this.value&&""!=this.value&&fcn_updateDarken((parseInt(this.value)??0)/100)}function fcn_updateSaturation(t=null){t=FcnUtils.clamp(-1,1,t??fcn_siteSettings.saturation),fcn_settingSaturationResets.forEach((e=>{e.classList.toggle("_modified",0!=t)})),fcn_settingSaturationRanges.forEach((e=>{e.value=t})),fcn_settingSaturationTexts.forEach((e=>{e.value=parseInt(100*t)}));const e=t>=0?1+t**2:1-t**2;document.documentElement.style.setProperty("--saturation",`(${e} + var(--saturation-offset))`),fcn_siteSettings.saturation=t,fcn_setSiteSettings(),fcn_updateThemeColor()}function fcn_setSaturationFromRange(){fcn_updateSaturation(this.value)}function fcn_setSaturationFromText(){"-"!=this.value&&""!=this.value&&fcn_updateSaturation((parseInt(this.value)??0)/100)}function fcn_updateFontLightness(t=null){t=FcnUtils.clamp(-1,1,t??fcn_siteSettings["font-lightness"]??1),fcn_settingFontLightnessResets.forEach((e=>{e.classList.toggle("_modified",0!=t)})),fcn_settingFontLightnessRanges.forEach((e=>{e.value=t})),fcn_settingFontLightnessTexts.forEach((e=>{e.value=parseInt(100*t)}));const e=t>=0?1+t**2:1-t**2;document.documentElement.style.setProperty("--font-lightness",`(${e} + var(--font-lightness-offset))`),fcn_siteSettings["font-lightness"]=t,fcn_setSiteSettings(),fcn_updateThemeColor()}function fcn_setFontLightnessFromRange(){fcn_updateFontLightness(this.value)}function fcn_setFontLightnessFromText(){"-"!=this.value&&""!=this.value&&fcn_updateFontLightness((parseInt(this.value)??0)/100)}function fcn_defaultSiteSettings(){return{"nav-sticky":!0,"background-textures":!0,polygons:!0,covers:!0,taxonomies:!0,"text-shadows":!1,minimal:!1,"chapter-progress-bar":!0,"site-theme":"default","font-weight":"default",darken:0,saturation:0,"font-saturation":0,"font-lightness":0,"hue-rotate":0}}function fcn_getSiteSettings(){const t=FcnUtils.parseJSON(localStorage.getItem("fcnSiteSettings"))??fcn_defaultSiteSettings();return fcn_setSiteSettings(t),t}function fcn_setSiteSettings(t=null){"object"==typeof(t=t||fcn_siteSettings)&&(fcn_siteSettings=t,localStorage.setItem("fcnSiteSettings",JSON.stringify(t)))}function fcn_applySiteSettings(t){t="object"!=typeof t?fcn_defaultSiteSettings():t,Object.entries(t).forEach((t=>{const e=_$$$(`site-setting-${t[0]}`);switch(e&&(e.checked=t[1]),t[0]){case"minimal":document.documentElement.classList.toggle("minimal",t[1]);break;case"darken":fcn_updateDarken();break;case"saturation":fcn_updateSaturation();break;case"font-saturation":break;case"font-lightness":fcn_updateFontLightness();break;case"hue-rotate":fcn_updateHueRotate(t[1]);break;case"font-weight":fcn_updateFontWeight();break;default:document.documentElement.classList.toggle(`no-${t[0]}`,!t[1])}})),fcn_setSiteSettings(t)}function fcn_updateSiteTheme(t){fcn_siteSettings["site-theme"]=t,document.documentElement.dataset.theme=t,_$$$("site-setting-theme-reset").classList.toggle("_modified","default"!=t),fcn_applySiteSettings(fcn_siteSettings),fcn_updateThemeColor()}function fcn_resetSiteTheme(){fcn_updateSiteTheme("default"),_$$(".site-setting-site-theme").forEach((t=>{t.value="default"}))}function fcn_jumpPage(t){if(document.documentElement.dataset.disablePageJump)return;const e=parseInt(window.prompt(fictioneer_tl.notification.enterPageNumber));if(e>0){const n=t.nextElementSibling.getAttribute("href"),a=["page=","paged=","comment-page-","pg="];for(const t of a)if(n.includes(t))return void(window.location.href=n.replace(new RegExp(`${t}\\d+`),t+e));window.location.href=n.replace(/page\/\d+/,`page/${e}`)}}function fcn_revealCommentImage(t){const e=t.parentElement.querySelector("img");e.src=e.dataset.src,t.remove()}function fcn_contactFormSubmit(t){const e=t.closest("form"),n=new FormData(e),a={action:"fictioneer_ajax_submit_contact_form"};if(e.reportValidity()&&(t.disabled=!0,t.innerHTML=t.dataset.disabled,!(Date.now()<FcnGlobals.pageLoadTimestamp+3e3))){for(const[t,e]of n)a[t]=e;e.classList.add("ajax-in-progress"),FcnUtils.aPost(a).then((n=>{n.success?(e.querySelector("textarea").value="",t.innerHTML=t.dataset.done,fcn_showNotification(n.data.success,3,"success")):n.data.failure&&(t.disabled=!1,t.innerHTML=t.dataset.enabled,fcn_showNotification(n.data.failure,5,"warning"))})).catch((e=>{e.status&&e.statusText&&(fcn_showNotification(`${e.status}: ${e.statusText}`,5,"warning"),t.disabled=!1,t.innerHTML=t.dataset.enabled),console.error(e)})).then((()=>{e.classList.remove("ajax-in-progress")}))}}fcn_settingEvents.forEach((t=>{_$$$(`site-setting-${t}`)?.addEventListener("change",(e=>{fcn_updateSiteSetting(e.currentTarget,t,e.currentTarget.checked)}))})),fcn_setLightMode(localStorage.getItem("fcnLightmode")?"true"==localStorage.getItem("fcnLightmode"):"light"==document.documentElement.dataset.modeDefault,!0),_$$(".toggle-light-mode").forEach((t=>{t.onclick=()=>fcn_toggleLightMode()})),_$$(".font-weight-reset").forEach((t=>{t.addEventListener("click",fcn_resetFontWeight)})),_$$(".site-setting-font-weight").forEach((t=>{t.onchange=t=>{fcn_siteSettings["font-weight"]=t.target.value,document.documentElement.dataset.fontWeight=t.target.value,fcn_applySiteSettings(fcn_siteSettings),fcn_updateFontWeight()}})),fcn_settingHueRotateReset?.addEventListener("click",(()=>{fcn_updateHueRotate(0)})),fcn_settingHueRotateRange?.addEventListener("input",FcnUtils.throttle(fcn_setHueRotate,1e3/24)),fcn_settingHueRotateText?.addEventListener("input",fcn_setHueRotate),fcn_settingDarkenResets.forEach((t=>{t.addEventListener("click",(()=>{fcn_updateDarken(0)}))})),fcn_settingDarkenRanges.forEach((t=>{t.addEventListener("input",FcnUtils.throttle(fcn_setDarkenFromRange,1e3/24))})),fcn_settingDarkenTexts.forEach((t=>{t.addEventListener("input",fcn_setDarkenFromText)})),fcn_settingSaturationResets.forEach((t=>{t.addEventListener("click",(()=>{fcn_updateSaturation(0)}))})),fcn_settingSaturationRanges.forEach((t=>{t.addEventListener("input",FcnUtils.throttle(fcn_setSaturationFromRange,1e3/24))})),fcn_settingSaturationTexts.forEach((t=>{t.addEventListener("input",fcn_setSaturationFromText)})),fcn_settingFontLightnessResets.forEach((t=>{t.addEventListener("click",(()=>{fcn_updateFontLightness(0)}))})),fcn_settingFontLightnessRanges.forEach((t=>{t.addEventListener("input",FcnUtils.throttle(fcn_setFontLightnessFromRange,1e3/24))})),fcn_settingFontLightnessTexts.forEach((t=>{t.addEventListener("input",fcn_setFontLightnessFromText)})),fcn_applySiteSettings(fcn_siteSettings),_$$(".site-setting-site-theme").forEach((t=>{t.value=fcn_siteSettings["site-theme"]?fcn_siteSettings["site-theme"]:"default",_$$$("site-setting-theme-reset").classList.toggle("_modified","default"!=t.value),t.addEventListener("change",(t=>{fcn_updateSiteTheme(t.target.value)}))})),_$$$("site-setting-theme-reset")?.addEventListener("click",fcn_resetSiteTheme),fcn_updateThemeColor(),_$$(".chapter-group__name").forEach((t=>{t.addEventListener("click",(t=>{const e=t.currentTarget.closest(".chapter-group"),n=e.querySelector(".chapter-group__list"),a=!e.classList.contains("_closed");_$(".main__background")?.classList.add("will-change"),n.style.height=`${n.scrollHeight}px`,requestAnimationFrame((()=>{requestAnimationFrame((()=>{e.classList.toggle("_closed",a),n.style.height=a?"0":`${n.scrollHeight}px`}))}))}))})),_$$(".chapter-group__list").forEach((t=>{t.addEventListener("transitionend",(e=>{t.style.height="",t.querySelectorAll("a, button, label, input:not([hidden])").forEach((e=>{e.tabIndex=t.parentElement.classList.contains("_closed")?"-1":"0"})),_$(".main__background")?.classList.remove("will-change")}))})),_$(".fictioneer-comments")?.addEventListener("click",(t=>{t.target?.classList.contains("consent-button")&&fcn_revealCommentImage(t.target)})),_$$(".fcn-contact-form").forEach((t=>{t.querySelector(".fcn-contact-form__submit").addEventListener("click",(t=>{fcn_contactFormSubmit(t.currentTarget)}))})),_$$(".modal-toggle").forEach((t=>{t.addEventListener("change",(t=>{const e=_$$$(t.currentTarget.dataset.target);e.classList.toggle("_open",t.currentTarget.checked),e.hidden=!t.currentTarget.checked;const n=e.querySelector(".close");n?.focus(),n?.blur()}))})),document.body.querySelectorAll(".modal-toggle").forEach((t=>{t.addEventListener("change",(t=>{if(t.currentTarget.checked){const e=t.currentTarget.nextElementSibling.querySelector('[tabindex="0"]');e?.focus(),e?.blur()}else document.body.classList.contains("user-is-tabbing")&&FcnGlobals.eSite.querySelector(`label[for="${t.currentTarget.id}"]`)?.focus()}))})),_$$('[data-click-action*="open-dialog-modal"]').forEach((t=>{t.addEventListener("click",(t=>{document.querySelector(t.currentTarget.dataset.clickTarget).showModal()}))})),_$$('[data-click-action*="close-dialog-modal"], button[formmethod="dialog"][value="cancel"]').forEach((t=>{t.addEventListener("click",(t=>{t.preventDefault(),t.target.closest("dialog").close()}))})),_$$("dialog").forEach((t=>{t.addEventListener("mousedown",(e=>{if(e.target===e.currentTarget){const n=t.getBoundingClientRect();(e.clientX<n.left||e.clientX>n.right||e.clientY<n.top||e.clientY>n.bottom)&&(e.preventDefault(),e.target.close())}}))})),_$$(".content-section").forEach((t=>{t.addEventListener("click",(t=>{if(t.target.closest('[data-click-action*="open-tooltip-modal"]')&&!window.getSelection().toString()){const e=_$$$("fictioneer-tooltip-dialog"),n=t.target.dataset.dialogHeader,a=t.target.dataset.dialogContent;a.length>200?e.style.setProperty("--modal-width","400px"):e.style.removeProperty("--modal-width"),n&&(e.querySelector('[data-finder="tooltip-dialog-header"]').innerHTML=n),e.querySelector('[data-finder="tooltip-dialog-content"]').innerHTML=a,e.showModal()}}))})),document.body.addEventListener("keydown",(t=>{let e=document.activeElement.closest('[tabindex="0"]:not(a, input, button, select)');if(["BUTTON","A","INPUT","SELECT"].includes(document.activeElement.tagName)&&(e=null),e&&(" "!==t.key&&"Enter"!==t.key||(t.preventDefault(),e.click())),"Escape"===t.key){_$$(".modal-toggle:checked").forEach((t=>{t.checked=!1,t.dispatchEvent(new Event("change"))}));const t=_$(".lightbox.show");if(t)return void t.querySelector(".lightbox__close").click();const e=_$(".selected-paragraph #button-close-paragraph-tools");if(e)return void e.click();const n=_$("#tts-interface:not(.hidden)");if(n){if(n.classList.contains("playing")){const t=_$$$("button-tts-pause");t?.click(),t?.focus(),t?.blur()}else _$$$("button-tts-stop").click();return}}}));class FCN_KeywordInput{constructor(t){this.input=t,this.type=t.dataset.type,this.operator=t.closest(".keyword-input").querySelector(".keyword-input__operator input"),this.inputWrapper=t.closest(".keyword-input__input-wrapper"),this.block=t.closest(".keyword-input"),this.form=this.block.closest(".search-form"),this.collection=this.block.querySelector(".keyword-input__collection"),this.suggestionList=this.block.querySelector(".keyword-input__suggestion-list"),this.tabSuggestion=this.block.querySelector(".keyword-input__tab-suggestion"),this.allowText=this.form.querySelector(".allow-list")?.innerText??"{}",this.allowList=FcnUtils.parseJSON(this.allowText),this.hints=this.block.querySelector(".keyword-input__hints"),this.noHint=this.block.querySelector(".keyword-input__no-suggestions"),this.keywords=this.collection.value.length>0?this.collection.value.split(","):[],this.bindEvents(),this.resize(),this.filterSuggestions()}resize(){const t=this.tabSuggestion.innerText.length>0?this.tabSuggestion.innerText.length:this.input.value.length;this.input.style.width=.88*t+2+"ch"}reset(){this.keywords=[],this.block.querySelectorAll(".node").forEach((t=>{t.remove()})),this.block.querySelectorAll(".keyword-input__operator > input").forEach((t=>{t.checked=!1})),this.input.value="",this.updateCollection(),
this.filterSuggestions(),this.resize()}encode(t){const e=(new TextEncoder).encode(t.toLowerCase());return btoa(String.fromCharCode.apply(null,e))}filterSuggestions(){const t=this.input.value.toLowerCase();let e=0,n="";""==t?this.suggestionList.querySelectorAll(".keyword-button").forEach((t=>{t.hidden=!0})):this.suggestionList.querySelectorAll(".keyword-button").forEach((a=>{const o=a.innerText.toLowerCase();o.includes(t)&&this.keywords.indexOf(o)<0?(a.hidden=!1,e++,""==n&&o.startsWith(t)&&(n=o)):a.hidden=!0})),this.hints.querySelectorAll(".keyword-button").forEach((t=>{this.keywords.indexOf(t.value.toLowerCase())>-1?t.hidden=!0:t.hidden=!1})),this.tabSuggestion.innerHTML=n,this.hints.hidden=!(""==t),this.noHint.hidden=!(""!=t&&e<1)}addNode(t=null,e=null){const n=t??this.input.value.replace(",","");let a=this.allowList[`${this.type}_${this.encode(n)}`];if("authors"!=this.collection.name&&"ex_authors"!=this.collection.name||!e||(a=this.allowList[`${this.type}_${this.encode(n)}_${e.value}`]),!a||this.keywords.indexOf(a)>-1)return;this.keywords.push(a);const o=document.createElement("div");o.innerHTML=`<span class="node-name">${n}</span><span class="node-delete"><i class="fa-solid fa-xmark"></i></span>`,o.classList.add("node"),o.dataset.value=a,this.inputWrapper.parentNode.insertBefore(o,this.inputWrapper),this.input.value="",this.updateCollection(),this.filterSuggestions(),this.resize()}removeNodeByValue(t){this.block.querySelector(`[data-value="${t}"]`)?.remove(),this.keywords=this.keywords.filter((e=>e!=t)),this.updateCollection(),this.filterSuggestions(),this.resize()}updateCollection(){this.collection.value=this.keywords.join(","),this.block.classList.toggle("_empty",""===this.collection.value),this.form.querySelector(".search-form__current").innerHTML=""}bindEvents(){this.input.addEventListener("input",(t=>{t.currentTarget.value.includes(",")&&this.addNode(),this.block.classList.toggle("_empty",""===t.currentTarget.value&&""===this.collection.value),this.filterSuggestions(),this.resize()})),this.input.addEventListener("keydown",(t=>{"Tab"!==t.key&&"Enter"!==t.key||""!=this.tabSuggestion.innerText&&(t.preventDefault(),this.input.value=this.tabSuggestion.innerText,this.addNode()),"Escape"===t.key&&(this.input.value="",this.tabSuggestion.innerHTML="",document.activeElement.blur()),"Backspace"===t.key&&""==this.input.value&&this.keywords.length>0&&this.removeNodeByValue(this.keywords.slice(-1))})),this.input.addEventListener("blur",(()=>{const t=this.allowList[this.encode(this.input.value)];this.blurTimeout=t?setTimeout((()=>{this.addNode()}),150):setTimeout((()=>{this.input.value="",this.tabSuggestion.innerHTML="",this.filterSuggestions(),this.resize()}),150)})),this.block.addEventListener("click",(t=>{t.target.closest(".node-delete")&&(t.preventDefault(),this.removeNodeByValue(t.target.closest(".node").dataset.value))})),this.block.querySelectorAll(".keyword-button").forEach((t=>{t.addEventListener("click",(t=>{clearTimeout(this.blurTimeout),this.addNode(t.currentTarget.innerText,t.currentTarget)}))}))}}function fcn_resetSearchForm(t,e,n){n.forEach((t=>t.reset())),e.querySelectorAll("input, select").forEach((t=>{t.value=t.dataset.default??t.value})),e.querySelector(".search-form__current").innerHTML="",fcn_showNotification(t.dataset.reset,2)}function fcn_handleTabInput(t){"Tab"==t.key&&(document.body.classList.add("user-is-tabbing"),window.removeEventListener("keydown",fcn_handleTabInput),window.addEventListener("mousedown",fcn_handleMouseInput))}function fcn_handleMouseInput(){document.body.classList.remove("user-is-tabbing"),window.removeEventListener("mousedown",fcn_handleMouseInput),window.addEventListener("keydown",fcn_handleTabInput)}function fcn_popupPosition(){_$$(".popup-menu-toggle.last-clicked .popup-menu:not(._fixed-position)").forEach((t=>{if("none"===window.getComputedStyle(t).display)return;const e=fcn_detectScreenCollision(t);e&&0===e.length||(e.includes("top")?(t.classList.remove("_top"),t.classList.add("_bottom")):e.includes("bottom")&&(t.classList.remove("_bottom"),t.classList.add("_top")),t.closest("._fixed-horizontal")||(e.includes("left")?(t.classList.remove("_center","_justify-right"),t.classList.add("_justify-left")):e.includes("right")&&(t.classList.remove("_center","_justify-left"),t.classList.add("_justify-right"))))}))}function fcn_markCurrentMenuItem(){_$$(`.menu-item > [data-nav-object-id="${document.body.dataset.postId}"]`).forEach((t=>{t.setAttribute("aria-current","page"),t.closest(".menu-item").classList.add("current-menu-item")}))}function fcn_showAgeConfirmationModal(){const t=_$(".story__article, .chapter__article")?.dataset.ageRating;if(!document.documentElement.dataset.ageConfirmation&&t&&"adult"!==t)return void _$$$("age-confirmation-modal")?.remove();const e=_$$$("age-confirmation-leave");document.documentElement.classList.add("age-modal-open"),_$$$("age-confirmation-modal").classList.add("_open"),_$$$("age-confirmation-confirm")?.addEventListener("click",(t=>{document.documentElement.classList.remove("age-modal-open"),t.currentTarget.closest(".modal").remove(),localStorage.setItem("fcnAgeConfirmation","1")})),e?.addEventListener("click",(()=>{window.location.href=e.dataset.redirect??"https://search.brave.com/",localStorage.removeItem("fcnAgeConfirmation")}))}function fcn_showLightbox(t){const e=_$$$("fictioneer-lightbox"),n=_$(".lightbox__content");let a=!1,o=null;if(n.innerHTML="",t.classList.add("lightbox-last-trigger"),"IMG"==t.tagName?(o=t.cloneNode(),a=!0):t.href&&(o=document.createElement("img"),o.src=t.href,a=!0),a&&o){["class","style","height","width"].forEach((t=>o.removeAttribute(t))),n.appendChild(o),e.classList.add("show");const t=e.querySelector(".lightbox__close");t?.focus(),t?.blur()}}function fcn_toggleMobileMenu(t){_$(".mobile-menu._advanced-mobile-menu")?fcn_toggleAdvancedMobileMenu(t):fcn_toggleSimpleMobileMenu(t)}function fcn_toggleSimpleMobileMenu(t){t?(document.body.classList.add("mobile-menu-open","scrolling-down"),document.body.classList.remove("scrolling-up")):(document.body.classList.remove("mobile-menu-open"),fcn_closeMobileFrames(),fcn_openMobileFrame("main"),_$$$("mobile-menu-toggle").checked=!1)}function fcn_toggleAdvancedMobileMenu(t){const e=_$$$("wpadminbar")?.offsetHeight??0,n=window.scrollY,a=FcnGlobals.eSite.scrollTop;t?(document.body.classList.add("mobile-menu-open","scrolling-down","scrolled-to-top"),document.body.classList.remove("scrolling-up"),FcnGlobals.eSite.classList.add("transformed-scroll","transformed-site"),FcnGlobals.eSite.scrollTop=n-e,fcn_updateThemeColor()):(FcnGlobals.eSite.classList.remove("transformed-site","transformed-scroll"),document.body.classList.remove("mobile-menu-open"),fcn_updateThemeColor(),fcn_closeMobileFrames(),fcn_openMobileFrame("main"),document.documentElement.style.scrollBehavior="auto",window.scroll(0,a+e),document.documentElement.style.scrollBehavior="",_$$$("mobile-menu-toggle").checked=!1,"function"==typeof fcn_trackProgress&&fcn_trackProgress())}function fcn_setupMobileJumpButton(t,e){const n=_$(t);n&&n.addEventListener("click",(()=>{fcn_toggleMobileMenu(!1),setTimeout((()=>{const t=e();t&&fcn_scrollTo(t)}),200)}))}function fcn_openMobileFrame(t){fcn_closeMobileFrames(),_$(`.mobile-menu__frame[data-frame="${t}"]`)?.classList.add("_active")}function fcn_closeMobileFrames(){_$$(".mobile-menu__frame._active").forEach((t=>{t.classList.remove("_active")}));const t=_$(".mobile-menu__bookmarks-panel");t&&(t.dataset.editing="false")}_$$(".search-form").forEach((t=>{if(t.classList.contains("_simple"))return;const e=[];t.querySelectorAll(".keyword-input__input").forEach((t=>{e.push(new FCN_KeywordInput(t))})),t.querySelector(".allow-list")?.remove(),t.addEventListener("change",(e=>{e.target.classList.contains("search-form__advanced-control")||e.target.classList.contains("search-form__string")||(t.querySelector(".search-form__current").innerHTML="")})),t.querySelectorAll(".reset").forEach((n=>{n.addEventListener("click",(()=>{fcn_resetSearchForm(n,t,e)}))}))})),_$$(".search-form__advanced-toggle").forEach((t=>{t.addEventListener("click",(t=>{const e=t.currentTarget.closest("form");e.dataset.advanced="true"==e.dataset.advanced?"false":"true"}))})),window.addEventListener("keydown",fcn_handleTabInput),window.addEventListener("scroll.rAF",FcnUtils.throttle(fcn_popupPosition,250)),document.body.addEventListener("click",(t=>{const e=t.target.closest("[href]"),n=e?.getAttribute("href");if(!e||"A"===!e.tagName||!n.startsWith("#")||n.length<2||"#respond"===n)return;const a=n.replace("#",""),o=_$$(`[name="${a}"], [id="${a}"]`)[0],s=e.closest(".comment._story-comment");s&&(window.location.href=s.querySelector(".fictioneer-comment__link").href+n),o&&(t.preventDefault(),o.scrollIntoView({behavior:"smooth",block:e.dataset?.block??"start"}))})),fcn_markCurrentMenuItem(),_$$$("age-confirmation-modal")&&"1"!==localStorage.getItem("fcnAgeConfirmation")&&!fcn_isSearchEngineCrawler()?setTimeout((()=>{fcn_showAgeConfirmationModal()}),2500):_$$$("age-confirmation-modal")?.remove(),document.addEventListener("DOMContentLoaded",(()=>{_$$(".splide:not(.no-auto-splide, .is-initialized)").forEach((t=>{t.querySelector(".splide__list")&&"undefined"!=typeof Splide&&(t.classList.remove("_splide-placeholder"),new Splide(t).mount())})),_$$(".temp-script, .splide-placeholder-styles").forEach((t=>{t.remove()}))})),application.register("fictioneer-large-card",class extends Stimulus.Controller{static get targets(){return["controls","menu"]}static values={postId:Number,storyId:Number,chapterId:Number};menOpen=!1;ready=!1;paused=!1;initialize(){fcn()?.userReady?this.ready=!0:document.addEventListener("fcnUserDataReady",(()=>{this.#e(),this.ready=!0,this.#n()}))}connect(){if(this.ready&&(this.#e(),this.#n()),document.addEventListener("click",(t=>{t.target.closest(`.card.post-${this.postIdValue}`)||this.#a()})),document.addEventListener("toggledLastClick",(t=>{this.#o(t.detail.target,t.detail.force)})),this.hasMenuTarget)for(this.menuFragment=document.createDocumentFragment();this.menuTarget.firstChild;)this.menuFragment.appendChild(this.menuTarget.firstChild)}disconnect(){this.#s()}isFollowed(){return this.#i()&&!!this.#r()?.follows?.data?.[this.storyIdValue]}isRemembered(){return this.#i()&&!!this.#r()?.reminders?.data?.[this.storyIdValue]}isRead(){if(!this.#i())return!1;const t=this.#r()?.checkmarks?.data?.[this.storyIdValue];return!!t&&(t.includes(this.chapterIdValue)||t.includes(this.storyIdValue))}cardClick(t){t.target.closest(".card__controls")||this.#c()}toggleMenu(){this.menuTarget.querySelector("*")?this.#c():this.#l()}toggleFollow(){this.#i()?(fcn_toggleFollow(this.storyIdValue,!this.isFollowed()),this.#d()):_$$$("modal-login-toggle")?.click()}toggleReminder(){this.#i()?(fcn_toggleReminder(this.storyIdValue,!this.isRemembered()),this.#f()):_$$$("modal-login-toggle")?.click()}toggleCheckmarks(t="toggle",e){this.#i()?(fcn_toggleCheckmark(this.storyIdValue,e,this.chapterIdValue,null,t),this.#h()):_$$$("modal-login-toggle")?.click()}setCheckmarks(t){this.toggleCheckmarks("set",t.params?.type??"story")}unsetCheckmarks(t){this.toggleCheckmarks("unset",t.params?.type??"story")}#u=null;#m=0;#i(){const t=Date.now();return null!==this.#u&&t-this.#m<20||(this.#u=FcnUtils.loggedIn(),this.#m=t,this.#u||(this.#s(),this.ready=!1,this.paused=!0)),this.#u}#r(){return this.userData=fcn().userData(),this.userData}#g(){return this.#i()&&JSON.stringify(this.userData)!==JSON.stringify(this.#r())}#_(){this.refreshInterval||(this.refreshInterval=setInterval((()=>{!this.paused&&this.#g()&&this.#e()}),3e4+1e4*Math.random()))}#n(){this.#_(),this.visibilityStateCheck=()=>{this.#i()&&("visible"===document.visibilityState?(this.paused=!1,this.#e(),this.#_()):(this.paused=!0,clearInterval(this.refreshInterval),this.refreshInterval=null))},document.addEventListener("visibilitychange",this.visibilityStateCheck)}#s(){clearInterval(this.refreshInterval),document.removeEventListener("visibilitychange",this.visibilityStateCheck)}#e(){this.#d(),this.#f(),this.#h()}#d(){this.element.classList.toggle("has-follow",this.isFollowed())}#f(){this.element.classList.toggle("has-reminder",this.isRemembered())}#h(){this.element.classList.toggle("has-checkmark",this.isRead())}#a(){this.#c()}#l(){this.menOpen=!0,this.menuTarget.appendChild(this.menuFragment.cloneNode(!0))}#c(){if(this.menOpen)for(this.menOpen=!1;this.menuTarget.firstChild;)this.menuTarget.removeChild(this.menuTarget.firstChild)}#o(t,e){e?t&&!t.closest(`.card.post-${this.postIdValue}`)&&this.menOpen&&this.#c():this.#c()}}),application.register("fictioneer-last-click",class extends Stimulus.Controller{static get targets(){return["toggle"]}last=null;connect(){document.addEventListener("fcnRemoveLastClicked",(()=>{this.last&&this.removeLastClick()}))}removeAll(){this.last&&(this.#p(this.last,!1),this.removeLastClick())}toggle(t){const e=t.target.closest('[data-fictioneer-last-click-target="toggle"]');if(!e||["BUTTON","A","INPUT","SELECT"].includes(t.target.tagName)&&!t.target.hasAttribute("data-fictioneer-last-click-target"))return;const n=!e.classList.contains("last-clicked");"function"==typeof fcn_popupPosition&&fcn_popupPosition(),e.classList.toggle("last-clicked",n),e.closest(".watch-last-clicked")?.classList.toggle("has-last-clicked",n),this.last&&this.last!=e&&this.removeLastClick(),this.last=e,this.#p(e,n),t.stopPropagation()}removeLastClick(){this.last&&(this.last.closest(".watch-last-clicked")?.classList.remove("has-last-clicked"),this.last.classList.remove("last-clicked"),this.last=null,document.activeElement?.blur())}#p(t,e){document.dispatchEvent(new CustomEvent("toggledLastClick",{detail:{target:t,force:e}}))}}),document.body.addEventListener("click",(t=>{const e=t.target.closest("[data-lightbox]:not(.no-auto-lightbox)");e&&(t.preventDefault(),fcn_showLightbox(e))})),document.body.addEventListener("keydown",(t=>{const e=t.target.closest("[data-lightbox]:not(.no-auto-lightbox)");e&&(" "!==t.key&&"Enter"!==t.key||(t.preventDefault(),fcn_showLightbox(e)))})),document.querySelectorAll(".lightbox__close, .lightbox").forEach((t=>{t.addEventListener("click",(t=>{if("IMG"!=t.target.tagName){_$$$("fictioneer-lightbox").classList.remove("show");const t=_$(".lightbox-last-trigger");t?.focus(),t?.blur(),t?.classList.remove("lightbox-last-trigger")}}))})),_$$$("mobile-menu-toggle")?.addEventListener("change",(t=>{fcn_toggleMobileMenu(t.currentTarget.checked)})),FcnGlobals.eSite.addEventListener("click",(t=>{document.body.classList.contains("mobile-menu-open")&&(t.preventDefault(),fcn_toggleMobileMenu(!1))})),fcn_setupMobileJumpButton("#mobile-menu-comment-jump",(()=>_$$$("comments"))),fcn_setupMobileJumpButton("#mobile-menu-bookmark-jump",(()=>_$(`[data-paragraph-id="${fcn_bookmarks.data[_$("article").id]["paragraph-id"]}"]`))),_$$(".button-change-lightness").forEach((t=>{t.addEventListener("click",(t=>{fcn_updateDarken(fcn_siteSettings.darken+parseFloat(t.currentTarget.value))}))})),_$$(".mobile-menu__frame-button").forEach((t=>{t.addEventListener("click",(t=>{fcn_openMobileFrame(t.currentTarget.dataset.frameTarget)}))})),_$$(".mobile-menu__back-button").forEach((t=>{t.addEventListener("click",(()=>{fcn_openMobileFrame("main")}))})),_$$$("button-mobile-menu-toggle-bookmarks-edit")?.addEventListener("click",(t=>{const e=t.currentTarget.closest(".mobile-menu__bookmarks-panel");e.dataset.editing="false"==e.dataset.editing?"true":"false"})),_$('.mobile-menu__frame-button[data-frame-target="bookmarks"]')?.addEventListener("click",(()=>{fcn_setMobileMenuBookmarks()}),{once:!0});const fcn_consentBanner=_$$$("consent-banner");function fcn_loadConsentBanner(){fcn_consentBanner.classList.remove("hidden"),fcn_consentBanner.hidden=!1,_$$$("consent-accept-button")?.addEventListener("click",(()=>{FcnUtils.setCookie("fcn_cookie_consent","full"),fcn_consentBanner.classList.add("hidden"),fcn_consentBanner.hidden=!0})),_$$$("consent-reject-button")?.addEventListener("click",(()=>{FcnUtils.setCookie("fcn_cookie_consent","necessary"),fcn_consentBanner.classList.add("hidden"),fcn_consentBanner.hidden=!0}))}fcn_consentBanner&&""===(FcnUtils.getCookie("fcn_cookie_consent")??"")&&!fcn_isSearchEngineCrawler()?setTimeout((()=>{fcn_loadConsentBanner()}),4e3):fcn_consentBanner.remove();const fcn_chapterFormatting=_$(".chapter-formatting");var fcn_formatting=fcn_getFormatting();const fcn_paragraphTools=_$$$("paragraph-tools");var fcn_lastSelectedParagraphId,fcn_bookmarkColor="none";function fcn_toggleParagraphTools(t=!1,e=null){e&&e.classList.contains("spoiler")&&!e.classList.contains("_open")||(_$$$(`paragraph-${fcn_lastSelectedParagraphId}`)?.classList.remove("selected-paragraph"),t&&fcn_formatting["show-paragraph-tools"]?(fcn_lastSelectedParagraphId=t,e.classList.add("selected-paragraph"),e.classList.contains("is-wrapped")||(e.innerHTML=`<span class="paragraph-inner">${e.innerHTML}</span>`,e.classList.add("is-wrapped")),e.append(fcn_paragraphTools)):fcn_lastSelectedParagraphId=null)}function fcn_touchParagraph(t){if(t.target.classList.contains("spoiler")||t.target.closest(".popup-menu-toggle, .skip-tools, a, button, label, input, textarea")||!t.target.closest("p")?.textContent.trim().length)return;if(!t.target.closest("p")?.parentElement?.classList.contains("chapter-formatting"))return;if(t.target.closest(".hidden, .inside-epub"))return;if(""!=window.getSelection().toString())return;const e=t.target.closest("p[data-paragraph-id]");if(t.target.closest(".tts-interface, .paragraph-tools__actions"))return;if(!e)return void fcn_toggleParagraphTools(!1);let n=!!e.dataset.paragraphId&&e.dataset.paragraphId;n=n!=fcn_lastSelectedParagraphId&&n;const a=(new Date).getTime();e.addEventListener("mouseup",(()=>{(new Date).getTime()<=a+300&&fcn_toggleParagraphTools(n,e)}),{once:!0})}function fcn_cleanTextSelectionFromButtons(t){return t=(t=(t=(t=(t=(t=t.replace(/[\r\n]{2,}/g,"__$__")).replace(new RegExp("(__Bookmark|__Quote|__Link)","g"),"")).replace(new RegExp("(__Bookmark|__Quote|__TTS|__Link)","g"),"")).replace(new RegExp("(__Bookmark|__Quote|__Suggestion|__TTS|__Link)","g"),"")).replace(new RegExp("(__Bookmark|__Quote|__Suggestion|__Link)","g"),"")).replace(/[__$]{1,}/g,"\n\n").replace(/^[\r\n]+|[\r\n]+$/g,"")}function fcn_getQuote(t){const e=fcn_cleanTextSelectionFromButtons(window.getSelection().toString()),n=`[anchor]${t.target.closest("p[data-paragraph-id]").id}[/anchor]`;let a=t.target.closest("p[data-paragraph-id]").querySelector(".paragraph-inner").innerText,o="[] ",s=" []";if(a.length>16&&e.replace(/\s/g,"").length){const t=Math.ceil(.25*e.length),n=a.substring(0,t+1),i=a.substring(a.length-t,a.length);e.startsWith(n)&&(o=""),e.endsWith(i)&&(s=""),a=`${o}${e}${s}`}a=`${a} ${n}`,fcn_addQuoteToStack(a),fcn_showNotification(fictioneer_tl.notification.quoteAppendedToComment)}function fcn_addQuoteToStack(t){const e=_$(FcnGlobals.commentFormSelector);e?"TEXTAREA"==e.tagName?(e.value+=`\n[quote]${t}[/quote]\n`,fcn_adjustTextarea(_$("textarea#comment"))):"DIV"==e.tagName&&(e.innerHTML+=`\n[quote]${t}[/quote]\n`):fcn_commentStack?.push(`\n[quote]${t}[/quote]\n`)}function fcn_openFullscreen(){document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen()}function fcn_closeFullscreen(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}function fcn_getFormatting(){let t=FcnUtils.parseJSON(localStorage.getItem("fcnChapterFormatting"))??fcn_defaultFormatting();return Object.keys(t).length<15&&(t=fcn_defaultFormatting()),t.timestamp<1651164557584&&(t=fcn_defaultFormatting(),t.timestamp=Date.now()),fcn_setFormatting(t),t}function fcn_defaultFormatting(){return{"font-saturation":0,"font-color":FcnGlobals.fontColors[0].css,"font-name":FcnGlobals.fonts[0].css,"font-size":100,"letter-spacing":0,"line-height":1.7,"paragraph-spacing":1.5,"site-width":document.documentElement.dataset.siteWidthDefault??"960",indent:!0,"show-sensitive-content":!0,"show-chapter-notes":!0,justify:!1,"show-comments":!0,"show-paragraph-tools":!0,timestamp:1664797604825,...FcnUtils.parseJSON(document.documentElement.dataset.defaultFormatting??"{}")}}function fcn_setFormatting(t){"object"==typeof t&&(fcn_formatting=t,localStorage.setItem("fcnChapterFormatting",JSON.stringify(t)))}function fcn_updateToggle(t,e,n,a={}){a={save:!0,...a};const o=Boolean(t),s=_$(e);if(s&&(s.checked=o,s.closest("label").setAttribute("aria-checked",o)),a.toggleClass&&fcn_chapterFormatting.classList.toggle(a.toggleClass,a.invertClass?!o:o),a.sensitiveContent){const t=_$$$("inline-sensitive-content-toggle");t?.classList.toggle("hide-sensitive",!o),t?.setAttribute("aria-checked",!o)}a.notes&&_$$(".chapter-note-hideable").forEach((t=>{t.classList.toggle("hidden",!o)})),a.comments&&_$$(".chapter-comments-hideable").forEach((t=>{t.classList.toggle("hidden",!o)})),fcn_formatting[n]=o,a.save&&fcn_setFormatting(fcn_formatting)}document.addEventListener("click",(t=>{fcn_paragraphTools?.closest("p")?.contains(t.target)||fcn_toggleParagraphTools(!1)})),fcn_paragraphTools&&(document.addEventListener("mousedown",(t=>{fcn_touchParagraph(t)})),_$$$("button-close-paragraph-tools").onclick=t=>{fcn_toggleParagraphTools(!1)},_$$$("button-get-link").onclick=t=>{FcnUtils.copyToClipboard(`${location.protocol}//${location.host}${location.pathname}#${t.target.closest("p[data-paragraph-id]").id}`,fictioneer_tl.notification.linkCopiedToClipboard)},_$$$("button-comment-stack")?.addEventListener("click",(t=>{fcn_getQuote(t)})),_$$(".paragraph-tools__bookmark-colors > div").forEach((t=>{t.onclick=t=>{fcn_bookmarkColor=t.target.dataset.color}})),_$$$("button-set-bookmark")?.addEventListener("click",(t=>{fcn_toggleBookmark(t.target.closest("p[data-paragraph-id]").dataset.paragraphId,fcn_bookmarkColor),window.matchMedia("(min-width: 1024px)").matches&&fcn_toggleParagraphTools(!1),fcn_bookmarkColor="none"}))),_$$(".open-fullscreen").forEach((t=>{t.addEventListener("click",(()=>{fcn_openFullscreen()}))})),_$$(".close-fullscreen").forEach((t=>{t.addEventListener("click",(()=>{fcn_closeFullscreen()}))})),(()=>{"use strict";const t=_$$$("reader-settings-font-size-text"),e=_$$$("reader-settings-font-size-range"),n=_$$$("reader-settings-font-size-reset");function a(a,o=!0){a=FcnUtils.clamp(50,200,a??100),t.value=a,e.value=a,n.classList.toggle("_modified",100!=a),_$$(".resize-font").forEach((t=>{t.style.fontSize=`${a}%`})),fcn_formatting["font-size"]=a,o&&fcn_setFormatting(fcn_formatting)}function o(){a(this.value)}function s(){a(parseFloat(fcn_formatting["font-size"])+parseFloat(this.dataset.modifier))}n&&(_$$$("reset-font")?.addEventListener("click",(()=>{a(100)})),n?.addEventListener("click",(()=>{a(100)})),e?.addEventListener("input",FcnUtils.throttle(o,1e3/24)),t?.addEventListener("input",o),_$$$("increase-font")?.addEventListener("click",s),_$$$("decrease-font")?.addEventListener("click",s),a(fcn_formatting["font-size"],!1))})(),(()=>{"use strict";const t=_$$$("reader-settings-font-color-reset"),e=_$$$("reader-settings-font-color-select");function n(n,a=!0){n=FcnUtils.clamp(0,FcnGlobals.fontColors.length-1,n),t.classList.toggle("_modified",n>0),e.value=n,fcn_chapterFormatting.style.setProperty("--text-chapter",FcnGlobals.fontColors[n].css),fcn_formatting["font-color"]=FcnGlobals.fontColors[n].css,a&&fcn_setFormatting(fcn_formatting)}t&&(t.onclick=()=>{n(0)},e.onchange=t=>{n(t.target.value)},_$$(".font-color-stepper").forEach((t=>{t.addEventListener("click",(t=>{!function(t=1){let a=(e.selectedIndex+parseInt(t))%FcnGlobals.fontColors.length;a=a<0?FcnGlobals.fontColors.length-1:a,n(a)}(t.currentTarget.value)}))})),n(FcnGlobals.fontColors.findIndex((t=>t.css==fcn_formatting["font-color"])),!1))})(),(()=>{"use strict";const t=_$$$("reader-settings-font-reset"),e=_$$$("reader-settings-font-select");function n(a,o=!0){a=FcnUtils.clamp(0,FcnGlobals.fonts.length-1,a);let s=FcnGlobals.fonts[a].css;FcnGlobals.fonts[a].alt&&(s=`${s}, ${FcnGlobals.fonts[a].alt}`),a<0?n(0):(t.classList.toggle("_modified",a>0),e.value=a,_$$(".chapter-font-family").forEach((t=>{t.style.fontFamily=""===s?"var(--ff-system)":s+", var(--ff-system)"})),fcn_formatting["font-name"]=FcnGlobals.fonts[a].css,o&&fcn_setFormatting(fcn_formatting))}t&&(t.onclick=()=>{n(0)},e.onchange=t=>{n(t.target.value)},_$$(".font-stepper").forEach((t=>{t.addEventListener("click",(t=>{!function(t=1){let a=(e.selectedIndex+parseInt(t))%FcnGlobals.fonts.length;a=a<0?FcnGlobals.fonts.length-1:a,n(a)}(t.currentTarget.value)}))})),n(FcnGlobals.fonts.findIndex((t=>t.css==fcn_formatting["font-name"])),!1))})(),(()=>{"use strict";const t=_$$$("reader-settings-font-saturation-text"),e=_$$$("reader-settings-font-saturation-range"),n=_$$$("reader-settings-font-saturation-reset");function a(a,o=!0){a=FcnUtils.clamp(-1,1,a??0),t.value=parseInt(100*a),e.value=a,n.classList.toggle("_modified",0!=a),fcn_chapterFormatting.style.setProperty("--font-saturation",`(${a>=0?1+a**2:1-a**2} + var(--font-saturation-offset))`),fcn_formatting["font-saturation"]=a,o&&fcn_setFormatting(fcn_formatting)}n&&(n?.addEventListener("click",(()=>{a(0)})),e?.addEventListener("input",FcnUtils.throttle((function(){a(this.value)}),1e3/24)),t?.addEventListener("input",(function(){a(parseInt(this.value)/100)})),a(fcn_formatting["font-saturation"],!1))})(),(()=>{"use strict";const t=_$$$("reader-settings-letter-spacing-text"),e=_$$$("reader-settings-letter-spacing-range"),n=_$$$("reader-settings-letter-spacing-reset"),a=fcn_defaultFormatting()["letter-spacing"];function o(o,s=!0){o=FcnUtils.clamp(-.1,.2,o??a),t.value=o,e.value=o,n.classList.toggle("_modified",o!=a),fcn_chapterFormatting.style.letterSpacing=`calc(${o}em + var(--font-letter-spacing-base))`,fcn_formatting["letter-spacing"]=o,s&&fcn_setFormatting(fcn_formatting)}function s(){o(this.value)}n&&(n?.addEventListener("click",(()=>{o(a)})),e?.addEventListener("input",FcnUtils.throttle(s,1e3/24)),t?.addEventListener("input",s),o(fcn_formatting["letter-spacing"],!1))})(),(()=>{"use strict";const t=_$$$("reader-settings-paragraph-spacing-text"),e=_$$$("reader-settings-paragraph-spacing-range"),n=_$$$("reader-settings-paragraph-spacing-reset"),a=fcn_defaultFormatting()["paragraph-spacing"];function o(o,s=!0){o=FcnUtils.clamp(0,3,o??a),t.value=o,e.value=o,n.classList.toggle("_modified",o!=a),fcn_chapterFormatting.style.setProperty("--paragraph-spacing",`${o}em`),fcn_formatting["paragraph-spacing"]=o,s&&fcn_setFormatting(fcn_formatting)}function s(){o(this.value)}n&&(n?.addEventListener("click",(()=>{o(a)})),e?.addEventListener("input",FcnUtils.throttle(s,1e3/24)),t?.addEventListener("input",s),o(fcn_formatting["paragraph-spacing"],!1))})(),(()=>{"use strict";const t=_$$$("reader-settings-line-height-text"),e=_$$$("reader-settings-line-height-range"),n=_$$$("reader-settings-line-height-reset"),a=fcn_defaultFormatting()["line-height"];function o(o,s=!0){o=FcnUtils.clamp(.8,3,o??a),t.value=o,e.value=o,n.classList.toggle("_modified",o!=a),fcn_chapterFormatting.style.lineHeight=`${o}`,fcn_formatting["line-height"]=o,s&&fcn_setFormatting(fcn_formatting)}function s(){o(this.value)}n&&(n?.addEventListener("click",(()=>{o(a)})),e?.addEventListener("input",FcnUtils.throttle(s,1e3/24)),t?.addEventListener("input",s),o(fcn_formatting["line-height"],!1))})(),(()=>{"use strict";const t=_$$$("reader-settings-site-width-text"),e=_$$$("reader-settings-site-width-range"),n=_$$$("reader-settings-site-width-reset"),a=fcn_defaultFormatting()["site-width"];function o(o,s=!0){const i=_$("main");o=FcnUtils.clamp(640,1920,o??a),t.value=o,e.value=o,n.classList.toggle("_modified",o!=a),i.style.setProperty("--site-width",`${o}px`),i.classList.toggle("_default-width",o==document.documentElement.dataset.siteWidthDefault),i.classList.toggle("_below-1024",o<1024&&o>=768),i.classList.toggle("_below-768",o<768&&o>640),i.classList.toggle("_640-and-below",o<=640),fcn_formatting["site-width"]=o,s&&fcn_setFormatting(fcn_formatting)}function s(){o(this.value)}n&&(n?.addEventListener("click",(()=>{o(a)})),e?.addEventListener("input",FcnUtils.throttle(s,1e3/24)),t?.addEventListener("input",s),o(fcn_formatting["site-width"],!1))})(),_$$("#reader-settings-indent-toggle").forEach((t=>{const e={invertClass:!0,toggleClass:"no-indent"},n="indent";t.onclick=a=>{fcn_updateToggle(a.currentTarget.checked,`#${t.id}`,n,e)},fcn_updateToggle(fcn_formatting[n],`#${t.id}`,n,{save:!1,...e})})),_$$("#reader-settings-justify-toggle").forEach((t=>{const e={toggleClass:"justify"},n="justify";t.onclick=a=>{fcn_updateToggle(a.currentTarget.checked,`#${t.id}`,n,e)},fcn_updateToggle(fcn_formatting[n],`#${t.id}`,n,{save:!1,...e})})),_$$("#reader-settings-paragraph-tools-toggle").forEach((t=>{const e="show-paragraph-tools";t.onclick=n=>{fcn_updateToggle(n.currentTarget.checked,`#${t.id}`,e)},fcn_updateToggle(fcn_formatting[e],`#${t.id}`,e,{save:!1})})),_$$("#reader-settings-chapter-notes-toggle").forEach((t=>{const e={notes:!0},n="show-chapter-notes";t.onclick=a=>{fcn_updateToggle(a.currentTarget.checked,`#${t.id}`,n,e)},fcn_updateToggle(fcn_formatting[n],`#${t.id}`,n,{save:!1,...e})})),_$$("#reader-settings-comments-toggle").forEach((t=>{const e={comments:!0},n="show-comments";t.onclick=a=>{fcn_updateToggle(a.currentTarget.checked,`#${t.id}`,n,e)},fcn_updateToggle(fcn_formatting[n],`#${t.id}`,n,{save:!1,...e})})),_$$("#reader-settings-sensitive-content-toggle").forEach((t=>{const e={toggleClass:"hide-sensitive",invertClass:!0,sensitiveContent:!0},n="show-sensitive-content";t.onclick=a=>{fcn_updateToggle(a.currentTarget.checked,`#${t.id}`,n,e)},fcn_updateToggle(fcn_formatting[n],`#${t.id}`,n,{save:!1,...e})}));const fcn_progressBar=_$(".progress__bar"),fcn_chapterContent=_$$$("chapter-content");var fcn_chapterCheckmarkUpdated=!1;function fcn_trackProgress(){fcn_chapterContent&&(fcn_readingProgress(),window.addEventListener("scroll.rAF",FcnUtils.throttle(fcn_readingProgress,1e3/48)))}function fcn_readingProgress(){if(fcn_settingMinimal.checked||!fcn_settingChapterProgressBar.checked)return;const t=fcn_chapterContent.getBoundingClientRect(),e=t.height,n=window.innerHeight,a=e-t.bottom-Math.max(t.top,0)+n;let o=100*a/e;if(document.body.classList.toggle("hasProgressBar",!(o<0||a>e+500)),o=FcnUtils.clamp(0,100,o),fcn_progressBar.style.width=`${o}%`,o>=100&&!fcn_chapterCheckmarkUpdated&&FcnUtils.loggedIn()){const t=document.body.dataset.storyId;if(fcn_chapterCheckmarkUpdated=!0,!t||"function"!=typeof fcn_toggleCheckmark)return;fcn_toggleCheckmark(t,"progress",parseInt(document.body.dataset.postId),null,"set")}}_$("article:not(._password)")&&fcn_trackProgress(),_$('[data-click-action*="toggle-chapter-index-order"]')?.addEventListener("click",(t=>{const e=t.currentTarget.closest(".chapter-index");e.dataset.order="asc"===e.dataset.order?"desc":"asc"})),document.addEventListener("DOMContentLoaded",(()=>{const t=_$(".chapter-index"),e=t.closest("dialog").dataset.postId??0;t&&t.querySelector(`[data-id="${e}"]`)?.classList.add("current")}));const fcn_chapterKeyboardNavigation=t=>{if(["INPUT","TEXTAREA","SELECT","OPTION"].includes(t.target.tagName)||t.target.isContentEditable)return;let e=null;"ArrowLeft"===t.code?e=_$("a.button._navigation._prev"):"ArrowRight"===t.code&&(e=_$("a.button._navigation._next")),e&&e.href&&(window.location.href=e+"#start")};if(document.addEventListener("keydown",fcn_chapterKeyboardNavigation),"#start"===window.location.hash){history.replaceState(null,document.title,window.location.pathname);const t=_$(".chapter__article");t&&fcn_scrollTo(t,128)}var diff_match_patch=function(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32},DIFF_DELETE=-1,DIFF_INSERT=1,DIFF_EQUAL=0;diff_match_patch.Diff=function(t,e){this[0]=t,this[1]=e},diff_match_patch.Diff.prototype.length=2,diff_match_patch.Diff.prototype.toString=function(){
return this[0]+","+this[1]},diff_match_patch.prototype.diff_main=function(t,e,n,a){if(void 0===a&&(a=0>=this.Diff_Timeout?Number.MAX_VALUE:(new Date).getTime()+1e3*this.Diff_Timeout),null==t||null==e)throw Error("Null input. (diff_main)");if(t==e)return t?[new diff_match_patch.Diff(DIFF_EQUAL,t)]:[];void 0===n&&(n=!0);var o=n,s=this.diff_commonPrefix(t,e);n=t.substring(0,s),t=t.substring(s),e=e.substring(s),s=this.diff_commonSuffix(t,e);var i=t.substring(t.length-s);return t=t.substring(0,t.length-s),e=e.substring(0,e.length-s),t=this.diff_compute_(t,e,o,a),n&&t.unshift(new diff_match_patch.Diff(DIFF_EQUAL,n)),i&&t.push(new diff_match_patch.Diff(DIFF_EQUAL,i)),this.diff_cleanupMerge(t),t},diff_match_patch.prototype.diff_compute_=function(t,e,n,a){if(!t)return[new diff_match_patch.Diff(DIFF_INSERT,e)];if(!e)return[new diff_match_patch.Diff(DIFF_DELETE,t)];var o=t.length>e.length?t:e,s=t.length>e.length?e:t,i=o.indexOf(s);return-1!=i?(n=[new diff_match_patch.Diff(DIFF_INSERT,o.substring(0,i)),new diff_match_patch.Diff(DIFF_EQUAL,s),new diff_match_patch.Diff(DIFF_INSERT,o.substring(i+s.length))],t.length>e.length&&(n[0][0]=n[2][0]=DIFF_DELETE),n):1==s.length?[new diff_match_patch.Diff(DIFF_DELETE,t),new diff_match_patch.Diff(DIFF_INSERT,e)]:(o=this.diff_halfMatch_(t,e))?(e=o[1],s=o[3],t=o[4],o=this.diff_main(o[0],o[2],n,a),n=this.diff_main(e,s,n,a),o.concat([new diff_match_patch.Diff(DIFF_EQUAL,t)],n)):n&&100<t.length&&100<e.length?this.diff_lineMode_(t,e,a):this.diff_bisect_(t,e,a)},diff_match_patch.prototype.diff_lineMode_=function(t,e,n){var a=this.diff_linesToChars_(t,e);t=a.chars1,e=a.chars2,a=a.lineArray,t=this.diff_main(t,e,!1,n),this.diff_charsToLines_(t,a),this.diff_cleanupSemantic(t),t.push(new diff_match_patch.Diff(DIFF_EQUAL,""));for(var o=a=e=0,s="",i="";e<t.length;){switch(t[e][0]){case DIFF_INSERT:o++,i+=t[e][1];break;case DIFF_DELETE:a++,s+=t[e][1];break;case DIFF_EQUAL:if(1<=a&&1<=o){for(t.splice(e-a-o,a+o),e=e-a-o,o=(a=this.diff_main(s,i,!1,n)).length-1;0<=o;o--)t.splice(e,0,a[o]);e+=a.length}a=o=0,i=s=""}e++}return t.pop(),t},diff_match_patch.prototype.diff_bisect_=function(t,e,n){for(var a=t.length,o=e.length,s=Math.ceil((a+o)/2),i=2*s,r=Array(i),c=Array(i),l=0;l<i;l++)r[l]=-1,c[l]=-1;r[s+1]=0,c[s+1]=0;for(var d=0!=(l=a-o)%2,f=0,h=0,u=0,m=0,g=0;g<s&&!((new Date).getTime()>n);g++){for(var _=-g+f;_<=g-h;_+=2){for(var p=s+_,k=_==-g||_!=g&&r[p-1]<r[p+1]?r[p+1]:r[p-1]+1,b=k-_;k<a&&b<o&&t.charAt(k)==e.charAt(b);)k++,b++;if(r[p]=k,k>a)h+=2;else if(b>o)f+=2;else if(d&&(0<=(p=s+l-_)&&p<i&&-1!=c[p])){var v=a-c[p];if(k>=v)return this.diff_bisectSplit_(t,e,k,b,n)}}for(_=-g+u;_<=g-m;_+=2){for(p=s+_,k=(v=_==-g||_!=g&&c[p-1]<c[p+1]?c[p+1]:c[p-1]+1)-_;v<a&&k<o&&t.charAt(a-v-1)==e.charAt(o-k-1);)v++,k++;if(c[p]=v,v>a)m+=2;else if(k>o)u+=2;else if(!d&&(0<=(p=s+l-_)&&p<i&&-1!=r[p]&&(b=s+(k=r[p])-p,k>=(v=a-v))))return this.diff_bisectSplit_(t,e,k,b,n)}}return[new diff_match_patch.Diff(DIFF_DELETE,t),new diff_match_patch.Diff(DIFF_INSERT,e)]},diff_match_patch.prototype.diff_bisectSplit_=function(t,e,n,a,o){var s=t.substring(0,n),i=e.substring(0,a);return t=t.substring(n),e=e.substring(a),s=this.diff_main(s,i,!1,o),o=this.diff_main(t,e,!1,o),s.concat(o)},diff_match_patch.prototype.diff_linesToChars_=function(t,e){function n(t){for(var e="",n=0,i=-1,r=a.length;i<t.length-1;){-1==(i=t.indexOf("\n",n))&&(i=t.length-1);var c=t.substring(n,i+1);void 0!==o[c]?e+=String.fromCharCode(o[c]):(r==s&&(c=t.substring(n),i=t.length),e+=String.fromCharCode(r),o[c]=r,a[r++]=c),n=i+1}return e}var a=[],o={};a[0]="";var s=4e4,i=n(t);return s=65535,{chars1:i,chars2:n(e),lineArray:a}},diff_match_patch.prototype.diff_charsToLines_=function(t,e){for(var n=0;n<t.length;n++){for(var a=t[n][1],o=[],s=0;s<a.length;s++)o[s]=e[a.charCodeAt(s)];t[n][1]=o.join("")}},diff_match_patch.prototype.diff_commonPrefix=function(t,e){if(!t||!e||t.charAt(0)!=e.charAt(0))return 0;for(var n=0,a=Math.min(t.length,e.length),o=a,s=0;n<o;)t.substring(s,o)==e.substring(s,o)?s=n=o:a=o,o=Math.floor((a-n)/2+n);return o},diff_match_patch.prototype.diff_commonSuffix=function(t,e){if(!t||!e||t.charAt(t.length-1)!=e.charAt(e.length-1))return 0;for(var n=0,a=Math.min(t.length,e.length),o=a,s=0;n<o;)t.substring(t.length-o,t.length-s)==e.substring(e.length-o,e.length-s)?s=n=o:a=o,o=Math.floor((a-n)/2+n);return o},diff_match_patch.prototype.diff_commonOverlap_=function(t,e){var n=t.length,a=e.length;if(0==n||0==a)return 0;if(n>a?t=t.substring(n-a):n<a&&(e=e.substring(0,n)),n=Math.min(n,a),t==e)return n;a=0;for(var o=1;;){var s=t.substring(n-o);if(-1==(s=e.indexOf(s)))return a;o+=s,0!=s&&t.substring(n-o)!=e.substring(0,o)||(a=o,o++)}},diff_match_patch.prototype.diff_halfMatch_=function(t,e){function n(t,e,n){for(var a,o,i,r,c=t.substring(n,n+Math.floor(t.length/4)),l=-1,d="";-1!=(l=e.indexOf(c,l+1));){var f=s.diff_commonPrefix(t.substring(n),e.substring(l)),h=s.diff_commonSuffix(t.substring(0,n),e.substring(0,l));d.length<h+f&&(d=e.substring(l-h,l)+e.substring(l,l+f),a=t.substring(0,n-h),o=t.substring(n+f),i=e.substring(0,l-h),r=e.substring(l+f))}return 2*d.length>=t.length?[a,o,i,r,d]:null}if(0>=this.Diff_Timeout)return null;var a=t.length>e.length?t:e,o=t.length>e.length?e:t;if(4>a.length||2*o.length<a.length)return null;var s=this,i=n(a,o,Math.ceil(a.length/4));if(a=n(a,o,Math.ceil(a.length/2)),!i&&!a)return null;if(i=a?i&&i[4].length>a[4].length?i:a:i,t.length>e.length){a=i[0],o=i[1];var r=i[2],c=i[3]}else r=i[0],c=i[1],a=i[2],o=i[3];return[a,o,r,c,i[4]]},diff_match_patch.prototype.diff_cleanupSemantic=function(t){for(var e=!1,n=[],a=0,o=null,s=0,i=0,r=0,c=0,l=0;s<t.length;)t[s][0]==DIFF_EQUAL?(n[a++]=s,i=c,r=l,l=c=0,o=t[s][1]):(t[s][0]==DIFF_INSERT?c+=t[s][1].length:l+=t[s][1].length,o&&o.length<=Math.max(i,r)&&o.length<=Math.max(c,l)&&(t.splice(n[a-1],0,new diff_match_patch.Diff(DIFF_DELETE,o)),t[n[a-1]+1][0]=DIFF_INSERT,a--,s=0<--a?n[a-1]:-1,l=c=r=i=0,o=null,e=!0)),s++;for(e&&this.diff_cleanupMerge(t),this.diff_cleanupSemanticLossless(t),s=1;s<t.length;)t[s-1][0]==DIFF_DELETE&&t[s][0]==DIFF_INSERT&&(e=t[s-1][1],n=t[s][1],(a=this.diff_commonOverlap_(e,n))>=(o=this.diff_commonOverlap_(n,e))?(a>=e.length/2||a>=n.length/2)&&(t.splice(s,0,new diff_match_patch.Diff(DIFF_EQUAL,n.substring(0,a))),t[s-1][1]=e.substring(0,e.length-a),t[s+1][1]=n.substring(a),s++):(o>=e.length/2||o>=n.length/2)&&(t.splice(s,0,new diff_match_patch.Diff(DIFF_EQUAL,e.substring(0,o))),t[s-1][0]=DIFF_INSERT,t[s-1][1]=n.substring(0,n.length-o),t[s+1][0]=DIFF_DELETE,t[s+1][1]=e.substring(o),s++),s++),s++},diff_match_patch.prototype.diff_cleanupSemanticLossless=function(t){function e(t,e){if(!t||!e)return 6;var n=t.charAt(t.length-1),a=e.charAt(0),o=n.match(diff_match_patch.nonAlphaNumericRegex_),s=a.match(diff_match_patch.nonAlphaNumericRegex_),i=o&&n.match(diff_match_patch.whitespaceRegex_),r=s&&a.match(diff_match_patch.whitespaceRegex_);n=i&&n.match(diff_match_patch.linebreakRegex_),a=r&&a.match(diff_match_patch.linebreakRegex_);var c=n&&t.match(diff_match_patch.blanklineEndRegex_),l=a&&e.match(diff_match_patch.blanklineStartRegex_);return c||l?5:n||a?4:o&&!i&&r?3:i||r?2:o||s?1:0}for(var n=1;n<t.length-1;){if(t[n-1][0]==DIFF_EQUAL&&t[n+1][0]==DIFF_EQUAL){var a=t[n-1][1],o=t[n][1],s=t[n+1][1],i=this.diff_commonSuffix(a,o);if(i){var r=o.substring(o.length-i);a=a.substring(0,a.length-i),o=r+o.substring(0,o.length-i),s=r+s}i=a,r=o;for(var c=s,l=e(a,o)+e(o,s);o.charAt(0)===s.charAt(0);){a+=o.charAt(0),o=o.substring(1)+s.charAt(0),s=s.substring(1);var d=e(a,o)+e(o,s);d>=l&&(l=d,i=a,r=o,c=s)}t[n-1][1]!=i&&(i?t[n-1][1]=i:(t.splice(n-1,1),n--),t[n][1]=r,c?t[n+1][1]=c:(t.splice(n+1,1),n--))}n++}},diff_match_patch.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,diff_match_patch.whitespaceRegex_=/\s/,diff_match_patch.linebreakRegex_=/[\r\n]/,diff_match_patch.blanklineEndRegex_=/\n\r?\n$/,diff_match_patch.blanklineStartRegex_=/^\r?\n\r?\n/,diff_match_patch.prototype.diff_cleanupEfficiency=function(t){for(var e=!1,n=[],a=0,o=null,s=0,i=!1,r=!1,c=!1,l=!1;s<t.length;)t[s][0]==DIFF_EQUAL?(t[s][1].length<this.Diff_EditCost&&(c||l)?(n[a++]=s,i=c,r=l,o=t[s][1]):(a=0,o=null),c=l=!1):(t[s][0]==DIFF_DELETE?l=!0:c=!0,o&&(i&&r&&c&&l||o.length<this.Diff_EditCost/2&&3==i+r+c+l)&&(t.splice(n[a-1],0,new diff_match_patch.Diff(DIFF_DELETE,o)),t[n[a-1]+1][0]=DIFF_INSERT,a--,o=null,i&&r?(c=l=!0,a=0):(s=0<--a?n[a-1]:-1,c=l=!1),e=!0)),s++;e&&this.diff_cleanupMerge(t)},diff_match_patch.prototype.diff_cleanupMerge=function(t){t.push(new diff_match_patch.Diff(DIFF_EQUAL,""));for(var e,n=0,a=0,o=0,s="",i="";n<t.length;)switch(t[n][0]){case DIFF_INSERT:o++,i+=t[n][1],n++;break;case DIFF_DELETE:a++,s+=t[n][1],n++;break;case DIFF_EQUAL:1<a+o?(0!==a&&0!==o&&(0!==(e=this.diff_commonPrefix(i,s))&&(0<n-a-o&&t[n-a-o-1][0]==DIFF_EQUAL?t[n-a-o-1][1]+=i.substring(0,e):(t.splice(0,0,new diff_match_patch.Diff(DIFF_EQUAL,i.substring(0,e))),n++),i=i.substring(e),s=s.substring(e)),0!==(e=this.diff_commonSuffix(i,s))&&(t[n][1]=i.substring(i.length-e)+t[n][1],i=i.substring(0,i.length-e),s=s.substring(0,s.length-e))),n-=a+o,t.splice(n,a+o),s.length&&(t.splice(n,0,new diff_match_patch.Diff(DIFF_DELETE,s)),n++),i.length&&(t.splice(n,0,new diff_match_patch.Diff(DIFF_INSERT,i)),n++),n++):0!==n&&t[n-1][0]==DIFF_EQUAL?(t[n-1][1]+=t[n][1],t.splice(n,1)):n++,a=o=0,i=s=""}for(""===t[t.length-1][1]&&t.pop(),a=!1,n=1;n<t.length-1;)t[n-1][0]==DIFF_EQUAL&&t[n+1][0]==DIFF_EQUAL&&(t[n][1].substring(t[n][1].length-t[n-1][1].length)==t[n-1][1]?(t[n][1]=t[n-1][1]+t[n][1].substring(0,t[n][1].length-t[n-1][1].length),t[n+1][1]=t[n-1][1]+t[n+1][1],t.splice(n-1,1),a=!0):t[n][1].substring(0,t[n+1][1].length)==t[n+1][1]&&(t[n-1][1]+=t[n+1][1],t[n][1]=t[n][1].substring(t[n+1][1].length)+t[n+1][1],t.splice(n+1,1),a=!0)),n++;a&&this.diff_cleanupMerge(t)},diff_match_patch.prototype.diff_xIndex=function(t,e){var n,a=0,o=0,s=0,i=0;for(n=0;n<t.length&&(t[n][0]!==DIFF_INSERT&&(a+=t[n][1].length),t[n][0]!==DIFF_DELETE&&(o+=t[n][1].length),!(a>e));n++)s=a,i=o;return t.length!=n&&t[n][0]===DIFF_DELETE?i:i+(e-s)},diff_match_patch.prototype.diff_prettyHtml=function(t){for(var e=[],n=/&/g,a=/</g,o=/>/g,s=/\n/g,i=0;i<t.length;i++){var r=t[i][0],c=t[i][1].replace(n,"&amp;").replace(a,"&lt;").replace(o,"&gt;").replace(s,"&para;<br>");switch(r){case DIFF_INSERT:e[i]='<ins style="background:#e6ffe6;">'+c+"</ins>";break;case DIFF_DELETE:e[i]='<del style="background:#ffe6e6;">'+c+"</del>";break;case DIFF_EQUAL:e[i]="<span>"+c+"</span>"}}return e.join("")},diff_match_patch.prototype.diff_text1=function(t){for(var e=[],n=0;n<t.length;n++)t[n][0]!==DIFF_INSERT&&(e[n]=t[n][1]);return e.join("")},diff_match_patch.prototype.diff_text2=function(t){for(var e=[],n=0;n<t.length;n++)t[n][0]!==DIFF_DELETE&&(e[n]=t[n][1]);return e.join("")},diff_match_patch.prototype.diff_levenshtein=function(t){for(var e=0,n=0,a=0,o=0;o<t.length;o++){var s=t[o][1];switch(t[o][0]){case DIFF_INSERT:n+=s.length;break;case DIFF_DELETE:a+=s.length;break;case DIFF_EQUAL:e+=Math.max(n,a),a=n=0}}return e+Math.max(n,a)},diff_match_patch.prototype.diff_toDelta=function(t){for(var e=[],n=0;n<t.length;n++)switch(t[n][0]){case DIFF_INSERT:e[n]="+"+encodeURI(t[n][1]);break;case DIFF_DELETE:e[n]="-"+t[n][1].length;break;case DIFF_EQUAL:e[n]="="+t[n][1].length}return e.join("\t").replace(/%20/g," ")},diff_match_patch.prototype.diff_fromDelta=function(t,e){for(var n=[],a=0,o=0,s=e.split(/\t/g),i=0;i<s.length;i++){var r=s[i].substring(1);switch(s[i].charAt(0)){case"+":try{n[a++]=new diff_match_patch.Diff(DIFF_INSERT,decodeURI(r))}catch(t){throw Error("Illegal escape in diff_fromDelta: "+r)}break;case"-":case"=":var c=parseInt(r,10);if(isNaN(c)||0>c)throw Error("Invalid number in diff_fromDelta: "+r);r=t.substring(o,o+=c),"="==s[i].charAt(0)?n[a++]=new diff_match_patch.Diff(DIFF_EQUAL,r):n[a++]=new diff_match_patch.Diff(DIFF_DELETE,r);break;default:if(s[i])throw Error("Invalid diff operation in diff_fromDelta: "+s[i])}}if(o!=t.length)throw Error("Delta length ("+o+") does not equal source text length ("+t.length+").");return n},diff_match_patch.prototype.match_main=function(t,e,n){if(null==t||null==e||null==n)throw Error("Null input. (match_main)");return n=Math.max(0,Math.min(n,t.length)),t==e?0:t.length?t.substring(n,n+e.length)==e?n:this.match_bitap_(t,e,n):-1},diff_match_patch.prototype.match_bitap_=function(t,e,n){function a(t,a){var o=t/e.length,i=Math.abs(n-a);return s.Match_Distance?o+i/s.Match_Distance:i?1:o}if(e.length>this.Match_MaxBits)throw Error("Pattern too long for this browser.");var o=this.match_alphabet_(e),s=this,i=this.Match_Threshold,r=t.indexOf(e,n);-1!=r&&(i=Math.min(a(0,r),i),-1!=(r=t.lastIndexOf(e,n+e.length))&&(i=Math.min(a(0,r),i)));var c=1<<e.length-1;r=-1;for(var l,d,f,h=e.length+t.length,u=0;u<e.length;u++){for(l=0,d=h;l<d;)a(u,n+d)<=i?l=d:h=d,d=Math.floor((h-l)/2+l);h=d,l=Math.max(1,n-d+1);var m=Math.min(n+d,t.length)+e.length;for((d=Array(m+2))[m+1]=(1<<u)-1;m>=l;m--){var g=o[t.charAt(m-1)];if(d[m]=0===u?(d[m+1]<<1|1)&g:(d[m+1]<<1|1)&g|(f[m+1]|f[m])<<1|1|f[m+1],d[m]&c&&(g=a(u,m-1))<=i){if(i=g,!((r=m-1)>n))break;l=Math.max(1,2*n-r)}}if(a(u+1,n)>i)break;f=d}return r},diff_match_patch.prototype.match_alphabet_=function(t){for(var e={},n=0;n<t.length;n++)e[t.charAt(n)]=0;for(n=0;n<t.length;n++)e[t.charAt(n)]|=1<<t.length-n-1;return e},diff_match_patch.prototype.patch_addContext_=function(t,e){if(0!=e.length){if(null===t.start2)throw Error("patch not initialized");for(var n=e.substring(t.start2,t.start2+t.length1),a=0;e.indexOf(n)!=e.lastIndexOf(n)&&n.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)a+=this.Patch_Margin,n=e.substring(t.start2-a,t.start2+t.length1+a);a+=this.Patch_Margin,(n=e.substring(t.start2-a,t.start2))&&t.diffs.unshift(new diff_match_patch.Diff(DIFF_EQUAL,n)),(a=e.substring(t.start2+t.length1,t.start2+t.length1+a))&&t.diffs.push(new diff_match_patch.Diff(DIFF_EQUAL,a)),t.start1-=n.length,t.start2-=n.length,t.length1+=n.length+a.length,t.length2+=n.length+a.length}},diff_match_patch.prototype.patch_make=function(t,e,n){if("string"==typeof t&&"string"==typeof e&&void 0===n){var a=t;2<(e=this.diff_main(a,e,!0)).length&&(this.diff_cleanupSemantic(e),this.diff_cleanupEfficiency(e))}else if(t&&"object"==typeof t&&void 0===e&&void 0===n)e=t,a=this.diff_text1(e);else if("string"==typeof t&&e&&"object"==typeof e&&void 0===n)a=t;else{if("string"!=typeof t||"string"!=typeof e||!n||"object"!=typeof n)throw Error("Unknown call format to patch_make.");a=t,e=n}if(0===e.length)return[];n=[],t=new diff_match_patch.patch_obj;for(var o=0,s=0,i=0,r=a,c=0;c<e.length;c++){var l=e[c][0],d=e[c][1];switch(o||l===DIFF_EQUAL||(t.start1=s,t.start2=i),l){case DIFF_INSERT:t.diffs[o++]=e[c],t.length2+=d.length,a=a.substring(0,i)+d+a.substring(i);break;case DIFF_DELETE:t.length1+=d.length,t.diffs[o++]=e[c],a=a.substring(0,i)+a.substring(i+d.length);break;case DIFF_EQUAL:d.length<=2*this.Patch_Margin&&o&&e.length!=c+1?(t.diffs[o++]=e[c],t.length1+=d.length,t.length2+=d.length):d.length>=2*this.Patch_Margin&&o&&(this.patch_addContext_(t,r),n.push(t),t=new diff_match_patch.patch_obj,o=0,r=a,s=i)}l!==DIFF_INSERT&&(s+=d.length),l!==DIFF_DELETE&&(i+=d.length)}return o&&(this.patch_addContext_(t,r),n.push(t)),n},diff_match_patch.prototype.patch_deepCopy=function(t){for(var e=[],n=0;n<t.length;n++){var a=t[n],o=new diff_match_patch.patch_obj;o.diffs=[];for(var s=0;s<a.diffs.length;s++)o.diffs[s]=new diff_match_patch.Diff(a.diffs[s][0],a.diffs[s][1]);o.start1=a.start1,o.start2=a.start2,o.length1=a.length1,o.length2=a.length2,e[n]=o}return e},diff_match_patch.prototype.patch_apply=function(t,e){if(0==t.length)return[e,[]];t=this.patch_deepCopy(t);var n=this.patch_addPadding(t);e=n+e+n,this.patch_splitMax(t);for(var a=0,o=[],s=0;s<t.length;s++){var i=t[s].start2+a,r=this.diff_text1(t[s].diffs),c=-1;if(r.length>this.Match_MaxBits){var l=this.match_main(e,r.substring(0,this.Match_MaxBits),i);-1!=l&&(-1==(c=this.match_main(e,r.substring(r.length-this.Match_MaxBits),i+r.length-this.Match_MaxBits))||l>=c)&&(l=-1)}else l=this.match_main(e,r,i);if(-1==l)o[s]=!1,a-=t[s].length2-t[s].length1;else if(o[s]=!0,a=l-i,r==(i=-1==c?e.substring(l,l+r.length):e.substring(l,c+this.Match_MaxBits)))e=e.substring(0,l)+this.diff_text2(t[s].diffs)+e.substring(l+r.length);else if(i=this.diff_main(r,i,!1),r.length>this.Match_MaxBits&&this.diff_levenshtein(i)/r.length>this.Patch_DeleteThreshold)o[s]=!1;else{var d;for(this.diff_cleanupSemanticLossless(i),r=0,c=0;c<t[s].diffs.length;c++){var f=t[s].diffs[c];f[0]!==DIFF_EQUAL&&(d=this.diff_xIndex(i,r)),f[0]===DIFF_INSERT?e=e.substring(0,l+d)+f[1]+e.substring(l+d):f[0]===DIFF_DELETE&&(e=e.substring(0,l+d)+e.substring(l+this.diff_xIndex(i,r+f[1].length))),f[0]!==DIFF_DELETE&&(r+=f[1].length)}}}return[e=e.substring(n.length,e.length-n.length),o]},diff_match_patch.prototype.patch_addPadding=function(t){for(var e=this.Patch_Margin,n="",a=1;a<=e;a++)n+=String.fromCharCode(a);for(a=0;a<t.length;a++)t[a].start1+=e,t[a].start2+=e;var o=(a=t[0]).diffs;if(0==o.length||o[0][0]!=DIFF_EQUAL)o.unshift(new diff_match_patch.Diff(DIFF_EQUAL,n)),a.start1-=e,a.start2-=e,a.length1+=e,a.length2+=e;else if(e>o[0][1].length){var s=e-o[0][1].length;o[0][1]=n.substring(o[0][1].length)+o[0][1],a.start1-=s,a.start2-=s,a.length1+=s,a.length2+=s}return 0==(o=(a=t[t.length-1]).diffs).length||o[o.length-1][0]!=DIFF_EQUAL?(o.push(new diff_match_patch.Diff(DIFF_EQUAL,n)),a.length1+=e,a.length2+=e):e>o[o.length-1][1].length&&(s=e-o[o.length-1][1].length,o[o.length-1][1]+=n.substring(0,s),a.length1+=s,a.length2+=s),n},diff_match_patch.prototype.patch_splitMax=function(t){for(var e=this.Match_MaxBits,n=0;n<t.length;n++)if(!(t[n].length1<=e)){var a=t[n];t.splice(n--,1);for(var o=a.start1,s=a.start2,i="";0!==a.diffs.length;){var r=new diff_match_patch.patch_obj,c=!0;for(r.start1=o-i.length,r.start2=s-i.length,""!==i&&(r.length1=r.length2=i.length,r.diffs.push(new diff_match_patch.Diff(DIFF_EQUAL,i)));0!==a.diffs.length&&r.length1<e-this.Patch_Margin;){i=a.diffs[0][0];var l=a.diffs[0][1];i===DIFF_INSERT?(r.length2+=l.length,s+=l.length,r.diffs.push(a.diffs.shift()),c=!1):i===DIFF_DELETE&&1==r.diffs.length&&r.diffs[0][0]==DIFF_EQUAL&&l.length>2*e?(r.length1+=l.length,o+=l.length,c=!1,r.diffs.push(new diff_match_patch.Diff(i,l)),a.diffs.shift()):(l=l.substring(0,e-r.length1-this.Patch_Margin),r.length1+=l.length,o+=l.length,i===DIFF_EQUAL?(r.length2+=l.length,s+=l.length):c=!1,r.diffs.push(new diff_match_patch.Diff(i,l)),l==a.diffs[0][1]?a.diffs.shift():a.diffs[0][1]=a.diffs[0][1].substring(l.length))}i=(i=this.diff_text2(r.diffs)).substring(i.length-this.Patch_Margin),""!==(l=this.diff_text1(a.diffs).substring(0,this.Patch_Margin))&&(r.length1+=l.length,r.length2+=l.length,0!==r.diffs.length&&r.diffs[r.diffs.length-1][0]===DIFF_EQUAL?r.diffs[r.diffs.length-1][1]+=l:r.diffs.push(new diff_match_patch.Diff(DIFF_EQUAL,l))),c||t.splice(++n,0,r)}}},diff_match_patch.prototype.patch_toText=function(t){for(var e=[],n=0;n<t.length;n++)e[n]=t[n];return e.join("")},diff_match_patch.prototype.patch_fromText=function(t){var e=[];if(!t)return e;t=t.split("\n");for(var n=0,a=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;n<t.length;){var o=t[n].match(a);if(!o)throw Error("Invalid patch string: "+t[n]);var s=new diff_match_patch.patch_obj;for(e.push(s),s.start1=parseInt(o[1],10),""===o[2]?(s.start1--,s.length1=1):"0"==o[2]?s.length1=0:(s.start1--,s.length1=parseInt(o[2],10)),s.start2=parseInt(o[3],10),""===o[4]?(s.start2--,s.length2=1):"0"==o[4]?s.length2=0:(s.start2--,s.length2=parseInt(o[4],10)),n++;n<t.length;){o=t[n].charAt(0);try{var i=decodeURI(t[n].substring(1))}catch(t){throw Error("Illegal escape in patch_fromText: "+i)}if("-"==o)s.diffs.push(new diff_match_patch.Diff(DIFF_DELETE,i));else if("+"==o)s.diffs.push(new diff_match_patch.Diff(DIFF_INSERT,i));else if(" "==o)s.diffs.push(new diff_match_patch.Diff(DIFF_EQUAL,i));else{if("@"==o)break;if(""!==o)throw Error('Invalid patch mode "'+o+'" in: '+i)}n++}}return e},diff_match_patch.patch_obj=function(){this.diffs=[],this.start2=this.start1=null,this.length2=this.length1=0},diff_match_patch.patch_obj.prototype.toString=function(){for(var t,e=["@@ -"+(0===this.length1?this.start1+",0":1==this.length1?this.start1+1:this.start1+1+","+this.length1)+" +"+(0===this.length2?this.start2+",0":1==this.length2?this.start2+1:this.start2+1+","+this.length2)+" @@\n"],n=0;n<this.diffs.length;n++){switch(this.diffs[n][0]){case DIFF_INSERT:t="+";break;case DIFF_DELETE:t="-";break;case DIFF_EQUAL:t=" "}e[n+1]=t+encodeURI(this.diffs[n][1])+"\n"}return e.join("").replace(/%20/g," ")},this.diff_match_patch=diff_match_patch,this.DIFF_DELETE=DIFF_DELETE,this.DIFF_INSERT=DIFF_INSERT,this.DIFF_EQUAL=DIFF_EQUAL,diff_match_patch.prototype.fcn_prettyHtml=function(t){for(var e=[],n=/&/g,a=/</g,o=/>/g,s=/\n/g,i=0;i<t.length;i++){var r=t[i][0],c=t[i][1].replace(n,"&amp;").replace(a,"&lt;").replace(o,"&gt;").replace(s,"&para;<br>");switch(r){case 1:e[i]=`<ins>${c}</ins>`;break;case-1:e[i]=`<del>${c}</del>`;break;case 0:e[i]=`${c}`}}return e.join("")};class FCN_Suggestion{constructor(){this.toggle=_$$$("suggestions-modal-toggle"),this.tools=_$$$("selection-tools"),this.button=_$$$("button-add-suggestion"),this.toolsButton=_$$$("button-tools-add-suggestion"),this.reset=_$$$("button-suggestion-reset"),this.submit=_$$$("button-suggestion-submit"),this.current=_$$$("suggestions-modal-original"),this.input=_$$$("suggestions-modal-input"),this.output=_$$$("suggestions-modal-diff"),this.chapter=_$(".chapter__article"),this.text="",this.original="",this.latest="",this.paragraph=null,this.dmp=new diff_match_patch,this.bindEvents()}getCaretCoordinates(){let t=0,e=0;if(void 0!==window.getSelection){const n=window.getSelection();if(0!==n.rangeCount){let a=n.getRangeAt(0).cloneRange().getClientRects();a=a[a.length-1],a&&(t=a.right+window.scrollX,e=a.bottom+window.scrollY)}}return{x:t,y:e}}getClosestParagraph(){const t=window.getSelection();return t.rangeCount?t.getRangeAt(0).startContainer.parentNode.closest("p"):null}showTools(t,e){const n=document.documentElement.offsetWidth/2+this.tools.offsetWidth,a=_$$$("wpadminbar")?_$$$("wpadminbar").offsetHeight:0;this.tools.style.transform=e>n?"translate(-100%)":"translate(0)",this.tools.style.top=t+4-a+"px",this.tools.style.left=`${e}px`,this.tools.classList.remove("invisible")}hideTools(){this.tools.style.top="0",this.tools.style.left="-1000px",this.tools.classList.add("invisible")}textSelection(){return fcn_cleanTextSelectionFromButtons(window.getSelection().toString())}clearSelection(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()}getDiff(t,e){const n=this.dmp.diff_main(t,e);return this.dmp.diff_cleanupEfficiency(n),this.dmp.fcn_prettyHtml(n)}toggleTools(t){FcnGlobals.eSite.classList.contains("transformed-site")||window.getSelection().rangeCount<1||!window.getSelection().getRangeAt(0).startContainer.parentNode.closest(".content-section")||setTimeout((()=>{if(t.text=t.textSelection().replaceAll("\n\n","\n"),""!==t.text){const e=t.getCaretCoordinates();t.showTools(e.y,e.x)}else t.hideTools()}),10)}toggleViaParagraphTools(t){FcnGlobals.eSite.classList.contains("transformed-site")||(t.text=_$(".selected-paragraph").querySelector(".paragraph-inner").innerText,t.showModal(t))}resizeInput(){this.input.style.height="auto",this.input.style.height=`${FcnUtils.clamp(32,108,this.input.scrollHeight+4)}px`}showModal(t){fcn_lastSelectedParagraphId&&fcn_toggleParagraphTools(!1),t.original=t.text,t.current.innerHTML=t.text.replaceAll("\n","<br>"),t.input.value=t.text,t.output.innerHTML=t.getDiff(t.original,t.text),t.paragraph=t.getClosestParagraph(),t.toggle.click(),t.toggle.checked=!0,t.clearSelection(),t.hideTools(),t.resizeInput(),t.input.focus()}editSuggestion(t){t.resizeInput(),t.output.innerHTML=t.getDiff(t.original,t.input.value)}resetSuggestion(t){t.input.value=t.original,t.resizeInput(),t.output.innerHTML=t.getDiff(t.original,t.original)}submitSuggestion(t){const e=_$(FcnGlobals.commentFormSelector),n=t.paragraph?.id??null;let a=t.output.innerHTML;[["","&para;\n"],["<br>","\n"],["<ins>","[ins]"],["</ins>","[/ins]"],["<del>","[del]"],["</del>","[/del]"]].forEach((([t,e])=>{a=a.replaceAll(t,e)})),t.latest=n?`\n[quote]${a} [anchor]${n}[/anchor][/quote]\n`:`\n[quote]${a}[/quote]\n`,e?"TEXTAREA"==e.tagName?(e.value+=t.latest,fcn_adjustTextarea(_$("textarea#comment"))):"DIV"==e.tagName&&(e.innerHTML+=t.latest):fcn_commentStack?.push(t.latest),t.toggle.click(),t.toggle.checked=!1,fcn_showNotification(fictioneer_tl.notification.suggestionAppendedToComment)}bindEvents(){this.chapter?.addEventListener("mouseup",this.toggleTools.bind(null,this)),this.button?.addEventListener("click",this.showModal.bind(null,this)),this.toolsButton?.addEventListener("click",this.toggleViaParagraphTools.bind(null,this)),this.input?.addEventListener("input",this.editSuggestion.bind(null,this)),this.reset?.addEventListener("click",this.resetSuggestion.bind(null,this)),this.submit?.addEventListener("click",this.submitSuggestion.bind(null,this))}}const fcn_suggestions=_$(".chapter__article")&&_$(".comment-section")&&_$$$("selection-tools")?new FCN_Suggestion:null;fcn_suggestions&&document.addEventListener("click",(function(t){t.target.closest(".content-section")||fcn_suggestions.hideTools()}));const fcn_ttsInterface=_$$$("tts-interface");var fcn_utter,fcn_synth,fcn_ttsStack=[],fcn_currentReadingId=-1,fcn_ttsPauseTimestamp=-1,fcn_ttsCurrentText="",fcn_ttsSettings=fcn_getTTSsettings(),fcn_voices=[];if("undefined"!=typeof speechSynthesis&&fcn_ttsInterface){fcn_synth=window.speechSynthesis,(fcn_utter=new SpeechSynthesisUtterance).lang=document.documentElement.lang;const t=setTimeout((()=>{fcn_setupTTS()}),2e3);"onvoiceschanged"in speechSynthesis&&fcn_synth.addEventListener("voiceschanged",(()=>{fcn_setupTTS(),clearTimeout(t)}),{once:!0})}function fcn_setupTTS(){fcn_voices.length>0||(fcn_setUpVoices(),fcn_updateVolume(fcn_ttsSettings.volume),fcn_updatePitch(fcn_ttsSettings.pitch),fcn_updateRate(fcn_ttsSettings.rate))}function fcn_setTTSsettings(t){fcn_ttsSettings=t,localStorage.setItem("ttsSettings",JSON.stringify(t))}function fcn_getTTSsettings(){const t=FcnUtils.parseJSON(localStorage.getItem("ttsSettings"))??{};return fcn_setTTSsettings(t),t}function fcn_setUpVoices(){const t=fcn_synth.getVoices(),e=_$$$("tts-voice-select");if(!e)return;let n=0;for(let a=0;a<t.length;a++){const o=t[a];fcn_voices.push(o);const s=document.createElement("option");s.value=n,s.innerHTML=`${o.name} (${o.lang})`,e.appendChild(s),n++}fcn_voices.length<1?_$(".tts-settings__voice-selection")?.remove():(e.addEventListener("change",(t=>{fcn_updateVoice(t.currentTarget.value)})),fcn_updateVoice(fcn_ttsSettings.voice))}function fcn_updateVoice(t){if(isNaN(t)||void 0===fcn_voices[t]){let e=fcn_voices.findIndex((t=>"Samantha"===t.name&&("en-US"===t.lang||"en_US"===t.lang)));e<0&&(e=fcn_voices.findIndex((t=>"en-US"===t.lang||"en_US"===t.lang))),t=e>-1?e:0}fcn_utter.voice=fcn_voices[t],_$$$("tts-voice-select").value=t,fcn_ttsSettings.voice=t,fcn_setTTSsettings(fcn_ttsSettings)}function fcn_updateVolume(t){t=isNaN(t)?100:parseInt(t),t=FcnUtils.clamp(0,100,t),_$$$("tts-volume-range").value=t,_$$$("tts-volume-text").value=t,_$$$("tts-volume-reset").classList.toggle("_modified",100!=t),fcn_ttsSettings.volume=t,fcn_setTTSsettings(fcn_ttsSettings),fcn_utter.volume=t/100}function fcn_updatePitch(t){t=isNaN(t)?1:parseFloat(t),t=FcnUtils.clamp(.2,1.8,t),_$$$("tts-pitch-range").value=t,_$$$("tts-pitch-text").value=t,_$$$("tts-pitch-reset").classList.toggle("_modified",1!=t),fcn_ttsSettings.pitch=t,fcn_setTTSsettings(fcn_ttsSettings),fcn_utter.pitch=t}function fcn_updateRate(t){t=isNaN(t)?1:parseFloat(t),t=FcnUtils.clamp(.2,1.8,t),_$$$("tts-rate-range").value=t,_$$$("tts-rate-text").value=t,_$$$("tts-rate-reset").classList.toggle("_modified",1!=t),fcn_ttsSettings.rate=t,fcn_setTTSsettings(fcn_ttsSettings),fcn_utter.rate=t}function fcn_readTextStack(){const t=_$(".current-reading");if(0===fcn_ttsStack.length)return fcn_ttsInterface.classList.add("ended"),t&&t.classList.remove("current-reading"),fcn_currentReadingId=-1,void(fcn_ttsCurrentText="");const e=fcn_ttsStack.shift();fcn_ttsCurrentText=e[1],fcn_currentReadingId!=e[0]&&(fcn_currentReadingId=e[0],t&&t.classList.remove("current-reading"),_$$$(fcn_currentReadingId).classList.add("current-reading")),fcn_utter.text=fcn_ttsCurrentText,fcn_utter.addEventListener("end",fcn_readTextStack,{once:!0}),fcn_synth.speak(fcn_utter)}"undefined"!=typeof speechSynthesis&&fcn_ttsInterface&&(_$$$("button-tts-set").addEventListener("click",(t=>{fcn_ttsStack=[],fcn_currentReadingId=-1;const e=_$(".chapter-formatting")?.classList.contains("hide-sensitive")??!1?"sensitive-content":"sensitive-alternative",n=_$$$("button-tts-play"),a=new RegExp(fcn_ttsInterface.dataset.regex,"gm");fcn_synth.speaking&&fcn_utter.removeEventListener("end",fcn_readTextStack),fcn_synth.cancel();const o=new Set(["P","H1","H2","H3","H4","H5","H6"]),s=["skip-tts","inside-epub",e];let i=t.target.closest("p[data-paragraph-id]");for(fcn_ttsStack.push(i);i=i.nextElementSibling;)o.has(i.tagName)&&!s.some((t=>i.classList.contains(t)))&&fcn_ttsStack.push(i);fcn_ttsStack=fcn_ttsStack.flatMap((t=>{const e=[],n=t.querySelector(".paragraph-inner");return(n?n.textContent:t.textContent).replace(a,"$1|").split("|").forEach((n=>{const a=n.trim();a.length>0&&e.push([t.id,a])})),e})),fcn_readTextStack(),document.body.classList.add("tts-open"),fcn_ttsInterface.classList.remove("hidden","ended","paused"),fcn_ttsInterface.classList.add("playing"),n.focus(),n.blur()})),_$$$("button-tts-stop")?.addEventListener("click",(()=>{const t=_$(".current-reading");fcn_ttsInterface.classList.add("hidden","ended"),fcn_ttsInterface.classList.remove("playing","paused"),document.body.classList.remove("tts-open"),t&&t.classList.remove("current-reading"),fcn_ttsStack=[],fcn_currentReadingId=-1,fcn_utter.removeEventListener("end",fcn_readTextStack),fcn_synth.cancel()})),_$$$("button-tts-play")?.addEventListener("click",(()=>{fcn_synth.resume(),-1!==fcn_ttsPauseTimestamp&&Date.now()-fcn_ttsPauseTimestamp>1e4&&(fcn_ttsStack.unshift([fcn_currentReadingId,fcn_ttsCurrentText]),fcn_synth.cancel(),fcn_readTextStack(),fcn_ttsPauseTimestamp=-1),fcn_ttsInterface.classList.add("playing"),fcn_ttsInterface.classList.remove("paused")})),_$$$("button-tts-pause")?.addEventListener("click",(()=>{fcn_synth.pause(),fcn_ttsPauseTimestamp=Date.now(),fcn_ttsInterface.classList.remove("playing"),fcn_ttsInterface.classList.add("paused")})),_$$$("button-tts-skip")?.addEventListener("click",(()=>{fcn_utter.removeEventListener("end",fcn_readTextStack),fcn_synth.cancel(),fcn_readTextStack(),fcn_ttsInterface.classList.remove("paused"),fcn_ttsInterface.classList.add("playing")})),_$$$("button-tts-scroll")?.addEventListener("click",(()=>{fcn_scrollTo(_$(`p[id="${fcn_currentReadingId}"]`),128)})),_$$("#tts-volume-range, #tts-volume-text").forEach((t=>{t.addEventListener("input",(t=>{fcn_updateVolume(t.target.value)}))})),_$$$("tts-volume-reset")?.addEventListener("click",(()=>{fcn_updateVolume(100)})),_$$("#tts-pitch-range, #tts-pitch-text").forEach((t=>{t.addEventListener("input",(t=>{fcn_updatePitch(t.target.value)}))})),_$$$("tts-pitch-reset")?.addEventListener("click",(()=>{fcn_updatePitch(1)})),_$$("#tts-rate-range, #tts-rate-text").forEach((t=>{t.addEventListener("input",(t=>{fcn_updateRate(t.target.value)}))})),_$$$("tts-rate-reset")?.addEventListener("click",(()=>{fcn_updateRate(1)})),window.addEventListener("beforeunload",(()=>{fcn_synth.cancel()})));var fcn_storyCommentPage=1,fcn_storySettings=fcn_getStorySettings();function fcn_cleanUpActions(){_$$(".story__actions > *").forEach((t=>{const e=window.getComputedStyle(t);"none"!==e.display&&"hidden"!==e.visibility||t.remove()}))}function fcn_getStorySettings(){
let t=FcnUtils.parseJSON(localStorage.getItem("fcnStorySettings"))??fcn_defaultStorySettings();return t.timestamp<1674770712849&&(t=fcn_defaultStorySettings(),t.timestamp=Date.now()),fcn_setStorySettings(t),t}function fcn_defaultStorySettings(){return{view:"list",order:"asc",timestamp:1674770712849}}function fcn_setStorySettings(t){"object"==typeof t&&(fcn_storySettings=t,localStorage.setItem("fcnStorySettings",JSON.stringify(t)))}function fcn_applyStorySettings(){"object"==typeof fcn_storySettings&&(_$$("[data-view]").forEach((t=>{t.dataset.view="grid"==fcn_storySettings.view?"grid":"list"})),_$$("[data-order]").forEach((t=>{t.dataset.order="desc"==fcn_storySettings.order?"desc":"asc"})))}document.addEventListener("fcnUserDataReady",(()=>{fcn_cleanUpActions()})),fcn_applyStorySettings();var fcn_isToggling=!1;function fcn_toggleStoryTab(t){const e=t.closest(".story");e.querySelectorAll(".story__tab-target._current, .story__tabs ._current").forEach((t=>{t.classList.remove("_current")})),e.querySelectorAll(`[data-finder="${t.dataset.target}"]`).forEach((t=>{t.classList.add("_current")})),e.querySelector(".story__tabs").dataset.current=t.dataset.target,t.classList.add("_current")}function fcn_loadStoryComments(t){let e;_$(".load-more-list-item").remove(),_$(".comments-loading-placeholder").classList.remove("hidden"),fcn_ajaxGet({post_id:t.dataset.storyId??document.body.dataset.postId,page:fcn_storyCommentPage},"get_story_comments").then((t=>{t.success?(_$(".fictioneer-comments__list > ul").innerHTML+=t.data.html,fcn_storyCommentPage++):t.data?.error&&(e=fcn_buildErrorNotice(t.data.error))})).catch((t=>{e=fcn_buildErrorNotice(t)})).then((()=>{_$(".comments-loading-placeholder").remove(),e&&_$(".fictioneer-comments__list > ul").appendChild(e)}))}function fcn_startEpubDownload(t,e=0){e>3?t.classList.remove("ajax-in-progress"):fcn_ajaxGet({action:"fictioneer_ajax_download_epub",story_id:t.dataset.storyId}).then((n=>{n.success?(window.location.href=t.href,setTimeout((()=>{t.classList.remove("ajax-in-progress")}),2e3)):setTimeout((()=>{fcn_startEpubDownload(t,e+1)}),2e3)})).catch((e=>{t.classList.remove("ajax-in-progress"),e.status&&e.statusText&&fcn_showNotification(`${e.status}: ${e.statusText}`,5,"warning")}))}function fcn_unsetOauth(t){const e=prompt(t.dataset.warning);if(!e||e.toLowerCase()!=t.dataset.confirm.toLowerCase())return;const n=_$$$(`oauth-${t.dataset.channel}`);n.classList.add("ajax-in-progress"),FcnUtils.aPost(payload={action:"fictioneer_ajax_unset_my_oauth",nonce:t.dataset.nonce,channel:t.dataset.channel,id:t.dataset.id}).then((t=>{t.success?(n.classList.remove("_connected"),n.classList.add("_disconnected"),n.querySelector("button").remove(),fcn_showNotification(n.dataset.unset)):(n.style.background="var(--notice-warning-background)",fcn_showNotification(t.data.failure??t.data.error??fictioneer_tl.notification.error,5,"warning"),(t.data.error||t.data.failure)&&console.error("Error:",t.data.error??t.data.failure))})).catch((t=>{t.status&&t.statusText&&(n.style.background="var(--notice-warning-background)",fcn_showNotification(`${t.status}: ${t.statusText}`,5,"warning")),console.error(t)})).then((()=>{n.classList.remove("ajax-in-progress")}))}function fcn_deleteMyAccount(t){if(_$$$("button-delete-my-account").hasAttribute("disabled"))return;const e=prompt(t.dataset.warning);e&&e.toLowerCase()==t.dataset.confirm.toLowerCase()&&(_$$$("button-delete-my-account").setAttribute("disabled",!0),FcnUtils.aPost({action:"fictioneer_ajax_delete_my_account",nonce:t.dataset.nonce,id:t.dataset.id}).then((t=>{t.success?(localStorage.removeItem("fcnAuth"),localStorage.removeItem("fcnProfileAvatar"),location.reload()):(_$$$("button-delete-my-account").innerHTML=t.data.button,fcn_showNotification(t.data.failure??t.data.error??fictioneer_tl.notification.error,5,"warning"),(t.data.error||t.data.failure)&&console.error("Error:",t.data.error??t.data.failure))})).catch((t=>{t.status&&t.statusText&&(fcn_showNotification(`${t.status}: ${t.statusText}`,5,"warning"),_$$$("button-delete-my-account").innerHTML=response.data.button),console.error(t)})))}_$$('[data-click-action*="toggle-chapter-order"]').forEach((t=>{t.addEventListener("click",(t=>{fcn_isToggling||(fcn_isToggling=!0,setTimeout((()=>fcn_isToggling=!1),50),fcn_storySettings.order="asc"===t.currentTarget.dataset.order?"desc":"asc",fcn_setStorySettings(fcn_storySettings),fcn_applyStorySettings())}))})),_$$('[data-click-action*="toggle-chapter-view"]').forEach((t=>{t.addEventListener("click",(t=>{fcn_isToggling||(fcn_isToggling=!0,setTimeout((()=>fcn_isToggling=!1),50),fcn_storySettings.view="list"===t.currentTarget.dataset.view?"grid":"list",fcn_setStorySettings(fcn_storySettings),fcn_applyStorySettings())}))})),_$$(".chapter-group__folding-toggle").forEach((t=>{t.addEventListener("click",(t=>{const e=t.currentTarget.closest(".chapter-group[data-folded]");e&&(e.dataset.folded="true"==e.dataset.folded?"false":"true")}))})),_$$(".tabs__item").forEach((t=>{t.addEventListener("click",(t=>{fcn_toggleStoryTab(t.currentTarget)}))})),_$(".comment-section")?.addEventListener("click",(t=>{t.target?.classList.contains("load-more-comments-button")&&fcn_loadStoryComments(t.target)})),_$$('[data-action="download-epub"]').forEach((t=>{t.addEventListener("click",(t=>{t.preventDefault(),t.currentTarget.classList.contains("ajax-in-progress")||(t.currentTarget.classList.add("ajax-in-progress"),fcn_startEpubDownload(t.currentTarget))}))})),_$$(".button-unset-oauth").forEach((t=>{t.addEventListener("click",(t=>{fcn_unsetOauth(t.currentTarget)}))})),_$$$("button-delete-my-account")?.addEventListener("click",(t=>{fcn_deleteMyAccount(t.currentTarget)}));const fcn_profileDataTranslations=_$$$("profile-data-translations")?.dataset;function fcn_dataDeletionPrompt(t){const e=prompt(t.dataset.warning);return!(!e||e.toLowerCase()!=t.dataset.confirm.toLowerCase())}function fcn_clearData(t,e){const n=t.closest(".card");localStorage.removeItem("fcnBookshelfContent"),n.classList.add("ajax-in-progress"),t.remove(),FcnUtils.aPost({action:e,fcn_fast_ajax:1,nonce:t.dataset.nonce}).then((t=>{t.success?n.querySelector(".card__content").innerHTML=t.data.success:(fcn_showNotification(t.data.failure??t.data.error??fictioneer_tl.notification.error,10,"warning"),(t.data.error||t.data.failure)&&console.error("Error:",t.data.error??t.data.failure))})).catch((t=>{t.status&&t.statusText&&fcn_showNotification(`${t.status}: ${t.statusText}`,10,"warning"),console.error(t)})).then((()=>{n.classList.remove("ajax-in-progress")}))}_$(".button-clear-comments")?.addEventListener("click",(t=>{fcn_dataDeletionPrompt(t.currentTarget)&&fcn_clearData(t.currentTarget,"fictioneer_ajax_clear_my_comments")})),_$(".button-clear-comment-subscriptions")?.addEventListener("click",(t=>{fcn_dataDeletionPrompt(t.currentTarget)&&fcn_clearData(t.currentTarget,"fictioneer_ajax_clear_my_comment_subscriptions")})),_$(".button-clear-checkmarks")?.addEventListener("click",(t=>{if(!fcn_dataDeletionPrompt(t.currentTarget))return;const e=fcn().userData();e.checkmarks={data:{},updated:Date.now()},fcn().setUserData(e),fcn_updateCheckmarksView(),fcn_clearData(t.currentTarget,"fictioneer_ajax_clear_my_checkmarks",!0)})),_$(".button-clear-reminders")?.addEventListener("click",(t=>{if(!fcn_dataDeletionPrompt(t.currentTarget))return;const e=fcn().userData();e.reminders={data:{}},fcn().setUserData(e),fcn_updateRemindersView(),fcn_clearData(t.currentTarget,"fictioneer_ajax_clear_my_reminders",!0)})),_$(".button-clear-follows")?.addEventListener("click",(t=>{if(!fcn_dataDeletionPrompt(t.currentTarget))return;const e=fcn().userData();e.follows={data:{}},fcn().setUserData(e),fcn_updateFollowsView(),fcn_clearData(t.currentTarget,"fictioneer_ajax_clear_my_follows",!0)})),_$(".button-clear-bookmarks")?.addEventListener("click",(t=>{if(!fcn_dataDeletionPrompt(t.currentTarget))return;const e=fcn().userData();e.bookmarks="{}",fcn().setUserData(e),fcn_bookmarks.data={},t.currentTarget.closest(".card").querySelector(".card__content").innerHTML=fcn_profileDataTranslations.clearedSuccess,fcn_setBookmarks(fcn_bookmarks)}));const fcn_jumpToBookmarkButtons=_$$(".button--bookmark"),fcn_mobileBookmarkJump=_$$$("mobile-menu-bookmark-jump"),fcn_mobileBookmarkList=_$(".mobile-menu__bookmark-list"),fcn_bookmarksSmallCardBlock=_$(".bookmarks-block"),fcn_bookmarksSmallCardTemplate=_$(".bookmark-small-card-template");var fcn_bookmarks,fcn_userBookmarksTimeout;function fcn_initializeLocalBookmarks(){fcn_setBookmarks(fcn_bookmarks=fcn_getBookmarks(),!0),fcn_updateBookmarksView()}function fcn_initializeUserBookmarks(t){fcn_setBookmarks(FcnUtils.parseJSON(t.detail.data.bookmarks)??{},!0),fcn_updateBookmarksView()}function fcn_getBookmarks(){let t=FcnUtils.parseJSON(localStorage.getItem("fcnChapterBookmarks"))??{data:{}};return Array.isArray(t.data)&&0===t.data.length&&(t.data={}),t=fcn_fixBookmarks(t),!t||Object.keys(t).length<1?{data:{}}:t}function fcn_fixBookmarks(t){const e={};for(const n in t.data)if(n.startsWith("ch-")){const a=fcn_fixBookmarksNode(t.data[n]);a&&(e[n]=a)}return{data:e}}function fcn_fixBookmarksNode(t){const e={},n={"paragraph-id":"",progress:0,date:"",color:"",chapter:"",link:"",thumb:"",image:"",story:"",content:""};for(const a in n){if(typeof t[a]!=typeof n[a])return null;e[a]=t[a]}const a=new Date(e.date);return a&&"[object Date]"===Object.prototype.toString.call(a)&&!isNaN(a)||(e.date=(new Date).toISOString()),("number"!=typeof e.progress||e.progress<0)&&(e.progress=0),e}function fcn_setBookmarks(t,e=!1){if("object"==typeof t){if(fcn_bookmarks=t,localStorage.setItem("fcnChapterBookmarks",JSON.stringify(t)),FcnUtils.loggedIn()){const e=fcn().userData();e&&(e.bookmarks=JSON.stringify(t),fcn().setUserData(e))}e||fcn_saveUserBookmarks(t)}}function fcn_updateBookmarksView(){if(!fcn_bookmarks||!fcn_bookmarks.data)return;const t=_$(".profile-bookmarks-stats"),e=Object.keys(fcn_bookmarks.data).length;t&&(t.innerHTML=t.innerHTML.replace("%s",e)),e>0&&_$$(".icon-menu-bookmarks").forEach((t=>{t.classList.remove("hidden")})),fcn_showBookmarkCards(),fcn_showChapterBookmark()}function fcn_saveUserBookmarks(t){FcnUtils.loggedIn()&&(clearTimeout(fcn_userBookmarksTimeout),t=fcn_fixBookmarks(t),fcn_userBookmarksTimeout=setTimeout((()=>{FcnUtils.aPost({action:"fictioneer_ajax_save_bookmarks",fcn_fast_ajax:1,bookmarks:JSON.stringify(t)}).then((t=>{t.success||(fcn_showNotification(t.data.failure??t.data.error??fictioneer_tl.notification.error,3,"warning"),(t.data.error||t.data.failure)&&console.error("Error:",t.data.error??t.data.failure))})).catch((t=>{t.status&&t.statusText&&fcn_showNotification(`${t.status}: ${t.statusText}`,3,"warning"),console.error(t)}))}),FcnGlobals.debounceRate))}function fcn_toggleBookmark(t,e="none"){fcn_bookmarks=fcn_getBookmarks();const n=_$(".chapter__article"),a=_$(".current-bookmark");if(!n)return;const o=fcn_bookmarks.data[n.id];if(o&&o["paragraph-id"]==t&&a)"none"!=e&&e!=o.color?(_$(".current-bookmark").dataset.bookmarkColor=e,o.color=e):fcn_removeBookmark(n.id);else{Object.keys(fcn_bookmarks.data).length>=50&&fcn_removeBookmark(Object.keys(fcn_bookmarks.data)[0]);const o=_$(`[data-paragraph-id="${t}"]`),s=_$$$("chapter-bookmark-data").dataset;fcn_bookmarks.data[n.id]={"paragraph-id":t,progress:100*(FcnUtils.offset(o).top-FcnUtils.offset(o.parentElement).top)/o.parentElement.clientHeight,date:(new Date).toISOString(),color:e,chapter:s.title.trim(),link:s.link,thumb:s.thumb,image:s.image,story:s.storyTitle.trim(),content:o.querySelector("span").innerHTML.substring(0,128)+""},fcn_jumpToBookmarkButtons.forEach((t=>{t.classList.remove("hidden")})),fcn_mobileBookmarkJump?.removeAttribute("hidden"),a?.classList.remove("current-bookmark"),o.classList.add("current-bookmark"),o.setAttribute("data-bookmark-color",e)}fcn_setMobileMenuBookmarks(),fcn_setBookmarks(fcn_bookmarks)}function fcn_showChapterBookmark(){_$(".current-bookmark")?.classList.remove("current-bookmark");const t=_$(".chapter__article");if(!t||!fcn_bookmarks.data[t.id])return;const e=fcn_bookmarks.data[t.id]["paragraph-id"],n=_$(`[data-paragraph-id="${e}"]`),a=fcn_bookmarks.data[t.id].color??"none";e&&n&&(fcn_jumpToBookmarkButtons.forEach((t=>{t.classList.remove("hidden")})),fcn_mobileBookmarkJump?.removeAttribute("hidden"),n.classList.add("current-bookmark"),n.setAttribute("data-bookmark-color",a))}function fcn_setMobileMenuBookmarks(){fcn_mobileBookmarkList.innerHTML="";const t=Object.entries(fcn_bookmarks.data),e=_$("#mobile-bookmark-template");if(t.length>0){const n=document.createDocumentFragment();t.forEach((([t,{color:a,progress:o,link:s,chapter:i,"paragraph-id":r}])=>{const c=e.content.cloneNode(!0),l=c.querySelector(".mobile-menu__bookmark");l.classList.add(`bookmark-${t}`),l.dataset.color=a,c.querySelector(".mobile-menu__bookmark-progress > div > div").style.width=`${o.toFixed(1)}%`,c.querySelector(".mobile-menu__bookmark a").href=`${s}#paragraph-${r}`,c.querySelector(".mobile-menu__bookmark a span").innerText=i,c.querySelector(".mobile-menu-bookmark-delete-button").setAttribute("data-bookmark-id",t),n.appendChild(c)})),fcn_mobileBookmarkList.appendChild(n),fcn_bookmarkDeleteHandler(_$$(".mobile-menu-bookmark-delete-button"))}else{const t=document.createElement("li");t.classList.add("no-bookmarks"),t.textContent=fcn_mobileBookmarkList.dataset.empty,fcn_mobileBookmarkList.appendChild(t)}}function fcn_showBookmarkCards(){if(!fcn_bookmarks||!fcn_bookmarksSmallCardBlock||!fcn_bookmarksSmallCardTemplate||Object.keys(fcn_bookmarks.data).length<1||_$(".bookmark-card"))return;fcn_bookmarksSmallCardBlock.classList.remove("hidden"),_$(".bookmarks-block__no-bookmarks")?.remove(),_$$(".show-if-bookmarks").forEach((t=>t.classList.remove("hidden")));let t=parseInt(fcn_bookmarksSmallCardBlock.dataset.count);const e=document.createDocumentFragment();Object.entries(fcn_bookmarks.data).sort(((t,e)=>new Date(e[1].date)-new Date(t[1].date))).forEach((([n,{color:a,progress:o,link:s,chapter:i,"paragraph-id":r,date:c,image:l,thumb:d,content:f}])=>{if(0==t)return;t--;const h=fcn_bookmarksSmallCardTemplate.content.cloneNode(!0),u=new Date(c).toLocaleDateString(navigator.language??"en-US",{year:"2-digit",month:"short",day:"numeric"});l&&h.querySelector(".bookmark-card__image")?(h.querySelector(".bookmark-card__image").href=l,h.querySelector(".bookmark-card__image img").src=d):h.querySelector(".bookmark-card__image")?.remove(),h.querySelector(".bookmark-card__excerpt").innerHTML+=f,h.querySelector(".bookmark-card").classList.add(`bookmark-${n}`),h.querySelector(".bookmark-card").dataset.color=a,h.querySelector(".bookmark-card__title > a").href=`${s}#paragraph-${r}`,h.querySelector(".bookmark-card__title > a").innerText=i,h.querySelector(".bookmark-card__percentage").innerText=`${o.toFixed(1)} %`,h.querySelector(".bookmark-card__progress").style.width=`calc(${o.toFixed(1)}% - var(--bookmark-progress-offset, 0px))`,h.querySelector("time").innerText=u,h.querySelector(".button-delete-bookmark").setAttribute("data-bookmark-id",n),e.appendChild(h)})),fcn_bookmarksSmallCardBlock.querySelector("ul").appendChild(e),fcn_bookmarkDeleteHandler(_$$(".button-delete-bookmark"))}function fcn_bookmarkDeleteHandler(t){("object"==typeof t?t:[t]).forEach((t=>{t.addEventListener("click",(t=>{fcn_removeBookmark(t.currentTarget.dataset.bookmarkId),fcn_setBookmarks(fcn_bookmarks),Object.keys(fcn_bookmarks.data).length<1&&(_$(".bookmarks-block")?.classList.add("hidden"),_$$(".show-if-bookmarks").forEach((t=>{t.classList.add("hidden")})))}))}))}function fcn_removeBookmark(t){const e=_$(".chapter__article"),n=_$(".current-bookmark");delete fcn_bookmarks.data[t],e&&e.id==t&&(fcn_jumpToBookmarkButtons.forEach((t=>{t.classList.add("hidden")})),fcn_mobileBookmarkJump?.setAttribute("hidden",!0),n&&(n.classList.remove("current-bookmark"),n.removeAttribute("data-bookmark-color"))),_$$(`.bookmark-${t}`)?.forEach((t=>{t.remove()}))}fcn_initializeLocalBookmarks(),document.addEventListener("fcnUserDataReady",(t=>{t.detail.data.loggedIn&&fcn_initializeUserBookmarks(t)})),fcn_jumpToBookmarkButtons.forEach((t=>{t.addEventListener("click",(()=>{_$(`[data-paragraph-id="${fcn_bookmarks.data[_$("article").id]["paragraph-id"]}"]`).scrollIntoView({behavior:"smooth"})}))}));const fcn_followsMenuItem=_$$$("follow-menu-button");var fcn_userFollowsTimeout,fcn_follows,fcn_checkmarks,fcn_userCheckmarksTimeout,fcn_userRemindersTimeout,fcn_reminders;function fcn_initializeFollows(t){const e=t.detail.data.follows;!1!==e&&(Array.isArray(e.data)&&0===e.data.length&&(e.data={}),fcn_follows=e,fcn_updateFollowsView(),localStorage.removeItem("fcnBookshelfContent"))}function fcn_toggleFollow(t,e=null){const n=fcn().userData();if(fcn_follows&&n.follows){if(localStorage.removeItem("fcnBookshelfContent"),null===e&&JSON.stringify(fcn_follows.data[t])!==JSON.stringify(n.follows.data[t]))return fcn_follows=n.follows,fcn_showNotification(fictioneer_tl.notification.followsResynchronized),void fcn_updateFollowsView();(e=e??!fcn_follows.data[t])?fcn_follows.data[t]={story_id:parseInt(t),timestamp:Date.now()}:delete fcn_follows.data[t],n.follows.data[t]=fcn_follows.data[t],n.lastLoaded=0,fcn().setUserData(n),fcn_updateFollowsView(),clearTimeout(fcn_userFollowsTimeout),fcn_userFollowsTimeout=setTimeout((()=>{FcnUtils.aPost({action:"fictioneer_ajax_toggle_follow",fcn_fast_ajax:1,story_id:t,set:e}).then((t=>{t.success||(fcn_showNotification(t.data.failure??t.data.error??fictioneer_tl.notification.error,5,"warning"),(t.data.error||t.data.failure)&&console.error("Error:",t.data.error??t.data.failure))})).catch((t=>{429===t.status?fcn_showNotification(fictioneer_tl.notification.slowDown,3,"warning"):t.status&&t.statusText&&fcn_showNotification(`${t.status}: ${t.statusText}`,5,"warning"),console.error(t)}))}),FcnGlobals.debounceRate)}}function fcn_updateFollowsView(){const t=fcn().userData();if(!fcn_follows||!t.follows)return;_$$(".button-follow-story").forEach((t=>{t.classList.toggle("_followed",!!fcn_follows?.data[t.dataset.storyId])}));const e=parseInt(fcn_follows.new)>0;_$$(".mark-follows-read, .follows-alert-number, .mobile-menu-button").forEach((t=>{t.classList.toggle("_new",e),e>0&&(t.dataset.newCount=fcn_follows.new)}))}function fcn_setupFollowsHTML(){fcn_followsMenuItem.classList.contains("_loaded")||fcn_ajaxGet({action:"fictioneer_ajax_get_follows_notifications",fcn_fast_ajax:1}).then((t=>{if(t.data.html){const e=_$$$("follow-menu-scroll");e&&(e.innerHTML=t.data.html);const n=_$$$("mobile-menu-follows-list");n&&(n.innerHTML=t.data.html),!1===fcn().userData().loggedIn&&(fcn().removeUserData(),fcn().fetchUserData())}})).catch((t=>{429===t.status?fcn_showNotification(fictioneer_tl.notification.slowDown,3,"warning"):t.status&&t.statusText&&fcn_showNotification(`${t.status}: ${t.statusText}`,5,"warning"),_$$$("follow-menu-scroll")?.remove(),_$$$("mobile-menu-follows-list")?.remove()})).then((()=>{fcn_followsMenuItem.classList.add("_loaded")}))}function fcn_markFollowsRead(){if(!fcn_followsMenuItem.classList.contains("_new")||!fcn_followsMenuItem.classList.contains("_loaded"))return;_$$(".mark-follows-read, .follows-alert-number, .follow-item, .mobile-menu-button").forEach((t=>{t.classList.remove("_new")}));const t=fcn().userData();t.new=0,t.lastLoaded=0,fcn().setUserData(t),FcnUtils.aPost({action:"fictioneer_ajax_mark_follows_read",fcn_fast_ajax:1}).catch((t=>{t.status&&t.statusText&&fcn_showNotification(`${t.status}: ${t.statusText}`,5,"warning")}))}function fcn_removeItemOnce(t,e){var n=t.indexOf(e);return n>-1&&t.splice(n,1),t}function fcn_initializeCheckmarks(t){const e=t.detail.data.checkmarks;!1!==e&&(Array.isArray(e.data)&&0===e.data.length&&(e.data={}),fcn_checkmarks=e,fcn_updateCheckmarksView(),localStorage.removeItem("fcnBookshelfContent"),_$$("button.checkmark").forEach((t=>{t.addEventListener("click",(t=>{fcn_clickCheckmark(t.currentTarget)}))})))}function fcn_toggleCheckmark(t,e,n=null,a=null,o="toggle"){const s=fcn().userData();if(fcn_checkmarks&&s.checkmarks){if(localStorage.removeItem("fcnBookshelfContent"),"toggle"===o&&JSON.stringify(fcn_checkmarks.data[t])!==JSON.stringify(s.checkmarks.data[t]))return fcn_checkmarks=s.checkmarks,fcn_showNotification(fictioneer_tl.notification.checkmarksResynchronized),void fcn_updateCheckmarksView();if(fcn_checkmarks.data[t]||(fcn_checkmarks.data[t]=[]),s.checkmarks.data[t]||(s.checkmarks.data[t]=[]),n&&"progress"===e&&!fcn_checkmarks.data[t].includes(n)&&fcn_checkmarks.data[t].push(n),n&&"chapter"===e)if(!fcn_checkmarks.data[t].includes(n)&&"unset"!==o||"set"===o)fcn_checkmarks.data[t].push(n),a&&(a.classList.add("marked"),a.setAttribute("aria-checked",!0));else{fcn_removeItemOnce(fcn_checkmarks.data[t],n),a&&(a.classList.remove("marked"),a.setAttribute("aria-checked",!1)),fcn_removeItemOnce(fcn_checkmarks.data[t],t);const e=_$('button[data-type="story"]');e&&(e.classList.remove("marked"),e.setAttribute("aria-checked",!1))}if("story"===e){const e=(fcn_checkmarks.data[t].includes(t)||"unset"===o)&&"set"!==o;fcn_checkmarks.data[t]=[],e||(_$$("button.checkmark").forEach((e=>{fcn_checkmarks.data[t].push(parseInt(e.dataset.id))})),fcn_checkmarks.data[t].includes(t)||fcn_checkmarks.data[t].push(t))}fcn_checkmarks.data[t]=fcn_checkmarks.data[t].filter(((t,e,n)=>n.indexOf(t)==e)),s.checkmarks.data[t]=fcn_checkmarks.data[t],s.lastLoaded=0,fcn().setUserData(s),fcn_updateCheckmarksView(),clearTimeout(fcn_userCheckmarksTimeout),fcn_userCheckmarksTimeout=setTimeout((()=>{fcn_updateCheckmarks(t,fcn_checkmarks.data[t])}),FcnGlobals.debounceRate)}}function fcn_clickCheckmark(t){fcn_toggleCheckmark(parseInt(t.dataset.storyId),t.dataset.type,parseInt(t.dataset.id),t)}function fcn_updateCheckmarks(t,e=null){e=e||fcn().userData().checkmarks.data[t],FcnUtils.aPost({action:"fictioneer_ajax_set_checkmark",fcn_fast_ajax:1,story_id:t,update:e.join(" ")}).then((t=>{t.success||(fcn_showNotification(t.data.failure??t.data.error??fictioneer_tl.notification.error,3,"warning"),(t.data.error||t.data.failure)&&console.error("Error:",t.data.error??t.data.failure))})).catch((t=>{t.status&&t.statusText&&fcn_showNotification(`${t.status}: ${t.statusText}`,5,"warning"),console.error(t)}))}function fcn_updateCheckmarksView(){const t=fcn().userData(),e=t.checkmarks;if(!e)return;const n=parseInt(document.body.dataset.storyId);if(n){const a=e.data[n]&&e.data[n].includes(n);if(a){let a=!1;_$$("button.checkmark").forEach((t=>{const o=parseInt(t.dataset.id);e.data[n].includes(o)||(e.data[n].push(o),a=!0)})),a&&(t.checkmarks=e,fcn().setUserData(t),fcn_updateCheckmarks(n,e.data[n]))}_$$$("ribbon-read")?.classList.toggle("hidden",!a)}_$$("button.checkmark").forEach((t=>{const n=parseInt(t.dataset.storyId);if(e.data[n]){const a=e.data[n].includes(parseInt(t.dataset.id));t.classList.toggle("marked",a),t.setAttribute("aria-checked",a)}}))}function fcn_initializeReminders(t){const e=t.detail.data.reminders;!1!==e&&(Array.isArray(e.data)&&0===e.data.length&&(e.data={}),fcn_reminders=e,fcn_updateRemindersView(),localStorage.removeItem("fcnBookshelfContent"))}function fcn_toggleReminder(t,e=null){const n=fcn().userData();if(fcn_reminders&&n.reminders){if(localStorage.removeItem("fcnBookshelfContent"),null===e&&JSON.stringify(fcn_reminders.data[t])!==JSON.stringify(n.reminders.data[t]))return fcn_reminders=n.reminders,fcn_showNotification(fictioneer_tl.notification.remindersResynchronized),void fcn_updateRemindersView();(e=e??!fcn_reminders.data[t])?fcn_reminders.data[t]={story_id:parseInt(t),timestamp:Date.now()}:delete fcn_reminders.data[t],n.reminders.data[t]=fcn_reminders.data[t],n.lastLoaded=0,fcn().setUserData(n),fcn_updateRemindersView(),clearTimeout(fcn_userRemindersTimeout),fcn_userRemindersTimeout=setTimeout((()=>{FcnUtils.aPost({action:"fictioneer_ajax_toggle_reminder",fcn_fast_ajax:1,story_id:t,set:e}).then((t=>{t.success||(fcn_showNotification(t.data.failure??t.data.error??fictioneer_tl.notification.error,5,"warning"),(t.data.error||t.data.failure)&&console.error("Error:",t.data.error??t.data.failure))})).catch((t=>{429===t.status?fcn_showNotification(fictioneer_tl.notification.slowDown,3,"warning"):t.status&&t.statusText&&fcn_showNotification(`${t.status}: ${t.statusText}`,5,"warning"),console.error(t)}))}),FcnGlobals.debounceRate)}}function fcn_updateRemindersView(){const t=fcn().userData();fcn_reminders&&t.reminders&&_$$(".button-read-later").forEach((t=>{t.classList.toggle("_remembered",!!fcn_reminders.data[t.dataset.storyId])}))}function fcn_wrapInTag(t,e,n={}){const a=n.href?' href="'+n.href+'" target="_blank" rel="nofollow noreferrer noopener"':"",o=n.shortcode?["[","]"]:["<",">"],s=t.selectionStart,i=t.selectionEnd,r=o[0]+e+a+o[1],c=o[0]+"/"+e+o[1],l=r+t.value.substring(s,i)+c;t.value=t.value.substring(0,s)+l+t.value.substring(i,t.value.length),t.setSelectionRange(s+r.length,i+r.length),t.focus()}document.addEventListener("fcnUserDataReady",(t=>{fcn_initializeFollows(t)})),fcn_followsMenuItem?.addEventListener("mouseover",(()=>{fcn_setupFollowsHTML()}),{once:!0}),fcn_followsMenuItem?.addEventListener("focus",(()=>{fcn_setupFollowsHTML()}),{once:!0}),_$('.mobile-menu__frame-button[data-frame-target="follows"]')?.addEventListener("click",(()=>{fcn_setupFollowsHTML()}),{once:!0}),_$$(".button-follow-story").forEach((t=>{t.addEventListener("click",(t=>{fcn_toggleFollow(t.currentTarget.dataset.storyId)}))})),_$$(".mark-follows-read").forEach((t=>{t.addEventListener("click",(()=>{fcn_markFollowsRead()}))})),document.addEventListener("fcnUserDataReady",(t=>{fcn_initializeCheckmarks(t)})),document.addEventListener("fcnUserDataReady",(t=>{fcn_initializeReminders(t)})),_$$(".button-read-later").forEach((t=>{t.addEventListener("click",(t=>{fcn_toggleReminder(t.currentTarget.dataset.storyId)}))})),document.addEventListener("fcnUserDataReady",(()=>{fcn().userData().fingerprint==document.documentElement.dataset.authorFingerprint&&document.body.classList.add("is-post-author")}));const fcn_ajaxCommentForm=_$$$("ajax-comment-form-target");function fcn_setupCommentFormObserver(){const t=new IntersectionObserver((([e])=>{e.isIntersecting&&(fcn_getCommentForm(),t.disconnect())}),{rootMargin:"450px",threshold:1});t.observe(fcn_ajaxCommentForm)}function fcn_getCommentForm(){let t;fcn_ajaxGet({action:"fictioneer_ajax_get_comment_form",post_id:_$$$("comments").dataset.postId,fcn_fast_comment_ajax:1}).then((e=>{if(e.success){const t=document.createElement("div");t.innerHTML=e.data.html;const n=t.querySelector("#comment_post_ID"),a=t.querySelector("#cancel-comment-reply-link"),o=t.querySelector(".logout-link");n&&(n.value=e.data.postId),a&&(a.href="#respond"),o&&(o.href=_$$$("comments").dataset.logoutUrl),fcn_ajaxCommentForm.innerHTML=t.innerHTML,t.remove(),fcn_applyCommentStack(),_$$$("fictioneer-ajax-nonce")?.remove(),document.body.appendChild(fcn_html`${e.data.nonceHtml}`)}else t=fcn_buildErrorNotice(e.data.error)})).catch((e=>{t=fcn_buildErrorNotice(e)})).then((()=>{fcn_ajaxCommentForm.classList.remove("comments-skeleton"),t&&(fcn_ajaxCommentForm.innerHTML="",fcn_ajaxCommentForm.appendChild(t))}))}fcn_ajaxCommentForm&&document.addEventListener("fcnUserDataReady",(()=>{fcn_setupCommentFormObserver()}));var fcn_commentStack=[];function fcn_applyCommentStack(t=null){(t=t??_$(FcnGlobals.commentFormSelector))&&("TEXTAREA"==t.tagName?(fcn_commentStack.forEach((e=>{t.value+=e})),fcn_adjustTextarea(t)):"DIV"==t.tagName&&fcn_commentStack.forEach((e=>{t.innerHTML+=e})),fcn_commentStack=[])}application.register("fictioneer-comment-form",class extends Stimulus.Controller{static get targets(){return["submit","cancel","textarea","privateToggle","emailNotificationToggle","author","email","cookies","privacyPolicy"]}initialize(){this.respond=this.element.closest("#respond"),this.order=this.respond.closest(".fictioneer-comments")?.dataset.order??"desc",this.parent=this.element.querySelector("#comment_parent"),this.addJSTrap()}adjustTextarea(){fcn_adjustTextarea(this.textareaTarget)}toolbarButtons(t){const e=t.target.closest("[data-bbcode]");e&&fcn_wrapInTag(this.textareaTarget,e.dataset.bbcode,{shortcode:!0})}keyComboCodes(t){if(_$(".fictioneer-comment-toolbar")&&"TEXTAREA"===document.activeElement.tagName&&(t.ctrlKey||t.metaKey)){const e=t.key.toLowerCase();if(["b","i","s","q","h","l"].includes(e)){t.preventDefault();const n={q:"quote",h:"spoiler",l:"link"};fcn_wrapInTag(document.activeElement,n[e]||e,{shortcode:!0})}}}addJSTrap(){this.element.appendChild(fcn_html`
      <input type="hidden" name="fictioneer_comment_validator" value="299792458">
    `)}revealFormInputs(){this.respond.querySelectorAll(".fictioneer-respond__form-actions, .fictioneer-respond__form-bottom").forEach((t=>{t.classList.remove("hidden")}))}ajaxSubmit(t){if(Date.now()<FcnGlobals.pageLoadTimestamp+3e3)return;if(this.element.classList.remove("_invalid"),!document.documentElement.dataset.ajaxSubmit)return this.element.reportValidity()?(this.submitTarget.value=this.submitTarget.dataset.disabled,this.submitTarget.classList.add("_disabled"),void setTimeout((()=>{this.submitTarget.value=this.submitTarget.dataset.enabled,this.submitTarget.classList.remove("_disabled")}),2e3)):void this.element.classList.add("_invalid");if(t.preventDefault(),!this.element.reportValidity())return void this.element.classList.add("_invalid");const e=new FormData(this.element),n=Object.fromEntries(e.entries()),a=n.comment_parent??0,o=_$$$(`comment-${a}`),s=this.textareaTarget.value.length>1;let i=!0,r=!0;if(this.textareaTarget.classList.toggle("_error",!s),this.hasPrivacyPolicyTarget&&(r=this.privacyPolicyTarget.checked,this.privacyPolicyTarget.classList.toggle("_error",!r)),this.hasEmailTarget&&this.emailTarget?.value.length>0&&(i=/\S+@\S+\.\S+/.test(this.emailTarget.value),this.emailTarget.classList.toggle("_error",!i)),!s||!r||!i)return;this.element.classList.add("ajax-in-progress"),this.submitTarget.value=this.submitTarget.dataset.disabled,this.submitTarget.disabled=!0;const c={action:"fictioneer_ajax_submit_comment",content:this.textareaTarget.value,depth:o?parseInt(o.dataset.depth)+1:1,fcn_fast_comment_ajax:1,...n};this.hasEmailTarget&&this.emailTarget?.value&&(c.email=this.emailTarget.value),this.hasAuthorTarget&&this.authorTarget?.value&&(c.author=this.authorTarget.value),_$$$("comment-submit-error-notice")?.remove(),FcnUtils.aPost(c).then((t=>{if(t.success&&t.data?.comment){let e=_$(".commentlist"),n="insertBefore";if(e&&!o&&e.firstElementChild){let t=null;if(e.firstElementChild.classList.contains("_sticky"))for(t=e.firstElementChild,e=t,n="insertAfter";t.nextElementSibling&&t.nextElementSibling.classList.contains("_sticky");)t=e.nextElementSibling,e=t}if(e||(e=document.createElement("ol"),e.classList="fictioneer-comments__list commentlist",_$$$("comments").appendChild(e),n="append"),o&&(e=o.querySelector(".children"),n="append",!e)){const t=document.createElement("ol");o.appendChild(t),e=t}let a=document.createElement("div");switch(a.innerHTML=t.data.comment,a=a.firstChild,n){case"append":e.appendChild(a);break;case"insertBefore":e.insertBefore(a,e.firstChild);break;case"insertAfter":e.nextSibling?e.parentNode.insertBefore(a,e.nextSibling):e.parentNode.appendChild(a)}this.textareaTarget.value="",this.textareaTarget.style.height="","0"!=this.parent.value&&this.cancelTarget.click();const s=window.location.protocol+"//"+window.location.host+window.location.pathname;("desc"!=this.order||FcnGlobals.urlParams.corder)&&(FcnGlobals.urlParams.corder=this.order),t.data.commentcode&&(FcnGlobals.urlParams.commentcode=t.data.commentcode);let i=Object.entries(FcnGlobals.urlParams).map((([t,e])=>`${t}=${e}`)).join("&");""!==i&&(i=`?${i}`),history.replaceState({path:s},"",s+i+`#comment-${t.data.comment_id}`),a.scrollIntoView({behavior:"smooth"})}else this.element.insertBefore(fcn_buildErrorNotice(t.data.failure??t.data.error??fictioneer_tl.notification.error,"comment-submit-error-notice",!1),this.element.firstChild),console.error("Error:",t.data.error??t.data.failure??"Unknown")})).catch((t=>{this.element.insertBefore(fcn_buildErrorNotice(`${t.statusText} (${t.status})`,"comment-submit-error-notice"),this.element.firstChild)})).then((()=>{this.element.classList.remove("ajax-in-progress"),this.submitTarget.disabled=!1,this.submitTarget.value=this.submitTarget.dataset.enabled}))}togglePrivate(){this.respond.classList.toggle("_private",this.privateToggleTarget.checked)}}),application.register("fictioneer-comment",class extends Stimulus.Controller{static get targets(){return["modMenuToggle","modMenu","modIcon","editLink","flagButton","deleteButton","editButton","content","inlineEditWrapper","inlineEditTextarea","inlineEditButtons","inlineEditSubmit","editNote"]}static values={id:Number,timestamp:Number,fingerprint:String};comment=this.element.closest(".fictioneer-comment");menuOpen=!1;initialize(){document.addEventListener("fcnLastClicked",(t=>{t.detail?.element?.closest(`[data-fictioneer-comment-id-value="${this.idValue}"]`)||this.#c()})),document.addEventListener("click",(t=>{t.target.closest(`[data-fictioneer-comment-id-value="${this.idValue}"]`)||this.#c()}))}connect(){this.hasModMenuTarget&&(this.editLink=this.modMenuTarget.dataset.editLink),fcn().userData().fingerprint?(this.#k(),this.#b()):document.addEventListener("fcnUserDataReady",(()=>{this.#k(),this.#b()})),this.hasInlineEditTextareaTarget&&this.inlineEditTextareaTarget.addEventListener("input",(()=>{fcn_adjustTextarea(this.inlineEditTextareaTarget)})),document.addEventListener("toggledLastClick",(t=>{!t.detail.force&&this.menuOpen&&this.#c()}))}toggleMenu(t=null){this.hasModMenuTarget&&(!this.menuOpen&&"close"!==t||"open"===t?this.#l():this.#c())}mouseLeave(){this.hasModMenuTarget&&this.menuOpen&&(this.#c(),document.dispatchEvent(new CustomEvent("fcnRemoveLastClicked")))}commentClick(t){t.target.closest('[data-fictioneer-comment-target="modMenuToggle"]')||this.#c()}approve(){this.#v("approve")}unapprove(){this.#v("unapprove")}offensive(){this.#v("offensive")}unoffensive(){this.#v("unoffensive")}open(){this.#v("open")}close(){this.#v("close")}sticky(){this.#v("sticky")}unsticky(){this.#v("unsticky")}trash(){this.#v("trash")}spam(){this.#v("spam")}flag(){FcnUtils.loggedIn()&&this.hasFlagButtonTarget&&(this.comment.classList.contains("ajax-in-progress")||(this.comment.classList.add("ajax-in-progress"),FcnUtils.aPost({action:"fictioneer_ajax_report_comment",id:this.idValue,dubious:this.flagButtonTarget.classList.contains("_dubious"),fcn_fast_comment_ajax:1}).then((t=>{t.success?(this.flagButtonTarget.classList.toggle("on",t.data.flagged),this.flagButtonTarget.classList.remove("_dubious"),t.data.resync&&fcn_showNotification(t.data.resync)):(fcn_showNotification(t.data.failure??t.data.error??fictioneer_tl.notification.error,5,"warning"),console.error("Error:",t.data.error??t.data.failure??"Unknown"))})).catch((t=>{this.#$(t)})).then((()=>{this.comment.classList.remove("ajax-in-progress")}))))}selfDelete(){if(!FcnUtils.loggedIn()||!this.hasDeleteButtonTarget)return;const t=prompt(this.deleteButtonTarget.dataset.dialogMessage);t&&t.toLowerCase()==this.deleteButtonTarget.dataset.dialogConfirm.toLowerCase()&&(this.comment.classList.contains("ajax-in-progress")||(this.comment.classList.add("ajax-in-progress"),FcnUtils.aPost({action:"fictioneer_ajax_delete_my_comment",comment_id:this.idValue,fcn_fast_comment_ajax:1}).then((t=>{t.success?(this.comment.classList.add("_deleted"),this.element.innerHTML=t.data.html):(fcn_showNotification(t.data.failure??t.data.error??fictioneer_tl.notification.error,5,"warning"),console.error("Error:",t.data.error??t.data.failure??"Unknown"))})).catch((t=>{this.#$(t)})).then((()=>{this.comment.classList.remove("ajax-in-progress")}))))}startEditInline(){const t=_$$$("template-comment-inline-edit-form")?.content.cloneNode(!0);t&&(this.comment.classList.add("_editing"),this.commentEditUndo=this.inlineEditTextareaTarget.value,this.inlineEditWrapperTarget.appendChild(t),this.contentTarget.hidden=!0,this.inlineEditWrapperTarget.hidden=!1,this.inlineEditTextareaTarget.style.height=`${this.inlineEditTextareaTarget.scrollHeight}px`,fcn_adjustTextarea(this.inlineEditTextareaTarget))}cancelEditInline(){this.#E(!0)}submitEditInline(){this.inlineEditTextareaTarget.value!==this.commentEditUndo?(this.inlineEditWrapperTarget.classList.add("ajax-in-progress"),this.inlineEditSubmitTarget.innerHTML=this.inlineEditSubmitTarget.dataset.disabled,this.inlineEditSubmitTarget.disabled=!0,FcnUtils.aPost({action:"fictioneer_ajax_edit_comment",comment_id:this.idValue,content:this.inlineEditTextareaTarget.value,fcn_fast_comment_ajax:1}).then((t=>{if(t.success){this.contentTarget.innerHTML=t.data.content,this.#E(!1,t.data.raw);let e=this.editNoteTarget;this.hasEditNoteTarget||(e=document.createElement("div")),e.classList.add("fictioneer-comment__edit-note"),e.dataset.fictioneerCommentTarget="editNote",e.innerHTML=t.data.edited,this.contentTarget.parentNode.appendChild(e)}else this.#E(!0),fcn_showNotification(t.data.failure??t.data.error??fictioneer_tl.notification.error,5,"warning"),console.error("Error:",t.data.error??t.data.failure??"Unknown")})).catch((t=>{this.#E(!0),this.#$(t)})).then((()=>{this.inlineEditWrapperTarget.classList.remove("ajax-in-progress"),this.hasInlineEditSubmitTarget&&(this.inlineEditSubmitTarget.innerHTML=this.inlineEditSubmitTarget.dataset.enabled,this.inlineEditSubmitTarget.disabled=!1)}))):this.#E(!0)}keyComboCodes(t){if(_$(".fictioneer-comment-toolbar")&&"TEXTAREA"===document.activeElement.tagName&&(t.ctrlKey||t.metaKey)){const e=t.key.toLowerCase();if(["b","i","s","q","h","l"].includes(e)){t.preventDefault();const n={q:"quote",h:"spoiler",l:"link"};fcn_wrapInTag(document.activeElement,n[e]||e,{shortcode:!0})}}}#k(){this.hasDeleteButtonTarget&&this.#w()&&(this.deleteButtonTarget.hidden=!1)}#b(){let t=parseInt(document.documentElement.dataset.editTime);if(t&&(t=t>0?6e4*t:t,this.hasEditButtonTarget&&this.#w())){if(t>0&&parseInt(this.timestampValue)+t<Date.now())return;this.editButtonTarget.hidden=!1}}#w(){const t=fcn().userData().fingerprint;return!(!t||!this.hasFingerprintValue)&&t===this.fingerprintValue}#E(t=!1,e=null){this.comment.classList.remove("_editing"),this.contentTarget.hidden=!1,this.inlineEditWrapperTarget.hidden=!0,this.hasInlineEditButtonsTarget&&this.inlineEditButtonsTarget.remove(),t&&this.commentEditUndo?this.inlineEditTextareaTarget.value=this.commentEditUndo:e&&(this.inlineEditTextareaTarget.value=e),this.commentEditUndo=null}#l(){const t=_$$$("template-comment-frontend-moderation-menu")?.content.cloneNode(!0);t&&this.hasModMenuTarget&&(this.modMenuTarget.appendChild(t),this.editLinkTarget.href=this.editLink,this.menuOpen=!0)}#c(){if(this.hasModMenuTarget&&this.menuOpen)for(this.menuOpen=!1;this.modMenuTarget.firstChild;)this.modMenuTarget.removeChild(this.modMenuTarget.firstChild)}#L(t){this.modIconTarget.classList="fa-solid fa-triangle-exclamation mod-menu-toggle-icon",this.modIconTarget.style.color="var(--notice-warning-background)",this.modMenuToggleTarget.style.opacity="1",t&&fcn_showNotification(t,5,"warning")}#$(t){t.status&&t.statusText&&fcn_showNotification(`${t.status}: ${t.statusText}`,5,"warning"),console.error("Error:",t)}#v(t){this.comment.classList.contains("ajax-in-progress")||(this.comment.classList.add("ajax-in-progress"),"trash"!=t&&"spam"!=t||(this.comment.style.height=this.comment.clientHeight+"px"),FcnUtils.aPost({action:"fictioneer_ajax_moderate_comment",operation:t,id:this.idValue,fcn_fast_comment_ajax:1}).then((t=>{if(t.success){const e=t.data.operation,n={sticky:{action:"add",className:"_sticky"},unsticky:{action:"remove",className:"_sticky"},offensive:{action:"add",className:"_offensive"},unoffensive:{action:"remove",className:"_offensive"},approve:{action:"remove",className:"_unapproved"},unapprove:{action:"add",className:"_unapproved"},open:{action:"remove",className:"_closed"},close:{action:"add",className:"_closed"}};if(e in n){const{action:t,className:a}=n[e];this.comment.classList[t](a)}else"trash"!==e&&"spam"!==e||(this.comment.style.cssText="overflow: hidden; height: 0; margin: 0; opacity: 0;")}else this.#L(t.data.failure??t.data.error??fictioneer_tl.notification.error)})).catch((t=>{this.#L(t?.status&&t?.statusText?`${t.status}: ${t.statusText}`:t)})).then((()=>{this.comment.classList.remove("ajax-in-progress"),this.#c(),document.dispatchEvent(new CustomEvent("fcnRemoveLastClicked"))})))}});const fcn_commentSection=_$("#comments[data-ajax-comments]");function fcn_getCommentSection(t=null,e=null,n=null,a=!1){if(!fcn_commentSection)return;let o,s="",i=_$(FcnGlobals.commentFormSelector);if(i&&(s=i.value),fcn_commentSection.classList.contains("ajax-in-progress"))return;if(fcn_commentSection.classList.add("ajax-in-progress"),e||(e=FcnGlobals.urlParams.pg??1),n||(n=n??fcn_commentSection.dataset.order??"desc"),!fcn_commentSection)return;const r={action:"fictioneer_ajax_get_comment_section",post_id:t??fcn_commentSection.dataset.postId,page:parseInt(e),corder:n,fcn_fast_comment_ajax:1};FcnGlobals.urlParams.commentcode&&(r.commentcode=FcnGlobals.urlParams.commentcode),fcn_ajaxGet(r).then((t=>{if(t.success){e=t.data.page,fcn_commentSection.dataset.page=e;const o=document.createElement("div");if(o.innerHTML=t.data.html,o.querySelector("#comment_post_ID")){o.querySelector("#comment_post_ID").value=t.data.postId,o.querySelector("#cancel-comment-reply-link").href="#respond";const e=o.querySelector(".logout-link");e&&(e.href=fcn_commentSection.dataset.logoutUrl)}fcn_commentSection.innerHTML=o.innerHTML,o.remove(),i=_$(FcnGlobals.commentFormSelector),i&&!t.data.disabled&&(i.value=s,fcn_applyCommentStack(i));const r=location.hash.includes("#comment")?location.hash:".respond",c=document.querySelector(r)??_$$$("respond");a&&c.scrollIntoView({behavior:"smooth"});const l=window.location.protocol+"//"+window.location.host+window.location.pathname;(e>1||FcnGlobals.urlParams.pg)&&(FcnGlobals.urlParams.pg=e),("desc"!=n||FcnGlobals.urlParams.corder)&&(FcnGlobals.urlParams.corder=n);let d=Object.entries(FcnGlobals.urlParams).map((([t,e])=>`${t}=${e}`)).join("&");""!==d&&(d=`?${d}`),window.history.pushState({path:l},"",l+d+location.hash)}else o=fcn_buildErrorNotice(t.data.error)})).catch((t=>{o=fcn_buildErrorNotice(t)})).then((()=>{fcn_commentSection.classList.remove("ajax-in-progress"),o&&(fcn_commentSection.innerHTML="",fcn_commentSection.appendChild(o))}))}function fcn_reloadCommentsPage(t=null){fcn_getCommentSection(null,t,null,!0)}function fcn_jumpToCommentPage(){const t=parseInt(window.prompt(fictioneer_tl.notification.enterPageNumber));t>0&&fcn_reloadCommentsPage(t)}var fct_commentSectionObserver;function fcn_setupCommentSectionObserver(){fct_commentSectionObserver=new IntersectionObserver((([t])=>{t.isIntersecting&&(fcn_getCommentSection(),fct_commentSectionObserver.disconnect())}),{rootMargin:"450px",threshold:1}),fcn_commentSection&&fct_commentSectionObserver.observe(fcn_commentSection)}function fcn_loadCommentEarly(){fcn_commentSection&&location.hash.includes("#comment")&&(_$(FcnGlobals.commentFormSelector)||(fct_commentSectionObserver.disconnect(),fcn_reloadCommentsPage()))}function fcn_toggleCommentOrder(t){const e=t.closest(".fictioneer-comments"),n="desc"==e.dataset.order;e.dataset.order=n?"asc":"desc",t.classList.toggle("_on",!n),t.classList.toggle("_off",n),fcn_reloadCommentsPage(e.dataset.page)}document.addEventListener("fcnUserDataReady",(()=>{fcn_setupCommentSectionObserver()})),document.addEventListener("fcnUserDataReady",(()=>{fcn_loadCommentEarly()})),_$(".fictioneer-comments")?.addEventListener("click",(t=>{if(t.target.closest("button[data-page-jump]"))return void fcn_jumpToCommentPage();const e=t.target.closest("button[data-page]");if(e)return void fcn_reloadCommentsPage(e.dataset.page);const n=t.target.closest("button[data-toggle-order]");n&&fcn_toggleCommentOrder(n)}));const fcn_bookshelfTarget=_$$$("ajax-bookshelf-target");function fcn_getBookshelfContent(){return FcnUtils.parseJSON(localStorage.getItem("fcnBookshelfContent"))??{html:{},count:{}}}function fcn_updateBookshelfView(t=null,e=null,n=null,a=!1){let o=fcn_getBookshelfContent();const s=(t=t??fcn_bookshelfTarget.dataset.action)+(e=e??fcn_bookshelfTarget.dataset.page)+(n=n??fcn_bookshelfTarget.dataset.order);if(!o.timestamp||o.timestamp+6e4<Date.now())return localStorage.removeItem("fcnBookshelfContent"),o={html:{},count:{}},void fcn_fetchBookshelfPart(t,e,n,a);o.html&&o.html[s]?(fcn_bookshelfTarget.innerHTML=o.html[s],fcn_bookshelfTarget.classList.remove("ajax-in-progress"),fcn_bookshelfTarget.dataset.page=e,_$(".item-number").innerHTML=`(${o.count[t]})`,a&&_$$$("main").scrollIntoView({behavior:"smooth"})):fcn_fetchBookshelfPart(t,e,n,a)}function fcn_browseBookshelfPage(t){fcn_bookshelfTarget.classList.add("ajax-in-progress"),fcn_updateBookshelfView(null,t,null,!0),history.pushState({},"",fcn_buildUrl({tab:fcn_bookshelfTarget.dataset.tab,pg:t,order:fcn_bookshelfTarget.dataset.order}).href)}function fcn_fetchBookshelfPart(t,e,n,a=!1){const o=t+e+n,s=fcn_getBookshelfContent();fcn_ajaxGet({action:t,fcn_fast_ajax:1,page:e,order:n}).then((n=>{n.success?(s.timestamp=Date.now(),s.html[o]=n.data.html,s.count[t]=n.data.count,localStorage.setItem("fcnBookshelfContent",JSON.stringify(s)),fcn_bookshelfTarget.innerHTML=n.data.html,fcn_bookshelfTarget.dataset.page=e,_$(".item-number").innerHTML=`(${n.data.count})`):(fcn_bookshelfTarget.innerHTML="",fcn_bookshelfTarget.appendChild(fcn_buildErrorNotice(n.data.error)))})).catch((t=>{_$(".item-number").innerHTML="",fcn_bookshelfTarget.innerHTML="",fcn_bookshelfTarget.appendChild(fcn_buildErrorNotice(`${t.status}: ${t.statusText}`))})).then((()=>{fcn_bookshelfTarget.classList.remove("ajax-in-progress"),a&&_$$$("main").scrollIntoView({behavior:"smooth"})}))}fcn_bookshelfTarget&&document.addEventListener("fcnUserDataReady",(()=>{fcn_updateBookshelfView()})),_$(".bookshelf__list")?.addEventListener("click",(t=>{const e=t.target.closest(".page-numbers[data-page]");e&&fcn_browseBookshelfPage(e.dataset.page)}));