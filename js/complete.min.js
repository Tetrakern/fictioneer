const _$=document.querySelector.bind(document),_$$=document.querySelectorAll.bind(document),_$$$=document.getElementById.bind(document),FcnUtils={userDataDefaults:{lastLoaded:0,timestamp:0,loggedIn:"pending",follows:!1,reminders:!1,checkmarks:!1,bookmarks:null,likes:null,fingerprint:!1,nonceHtml:"",nonce:"",isAdmin:!1,isModerator:!1,isAuthor:!1,isEditor:!1},userData(){const t=FcnUtils.parseJSON(localStorage.getItem("fcnUserData"))||{};return{...FcnUtils.userDataDefaults,...t}},ensureArray:t=>Array.isArray(t)?t:Object.values(t),resetUserData(){const t=FcnUtils.parseJSON(localStorage.getItem("fcnUserData"))||{},e={lastLoaded:t.lastLoaded??0,loggedIn:(!FcnGlobals.ajaxAuth||!1!==t.loggedIn)&&"pending"};localStorage.setItem("fcnUserData",JSON.stringify({...t,...FcnUtils.userDataDefaults,...e}))},removeUserData(){localStorage.removeItem("fcnUserData")},setUserData(t){localStorage.setItem("fcnUserData",JSON.stringify(t))},loggedInCache:null,loggedInCacheTime:0,loggedIn(){const t=Date.now();return null!==FcnUtils.loggedInCache&&t-FcnUtils.loggedInCacheTime<20||(FcnUtils.loggedInCache=FcnUtils.hasLoginCookie(),FcnUtils.loggedInCacheTime=t),FcnUtils.loggedInCache},hasLoginCookie(){const t=document.cookie.split(";");for(let e=0;e<t.length;e++){if(-1!==t[e].trim().indexOf("fcnLoggedIn="))return!0}return!1},async aGet(t={},e=null,n={}){try{return fcn_ajaxGet(t,e,n)}catch(t){throw console.error("aGet Error:",t),t}},async aPost(t={},e=null,n={}){try{return await fcn_ajaxPost(t,e,n)}catch(t){throw console.error("aPost Error:",t),t}},remoteAction(t,{element:e=null,callback:n=null,errorCallback:a=null,finalCallback:s=null,nonce:i=null,fast:r=!0,payload:o={}}={}){e?.classList.add("ajax-in-progress"),FcnUtils.aPost({action:t,fcn_fast_ajax:!!r,nonce:i??FcnUtils.nonce(),...o}).then((t=>{n&&n(t,e),t.success||(fcn_showNotification(t.data.failure??t.data.error??fictioneer_tl.notification.error,10,"warning"),(t.data.error||t.data.failure)&&console.error("Error:",t.data.error??t.data.failure))})).catch((t=>{429===t.status?fcn_showNotification(fictioneer_tl.notification.slowDown,3,"warning"):t.status&&t.statusText&&fcn_showNotification(`${t.status}: ${t.statusText}`,5,"warning"),a&&a(t,e),console.error(t)})).then((()=>{e?.classList.remove("ajax-in-progress"),s&&s(e)}))},parseJSON(t){if(null==t||"string"!=typeof t)return null;try{return JSON.parse(t)}catch(t){return null}},copyToClipboard(t,e=!1){e=e||fictioneer_tl.notification.copiedToClipboard,navigator.clipboard&&(navigator.clipboard.writeText(t),e&&fcn_showNotification(e,2))},clamp:(t,e,n)=>Math.min(Math.max(n,t),e),offset(t){const e=t.getBoundingClientRect();return{top:e.top+window.scrollY,left:e.left+window.scrollX}},throttle(t,e,n){var a,s,i,r=null,o=0;n||(n={});var c=function(){o=!1===n.leading?0:Date.now(),r=null,i=t.apply(a,s),r||(a=s=null)};return function(){var l=Date.now();o||!1!==n.leading||(o=l);var d=e-(l-o);return a=this,s=arguments,d<=0||d>e?(r&&(clearTimeout(r),r=null),o=l,i=t.apply(a,s),r||(a=s=null)):r||!1===n.trailing||(r=setTimeout(c,d)),i}},deleteCookie(t){document.cookie=t+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/"},deleteAllCookies(){localStorage.clear(),document.cookie.split(";").forEach((t=>{document.cookie=t.replace(/^ +/,"").replace(/=.*/,"=;expires="+(new Date).toUTCString()+";path=/")}))},setCookie(t,e,n=30){const a=new Date;a.setTime(a.getTime()+24*n*60*60*1e3);const s="expires="+a.toUTCString();document.cookie=t+"="+encodeURIComponent(e)+";"+s+";SameSite=Strict;path=/"},getCookie(t){const e=t+"=",n=document.cookie.split(";");for(var a=0;a<n.length;a++){const t=n[a].trim();if(0==t.indexOf(e))return decodeURIComponent(t.substring(e.length,t.length))}return null},nonce:()=>_$$$("fictioneer-ajax-nonce")?.value??_$$$("general-fictioneer-nonce")?.value??_$('[name="fictioneer_nonce"]')?.value??0,buildUrl:(t={},e=null)=>(e=e?new URL(e):new URL(window.location.protocol+"//"+window.location.host+window.location.pathname),t&&Object.keys(t).forEach((n=>{e.searchParams.append(n,t[n])})),e),buildErrorNotice(t,e=!1,n=!0){console.error("Error:",t);const a=document.createElement("div");let s=t;return e&&(a.id=e),a.classList="notice _warning","object"==typeof t&&(s="",t.status&&(s=`${t.status}: `),t.statusText&&(s+=t.statusText),s||(s="Unknown error.")),a.innerHTML=`<i class="fa-solid fa-triangle-exclamation"></i><div>${n?FcnUtils.sanitizeHTML(s):s}</div>`,a},detectScreenCollision(t){const e=t.getBoundingClientRect(),n=window.innerHeight??document.documentElement.clientHeight,a=window.innerWidth??document.documentElement.clientWidth,s=(t.closest(".popup-menu-toggle")?.clientHeight??32)+16,i=n-e.bottom,r=[];return e.top<=50&&i>50+s&&r.push("top"),e.bottom>=n-50&&e.top>50+s&&r.push("bottom"),e.left<=10&&r.push("left"),e.right>=a-10&&r.push("right"),r},sanitizeHTML(t){const e=document.createElement("div");return e.textContent=t instanceof HTMLElement?t.textContent:String(t),e.innerHTML},scrollTo(t,e=64){window.scrollTo({top:t.getBoundingClientRect().top+window.scrollY-e,behavior:"smooth"})},html(...t){const e=document.createElement("template");return e.innerHTML=String.raw(...t).trim(),e.content.firstChild},toggleInProgress(t,e=null){(e=null!==e?e:!t.disabled)?(t.dataset.enableWith=t.innerHTML,t.innerHTML=t.dataset.disableWith??"Processing",t.disabled=!0,t.classList.add("disabled")):(t.innerHTML=t.dataset.enableWith,t.disabled=!1,t.classList.remove("disabled"))},adjustTextarea(t){t&&(t.style.height="auto",t.style.height=`${t.scrollHeight}px`)},isSearchEngineCrawler(){const t=navigator.userAgent.toLowerCase();return["googlebot","bingbot","slurp","duckduckbot","baiduspider","yandexbot","sogou","exabot","facebot","ia_archiver"].some((e=>t.includes(e)))},removeArrayItemOnce(t,e){var n=t.indexOf(e);return n>-1&&t.splice(n,1),t},extractTextNodes(t,e=new Set(["strong","b","em","i","u","code","a","s","kbd","sub","sup","span","label","button","ins","del","small","mark","q","abbr","time","cite"])){let n="";return t.childNodes.forEach((t=>{if(t.nodeType===Node.TEXT_NODE)n+=t.textContent.replace(/\r?\n/g," ");else if(t.nodeType===Node.ELEMENT_NODE){const a=t.tagName.toLowerCase();"br"===a?n+=" ":e.has(a)&&(n+=FcnUtils.extractTextNodes(t,e))}})),n.replace(/\s+/g," ").trim()},appendToComment(t){const e=_$(FcnGlobals.commentFormSelector);if(e)switch(e.tagName){case"TEXTAREA":e.value+=t,FcnUtils.adjustTextarea(e);break;case"DIV":e.innerHTML+=t}else FcnGlobals.commentStack.push(t)},yieldToMain:()=>globalThis.scheduler?.yield?scheduler.yield():new Promise((t=>{setTimeout(t,0)}))};async function fcn_ajaxRequest(t,e={},n=null,a={}){n&&!n.startsWith("http")&&(n=FcnGlobals.restURL+n),n=n||(fictioneer_ajax.ajax_url??FcnGlobals.ajaxURL),e={nonce:FcnUtils.nonce(),...e};const s={method:t,credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded","Cache-Control":"no-cache",...a},mode:"same-origin"};"POST"===t?s.body=new URLSearchParams(e):n=FcnUtils.buildUrl(e,n);const i=await fetch(n,s);switch(i.status){case 200:return i.json();case 204:return null;default:return Promise.reject(i)}}async function fcn_ajaxPost(t={},e=null,n={}){return fcn_ajaxRequest("POST",t,e,n)}async function fcn_ajaxGet(t={},e=null,n={}){return fcn_ajaxRequest("GET",t,e,n)}const FcnGlobals={eSite:_$$$("site"),urlParams:Object.fromEntries(new URLSearchParams(window.location.search).entries()),pageLoadTimestamp:Date.now(),ajaxLimitThreshold:Date.now()-parseInt(fictioneer_ajax.ttl),ajaxURL:fictioneer_ajax.ajax_url,restURL:fictioneer_ajax.rest_url,ffcnrURL:fictioneer_ajax.ffcnr_url,ffcnrAuth:fictioneer_ajax.ffcnr_auth,debounceRate:fictioneer_ajax.post_debounce_rate,ajaxAuth:document.documentElement.dataset.fictioneerAjaxAuthValue??!1,fonts:fictioneer_fonts??[],fontColors:fictioneer_font_colors??[],commentFormSelector:fictioneer_comments?.selector??"#comment",commentStack:[]};function fcn(){const t=window.FictioneerApp?.Controllers?.fictioneer;return t||{userData:FcnUtils.userData,setUserData:FcnUtils.setUserData,resetUserData:FcnUtils.resetUserData,removeUserData:FcnUtils.removeUserData}}function fcn_getUserData(){return FcnUtils.userData()}function fcn_setUserData(t){return FcnUtils.setUserData(t)}function fcn_cleanUpWebStorage(){["fcnBookshelfContent"].forEach((t=>localStorage.removeItem(t))),fcn().resetUserData()}function fcn_cleanUpGuestView(){document.body.classList.remove("logged-in","is-admin","is-moderator","is-editor","is-author"),_$$$("fictioneer-ajax-nonce")?.remove(),_$$(".only-moderators, .only-admins, .only-authors, .only-editors, .only-logged-in").forEach((t=>{t.remove()}))}function fcn_setLoggedInState(){const t=fcn().userData(),e=!0===t.loggedIn;document.body.classList.toggle("logged-in",e),document.body.classList.toggle("is-admin",t.isAdmin),document.body.classList.toggle("is-moderator",t.isModerator),document.body.classList.toggle("is-author",t.isAuthor),document.body.classList.toggle("is-editor",t.isEditor);const n=[];e&&(n.push('[data-fictioneer-id-param="login-modal"]'),n.push("#login-modal")),t.isAdmin||(n.push(".only-admins"),t.isModerator||(t.fingerprint==document.documentElement.dataset.authorFingerprint?n.push(".only-moderators:not(.only-comment-moderators)"):n.push(".only-moderators")),t.isAuthor||n.push(".only-authors"),t.isEditor||n.push(".only-editors")),_$$(n.join(", ")).forEach((t=>t.remove()))}function fcn_setAvatar(){const t=fcn().userData()?.avatarUrl;t&&_$$('[data-fictioneer-target="avatarWrapper"]').forEach((e=>{const n=document.createElement("img");n.classList.add("user-profile-image"),n.src=t,e.firstChild.remove(),e.appendChild(n)}))}Object.freeze(FcnGlobals),window.FictioneerApp=window.FictioneerApp||{},window.FictioneerApp.Controllers=window.FictioneerApp.Controllers||{},application.register("fictioneer",class extends Stimulus.Controller{static get targets(){return["avatarWrapper","modal","mobileMenuToggle","dcjProtected"]}static values={fingerprint:String,ageConfirmation:{type:Boolean,default:!1},ajaxAuth:{type:Boolean,default:!1},ajaxSubmit:{type:Boolean,default:!1},cachingActive:{type:Boolean,default:!1},publicCaching:{type:Boolean,default:!1},forceChildTheme:{type:Boolean,default:!1},editTime:{type:Number,default:15}};userReady=!1;lastModalToggle=null;currentModal=null;dcjProtection=!0;initialize(){if(FcnUtils.loggedIn()||this.ajaxAuthValue)this.fetchUserData();else{fcn_cleanUpWebStorage();const t=new CustomEvent("fcnUserDataReady",{detail:{data:this.userData(),time:new Date,loggedOut:!0},bubbles:!0,cancelable:!1});document.dispatchEvent(t)}this.hasDcjProtectedTarget&&["mousemove","touchstart","keydown"].forEach((t=>{window.addEventListener(t,this.liftProtection.bind(this),{once:!0})}))}connect(){window.FictioneerApp.Controllers.fictioneer=this}liftProtection(){this.dcjProtection&&this.hasDcjProtectedTarget&&(this.dcjProtectedTargets.forEach((t=>t.disabled=!1)),this.dcjProtection=!1)}userData(){return FcnUtils.userData()}setUserData(t){FcnUtils.setUserData(t)}resetUserData(){FcnUtils.resetUserData()}removeUserData(){FcnUtils.removeUserData()}fetchUserData(){let t=this.userData();if(FcnUtils.loggedIn()&&!1===t.loggedIn&&(this.removeUserData(),t=this.userData()),(FcnGlobals.ajaxLimitThreshold<t.lastLoaded||!1===t.loggedIn)&&("pending"!==t.loggedIn||this.ajaxAuthValue)){const e=new CustomEvent("fcnUserDataReady",{detail:{data:t,time:new Date,cached:!0},bubbles:!t.loggedIn,cancelable:t.loggedIn});return fcn_setAvatar(),t.nonceHtml&&this.#t(t.nonceHtml),document.dispatchEvent(e),void(this.userReady=!0)}FcnUtils.aGet({action:FcnGlobals.ffcnrAuth?"auth":"fictioneer_ajax_get_user_data",fcn_fast_ajax:1},FcnGlobals.ffcnrAuth?FcnGlobals.ffcnrURL:null).then((e=>{if(e.success){let n=this.userData();if(n=e.data,n.lastLoaded=Date.now(),n.checkmarks&&n.checkmarks.data)for(let t in n.checkmarks.data)n.checkmarks.data[t]=FcnUtils.ensureArray(n.checkmarks.data[t]);this.setUserData(n),fcn_setAvatar(),t.nonceHtml&&this.#t(t.nonceHtml);const a=new CustomEvent("fcnUserDataReady",{detail:{data:e.data,time:new Date,cached:!1},bubbles:!0,cancelable:!1});document.dispatchEvent(a)}else{const t=this.userData();t.lastLoaded=Date.now(),t.loggedIn=!1,this.setUserData(t);const n=new CustomEvent("fcnUserDataFailed",{detail:{data:e,time:new Date,cached:!1},bubbles:!0,cancelable:!1});document.dispatchEvent(n)}this.userReady=!0})).catch((t=>{localStorage.removeItem("fcnUserData");const e=new CustomEvent("fcnUserDataError",{detail:{error:t,time:new Date},bubbles:!0,cancelable:!1});document.dispatchEvent(e)}))}copyInput(t){t.currentTarget.select(),FcnUtils.copyToClipboard(t.currentTarget.value,t.currentTarget.dataset.message)}clearConsent(t){FcnUtils.toggleInProgress(t.currentTarget),FcnUtils.deleteCookie("fcn_cookie_consent"),location.reload()}clearCookies(t){const e=t.currentTarget;if(!FcnUtils.loggedIn())return fcn_cleanUpWebStorage(),FcnUtils.deleteAllCookies(),void alert(e.dataset.message);FcnUtils.toggleInProgress(e),FcnUtils.aGet({action:"fictioneer_ajax_clear_cookies",nonce:FcnUtils.nonce()}).then((t=>{t.success?(fcn_cleanUpWebStorage(),FcnUtils.deleteAllCookies(),alert(t.data.success)):t.data.error&&(alert(t.data.failure),console.error("Error:",t.data.error))})).catch((t=>{alert(t),console.error(t)})).then((()=>{FcnUtils.toggleInProgress(e)}))}logout(){fcn_cleanUpWebStorage()}toggleObfuscation(t){t.target.closest('[data-fictioneer-target="obfuscated"]').classList.toggle("_obfuscated")}bodyClick(t){let e;this.dispatch("bodyClick",{detail:{event:t,target:t.target}}),(e=t.target.closest(".page-numbers.dots:not(button)"))?this.#e(e):(e=t.target.closest(".spoiler"))&&e.classList.toggle("_open")}toggleChapterGroup(t){const e=t.currentTarget.closest(".chapter-group"),n=e.querySelector(".chapter-group__list"),a=!e.classList.contains("_closed");n.addEventListener("transitionend",(()=>{n.style.height="",n.querySelectorAll("a, button, label, input:not([hidden])").forEach((t=>{t.tabIndex=n.parentElement.classList.contains("_closed")?"-1":"0"})),_$(".main__background")?.classList.remove("will-change")}),{once:!0}),_$(".main__background")?.classList.add("will-change"),n.style.height=`${n.scrollHeight}px`,requestAnimationFrame((()=>{requestAnimationFrame((()=>{e.classList.toggle("_closed",a),n.style.height=a?"0":`${n.scrollHeight}px`}))}))}toggleModal(t){t.preventDefault(),this.toggleModalVisibility(t.currentTarget,t.params.id)}toggleModalVisibility(t,e){const n=_$$$(e);if(n)if(this.currentModal!==n&&this.closeModals(),this.lastModalToggle=t,n.hidden=!n.hidden,n.hidden)this.closeModals();else{const t=n.querySelector(".close");t?.focus(),t?.blur()}}closeModals(){this.hasModalTarget&&this.modalTargets.forEach((t=>{t.hidden=!0})),this.lastModalToggle&&(this.lastModalToggle?.focus(),this.lastModalToggle?.blur(),this.lastModalToggle.null)}backgroundCloseModals({target:t}){t.classList.contains("modal")&&this.closeModals()}toggleMobileMenu(t){t.preventDefault();const e=window.FictioneerApp.Controllers.fictioneerMobileMenu;e&&e.toggle()}#t(t){_$$$("fictioneer-ajax-nonce")?.remove(),document.body.appendChild(FcnUtils.html`${t}`)}#e(t){if(document.documentElement.dataset.disablePageJump)return;const e=parseInt(window.prompt(fictioneer_tl.notification.enterPageNumber));if(e>0){const n=t.nextElementSibling.getAttribute("href"),a=["page=","paged=","comment-page-","pg="];for(const t of a)if(n.includes(t))return void(window.location.href=n.replace(new RegExp(`${t}\\d+`),t+e));window.location.href=n.replace(/page\/\d+/,`page/${e}`)}}}),application.register("fictioneer-alerts",class extends Stimulus.Controller{static get targets(){return["navAlertList","mobileAlertList","newAlertsDisplay"]}readUpdateStack=[];initialize(){fcn()?.userReady?this.#n=!0:document.addEventListener("fcnUserDataReady",(()=>{this.refreshView(),this.#n=!0,this.#a()}))}connect(){window.FictioneerApp.Controllers.fictioneerAlerts=this,this.#n&&(this.refreshView(),this.#a()),this.#s(),this.#s()}data(){return this.#i=FcnUtils.userData().alerts,this.#i||(this.#i={}),this.#i}markRead({currentTarget:t,params:{id:e}}){this.readUpdateStack.push(e),_$$(`.alert[data-id="alert-${e}"]`).forEach((t=>t.classList.remove("_unread"))),_$$('.mobile-menu-button, [data-fictioneer-alerts-target="newAlertsDisplay"]').forEach((t=>{const e=Math.max(0,parseInt(t.dataset.new??0)-1);t.dataset.new=e,t.classList.toggle("_new",e>0)})),this.#r("fa-solid fa-spinner fa-spin alert__icon-spin","--fa-animation-duration: .8s;",[e]),clearTimeout(this.readUpdateTimeout),t.closest(".alert__content")?this.#o():this.readUpdateTimeout=setTimeout((()=>this.#o()),1500)}refreshView(){const t=this.data();if(!t?.items?.length||!this.hasNavAlertListTarget&&!this.hasMobileAlertListTarget)return;this.refreshNewAlertsCounts(),FcnUtils.yieldToMain();const e=document.createDocumentFragment(),n=new Set(t.read??[]);let a=!1;t.showRead&&t.items.sort(((t,e)=>{const a=n.has(t.id);return a===n.has(e.id)?0:a?1:-1}));for(const s of t.items){const i=n.has(s.id);if(i&&!t.showRead)continue;a=!0;const r=document.createElement("div");r.className=`alert _${s.type??"info"} ${i?"":"_unread"}`,r.dataset.id=`alert-${s.id}`;const o=document.createElement("div");o.className="alert__content",o.innerHTML=s.url?`<a href="${s.url}" data-action="fictioneer-alerts#markRead" data-fictioneer-alerts-id-param="${s.id}">${s.content}</a>`:s.content;const c=document.createElement("div");c.className="alert__meta",c.innerHTML=`<time datetime="${s.date_gmt}">${s.date}</time>`;const l=document.createElement("div");l.className="alert__actions",l.innerHTML=`<button class="alert__button-read _no-menu-item-style" type="button" data-action="fictioneer-alerts#markRead" data-fictioneer-alerts-id-param="${s.id}"><i class="fa-solid fa-xmark alert__icon-x" data-alert-icon-id="${s.id}"></i></button>`,r.append(o,c,l),e.appendChild(r)}a&&this.hasNavAlertListTarget&&(this.navAlertListTarget.innerHTML="",this.navAlertListTarget.appendChild(e.cloneNode(!0))),a&&this.hasMobileAlertListTarget&&(this.mobileAlertListTarget.innerHTML="",this.mobileAlertListTarget.appendChild(e))}getNewAlertsCount(){const t=this.data();if(!t)return 0;const e=new Set(t.read);return t.items.filter((t=>!e.has(t.id))).length}refreshNewAlertsCounts(){const t=this.getNewAlertsCount();_$$('.mobile-menu-button, [data-fictioneer-alerts-target="newAlertsDisplay"]').forEach((e=>{e.dataset.new=t,e.classList.toggle("_new",t>0)}))}#n=!1;#c=!1;#i=null;#l(){return!!FcnUtils.loggedIn()||(this.#d(),this.#c=!0,!1)}#s(){return this.#l()&&JSON.stringify(this.#i)!==JSON.stringify(this.data())}#h(){this.refreshInterval||(this.refreshInterval=setInterval((()=>{!this.#c&&this.#s()&&this.refreshView()}),3e4+1e3*Math.random()))}#a(){this.#h(),this.visibilityStateCheck=()=>{this.#l()&&("visible"===document.visibilityState?(this.#c=!1,this.refreshView(),this.#h()):(this.#c=!0,clearInterval(this.refreshInterval),this.refreshInterval=null))},document.addEventListener("visibilitychange",this.visibilityStateCheck)}#d(){clearInterval(this.refreshInterval),document.removeEventListener("visibilitychange",this.visibilityStateCheck)}#o(){const t=FcnUtils.userData(),e=this.readUpdateStack;t.alerts&&(Array.isArray(t.alerts.read)||(t.alerts.read=[]),t.alerts.read=Array.from(new Set([...t.alerts.read,...e].map((t=>parseInt(t,10))).filter((t=>Number.isInteger(t))))),t.lastLoaded=0,FcnUtils.setUserData(t),FcnUtils.aPost({action:"fictioneer_ajax_mark_alert_read",fcn_fast_ajax:1,ids:t.alerts.read}).then((t=>{t.success?this.#r("fa-solid fa-check",null,e):this.#r("fa-solid fa-triangle-exclamation",null,e)})).catch((t=>{this.#r("fa-solid fa-triangle-exclamation",null,e),t.status&&t.statusText&&fcn_showNotification(`${t.status}: ${t.statusText}`,5,"warning")})),this.readUpdateStack=[],this.#i=t.alerts,this.refreshNewAlertsCounts())}#r(t,e=null,n=null){(n=n??this.readUpdateStack??[]).forEach((n=>{_$$(`[data-alert-icon-id="${n}"]`).forEach((n=>{n.classList=t,e?n.setAttribute("style",e):n.removeAttribute("style")}))}))}}),"function"==typeof fcn_removeQueryArgs&&fcn_removeQueryArgs(),document.addEventListener("fcnUserDataReady",(()=>{fcn().userData().loggedIn||(fcn_cleanUpWebStorage(),fcn_cleanUpGuestView())})),_$("#wp-admin-bar-logout a")?.addEventListener("click",(()=>{fcn_cleanUpWebStorage()})),_$$(".subscriber-login, .oauth-login-link, [data-prepare-login]").forEach((t=>{t.addEventListener("click",(()=>{fcn().removeUserData()}))})),document.addEventListener("fcnUserDataReady",(()=>{fcn_setLoggedInState()})),document.addEventListener("fcnUserDataReady",(()=>{fcn_setAvatar()}));var fcn_animFrameEvents=new Map;function fcn_bindEventToAnimationFrame(t,e,n=window){n.addEventListener(t,(function(){fcn_animFrameEvents.get(e)||(fcn_animFrameEvents.set(e,!0),requestAnimationFrame((()=>{n.dispatchEvent(new CustomEvent(e)),fcn_animFrameEvents.set(e,!1)})))}))}function fcn_loadEmbed(t){t.target.parentNode.querySelectorAll("iframe, script")[0].src=t.target.dataset.src,t.target.parentElement.querySelector(".embed-logo")?.remove(),t.target.remove()}function fcn_appendTermMenu(t,e){const n=_$$$(`term-submenu-${t}`);if(!n)return;const a=n.content.cloneNode(!0);e.classList.add("menu-item-has-children"),e.querySelector('[href="#"]').addEventListener("click",(t=>{t.preventDefault()})),e.appendChild(a)}fcn_bindEventToAnimationFrame("scroll","scroll.rAF"),fcn_bindEventToAnimationFrame("resize","resize.rAF"),document.body.addEventListener("change",(t=>{const e=t.target.closest('[type="checkbox"]');if(!e)return;const n=e.name,a=n?_$$(`label[for="${n}"]`):[],s=e.checked;e.closest("[aria-checked]")?.setAttribute("aria-checked",s),a.forEach((t=>{t.closest("[aria-checked]")?.setAttribute("aria-checked",s)}))})),_$$(".iframe-consent, .twitter-consent").forEach((t=>{t.onclick=t=>{fcn_loadEmbed(t)}})),document.addEventListener("DOMContentLoaded",(()=>{const t=_$("#menu-navigation > .menu-item"),e=_$$$("full-navigation");t&&e&&t.offsetHeight<e.offsetHeight&&e.classList.add("_oversized-navigation"),_$$(".main-navigation .trigger-term-menu-categories").forEach((t=>{fcn_appendTermMenu("category",t)})),_$$(".main-navigation .trigger-term-menu-tags").forEach((t=>{fcn_appendTermMenu("post_tag",t)})),_$$(".main-navigation .trigger-term-menu-genres").forEach((t=>{fcn_appendTermMenu("fcn_genre",t)})),_$$(".main-navigation .trigger-term-menu-fandoms").forEach((t=>{fcn_appendTermMenu("fcn_fandom",t)})),_$$(".main-navigation .trigger-term-menu-characters").forEach((t=>{fcn_appendTermMenu("fcn_character",t)})),_$$(".main-navigation .trigger-term-menu-warnings").forEach((t=>{fcn_appendTermMenu("fcn_content_warning",t)}))})),_$$$("full-navigation")?.addEventListener("mouseover",(()=>{document.dispatchEvent(new CustomEvent("fcnRemoveLastClicked"))}));var fcn_lastScrollTop=0;function fcn_scrollDirection(){if(FcnGlobals.eSite.classList.contains("transformed-scroll"))return;const t="hidden"!==window.getComputedStyle(document.documentElement).overflow?window.scrollY??document.documentElement.scrollTop:document.body.scrollTop??1;document.body.classList.toggle("scrolled-to-top",0===t),t>fcn_lastScrollTop&&Math.abs(fcn_lastScrollTop-t)>=10?(document.body.classList.add("scrolling-down"),document.body.classList.remove("scrolling-up"),fcn_lastScrollTop=Math.max(t,0)):t<fcn_lastScrollTop&&Math.abs(fcn_lastScrollTop-t)>=50&&(document.body.classList.add("scrolling-up"),document.body.classList.remove("scrolling-down"),fcn_lastScrollTop=Math.max(t,0))}function fcn_observe(t,e,n={}){const a=_$(t);if(!a)return null;new IntersectionObserver((t=>e(t[0])),n).observe(a)}function fcn_dragElement(t){let e,n,a,s;function i(i){i.preventDefault(),s=n-i.clientY,a=e-i.clientX,e=i.clientX,n=i.clientY,t.style.top=t.offsetTop-s+"px",t.style.left=t.offsetLeft-a+"px"}function r(){document.onmouseup=null,document.onmousemove=null}(t.querySelector(".drag-anchor")??t).onmousedown=function(t){t.preventDefault(),e=t.clientX,n=t.clientY,document.onmousemove=i,document.onmouseup=r}}function fcn_showNotification(t,e=3,n="base"){const a=_$("#notifications"),s=document.createElement("div");s.innerHTML=t,s.classList.add("notifications__message",`_${n}`),s.style.opacity=1,s.style.transitionDelay=`${e}s`,a.prepend(s),s.addEventListener("transitionend",(t=>{"opacity"===t.propertyName&&a.removeChild(t.target)})),s.addEventListener("click",(t=>{a.removeChild(t.currentTarget)})),setTimeout((()=>{s.style.opacity=0}),100)}if(window.addEventListener("scroll.rAF",FcnUtils.throttle(fcn_scrollDirection,200)),fcn_scrollDirection(),document.addEventListener("DOMContentLoaded",(()=>{fcn_observe(".main-observer",(t=>{document.body.classList.toggle("is-inside-main",t.intersectionRatio<1&&t.boundingClientRect.top<=0)}),{threshold:[1]}),fcn_observe(".chapter-end",(t=>{document.body.classList.toggle("is-end-of-chapter",t.isIntersecting||t.boundingClientRect.top<0)}),{root:null,threshold:0}),fcn_observe("#nav-observer-sticky",(t=>{_$$$("full-navigation").classList.toggle("is-sticky",t.intersectionRatio<1)}),{threshold:[1]})})),_$$(".modal__header.drag-anchor").forEach((t=>{fcn_dragElement(t.closest(".modal__wrapper"))})),FcnGlobals.urlParams){switch(FcnGlobals.urlParams.failure&&console.error("Failure:",FcnGlobals.urlParams.failure),FcnGlobals.urlParams.failure){case"oauth_email_taken":fcn_showNotification(fictioneer_tl.notification.oauthEmailTaken,5,"warning");break;case"oauth_already_linked":fcn_showNotification(fictioneer_tl.notification.oauthAccountAlreadyLinked,5,"warning")}if("oauth_new"===FcnGlobals.urlParams.success)fcn_showNotification(fictioneer_tl.notification.oauthNew,10);else FcnGlobals.urlParams.success?.startsWith("oauth_merged_")&&fcn_showNotification(fictioneer_tl.notification.oauthAccountLinked,3,"success");if(FcnGlobals.urlParams["fictioneer-notice"]){let t="1"===FcnGlobals.urlParams.failure?"warning":"base";t="1"===FcnGlobals.urlParams.success?"success":t,fcn_showNotification(FcnUtils.sanitizeHTML(FcnGlobals.urlParams["fictioneer-notice"]),3,t)}}function fcn_updateThemeColor(t=null){const e=fcn_siteSettings.darken?fcn_siteSettings.darken:0,n=fcn_siteSettings.saturation?fcn_siteSettings.saturation:0,a=fcn_siteSettings["hue-rotate"]?fcn_siteSettings["hue-rotate"]:0,s=e>=0?1+e**2:1-e**2,i=n>=0?1+n**2:1-n**2;let r=getComputedStyle(document.documentElement).getPropertyValue("--theme-color-base").trim().split(" ");r=`hsl(${(parseInt(r[0])+a)%360}deg ${(parseInt(r[1])*i).toFixed(2)}% ${(parseInt(r[2])*s).toFixed(2)}%)`,_$("meta[name=theme-color]").setAttribute("content",t??r)}const fcn_settingHueRotateRange=_$$$("site-setting-hue-rotate-range"),fcn_settingHueRotateText=_$$$("site-setting-hue-rotate-text"),fcn_settingHueRotateReset=_$$$("site-setting-hue-rotate-reset"),fcn_settingDarkenRanges=_$$(".setting-darken-range"),fcn_settingDarkenTexts=_$$(".setting-darken-text"),fcn_settingDarkenResets=_$$(".setting-darken-reset"),fcn_settingSaturationRanges=_$$(".setting-saturation-range"),fcn_settingSaturationTexts=_$$(".setting-saturation-text"),fcn_settingSaturationResets=_$$(".setting-saturation-reset"),fcn_settingFontLightnessRanges=_$$(".setting-font-lightness-range"),fcn_settingFontLightnessTexts=_$$(".setting-font-lightness-text"),fcn_settingFontLightnessResets=_$$(".setting-font-lightness-reset"),fcn_settingEvents=["nav-sticky","background-textures","polygons","covers","filters","taxonomies","text-shadows","minimal","chapter-progress-bar"];var fcn_siteSettings=fcn_getSiteSettings();function fcn_updateSiteSetting(t,e,n){t.checked=n,fcn_siteSettings[e]=n,fcn_applySiteSettings(fcn_siteSettings)}function fcn_toggleLightMode(){fcn_setLightMode(!(localStorage.getItem("fcnLightmode")?"true"==localStorage.getItem("fcnLightmode"):"light"==document.documentElement.dataset.modeDefault))}function fcn_setLightMode(t,e=!1){localStorage.setItem("fcnLightmode",t),document.documentElement.dataset.mode=t?"light":"dark",_$$(".toggle-light-mode").forEach((e=>{e.closest("[aria-checked]")?.setAttribute("aria-checked",t)})),e||fcn_updateThemeColor()}function fcn_updateFontWeight(){const t="default"!=fcn_siteSettings["font-weight"];_$$(".site-setting-font-weight").forEach((t=>{t.value=fcn_siteSettings["font-weight"]})),_$$(".font-weight-reset").forEach((e=>{e.classList.toggle("_modified",t)}))}function fcn_resetFontWeight(){fcn_siteSettings["font-weight"]="default",document.documentElement.dataset.fontWeight="default",fcn_applySiteSettings(fcn_siteSettings)}function fcn_updateHueRotate(t){t=FcnUtils.clamp(0,360,t??0),fcn_settingHueRotateText.value=t,fcn_settingHueRotateRange.value=t,fcn_settingHueRotateReset.classList.toggle("_modified",0!=t),document.documentElement.style.setProperty("--hue-rotate",`(${t}deg + var(--hue-offset))`),fcn_siteSettings["hue-rotate"]=t,fcn_setSiteSettings(),fcn_updateThemeColor()}function fcn_setHueRotate(){fcn_updateHueRotate(this.value)}function fcn_updateDarken(t=null){t=FcnUtils.clamp(-1,1,t??fcn_siteSettings.darken),t=Math.round(100*(t+Number.EPSILON))/100,fcn_settingDarkenResets.forEach((e=>{e.classList.toggle("_modified",0!=t)})),fcn_settingDarkenRanges.forEach((e=>{e.value=t})),fcn_settingDarkenTexts.forEach((e=>{e.value=parseInt(100*t)}));const e=t>=0?1+t**2:1-t**2;document.documentElement.style.setProperty("--darken",`(${e} + var(--lightness-offset))`),fcn_siteSettings.darken=t,fcn_setSiteSettings(),fcn_updateThemeColor()}function fcn_setDarkenFromRange(){fcn_updateDarken(this.value)}function fcn_setDarkenFromText(){"-"!=this.value&&""!=this.value&&fcn_updateDarken((parseInt(this.value)??0)/100)}function fcn_updateSaturation(t=null){t=FcnUtils.clamp(-1,1,t??fcn_siteSettings.saturation),fcn_settingSaturationResets.forEach((e=>{e.classList.toggle("_modified",0!=t)})),fcn_settingSaturationRanges.forEach((e=>{e.value=t})),fcn_settingSaturationTexts.forEach((e=>{e.value=parseInt(100*t)}));const e=t>=0?1+t**2:1-t**2;document.documentElement.style.setProperty("--saturation",`(${e} + var(--saturation-offset))`),fcn_siteSettings.saturation=t,fcn_setSiteSettings(),fcn_updateThemeColor()}function fcn_setSaturationFromRange(){fcn_updateSaturation(this.value)}function fcn_setSaturationFromText(){"-"!=this.value&&""!=this.value&&fcn_updateSaturation((parseInt(this.value)??0)/100)}function fcn_updateFontLightness(t=null){t=FcnUtils.clamp(-1,1,t??fcn_siteSettings["font-lightness"]??1),fcn_settingFontLightnessResets.forEach((e=>{e.classList.toggle("_modified",0!=t)})),fcn_settingFontLightnessRanges.forEach((e=>{e.value=t})),fcn_settingFontLightnessTexts.forEach((e=>{e.value=parseInt(100*t)}));const e=t>=0?1+t**2:1-t**2;document.documentElement.style.setProperty("--font-lightness",`(${e} + var(--font-lightness-offset))`),fcn_siteSettings["font-lightness"]=t,fcn_setSiteSettings(),fcn_updateThemeColor()}function fcn_setFontLightnessFromRange(){fcn_updateFontLightness(this.value)}function fcn_setFontLightnessFromText(){"-"!=this.value&&""!=this.value&&fcn_updateFontLightness((parseInt(this.value)??0)/100)}function fcn_defaultSiteSettings(){return{"nav-sticky":!0,"background-textures":!0,polygons:!0,covers:!0,taxonomies:!0,"text-shadows":!1,minimal:!1,"chapter-progress-bar":!0,"site-theme":"default","font-weight":"default",darken:0,saturation:0,"font-saturation":0,"font-lightness":0,"hue-rotate":0}}function fcn_getSiteSettings(){const t=FcnUtils.parseJSON(localStorage.getItem("fcnSiteSettings"))??fcn_defaultSiteSettings();return fcn_setSiteSettings(t),t}function fcn_setSiteSettings(t=null){"object"==typeof(t=t||fcn_siteSettings)&&(fcn_siteSettings=t,localStorage.setItem("fcnSiteSettings",JSON.stringify(t)))}function fcn_applySiteSettings(t){t="object"!=typeof t?fcn_defaultSiteSettings():t,Object.entries(t).forEach((t=>{const e=_$$$(`site-setting-${t[0]}`);switch(e&&(e.checked=t[1]),t[0]){case"minimal":document.documentElement.classList.toggle("minimal",t[1]);break;case"darken":fcn_updateDarken();break;case"saturation":fcn_updateSaturation();break;case"font-saturation":break;case"font-lightness":fcn_updateFontLightness();break;case"hue-rotate":fcn_updateHueRotate(t[1]);break;case"font-weight":fcn_updateFontWeight();break;default:document.documentElement.classList.toggle(`no-${t[0]}`,!t[1])}})),
fcn_setSiteSettings(t)}function fcn_updateSiteTheme(t){fcn_siteSettings["site-theme"]=t,document.documentElement.dataset.theme=t,_$$$("site-setting-theme-reset").classList.toggle("_modified","default"!=t),fcn_applySiteSettings(fcn_siteSettings),fcn_updateThemeColor()}function fcn_resetSiteTheme(){fcn_updateSiteTheme("default"),_$$(".site-setting-site-theme").forEach((t=>{t.value="default"}))}function fcn_revealCommentImage(t){const e=t.parentElement.querySelector("img");e.src=e.dataset.src,t.remove()}function fcn_contactFormSubmit(t){const e=t.closest("form"),n=new FormData(e);if(!e.reportValidity())return;if(t.disabled=!0,t.innerHTML=t.dataset.disabled,Date.now()<FcnGlobals.pageLoadTimestamp+3e3)return;const a={};for(const[t,e]of n)a[t]=e;FcnUtils.remoteAction("fictioneer_ajax_submit_contact_form",{element:e,payload:a,callback:n=>{n.success?(e.querySelector("textarea").value="",t.innerHTML=t.dataset.done,fcn_showNotification(n.data.success,3,"success")):n.data.failure&&(t.disabled=!1,t.innerHTML=t.dataset.enabled)},errorCallback:()=>{t.disabled=!1,t.innerHTML=t.dataset.enabled}})}fcn_settingEvents.forEach((t=>{_$$$(`site-setting-${t}`)?.addEventListener("change",(e=>{fcn_updateSiteSetting(e.currentTarget,t,e.currentTarget.checked)}))})),fcn_setLightMode(localStorage.getItem("fcnLightmode")?"true"==localStorage.getItem("fcnLightmode"):"light"==document.documentElement.dataset.modeDefault,!0),_$$(".toggle-light-mode").forEach((t=>{t.onclick=()=>fcn_toggleLightMode()})),_$$(".font-weight-reset").forEach((t=>{t.addEventListener("click",fcn_resetFontWeight)})),_$$(".site-setting-font-weight").forEach((t=>{t.onchange=t=>{fcn_siteSettings["font-weight"]=t.target.value,document.documentElement.dataset.fontWeight=t.target.value,fcn_applySiteSettings(fcn_siteSettings),fcn_updateFontWeight()}})),fcn_settingHueRotateReset?.addEventListener("click",(()=>{fcn_updateHueRotate(0)})),fcn_settingHueRotateRange?.addEventListener("input",FcnUtils.throttle(fcn_setHueRotate,1e3/24)),fcn_settingHueRotateText?.addEventListener("input",fcn_setHueRotate),fcn_settingDarkenResets.forEach((t=>{t.addEventListener("click",(()=>{fcn_updateDarken(0)}))})),fcn_settingDarkenRanges.forEach((t=>{t.addEventListener("input",FcnUtils.throttle(fcn_setDarkenFromRange,1e3/24))})),fcn_settingDarkenTexts.forEach((t=>{t.addEventListener("input",fcn_setDarkenFromText)})),fcn_settingSaturationResets.forEach((t=>{t.addEventListener("click",(()=>{fcn_updateSaturation(0)}))})),fcn_settingSaturationRanges.forEach((t=>{t.addEventListener("input",FcnUtils.throttle(fcn_setSaturationFromRange,1e3/24))})),fcn_settingSaturationTexts.forEach((t=>{t.addEventListener("input",fcn_setSaturationFromText)})),fcn_settingFontLightnessResets.forEach((t=>{t.addEventListener("click",(()=>{fcn_updateFontLightness(0)}))})),fcn_settingFontLightnessRanges.forEach((t=>{t.addEventListener("input",FcnUtils.throttle(fcn_setFontLightnessFromRange,1e3/24))})),fcn_settingFontLightnessTexts.forEach((t=>{t.addEventListener("input",fcn_setFontLightnessFromText)})),fcn_applySiteSettings(fcn_siteSettings),_$$(".site-setting-site-theme").forEach((t=>{t.value=fcn_siteSettings["site-theme"]?fcn_siteSettings["site-theme"]:"default",_$$$("site-setting-theme-reset").classList.toggle("_modified","default"!=t.value),t.addEventListener("change",(t=>{fcn_updateSiteTheme(t.target.value)}))})),_$$$("site-setting-theme-reset")?.addEventListener("click",fcn_resetSiteTheme),fcn_updateThemeColor(),_$(".fictioneer-comments")?.addEventListener("click",(t=>{t.target?.classList.contains("consent-button")&&fcn_revealCommentImage(t.target)})),_$$(".fcn-contact-form").forEach((t=>{t.querySelector(".fcn-contact-form__submit").addEventListener("click",(t=>{fcn_contactFormSubmit(t.currentTarget)}))})),_$$('[data-click-action*="open-dialog-modal"]').forEach((t=>{t.addEventListener("click",(t=>{document.querySelector(t.currentTarget.dataset.clickTarget).showModal()}))})),_$$('[data-click-action*="close-dialog-modal"], button[formmethod="dialog"][value="cancel"]').forEach((t=>{t.addEventListener("click",(t=>{t.preventDefault(),t.target.closest("dialog").close()}))})),_$$("dialog").forEach((t=>{t.addEventListener("mousedown",(e=>{if(e.target===e.currentTarget){const n=t.getBoundingClientRect();(e.clientX<n.left||e.clientX>n.right||e.clientY<n.top||e.clientY>n.bottom)&&(e.preventDefault(),e.target.close())}}))})),_$$(".content-section").forEach((t=>{t.addEventListener("click",(t=>{if(t.target.closest('[data-click-action*="open-tooltip-modal"]')&&!window.getSelection().toString()){const e=_$$$("fictioneer-tooltip-dialog"),n=t.target.dataset.dialogHeader,a=t.target.dataset.dialogContent;a.length>200?e.style.setProperty("--modal-width","400px"):e.style.removeProperty("--modal-width"),n&&(e.querySelector('[data-finder="tooltip-dialog-header"]').innerHTML=n),e.querySelector('[data-finder="tooltip-dialog-content"]').innerHTML=a,e.showModal()}}))})),document.body.addEventListener("keydown",(t=>{let e=document.activeElement.closest('[tabindex="0"]:not(a, input, button, select)');if(["BUTTON","A","INPUT","SELECT"].includes(document.activeElement.tagName)&&(e=null),e&&(" "!==t.key&&"Enter"!==t.key||(t.preventDefault(),e.click())),"Escape"===t.key){_$$(".modal-toggle:checked").forEach((t=>{t.checked=!1,t.dispatchEvent(new Event("change"))}));const t=_$(".lightbox.show");if(t)return void t.querySelector(".lightbox__close").click();const e=_$(".selected-paragraph #button-close-paragraph-tools");if(e)return void e.click();const n=_$("#tts-interface:not(.hidden)");if(n){if(n.classList.contains("playing")){const t=_$$$("button-tts-pause");t?.click(),t?.focus(),t?.blur()}else _$$$("button-tts-stop").click();return}}}));class FCN_KeywordInput{constructor(t){this.input=t,this.type=t.dataset.type,this.operator=t.closest(".keyword-input").querySelector(".keyword-input__operator input"),this.inputWrapper=t.closest(".keyword-input__input-wrapper"),this.block=t.closest(".keyword-input"),this.form=this.block.closest(".search-form"),this.collection=this.block.querySelector(".keyword-input__collection"),this.suggestionList=this.block.querySelector(".keyword-input__suggestion-list"),this.tabSuggestion=this.block.querySelector(".keyword-input__tab-suggestion"),this.allowText=this.form.querySelector(".allow-list")?.innerText??"{}",this.allowList=FcnUtils.parseJSON(this.allowText),this.hints=this.block.querySelector(".keyword-input__hints"),this.noHint=this.block.querySelector(".keyword-input__no-suggestions"),this.keywords=this.collection.value.length>0?this.collection.value.split(","):[],this.bindEvents(),this.resize(),this.filterSuggestions()}resize(){const t=this.tabSuggestion.innerText.length>0?this.tabSuggestion.innerText.length:this.input.value.length;this.input.style.width=.88*t+2+"ch"}reset(){this.keywords=[],this.block.querySelectorAll(".node").forEach((t=>{t.remove()})),this.block.querySelectorAll(".keyword-input__operator > input").forEach((t=>{t.checked=!1})),this.input.value="",this.updateCollection(),this.filterSuggestions(),this.resize()}encode(t){const e=(new TextEncoder).encode(t.toLowerCase());return btoa(String.fromCharCode.apply(null,e))}filterSuggestions(){const t=this.input.value.toLowerCase();let e=0,n="";""==t?this.suggestionList.querySelectorAll(".keyword-button").forEach((t=>{t.hidden=!0})):this.suggestionList.querySelectorAll(".keyword-button").forEach((a=>{const s=a.innerText.toLowerCase();s.includes(t)&&this.keywords.indexOf(s)<0?(a.hidden=!1,e++,""==n&&s.startsWith(t)&&(n=s)):a.hidden=!0})),this.hints.querySelectorAll(".keyword-button").forEach((t=>{this.keywords.indexOf(t.value.toLowerCase())>-1?t.hidden=!0:t.hidden=!1})),this.tabSuggestion.innerHTML=n,this.hints.hidden=!(""==t),this.noHint.hidden=!(""!=t&&e<1)}addNode(t=null,e=null){const n=t??this.input.value.replace(",","");let a=this.allowList[`${this.type}_${this.encode(n)}`];if("authors"!=this.collection.name&&"ex_authors"!=this.collection.name||!e||(a=this.allowList[`${this.type}_${this.encode(n)}_${e.value}`]),!a||this.keywords.indexOf(a)>-1)return;this.keywords.push(a);const s=document.createElement("div");s.innerHTML=`<span class="node-name">${n}</span><span class="node-delete"><i class="fa-solid fa-xmark"></i></span>`,s.classList.add("node"),s.dataset.value=a,this.inputWrapper.parentNode.insertBefore(s,this.inputWrapper),this.input.value="",this.updateCollection(),this.filterSuggestions(),this.resize()}removeNodeByValue(t){this.block.querySelector(`[data-value="${t}"]`)?.remove(),this.keywords=this.keywords.filter((e=>e!=t)),this.updateCollection(),this.filterSuggestions(),this.resize()}updateCollection(){this.collection.value=this.keywords.join(","),this.block.classList.toggle("_empty",""===this.collection.value),this.form.querySelector(".search-form__current").innerHTML=""}bindEvents(){this.input.addEventListener("input",(t=>{t.currentTarget.value.includes(",")&&this.addNode(),this.block.classList.toggle("_empty",""===t.currentTarget.value&&""===this.collection.value),this.filterSuggestions(),this.resize()})),this.input.addEventListener("keydown",(t=>{"Tab"!==t.key&&"Enter"!==t.key||""!=this.tabSuggestion.innerText&&(t.preventDefault(),this.input.value=this.tabSuggestion.innerText,this.addNode()),"Escape"===t.key&&(this.input.value="",this.tabSuggestion.innerHTML="",document.activeElement.blur()),"Backspace"===t.key&&""==this.input.value&&this.keywords.length>0&&this.removeNodeByValue(this.keywords.slice(-1))})),this.input.addEventListener("blur",(()=>{const t=this.allowList[this.encode(this.input.value)];this.blurTimeout=t?setTimeout((()=>{this.addNode()}),150):setTimeout((()=>{this.input.value="",this.tabSuggestion.innerHTML="",this.filterSuggestions(),this.resize()}),150)})),this.block.addEventListener("click",(t=>{t.target.closest(".node-delete")&&(t.preventDefault(),this.removeNodeByValue(t.target.closest(".node").dataset.value))})),this.block.querySelectorAll(".keyword-button").forEach((t=>{t.addEventListener("click",(t=>{clearTimeout(this.blurTimeout),this.addNode(t.currentTarget.innerText,t.currentTarget)}))}))}}function fcn_resetSearchForm(t,e,n){n.forEach((t=>t.reset())),e.querySelectorAll("input, select").forEach((t=>{t.value=t.dataset.default??t.value})),e.querySelector(".search-form__current").innerHTML="",fcn_showNotification(t.dataset.reset,2)}function fcn_handleTabInput(t){"Tab"==t.key&&(document.body.classList.add("user-is-tabbing"),window.removeEventListener("keydown",fcn_handleTabInput),window.addEventListener("mousedown",fcn_handleMouseInput))}function fcn_handleMouseInput(){document.body.classList.remove("user-is-tabbing"),window.removeEventListener("mousedown",fcn_handleMouseInput),window.addEventListener("keydown",fcn_handleTabInput)}function fcn_popupPosition(){_$$(".popup-menu-toggle.last-clicked .popup-menu:not(._fixed-position)").forEach((t=>{if("none"===window.getComputedStyle(t).display)return;const e=FcnUtils.detectScreenCollision(t);e&&0===e.length||(e.includes("top")?(t.classList.remove("_top"),t.classList.add("_bottom")):e.includes("bottom")&&(t.classList.remove("_bottom"),t.classList.add("_top")),t.closest("._fixed-horizontal")||(e.includes("left")?(t.classList.remove("_center","_justify-right"),t.classList.add("_justify-left")):e.includes("right")&&(t.classList.remove("_center","_justify-left"),t.classList.add("_justify-right"))))}))}function fcn_markCurrentMenuItem(){_$$(`.menu-item > [data-nav-object-id="${document.body.dataset.postId}"]`).forEach((t=>{t.setAttribute("aria-current","page"),t.closest(".menu-item").classList.add("current-menu-item")}))}function fcn_showAgeConfirmationModal(){const t=_$(".story__article, .chapter__article")?.dataset.ageRating;if(!document.documentElement.dataset.ageConfirmation&&t&&"adult"!==t)return void _$$$("age-confirmation-modal")?.remove();const e=_$$$("age-confirmation-leave");document.documentElement.classList.add("age-modal-open"),_$$$("age-confirmation-modal").hidden=!1,_$$$("age-confirmation-confirm")?.addEventListener("click",(t=>{document.documentElement.classList.remove("age-modal-open"),t.currentTarget.closest(".modal").remove(),localStorage.setItem("fcnAgeConfirmation","1")})),e?.addEventListener("click",(()=>{window.location.href=e.dataset.redirect??"https://search.brave.com/",localStorage.removeItem("fcnAgeConfirmation")}))}_$$(".search-form").forEach((t=>{if(t.classList.contains("_simple"))return;const e=[];t.querySelectorAll(".keyword-input__input").forEach((t=>{e.push(new FCN_KeywordInput(t))})),t.querySelector(".allow-list")?.remove(),t.addEventListener("change",(e=>{e.target.classList.contains("search-form__advanced-control")||e.target.classList.contains("search-form__string")||(t.querySelector(".search-form__current").innerHTML="")})),t.querySelectorAll(".reset").forEach((n=>{n.addEventListener("click",(()=>{fcn_resetSearchForm(n,t,e)}))}))})),_$$(".search-form__advanced-toggle").forEach((t=>{t.addEventListener("click",(t=>{const e=t.currentTarget.closest("form");e.dataset.advanced="true"==e.dataset.advanced?"false":"true"}))})),window.addEventListener("keydown",fcn_handleTabInput),window.addEventListener("scroll.rAF",FcnUtils.throttle(fcn_popupPosition,250)),document.body.addEventListener("click",(t=>{const e=t.target.closest("[href]"),n=e?.getAttribute("href");if(!e||"A"===!e.tagName||!n.startsWith("#")||n.length<2||"#respond"===n)return;const a=n.replace("#",""),s=_$$(`[name="${a}"], [id="${a}"]`)[0],i=e.closest(".comment._story-comment");i&&(window.location.href=i.querySelector(".fictioneer-comment__link").href+n),s&&(t.preventDefault(),s.scrollIntoView({behavior:"smooth",block:e.dataset?.block??"start"}))})),fcn_markCurrentMenuItem(),_$$$("age-confirmation-modal")&&"1"!==localStorage.getItem("fcnAgeConfirmation")&&!FcnUtils.isSearchEngineCrawler()?fcn_showAgeConfirmationModal():_$$$("age-confirmation-modal")?.remove(),document.addEventListener("DOMContentLoaded",(()=>{_$$(".splide:not(.no-auto-splide, .is-initialized)").forEach((t=>{t.querySelector(".splide__list")&&"undefined"!=typeof Splide&&(t.classList.remove("_splide-placeholder"),new Splide(t).mount())})),_$$(".temp-script, .splide-placeholder-styles").forEach((t=>{t.remove()}))})),application.register("fictioneer-large-card",class extends Stimulus.Controller{static get targets(){return["controls","menu"]}static values={postId:Number,storyId:Number};initialize(){fcn()?.userReady?this.#n=!0:document.addEventListener("fcnUserDataReady",(()=>{this.#f(),this.#n=!0,this.#a()}))}connect(){if(window.FictioneerApp.Controllers.fictioneerLargeCard=this,this.#n&&(this.#f(),this.#a()),document.addEventListener("click",(t=>{t.target.closest(`.card.post-${this.postIdValue}`)||this.#g()})),document.addEventListener("toggledLastClick",(t=>{this.#u(t.detail.target,t.detail.force)})),this.hasMenuTarget)for(this.menuFragment=document.createDocumentFragment();this.menuTarget.firstChild;)this.menuFragment.appendChild(this.menuTarget.firstChild)}disconnect(){this.#d()}isFollowed(){return!(!this.#l()||!this.#m()?.follows?.data?.[this.storyIdValue])}isRemembered(){return!(!this.#l()||!this.#m()?.reminders?.data?.[this.storyIdValue])}isRead(){if(!this.#l())return!1;const t=this.#m()?.checkmarks?.data?.[this.storyIdValue];return!!t&&(t.includes(this.postIdValue)||t.includes(this.storyIdValue))}cardClick(t){t.target.closest(".card__controls")||this.#p()}toggleMenu(){this.menuTarget.querySelector("*")?this.#p():this.#_()}toggleFollow(){this.#l()?(fcn_toggleFollow(this.storyIdValue,!this.isFollowed()),this.#v()):_$('[data-fictioneer-id-param="login-modal"]')?.click()}toggleReminder(){this.#l()?(fcn_toggleReminder(this.storyIdValue,!this.isRemembered()),this.#k()):_$('[data-fictioneer-id-param="login-modal"]')?.click()}toggleCheckmarks(){this.#l()?(fcn_toggleCheckmark(this.storyIdValue,this.postIdValue),this.#b()):_$('[data-fictioneer-id-param="login-modal"]')?.click()}setCheckmarks(t){this.toggleCheckmarks("set",t.params?.type??"story")}unsetCheckmarks(t){this.toggleCheckmarks("unset",t.params?.type??"story")}#F=!1;#n=!1;#c=!1;#l(){const t=FcnUtils.loggedIn();return t||(this.#d(),this.#n=!1,this.#c=!0),t}#m(){return this.userData=fcn().userData(),this.userData}#T(){return this.#l()&&JSON.stringify(this.userData??0)!==JSON.stringify(this.#m())}#h(){this.refreshInterval||(this.refreshInterval=setInterval((()=>{!this.#c&&this.#T()&&this.#f()}),3e4+1e3*Math.random()))}#a(){this.#h(),this.visibilityStateCheck=()=>{this.#l()&&("visible"===document.visibilityState?(this.#c=!1,this.#f(),this.#h()):(this.#c=!0,clearInterval(this.refreshInterval),this.refreshInterval=null))},document.addEventListener("visibilitychange",this.visibilityStateCheck)}#d(){clearInterval(this.refreshInterval),document.removeEventListener("visibilitychange",this.visibilityStateCheck)}#f(){this.#v(),this.#k(),this.#b()}#v(){this.element.classList.toggle("has-follow",this.isFollowed())}#k(){this.element.classList.toggle("has-reminder",this.isRemembered())}#b(){this.element.classList.toggle("has-checkmark",this.isRead())}#g(){this.#p()}#_(){this.#F=!0,this.menuTarget.appendChild(this.menuFragment.cloneNode(!0))}#p(){if(this.#F)for(this.#F=!1;this.menuTarget.firstChild;)this.menuTarget.removeChild(this.menuTarget.firstChild)}#u(t,e){e?t&&!t.closest(`.card.post-${this.postIdValue}`)&&this.#F&&this.#p():this.#p()}}),application.register("fictioneer-last-click",class extends Stimulus.Controller{static get targets(){return["toggle"]}last=null;connect(){window.FictioneerApp.Controllers.fictioneerLastClick=this,document.addEventListener("fcnRemoveLastClicked",(()=>{this.last&&this.removeLastClick()}))}removeAll(){this.last&&(this.#w(this.last,!1),this.removeLastClick())}toggle(t){const e=t.target.closest('[data-fictioneer-last-click-target="toggle"]');if(!e||["BUTTON","A","INPUT","SELECT"].includes(t.target.tagName)&&!t.target.hasAttribute("data-fictioneer-last-click-target"))return;const n=!e.classList.contains("last-clicked");"function"==typeof fcn_popupPosition&&fcn_popupPosition(),e.classList.toggle("last-clicked",n),e.closest(".watch-last-clicked")?.classList.toggle("has-last-clicked",n),this.last&&this.last!=e&&this.removeLastClick(),this.last=e,this.#w(e,n),t.stopPropagation()}removeLastClick(){this.last&&(this.last.closest(".watch-last-clicked")?.classList.remove("has-last-clicked"),this.last.classList.remove("last-clicked"),this.last=null,document.activeElement?.blur())}#w(t,e){document.dispatchEvent(new CustomEvent("toggledLastClick",{detail:{target:t,force:e}}))}});const fcn_consentBanner=_$$$("consent-banner");function fcn_loadConsentBanner(){fcn_consentBanner.classList.remove("hidden"),fcn_consentBanner.hidden=!1,_$$$("consent-accept-button")?.addEventListener("click",(()=>{FcnUtils.setCookie("fcn_cookie_consent","full"),fcn_consentBanner.classList.add("hidden"),fcn_consentBanner.hidden=!0})),_$$$("consent-reject-button")?.addEventListener("click",(()=>{FcnUtils.setCookie("fcn_cookie_consent","necessary"),fcn_consentBanner.classList.add("hidden"),fcn_consentBanner.hidden=!0}))}function fcn_showLightbox(t){const e=_$$$("fictioneer-lightbox"),n=e.querySelector(".loader"),a=_$(".lightbox__content");let s=!1,i=null;if(a.innerHTML="",n.style.opacity=1,t.classList.add("lightbox-last-trigger"),"IMG"==t.tagName?(i=t.cloneNode(),s=!0):t.href&&(i=document.createElement("img"),i.src=t.href,s=!0),s&&i){["class","style","height","width"].forEach((t=>i.removeAttribute(t))),a.appendChild(i),e.classList.add("show"),setTimeout((()=>{n.style.opacity=0}),1e3);const t=e.querySelector(".lightbox__close");t?.focus(),t?.blur()}}fcn_consentBanner&&""===(FcnUtils.getCookie("fcn_cookie_consent")??"")&&!FcnUtils.isSearchEngineCrawler()?setTimeout((()=>{fcn_loadConsentBanner()}),4e3):fcn_consentBanner?.remove(),document.body.addEventListener("click",(t=>{const e=t.target.closest("[data-lightbox]:not(.no-auto-lightbox)");e&&(t.preventDefault(),fcn_showLightbox(e))})),document.body.addEventListener("keydown",(t=>{const e=t.target.closest("[data-lightbox]:not(.no-auto-lightbox)");e&&(" "!==t.key&&"Enter"!==t.key||(t.preventDefault(),fcn_showLightbox(e)))})),document.querySelectorAll(".lightbox__close, .lightbox").forEach((t=>{t.addEventListener("click",(t=>{if("IMG"!=t.target.tagName){_$$$("fictioneer-lightbox").classList.remove("show");const t=_$(".lightbox-last-trigger");t?.focus(),t?.blur(),t?.classList.remove("lightbox-last-trigger")}}))})),application.register("fictioneer-mobile-menu",class extends Stimulus.Controller{static get targets(){return["frame","bookmarks","panelBookmarks"]}advanced=!!_$(".mobile-menu._advanced-mobile-menu");open=!1;editingBookmarks=!1;currentFrame=null;bookmarkTemplate=_$$$("mobile-bookmark-template");chapterId=_$("article")?.id;connect(){window.FictioneerApp.Controllers.fictioneerMobileMenu=this}toggle(t=null){this.open=t??!this.open,this.advanced?this.#y(this.open):this.#S(this.open)}clickOutside({detail:{target:t}}){this.open&&"site"===t?.id&&this.toggle(!1)}openFrame({params:{frame:t}}){const e=`mobile-frame-${t}`;this.editingBookmarks=!1,this.hasPanelBookmarksTarget&&(this.panelBookmarksTarget.dataset.editing=!1),this.hasFrameTarget&&this.frameTargets.forEach((t=>{t.classList.toggle("_active",t.id===e),t.id===e&&(this.currentFrame=t)}))}back(){this.openFrame({params:{frame:"main"}})}setMobileBookmarks(){const t=window.FictioneerApp.Controllers.fictioneerBookmarks;if(t&&this.hasBookmarksTarget){const e=Object.entries(t.data());if(this.bookmarksTarget.innerHTML="",!e||e.length<1){const t=document.createElement("li");return t.classList.add("no-bookmarks"),t.textContent=this.bookmarksTarget.dataset.empty,void this.bookmarksTarget.appendChild(t)}const n=document.createDocumentFragment();e.forEach((([t,{color:e,progress:a,link:s,chapter:i,"paragraph-id":r}])=>{const o=this.bookmarkTemplate.content.cloneNode(!0),c=o.querySelector(".mobile-menu__bookmark");c.classList.add(`bookmark-${t}`),c.dataset.color=e,o.querySelector(".mobile-menu__bookmark-progress > div > div").style.width=`${a.toFixed(1)}%`,o.querySelector(".mobile-menu__bookmark a").href=`${s}#paragraph-${r}`,o.querySelector(".mobile-menu__bookmark a span").innerText=i,o.querySelector(".mobile-menu-bookmark-delete-button").setAttribute("data-fictioneer-mobile-menu-id-param",t),n.appendChild(o)})),this.bookmarksTarget.appendChild(n)}}deleteBookmark({params:{id:t}}){const e=window.FictioneerApp.Controllers.fictioneerBookmarks;e?(e.remove({params:{id:t}}),this.setMobileBookmarks()):fcn_showNotification("Error: Bookmarks Controller not connected.",3,"warning")}toggleBookmarksEdit(){this.editingBookmarks=!this.editingBookmarks,this.panelBookmarksTarget.dataset.editing=this.editingBookmarks}scrollToComments(){this.#E(_$$$("comments"))}scrollToBookmark(){const t=window.FictioneerApp.Controllers.fictioneerBookmarks;if(!t)return void fcn_showNotification("Error: Bookmarks Controller not connected.",3,"warning");const e=t.data()?.[this.chapterId]?.["paragraph-id"],n=_$(`[data-paragraph-id="${e}"]`);this.#E(n)}changeLightness({currentTarget:t}){fcn_updateDarken(fcn_siteSettings.darken+parseFloat(t.value))}#E(t){this.toggle(!1),t&&setTimeout((()=>{FcnUtils.scrollTo(t)}),200)}#S(t){this.back(),t?(document.body.classList.add("mobile-menu-open","scrolling-down"),document.body.classList.remove("scrolling-up")):document.body.classList.remove("mobile-menu-open")}#y(t){const e=_$$$("wpadminbar")?.offsetHeight??0,n=window.scrollY,a=FcnGlobals.eSite.scrollTop;this.back(),t?(document.body.classList.add("mobile-menu-open","scrolling-down","scrolled-to-top"),document.body.classList.remove("scrolling-up"),FcnGlobals.eSite.classList.add("transformed-scroll","transformed-site"),FcnGlobals.eSite.scrollTop=n-e):(FcnGlobals.eSite.classList.remove("transformed-site","transformed-scroll"),document.body.classList.remove("mobile-menu-open"),document.documentElement.style.scrollBehavior="auto",window.scroll(0,a+e),document.documentElement.style.scrollBehavior="")}}),application.register("fictioneer-chapter",class extends Stimulus.Controller{static get targets(){return["bookmarkScroll","contentWrapper","index","content"]}static values={chapterId:Number,storyId:Number};startClick=0;lastToolsParagraph=null;tools=_$$$("paragraph-tools");progressBar=_$(".progress__bar");hasPassword=!!_$("article._password");checkmarkUpdated=!1;checkboxProgressBar=_$$$("site-setting-chapter-progress-bar");checkboxMinimalist=_$$$("site-setting-minimal");initialize(){this.progressBar&&this.hasContentTarget&&!this.hasPassword&&(this.trackProgress(),window.addEventListener("scroll.rAF",FcnUtils.throttle(this.trackProgress.bind(this),1e3/48)))}connect(){window.FictioneerApp.Controllers.fictioneerChapter=this,this.hasIndexTarget&&this.indexTargets.forEach((t=>{t.querySelector(`[data-id="${this.chapterIdValue}"]`)?.classList.add("current")}))}clickOutside({detail:{target:t}}){this.lastToolsParagraph&&!t.closest(".selected-paragraph")&&this.closeTools()}scrollToBookmark(){const t=window.FictioneerApp.Controllers.fictioneerBookmarks;if(!t)return void fcn_showNotification("Error: Bookmarks Controller not connected.",3,"warning");const e=t.data()?.[`ch-${this.chapterIdValue}`]?.["paragraph-id"];if(!e)return;const n=_$(`[data-paragraph-id="${e}"]`);n?.scrollIntoView({behavior:"smooth"})}openFullscreen(){document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen()}closeFullscreen(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}toggleTools(t){FcnFormatting.get()["show-paragraph-tools"]&&this.tools?(this.lastToolsParagraph?.classList.remove("selected-paragraph"),this.lastToolsParagraph!==t?(this.lastToolsParagraph=t,t.classList.add("selected-paragraph"),t.append(this.tools)):this.closeTools()):this.lastToolsParagraph&&this.closeTools()}closeTools(){this.lastToolsParagraph?.classList.remove("selected-paragraph"),this.lastToolsParagraph=null}fastClick(t){""==window.getSelection().toString()&&(this.startClick=Date.now(),document.addEventListener("mouseup",(()=>{Date.now()<this.startClick+400&&this.#L(t.target)&&this.tools&&this.toggleTools(t.target.closest("p"))}),{once:!0}))}quote(t){const e=t.target.closest("p[data-paragraph-id]");if(!e)return;const n=window.getSelection()?window.getSelection().toString().trim():"",a=`[anchor]${e.id}[/anchor]`;let s=FcnUtils.extractTextNodes(e);if(s.length>16&&n.replace(/\s/g,"").length){const t=Math.ceil(.25*n.length);let e=fictioneer_tl.partial.quoteFragmentPrefix,a=fictioneer_tl.partial.quoteFragmentSuffix;n.startsWith(s.substring(0,t+1))&&(e=""),n.endsWith(s.substring(s.length-t,s.length))&&(a=""),s=`${e}${n}${a}`}fcn_showNotification(fictioneer_tl.notification.quoteAppendedToComment),FcnUtils.appendToComment(`\n[quote]${s} ${a}[/quote]\n`)}toggleBookmark({target:t}){const e=window.FictioneerApp.Controllers.fictioneerBookmarks;e?(e.toggle(t.closest("p[data-paragraph-id]").dataset.paragraphId,t.closest("[data-color]")?.dataset.color??"none"),window.matchMedia("(min-width: 1024px)").matches&&this.closeTools()):fcn_showNotification("Error: Bookmarks Controller not connected.",3,"warning")}copyLink(t){const e=t.target.closest("p[data-paragraph-id]");e&&FcnUtils.copyToClipboard(`${location.protocol}//${location.host}${location.pathname}#${e.id}`,fictioneer_tl.notification.linkCopiedToClipboard)}toggleIndexOrder({currentTarget:t}){const e=t.closest(".chapter-index");e.dataset.order="asc"===e.dataset.order?"desc":"asc"}trackProgress(){if(!this.progressBar||!this.hasContentTarget||this.hasPassword||this.checkboxMinimalist.checked||!(this.checkboxProgressBar?.checked??1))return;const t=this.contentTarget.getBoundingClientRect(),e=t.height,n=e-t.bottom-Math.max(t.top,0)+window.innerHeight;let a=100*n/e;if(document.body.classList.toggle("hasProgressBar",!(a<0||n>e+500)),a=FcnUtils.clamp(0,100,a),this.progressBar.style.width=`${a}%`,!this.checkmarkUpdated&&this.hasStoryIdValue&&this.storyIdValue&&a>=100&&FcnUtils.loggedIn()){if(this.checkmarkUpdated=!0,!this.hasChapterIdValue||!this.chapterIdValue||"function"!=typeof fcn_toggleCheckmark)return;fcn_toggleCheckmark(this.storyIdValue,this.chapterIdValue,!0)}}#L(t){return!(t.classList.contains("spoiler")||!t.closest("p[data-paragraph-id]")?.textContent.trim().length||!t.closest("p")?.parentElement?.classList.contains("tools-wrapper")||t.closest(".popup-menu-toggle, .skip-tools, .tts-interface, .paragraph-tools__actions, .hidden, .inside-epub, a, button, label, input, textarea, select, option"))}}),application.register("fictioneer-chapter-formatting",class extends Stimulus.Controller{static get targets(){return["fontSizeReset","fontSizeRange","fontSizeText","siteWidthReset","siteWidthRange","siteWidthText","fontSaturationReset","fontSaturationRange","fontSaturationText","letterSpacingReset","letterSpacingRange","letterSpacingText","lineHeightReset","lineHeightRange","lineHeightText","paragraphSpacingReset","paragraphSpacingRange","paragraphSpacingText"]}connect(){this.#$(),this.#C(),this.#I(),this.#D(),this.#x(),this.#U()}siteWidth({currentTarget:t,params:{type:e}}){const n="reset"===e?null:parseInt(t.value);FcnFormatting.updateSiteWidth(n),this.#$(n)}fontSaturation({currentTarget:t,params:{type:e}}){let n=null;switch(e){case"range":n=parseFloat(t.value);break;case"text":n=parseInt(t.value)/100}FcnFormatting.updateFontSaturation(n),this.#I(n)}fontSize({currentTarget:t,params:{type:e}}){const n=FcnFormatting.get();let a=null;switch(e){case"adjust":a=parseFloat(n["font-size"])+parseFloat(t.dataset.modifier);break;case"range":case"text":a=t.value}FcnFormatting.updateFontSize(a),this.#C(a)}letterSpacing({currentTarget:t,params:{type:e}}){let n="reset"===e?null:parseFloat(t.value);FcnFormatting.updateLetterSpacing(n),this.#D(n)}lineHeight({currentTarget:t,params:{type:e}}){let n="reset"===e?null:parseFloat(t.value);FcnFormatting.updateLineHeight(n),this.#x(n)}paragraphSpacing({currentTarget:t,params:{type:e}}){let n="reset"===e?null:parseFloat(t.value);FcnFormatting.updateParagraphSpacing(n),this.#U(n)}#C(t=null){this.#A("font-size",t)}#I(t=null){this.#A("font-saturation",t,(t=>parseInt(100*t)))}#$(t=null){this.#A("site-width",t)}#D(t=null){this.#A("letter-spacing",t)}#x(t=null){this.#A("line-height",t)}#U(t=null){this.#A("paragraph-spacing",t)}#A(t,e=null,n=null){e=e??FcnFormatting.get()[t];const a=t.replace(/-([a-z])/g,((t,e)=>e.toUpperCase()));this[`has${a.charAt(0).toUpperCase()+a.slice(1)}RangeTarget`]&&this[`${a}RangeTargets`].forEach((t=>t.value=e)),this[`has${a.charAt(0).toUpperCase()+a.slice(1)}TextTarget`]&&this[`${a}TextTargets`].forEach((t=>t.value=n?n(e):e)),this[`has${a.charAt(0).toUpperCase()+a.slice(1)}ResetTarget`]&&this[`${a}ResetTargets`].forEach((n=>n.classList.toggle("_modified",e!=FcnFormatting.defaults()[t])))}});const fcn_chapterKeyboardNavigation=t=>{if(["INPUT","TEXTAREA","SELECT","OPTION"].includes(t.target.tagName)||t.target.isContentEditable)return;const e={ArrowLeft:"a.button._navigation._prev",ArrowRight:"a.button._navigation._next"};if(!e[t.code])return;const n=_$(e[t.code]);n?.href&&(window.location.href=n.href.includes("#start")?n.href:`${n.href}#start`)};if(document.addEventListener("keydown",fcn_chapterKeyboardNavigation),"#start"===window.location.hash){history.replaceState(null,document.title,window.location.pathname);const t=_$(".chapter__article");t&&FcnUtils.scrollTo(t,128)}const FcnFormatting={eFormattingTarget:_$(".chapter-formatting"),defaults:()=>({"font-saturation":0,"font-color":FcnGlobals.fontColors[0].css,"font-name":FcnGlobals.fonts[0].css,"font-size":100,"letter-spacing":0,"line-height":1.7,"paragraph-spacing":1.5,"site-width":document.documentElement.dataset.siteWidthDefault??"960",indent:!0,"show-sensitive-content":!0,"show-chapter-notes":!0,justify:!1,"show-comments":!0,"show-paragraph-tools":!0,timestamp:1664797604825,...FcnUtils.parseJSON(document.documentElement.dataset.defaultFormatting??"{}")}),get(){
let t=FcnUtils.parseJSON(localStorage.getItem("fcnChapterFormatting"))??FcnFormatting.defaults();return Object.keys(t).length<15&&(t=FcnFormatting.defaults(),FcnFormatting.set(t)),t.timestamp<1651164557584&&(t=FcnFormatting.defaults(),t.timestamp=Date.now(),FcnFormatting.set(t)),t},set(t){"object"==typeof t&&localStorage.setItem("fcnChapterFormatting",JSON.stringify(t))},updateFontSize(t,e=!0){const n=this.get();t=FcnUtils.clamp(50,200,t??FcnFormatting.defaults()["font-size"]),_$$(".resize-font").forEach((e=>{e.style.fontSize=`${t}%`})),n["font-size"]=t,e&&this.set(n)},updateSiteWidth(t,e=!0){const n=FcnFormatting.get(),a=_$("main");t=FcnUtils.clamp(640,1920,t??FcnFormatting.defaults()["site-width"]),a.style.setProperty("--site-width",`${t}px`),a.classList.toggle("_default-width",t==document.documentElement.dataset.siteWidthDefault),a.classList.toggle("_below-1024",t<1024&&t>=768),a.classList.toggle("_below-768",t<768&&t>640),a.classList.toggle("_640-and-below",t<=640),n["site-width"]=t,e&&FcnFormatting.set(n)},updateFontSaturation(t,e=!0){const n=FcnFormatting.get();t=FcnUtils.clamp(-1,1,t??FcnFormatting.defaults()["font-saturation"]),this.eFormattingTarget.style.setProperty("--font-saturation",`(${t>=0?1+t**2:1-t**2} + var(--font-saturation-offset))`),n["font-saturation"]=t,e&&FcnFormatting.set(n)},updateLetterSpacing(t,e=!0){const n=FcnFormatting.get();t=FcnUtils.clamp(-.1,.2,t??FcnFormatting.defaults()["letter-spacing"]),this.eFormattingTarget.style.letterSpacing=`calc(${t}em + var(--font-letter-spacing-base))`,n["letter-spacing"]=t,e&&FcnFormatting.set(n)},updateLineHeight(t,e=!0){const n=FcnFormatting.get();t=FcnUtils.clamp(.8,3,t??FcnFormatting.defaults()["line-height"]),this.eFormattingTarget.style.lineHeight=`${t}`,n["line-height"]=t,e&&FcnFormatting.set(n)},updateParagraphSpacing(t,e=!0){const n=FcnFormatting.get();t=FcnUtils.clamp(0,3,t??FcnFormatting.defaults()["paragraph-spacing"]),this.eFormattingTarget.style.setProperty("--paragraph-spacing",`${t}em`),n["paragraph-spacing"]=t,e&&FcnFormatting.set(n)}};function fcn_updateToggle(t,e,n,a={}){const s=FcnFormatting.get();a={save:!0,...a};const i=Boolean(t),r=_$(e);if(r&&(r.checked=i,r.closest("label").setAttribute("aria-checked",i)),a.toggleClass&&FcnFormatting.eFormattingTarget.classList.toggle(a.toggleClass,a.invertClass?!i:i),a.sensitiveContent){const t=_$$$("inline-sensitive-content-toggle");t?.classList.toggle("hide-sensitive",!i),t?.setAttribute("aria-checked",!i)}a.notes&&_$$(".chapter-note-hideable").forEach((t=>{t.classList.toggle("hidden",!i)})),a.comments&&_$$(".chapter-comments-hideable").forEach((t=>{t.classList.toggle("hidden",!i)})),s[n]=i,a.save&&FcnFormatting.set(s)}(()=>{if(!FcnFormatting.eFormattingTarget)return;const t=FcnFormatting.get();FcnFormatting.updateSiteWidth(t["site-width"],!1),FcnFormatting.updateFontSize(t["font-size"],!1),FcnFormatting.updateFontSaturation(t["font-saturation"],!1),FcnFormatting.updateLetterSpacing(t["letter-spacing"],!1),FcnFormatting.updateLineHeight(t["line-height"],!1),FcnFormatting.updateParagraphSpacing(t["paragraph-spacing"],!1)})(),(()=>{"use strict";const t=_$$$("reader-settings-font-color-reset"),e=_$$$("reader-settings-font-color-select");if(!t)return;function n(n,a=!0){const s=FcnFormatting.get();n=FcnUtils.clamp(0,FcnGlobals.fontColors.length-1,n),t.classList.toggle("_modified",n>0),e.value=n,FcnFormatting.eFormattingTarget.style.setProperty("--text-chapter",FcnGlobals.fontColors[n].css),s["font-color"]=FcnGlobals.fontColors[n].css,a&&FcnFormatting.set(s)}t.onclick=()=>{n(0)},e.onchange=t=>{n(t.target.value)},_$$(".font-color-stepper").forEach((t=>{t.addEventListener("click",(t=>{!function(t=1){let a=(e.selectedIndex+parseInt(t))%FcnGlobals.fontColors.length;a=a<0?FcnGlobals.fontColors.length-1:a,n(a)}(t.currentTarget.value)}))}));const a=FcnFormatting.get();n(FcnGlobals.fontColors.findIndex((t=>t.css==a["font-color"])),!1)})(),(()=>{"use strict";const t=_$$$("reader-settings-font-reset"),e=_$$$("reader-settings-font-select");if(!t)return;function n(a,s=!0){const i=FcnFormatting.get();a=FcnUtils.clamp(0,FcnGlobals.fonts.length-1,a);let r=FcnGlobals.fonts[a].css;FcnGlobals.fonts[a].alt&&(r=`${r}, ${FcnGlobals.fonts[a].alt}`),a<0?n(0):(t.classList.toggle("_modified",a>0),e.value=a,_$$(".chapter-font-family").forEach((t=>{t.style.fontFamily=""===r?"var(--ff-system)":r+", var(--ff-system)"})),i["font-name"]=FcnGlobals.fonts[a].css,s&&FcnFormatting.set(i))}t.onclick=()=>{n(0)},e.onchange=t=>{n(t.target.value)},_$$(".font-stepper").forEach((t=>{t.addEventListener("click",(t=>{!function(t=1){let a=(e.selectedIndex+parseInt(t))%FcnGlobals.fonts.length;a=a<0?FcnGlobals.fonts.length-1:a,n(a)}(t.currentTarget.value)}))}));const a=FcnFormatting.get();n(FcnGlobals.fonts.findIndex((t=>t.css==a["font-name"])),!1)})(),_$$("#reader-settings-indent-toggle").forEach((t=>{const e={invertClass:!0,toggleClass:"no-indent"},n="indent";t.onclick=a=>{fcn_updateToggle(a.currentTarget.checked,`#${t.id}`,n,e)};fcn_updateToggle(FcnFormatting.get()[n],`#${t.id}`,n,{save:!1,...e})})),_$$("#reader-settings-justify-toggle").forEach((t=>{const e={toggleClass:"justify"},n="justify";t.onclick=a=>{fcn_updateToggle(a.currentTarget.checked,`#${t.id}`,n,e)};fcn_updateToggle(FcnFormatting.get()[n],`#${t.id}`,n,{save:!1,...e})})),_$$("#reader-settings-paragraph-tools-toggle").forEach((t=>{const e="show-paragraph-tools";t.onclick=n=>{fcn_updateToggle(n.currentTarget.checked,`#${t.id}`,e)};fcn_updateToggle(FcnFormatting.get()[e],`#${t.id}`,e,{save:!1})})),_$$("#reader-settings-chapter-notes-toggle").forEach((t=>{const e={notes:!0},n="show-chapter-notes";t.onclick=a=>{fcn_updateToggle(a.currentTarget.checked,`#${t.id}`,n,e)};fcn_updateToggle(FcnFormatting.get()[n],`#${t.id}`,n,{save:!1,...e})})),_$$("#reader-settings-comments-toggle").forEach((t=>{const e={comments:!0},n="show-comments";t.onclick=a=>{fcn_updateToggle(a.currentTarget.checked,`#${t.id}`,n,e)};fcn_updateToggle(FcnFormatting.get()[n],`#${t.id}`,n,{save:!1,...e})})),_$$("#reader-settings-sensitive-content-toggle").forEach((t=>{const e={toggleClass:"hide-sensitive",invertClass:!0,sensitiveContent:!0},n="show-sensitive-content";t.onclick=a=>{fcn_updateToggle(a.currentTarget.checked,`#${t.id}`,n,e)};fcn_updateToggle(FcnFormatting.get()[n],`#${t.id}`,n,{save:!1,...e})}));var diff_match_patch=function(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32},DIFF_DELETE=-1,DIFF_INSERT=1,DIFF_EQUAL=0;diff_match_patch.Diff=function(t,e){this[0]=t,this[1]=e},diff_match_patch.Diff.prototype.length=2,diff_match_patch.Diff.prototype.toString=function(){return this[0]+","+this[1]},diff_match_patch.prototype.diff_main=function(t,e,n,a){if(void 0===a&&(a=0>=this.Diff_Timeout?Number.MAX_VALUE:(new Date).getTime()+1e3*this.Diff_Timeout),null==t||null==e)throw Error("Null input. (diff_main)");if(t==e)return t?[new diff_match_patch.Diff(DIFF_EQUAL,t)]:[];void 0===n&&(n=!0);var s=n,i=this.diff_commonPrefix(t,e);n=t.substring(0,i),t=t.substring(i),e=e.substring(i),i=this.diff_commonSuffix(t,e);var r=t.substring(t.length-i);return t=t.substring(0,t.length-i),e=e.substring(0,e.length-i),t=this.diff_compute_(t,e,s,a),n&&t.unshift(new diff_match_patch.Diff(DIFF_EQUAL,n)),r&&t.push(new diff_match_patch.Diff(DIFF_EQUAL,r)),this.diff_cleanupMerge(t),t},diff_match_patch.prototype.diff_compute_=function(t,e,n,a){if(!t)return[new diff_match_patch.Diff(DIFF_INSERT,e)];if(!e)return[new diff_match_patch.Diff(DIFF_DELETE,t)];var s=t.length>e.length?t:e,i=t.length>e.length?e:t,r=s.indexOf(i);return-1!=r?(n=[new diff_match_patch.Diff(DIFF_INSERT,s.substring(0,r)),new diff_match_patch.Diff(DIFF_EQUAL,i),new diff_match_patch.Diff(DIFF_INSERT,s.substring(r+i.length))],t.length>e.length&&(n[0][0]=n[2][0]=DIFF_DELETE),n):1==i.length?[new diff_match_patch.Diff(DIFF_DELETE,t),new diff_match_patch.Diff(DIFF_INSERT,e)]:(s=this.diff_halfMatch_(t,e))?(e=s[1],i=s[3],t=s[4],s=this.diff_main(s[0],s[2],n,a),n=this.diff_main(e,i,n,a),s.concat([new diff_match_patch.Diff(DIFF_EQUAL,t)],n)):n&&100<t.length&&100<e.length?this.diff_lineMode_(t,e,a):this.diff_bisect_(t,e,a)},diff_match_patch.prototype.diff_lineMode_=function(t,e,n){var a=this.diff_linesToChars_(t,e);t=a.chars1,e=a.chars2,a=a.lineArray,t=this.diff_main(t,e,!1,n),this.diff_charsToLines_(t,a),this.diff_cleanupSemantic(t),t.push(new diff_match_patch.Diff(DIFF_EQUAL,""));for(var s=a=e=0,i="",r="";e<t.length;){switch(t[e][0]){case DIFF_INSERT:s++,r+=t[e][1];break;case DIFF_DELETE:a++,i+=t[e][1];break;case DIFF_EQUAL:if(1<=a&&1<=s){for(t.splice(e-a-s,a+s),e=e-a-s,s=(a=this.diff_main(i,r,!1,n)).length-1;0<=s;s--)t.splice(e,0,a[s]);e+=a.length}a=s=0,r=i=""}e++}return t.pop(),t},diff_match_patch.prototype.diff_bisect_=function(t,e,n){for(var a=t.length,s=e.length,i=Math.ceil((a+s)/2),r=2*i,o=Array(r),c=Array(r),l=0;l<r;l++)o[l]=-1,c[l]=-1;o[i+1]=0,c[i+1]=0;for(var d=0!=(l=a-s)%2,h=0,f=0,g=0,u=0,m=0;m<i&&!((new Date).getTime()>n);m++){for(var p=-m+h;p<=m-f;p+=2){for(var _=i+p,v=p==-m||p!=m&&o[_-1]<o[_+1]?o[_+1]:o[_-1]+1,k=v-p;v<a&&k<s&&t.charAt(v)==e.charAt(k);)v++,k++;if(o[_]=v,v>a)f+=2;else if(k>s)h+=2;else if(d&&(0<=(_=i+l-p)&&_<r&&-1!=c[_])){var b=a-c[_];if(v>=b)return this.diff_bisectSplit_(t,e,v,k,n)}}for(p=-m+g;p<=m-u;p+=2){for(_=i+p,v=(b=p==-m||p!=m&&c[_-1]<c[_+1]?c[_+1]:c[_-1]+1)-p;b<a&&v<s&&t.charAt(a-b-1)==e.charAt(s-v-1);)b++,v++;if(c[_]=b,b>a)u+=2;else if(v>s)g+=2;else if(!d&&(0<=(_=i+l-p)&&_<r&&-1!=o[_]&&(k=i+(v=o[_])-_,v>=(b=a-b))))return this.diff_bisectSplit_(t,e,v,k,n)}}return[new diff_match_patch.Diff(DIFF_DELETE,t),new diff_match_patch.Diff(DIFF_INSERT,e)]},diff_match_patch.prototype.diff_bisectSplit_=function(t,e,n,a,s){var i=t.substring(0,n),r=e.substring(0,a);return t=t.substring(n),e=e.substring(a),i=this.diff_main(i,r,!1,s),s=this.diff_main(t,e,!1,s),i.concat(s)},diff_match_patch.prototype.diff_linesToChars_=function(t,e){function n(t){for(var e="",n=0,r=-1,o=a.length;r<t.length-1;){-1==(r=t.indexOf("\n",n))&&(r=t.length-1);var c=t.substring(n,r+1);void 0!==s[c]?e+=String.fromCharCode(s[c]):(o==i&&(c=t.substring(n),r=t.length),e+=String.fromCharCode(o),s[c]=o,a[o++]=c),n=r+1}return e}var a=[],s={};a[0]="";var i=4e4,r=n(t);return i=65535,{chars1:r,chars2:n(e),lineArray:a}},diff_match_patch.prototype.diff_charsToLines_=function(t,e){for(var n=0;n<t.length;n++){for(var a=t[n][1],s=[],i=0;i<a.length;i++)s[i]=e[a.charCodeAt(i)];t[n][1]=s.join("")}},diff_match_patch.prototype.diff_commonPrefix=function(t,e){if(!t||!e||t.charAt(0)!=e.charAt(0))return 0;for(var n=0,a=Math.min(t.length,e.length),s=a,i=0;n<s;)t.substring(i,s)==e.substring(i,s)?i=n=s:a=s,s=Math.floor((a-n)/2+n);return s},diff_match_patch.prototype.diff_commonSuffix=function(t,e){if(!t||!e||t.charAt(t.length-1)!=e.charAt(e.length-1))return 0;for(var n=0,a=Math.min(t.length,e.length),s=a,i=0;n<s;)t.substring(t.length-s,t.length-i)==e.substring(e.length-s,e.length-i)?i=n=s:a=s,s=Math.floor((a-n)/2+n);return s},diff_match_patch.prototype.diff_commonOverlap_=function(t,e){var n=t.length,a=e.length;if(0==n||0==a)return 0;if(n>a?t=t.substring(n-a):n<a&&(e=e.substring(0,n)),n=Math.min(n,a),t==e)return n;a=0;for(var s=1;;){var i=t.substring(n-s);if(-1==(i=e.indexOf(i)))return a;s+=i,0!=i&&t.substring(n-s)!=e.substring(0,s)||(a=s,s++)}},diff_match_patch.prototype.diff_halfMatch_=function(t,e){function n(t,e,n){for(var a,s,r,o,c=t.substring(n,n+Math.floor(t.length/4)),l=-1,d="";-1!=(l=e.indexOf(c,l+1));){var h=i.diff_commonPrefix(t.substring(n),e.substring(l)),f=i.diff_commonSuffix(t.substring(0,n),e.substring(0,l));d.length<f+h&&(d=e.substring(l-f,l)+e.substring(l,l+h),a=t.substring(0,n-f),s=t.substring(n+h),r=e.substring(0,l-f),o=e.substring(l+h))}return 2*d.length>=t.length?[a,s,r,o,d]:null}if(0>=this.Diff_Timeout)return null;var a=t.length>e.length?t:e,s=t.length>e.length?e:t;if(4>a.length||2*s.length<a.length)return null;var i=this,r=n(a,s,Math.ceil(a.length/4));if(a=n(a,s,Math.ceil(a.length/2)),!r&&!a)return null;if(r=a?r&&r[4].length>a[4].length?r:a:r,t.length>e.length){a=r[0],s=r[1];var o=r[2],c=r[3]}else o=r[0],c=r[1],a=r[2],s=r[3];return[a,s,o,c,r[4]]},diff_match_patch.prototype.diff_cleanupSemantic=function(t){for(var e=!1,n=[],a=0,s=null,i=0,r=0,o=0,c=0,l=0;i<t.length;)t[i][0]==DIFF_EQUAL?(n[a++]=i,r=c,o=l,l=c=0,s=t[i][1]):(t[i][0]==DIFF_INSERT?c+=t[i][1].length:l+=t[i][1].length,s&&s.length<=Math.max(r,o)&&s.length<=Math.max(c,l)&&(t.splice(n[a-1],0,new diff_match_patch.Diff(DIFF_DELETE,s)),t[n[a-1]+1][0]=DIFF_INSERT,a--,i=0<--a?n[a-1]:-1,l=c=o=r=0,s=null,e=!0)),i++;for(e&&this.diff_cleanupMerge(t),this.diff_cleanupSemanticLossless(t),i=1;i<t.length;)t[i-1][0]==DIFF_DELETE&&t[i][0]==DIFF_INSERT&&(e=t[i-1][1],n=t[i][1],(a=this.diff_commonOverlap_(e,n))>=(s=this.diff_commonOverlap_(n,e))?(a>=e.length/2||a>=n.length/2)&&(t.splice(i,0,new diff_match_patch.Diff(DIFF_EQUAL,n.substring(0,a))),t[i-1][1]=e.substring(0,e.length-a),t[i+1][1]=n.substring(a),i++):(s>=e.length/2||s>=n.length/2)&&(t.splice(i,0,new diff_match_patch.Diff(DIFF_EQUAL,e.substring(0,s))),t[i-1][0]=DIFF_INSERT,t[i-1][1]=n.substring(0,n.length-s),t[i+1][0]=DIFF_DELETE,t[i+1][1]=e.substring(s),i++),i++),i++},diff_match_patch.prototype.diff_cleanupSemanticLossless=function(t){function e(t,e){if(!t||!e)return 6;var n=t.charAt(t.length-1),a=e.charAt(0),s=n.match(diff_match_patch.nonAlphaNumericRegex_),i=a.match(diff_match_patch.nonAlphaNumericRegex_),r=s&&n.match(diff_match_patch.whitespaceRegex_),o=i&&a.match(diff_match_patch.whitespaceRegex_);n=r&&n.match(diff_match_patch.linebreakRegex_),a=o&&a.match(diff_match_patch.linebreakRegex_);var c=n&&t.match(diff_match_patch.blanklineEndRegex_),l=a&&e.match(diff_match_patch.blanklineStartRegex_);return c||l?5:n||a?4:s&&!r&&o?3:r||o?2:s||i?1:0}for(var n=1;n<t.length-1;){if(t[n-1][0]==DIFF_EQUAL&&t[n+1][0]==DIFF_EQUAL){var a=t[n-1][1],s=t[n][1],i=t[n+1][1],r=this.diff_commonSuffix(a,s);if(r){var o=s.substring(s.length-r);a=a.substring(0,a.length-r),s=o+s.substring(0,s.length-r),i=o+i}r=a,o=s;for(var c=i,l=e(a,s)+e(s,i);s.charAt(0)===i.charAt(0);){a+=s.charAt(0),s=s.substring(1)+i.charAt(0),i=i.substring(1);var d=e(a,s)+e(s,i);d>=l&&(l=d,r=a,o=s,c=i)}t[n-1][1]!=r&&(r?t[n-1][1]=r:(t.splice(n-1,1),n--),t[n][1]=o,c?t[n+1][1]=c:(t.splice(n+1,1),n--))}n++}},diff_match_patch.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,diff_match_patch.whitespaceRegex_=/\s/,diff_match_patch.linebreakRegex_=/[\r\n]/,diff_match_patch.blanklineEndRegex_=/\n\r?\n$/,diff_match_patch.blanklineStartRegex_=/^\r?\n\r?\n/,diff_match_patch.prototype.diff_cleanupEfficiency=function(t){for(var e=!1,n=[],a=0,s=null,i=0,r=!1,o=!1,c=!1,l=!1;i<t.length;)t[i][0]==DIFF_EQUAL?(t[i][1].length<this.Diff_EditCost&&(c||l)?(n[a++]=i,r=c,o=l,s=t[i][1]):(a=0,s=null),c=l=!1):(t[i][0]==DIFF_DELETE?l=!0:c=!0,s&&(r&&o&&c&&l||s.length<this.Diff_EditCost/2&&3==r+o+c+l)&&(t.splice(n[a-1],0,new diff_match_patch.Diff(DIFF_DELETE,s)),t[n[a-1]+1][0]=DIFF_INSERT,a--,s=null,r&&o?(c=l=!0,a=0):(i=0<--a?n[a-1]:-1,c=l=!1),e=!0)),i++;e&&this.diff_cleanupMerge(t)},diff_match_patch.prototype.diff_cleanupMerge=function(t){t.push(new diff_match_patch.Diff(DIFF_EQUAL,""));for(var e,n=0,a=0,s=0,i="",r="";n<t.length;)switch(t[n][0]){case DIFF_INSERT:s++,r+=t[n][1],n++;break;case DIFF_DELETE:a++,i+=t[n][1],n++;break;case DIFF_EQUAL:1<a+s?(0!==a&&0!==s&&(0!==(e=this.diff_commonPrefix(r,i))&&(0<n-a-s&&t[n-a-s-1][0]==DIFF_EQUAL?t[n-a-s-1][1]+=r.substring(0,e):(t.splice(0,0,new diff_match_patch.Diff(DIFF_EQUAL,r.substring(0,e))),n++),r=r.substring(e),i=i.substring(e)),0!==(e=this.diff_commonSuffix(r,i))&&(t[n][1]=r.substring(r.length-e)+t[n][1],r=r.substring(0,r.length-e),i=i.substring(0,i.length-e))),n-=a+s,t.splice(n,a+s),i.length&&(t.splice(n,0,new diff_match_patch.Diff(DIFF_DELETE,i)),n++),r.length&&(t.splice(n,0,new diff_match_patch.Diff(DIFF_INSERT,r)),n++),n++):0!==n&&t[n-1][0]==DIFF_EQUAL?(t[n-1][1]+=t[n][1],t.splice(n,1)):n++,a=s=0,r=i=""}for(""===t[t.length-1][1]&&t.pop(),a=!1,n=1;n<t.length-1;)t[n-1][0]==DIFF_EQUAL&&t[n+1][0]==DIFF_EQUAL&&(t[n][1].substring(t[n][1].length-t[n-1][1].length)==t[n-1][1]?(t[n][1]=t[n-1][1]+t[n][1].substring(0,t[n][1].length-t[n-1][1].length),t[n+1][1]=t[n-1][1]+t[n+1][1],t.splice(n-1,1),a=!0):t[n][1].substring(0,t[n+1][1].length)==t[n+1][1]&&(t[n-1][1]+=t[n+1][1],t[n][1]=t[n][1].substring(t[n+1][1].length)+t[n+1][1],t.splice(n+1,1),a=!0)),n++;a&&this.diff_cleanupMerge(t)},diff_match_patch.prototype.diff_xIndex=function(t,e){var n,a=0,s=0,i=0,r=0;for(n=0;n<t.length&&(t[n][0]!==DIFF_INSERT&&(a+=t[n][1].length),t[n][0]!==DIFF_DELETE&&(s+=t[n][1].length),!(a>e));n++)i=a,r=s;return t.length!=n&&t[n][0]===DIFF_DELETE?r:r+(e-i)},diff_match_patch.prototype.diff_prettyHtml=function(t){for(var e=[],n=/&/g,a=/</g,s=/>/g,i=/\n/g,r=0;r<t.length;r++){var o=t[r][0],c=t[r][1].replace(n,"&amp;").replace(a,"&lt;").replace(s,"&gt;").replace(i,"&para;<br>");switch(o){case DIFF_INSERT:e[r]='<ins style="background:#e6ffe6;">'+c+"</ins>";break;case DIFF_DELETE:e[r]='<del style="background:#ffe6e6;">'+c+"</del>";break;case DIFF_EQUAL:e[r]="<span>"+c+"</span>"}}return e.join("")},diff_match_patch.prototype.diff_text1=function(t){for(var e=[],n=0;n<t.length;n++)t[n][0]!==DIFF_INSERT&&(e[n]=t[n][1]);return e.join("")},diff_match_patch.prototype.diff_text2=function(t){for(var e=[],n=0;n<t.length;n++)t[n][0]!==DIFF_DELETE&&(e[n]=t[n][1]);return e.join("")},diff_match_patch.prototype.diff_levenshtein=function(t){for(var e=0,n=0,a=0,s=0;s<t.length;s++){var i=t[s][1];switch(t[s][0]){case DIFF_INSERT:n+=i.length;break;case DIFF_DELETE:a+=i.length;break;case DIFF_EQUAL:e+=Math.max(n,a),a=n=0}}return e+Math.max(n,a)},diff_match_patch.prototype.diff_toDelta=function(t){for(var e=[],n=0;n<t.length;n++)switch(t[n][0]){case DIFF_INSERT:e[n]="+"+encodeURI(t[n][1]);break;case DIFF_DELETE:e[n]="-"+t[n][1].length;break;case DIFF_EQUAL:e[n]="="+t[n][1].length}return e.join("\t").replace(/%20/g," ")},diff_match_patch.prototype.diff_fromDelta=function(t,e){for(var n=[],a=0,s=0,i=e.split(/\t/g),r=0;r<i.length;r++){var o=i[r].substring(1);switch(i[r].charAt(0)){case"+":try{n[a++]=new diff_match_patch.Diff(DIFF_INSERT,decodeURI(o))}catch(t){throw Error("Illegal escape in diff_fromDelta: "+o)}break;case"-":case"=":var c=parseInt(o,10);if(isNaN(c)||0>c)throw Error("Invalid number in diff_fromDelta: "+o);o=t.substring(s,s+=c),"="==i[r].charAt(0)?n[a++]=new diff_match_patch.Diff(DIFF_EQUAL,o):n[a++]=new diff_match_patch.Diff(DIFF_DELETE,o);break;default:if(i[r])throw Error("Invalid diff operation in diff_fromDelta: "+i[r])}}if(s!=t.length)throw Error("Delta length ("+s+") does not equal source text length ("+t.length+").");return n},diff_match_patch.prototype.match_main=function(t,e,n){if(null==t||null==e||null==n)throw Error("Null input. (match_main)");return n=Math.max(0,Math.min(n,t.length)),t==e?0:t.length?t.substring(n,n+e.length)==e?n:this.match_bitap_(t,e,n):-1},diff_match_patch.prototype.match_bitap_=function(t,e,n){function a(t,a){var s=t/e.length,r=Math.abs(n-a);return i.Match_Distance?s+r/i.Match_Distance:r?1:s}if(e.length>this.Match_MaxBits)throw Error("Pattern too long for this browser.");var s=this.match_alphabet_(e),i=this,r=this.Match_Threshold,o=t.indexOf(e,n);-1!=o&&(r=Math.min(a(0,o),r),-1!=(o=t.lastIndexOf(e,n+e.length))&&(r=Math.min(a(0,o),r)));var c=1<<e.length-1;o=-1;for(var l,d,h,f=e.length+t.length,g=0;g<e.length;g++){for(l=0,d=f;l<d;)a(g,n+d)<=r?l=d:f=d,d=Math.floor((f-l)/2+l);f=d,l=Math.max(1,n-d+1);var u=Math.min(n+d,t.length)+e.length;for((d=Array(u+2))[u+1]=(1<<g)-1;u>=l;u--){var m=s[t.charAt(u-1)];if(d[u]=0===g?(d[u+1]<<1|1)&m:(d[u+1]<<1|1)&m|(h[u+1]|h[u])<<1|1|h[u+1],d[u]&c&&(m=a(g,u-1))<=r){if(r=m,!((o=u-1)>n))break;l=Math.max(1,2*n-o)}}if(a(g+1,n)>r)break;h=d}return o},diff_match_patch.prototype.match_alphabet_=function(t){for(var e={},n=0;n<t.length;n++)e[t.charAt(n)]=0;for(n=0;n<t.length;n++)e[t.charAt(n)]|=1<<t.length-n-1;return e},diff_match_patch.prototype.patch_addContext_=function(t,e){if(0!=e.length){if(null===t.start2)throw Error("patch not initialized");for(var n=e.substring(t.start2,t.start2+t.length1),a=0;e.indexOf(n)!=e.lastIndexOf(n)&&n.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)a+=this.Patch_Margin,n=e.substring(t.start2-a,t.start2+t.length1+a);a+=this.Patch_Margin,(n=e.substring(t.start2-a,t.start2))&&t.diffs.unshift(new diff_match_patch.Diff(DIFF_EQUAL,n)),(a=e.substring(t.start2+t.length1,t.start2+t.length1+a))&&t.diffs.push(new diff_match_patch.Diff(DIFF_EQUAL,a)),t.start1-=n.length,t.start2-=n.length,t.length1+=n.length+a.length,t.length2+=n.length+a.length}},diff_match_patch.prototype.patch_make=function(t,e,n){if("string"==typeof t&&"string"==typeof e&&void 0===n){var a=t;2<(e=this.diff_main(a,e,!0)).length&&(this.diff_cleanupSemantic(e),this.diff_cleanupEfficiency(e))}else if(t&&"object"==typeof t&&void 0===e&&void 0===n)e=t,a=this.diff_text1(e);else if("string"==typeof t&&e&&"object"==typeof e&&void 0===n)a=t;else{if("string"!=typeof t||"string"!=typeof e||!n||"object"!=typeof n)throw Error("Unknown call format to patch_make.");a=t,e=n}if(0===e.length)return[];n=[],t=new diff_match_patch.patch_obj;for(var s=0,i=0,r=0,o=a,c=0;c<e.length;c++){var l=e[c][0],d=e[c][1];switch(s||l===DIFF_EQUAL||(t.start1=i,t.start2=r),l){case DIFF_INSERT:t.diffs[s++]=e[c],t.length2+=d.length,a=a.substring(0,r)+d+a.substring(r);break;case DIFF_DELETE:t.length1+=d.length,t.diffs[s++]=e[c],a=a.substring(0,r)+a.substring(r+d.length);break;case DIFF_EQUAL:d.length<=2*this.Patch_Margin&&s&&e.length!=c+1?(t.diffs[s++]=e[c],t.length1+=d.length,t.length2+=d.length):d.length>=2*this.Patch_Margin&&s&&(this.patch_addContext_(t,o),n.push(t),t=new diff_match_patch.patch_obj,s=0,o=a,i=r)}l!==DIFF_INSERT&&(i+=d.length),l!==DIFF_DELETE&&(r+=d.length)}return s&&(this.patch_addContext_(t,o),n.push(t)),n},diff_match_patch.prototype.patch_deepCopy=function(t){for(var e=[],n=0;n<t.length;n++){var a=t[n],s=new diff_match_patch.patch_obj;s.diffs=[];for(var i=0;i<a.diffs.length;i++)s.diffs[i]=new diff_match_patch.Diff(a.diffs[i][0],a.diffs[i][1]);s.start1=a.start1,s.start2=a.start2,s.length1=a.length1,s.length2=a.length2,e[n]=s}return e},diff_match_patch.prototype.patch_apply=function(t,e){if(0==t.length)return[e,[]];t=this.patch_deepCopy(t);var n=this.patch_addPadding(t);e=n+e+n,this.patch_splitMax(t);for(var a=0,s=[],i=0;i<t.length;i++){var r=t[i].start2+a,o=this.diff_text1(t[i].diffs),c=-1;if(o.length>this.Match_MaxBits){var l=this.match_main(e,o.substring(0,this.Match_MaxBits),r);-1!=l&&(-1==(c=this.match_main(e,o.substring(o.length-this.Match_MaxBits),r+o.length-this.Match_MaxBits))||l>=c)&&(l=-1)}else l=this.match_main(e,o,r);if(-1==l)s[i]=!1,a-=t[i].length2-t[i].length1;else if(s[i]=!0,a=l-r,o==(r=-1==c?e.substring(l,l+o.length):e.substring(l,c+this.Match_MaxBits)))e=e.substring(0,l)+this.diff_text2(t[i].diffs)+e.substring(l+o.length);else if(r=this.diff_main(o,r,!1),o.length>this.Match_MaxBits&&this.diff_levenshtein(r)/o.length>this.Patch_DeleteThreshold)s[i]=!1;else{var d;for(this.diff_cleanupSemanticLossless(r),o=0,c=0;c<t[i].diffs.length;c++){var h=t[i].diffs[c];h[0]!==DIFF_EQUAL&&(d=this.diff_xIndex(r,o)),h[0]===DIFF_INSERT?e=e.substring(0,l+d)+h[1]+e.substring(l+d):h[0]===DIFF_DELETE&&(e=e.substring(0,l+d)+e.substring(l+this.diff_xIndex(r,o+h[1].length))),h[0]!==DIFF_DELETE&&(o+=h[1].length)}}}return[e=e.substring(n.length,e.length-n.length),s]},diff_match_patch.prototype.patch_addPadding=function(t){for(var e=this.Patch_Margin,n="",a=1;a<=e;a++)n+=String.fromCharCode(a);for(a=0;a<t.length;a++)t[a].start1+=e,t[a].start2+=e;var s=(a=t[0]).diffs;if(0==s.length||s[0][0]!=DIFF_EQUAL)s.unshift(new diff_match_patch.Diff(DIFF_EQUAL,n)),a.start1-=e,a.start2-=e,a.length1+=e,a.length2+=e;else if(e>s[0][1].length){var i=e-s[0][1].length;s[0][1]=n.substring(s[0][1].length)+s[0][1],a.start1-=i,a.start2-=i,a.length1+=i,a.length2+=i}return 0==(s=(a=t[t.length-1]).diffs).length||s[s.length-1][0]!=DIFF_EQUAL?(s.push(new diff_match_patch.Diff(DIFF_EQUAL,n)),a.length1+=e,a.length2+=e):e>s[s.length-1][1].length&&(i=e-s[s.length-1][1].length,s[s.length-1][1]+=n.substring(0,i),a.length1+=i,a.length2+=i),n},diff_match_patch.prototype.patch_splitMax=function(t){for(var e=this.Match_MaxBits,n=0;n<t.length;n++)if(!(t[n].length1<=e)){var a=t[n];t.splice(n--,1);for(var s=a.start1,i=a.start2,r="";0!==a.diffs.length;){var o=new diff_match_patch.patch_obj,c=!0;for(o.start1=s-r.length,o.start2=i-r.length,""!==r&&(o.length1=o.length2=r.length,o.diffs.push(new diff_match_patch.Diff(DIFF_EQUAL,r)));0!==a.diffs.length&&o.length1<e-this.Patch_Margin;){r=a.diffs[0][0];var l=a.diffs[0][1];r===DIFF_INSERT?(o.length2+=l.length,i+=l.length,o.diffs.push(a.diffs.shift()),c=!1):r===DIFF_DELETE&&1==o.diffs.length&&o.diffs[0][0]==DIFF_EQUAL&&l.length>2*e?(o.length1+=l.length,s+=l.length,c=!1,o.diffs.push(new diff_match_patch.Diff(r,l)),a.diffs.shift()):(l=l.substring(0,e-o.length1-this.Patch_Margin),o.length1+=l.length,s+=l.length,r===DIFF_EQUAL?(o.length2+=l.length,i+=l.length):c=!1,o.diffs.push(new diff_match_patch.Diff(r,l)),l==a.diffs[0][1]?a.diffs.shift():a.diffs[0][1]=a.diffs[0][1].substring(l.length))}r=(r=this.diff_text2(o.diffs)).substring(r.length-this.Patch_Margin),""!==(l=this.diff_text1(a.diffs).substring(0,this.Patch_Margin))&&(o.length1+=l.length,o.length2+=l.length,0!==o.diffs.length&&o.diffs[o.diffs.length-1][0]===DIFF_EQUAL?o.diffs[o.diffs.length-1][1]+=l:o.diffs.push(new diff_match_patch.Diff(DIFF_EQUAL,l))),c||t.splice(++n,0,o)}}},diff_match_patch.prototype.patch_toText=function(t){for(var e=[],n=0;n<t.length;n++)e[n]=t[n];return e.join("")},diff_match_patch.prototype.patch_fromText=function(t){var e=[];if(!t)return e;t=t.split("\n");for(var n=0,a=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;n<t.length;){var s=t[n].match(a);if(!s)throw Error("Invalid patch string: "+t[n]);var i=new diff_match_patch.patch_obj;for(e.push(i),i.start1=parseInt(s[1],10),""===s[2]?(i.start1--,i.length1=1):"0"==s[2]?i.length1=0:(i.start1--,i.length1=parseInt(s[2],10)),i.start2=parseInt(s[3],10),""===s[4]?(i.start2--,i.length2=1):"0"==s[4]?i.length2=0:(i.start2--,i.length2=parseInt(s[4],10)),n++;n<t.length;){s=t[n].charAt(0);try{var r=decodeURI(t[n].substring(1))}catch(t){throw Error("Illegal escape in patch_fromText: "+r)}if("-"==s)i.diffs.push(new diff_match_patch.Diff(DIFF_DELETE,r));else if("+"==s)i.diffs.push(new diff_match_patch.Diff(DIFF_INSERT,r));else if(" "==s)i.diffs.push(new diff_match_patch.Diff(DIFF_EQUAL,r));else{if("@"==s)break;if(""!==s)throw Error('Invalid patch mode "'+s+'" in: '+r)}n++}}return e},diff_match_patch.patch_obj=function(){this.diffs=[],this.start2=this.start1=null,this.length2=this.length1=0},diff_match_patch.patch_obj.prototype.toString=function(){for(var t,e=["@@ -"+(0===this.length1?this.start1+",0":1==this.length1?this.start1+1:this.start1+1+","+this.length1)+" +"+(0===this.length2?this.start2+",0":1==this.length2?this.start2+1:this.start2+1+","+this.length2)+" @@\n"],n=0;n<this.diffs.length;n++){switch(this.diffs[n][0]){case DIFF_INSERT:t="+";break;case DIFF_DELETE:t="-";break;case DIFF_EQUAL:t=" "}e[n+1]=t+encodeURI(this.diffs[n][1])+"\n"}return e.join("").replace(/%20/g," ")},this.diff_match_patch=diff_match_patch,this.DIFF_DELETE=DIFF_DELETE,this.DIFF_INSERT=DIFF_INSERT,this.DIFF_EQUAL=DIFF_EQUAL,diff_match_patch.prototype.fcn_prettyHtml=function(t){for(var e=[],n=/&/g,a=/</g,s=/>/g,i=/\n/g,r=0;r<t.length;r++){var o=t[r][0],c=t[r][1].replace(n,"&amp;").replace(a,"&lt;").replace(s,"&gt;").replace(i,"&para;<br>");switch(o){case 1:e[r]=`<ins>${c}</ins>`;break;case-1:e[r]=`<del>${c}</del>`;break;case 0:e[r]=`${c}`}}return e.join("")},application.register("fictioneer-suggestion",class extends Stimulus.Controller{modal=_$$$("suggestions-modal");floatingButton=_$$$("selection-tools");input=_$$$("suggestions-modal-input");current=_$$$("suggestions-modal-original");diff=_$$$("suggestions-modal-diff");reset=_$$$("button-suggestion-reset");submit=_$$$("button-suggestion-submit");original="";text="";open=!1;paragraph=null;dmp=new diff_match_patch;initialize(){this.floatingButton&&this.floatingButton.addEventListener("click",(t=>{this.toggleModalViaSelection(t.currentTarget)})),this.input.addEventListener("input",(()=>this.#M())),this.reset.addEventListener("click",(()=>this.#R())),this.submit.addEventListener("click",(()=>this.#N()))}connect(){window.FictioneerApp.Controllers.fictioneerSuggestion=this}clickOutside(){this.open&&this.#j()}toggleModalViaSelection(t){this.paragraph=this.#P(),this.toggleModalVisibility(t)}toggleModalViaParagraph(t){this.paragraph=_$(".selected-paragraph"),this.text=FcnUtils.extractTextNodes(this.paragraph),this.toggleModalVisibility(t.currentTarget)}toggleModalVisibility(t){const e=fcn(),n=window.FictioneerApp.Controllers.fictioneerChapter;e?n?(e.toggleModalVisibility(t,"suggestions-modal"),n.closeTools(),this.#B(),this.original=this.text,this.current.innerText=this.text,this.diff.innerText=this.text,this.input.value=this.text,this.input.focus()):fcn_showNotification("Error: Chapter Controller not connected.",3,"warning"):fcn_showNotification("Error: Fictioneer Controller not connected.",3,"warning")}toggleFloatingButton(){FcnGlobals.eSite.classList.contains("transformed-site")||window.getSelection().rangeCount<1||!window.getSelection().getRangeAt(0).startContainer.parentNode.closest(".content-section")||setTimeout((()=>{if(this.text=window.getSelection().toString().replaceAll("\n\n","\n").trim(),""!==this.text){const t=this.#O();this.#H(t.x,t.y)}else this.#j()}),10)}closeModal(){this.open=!1,this.original="",this.text="",this.paragraph=null,fcn().closeModals()}#H(t,e){this.open=!0;const n=document.documentElement.offsetWidth/2+this.floatingButton.offsetWidth,a=_$$$("wpadminbar")?.offsetHeight??0;this.floatingButton.style.transform=t>n?"translate(-100%)":"translate(0)",this.floatingButton.style.top=e+4-a+"px",this.floatingButton.style.left=`${t}px`,this.floatingButton.classList.remove("invisible")}#j(){this.open=!1,this.floatingButton.style.top="0",this.floatingButton.style.left="-1000px",this.floatingButton.classList.add("invisible")}#P(){const t=window.getSelection();return t.rangeCount?t.getRangeAt(0).startContainer.parentNode.closest("p"):null}#O(){let t=0,e=0;if(void 0!==window.getSelection){const n=window.getSelection();if(0!==n.rangeCount){let a=n.getRangeAt(0).cloneRange().getClientRects();a=a[a.length-1],a&&(t=a.right+window.scrollX,e=a.bottom+window.scrollY)}}return{x:t,y:e}}#B(){window.getSelection&&(window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges())}#M(){this.diff.innerHTML=this.#q(this.original,this.input.value)}#R(){this.input.value=this.original,this.diff.innerText=this.original}#q(t,e){const n=this.dmp.diff_main(t,e);return this.dmp.diff_cleanupEfficiency(n),this.dmp.fcn_prettyHtml(n)}#N(){const t=this.paragraph?.id??null;let e=this.diff.innerHTML;[["¶","&para;\n"],["<br>","\n"],["<ins>","[ins]"],["</ins>","[/ins]"],["<del>","[del]"],["</del>","[/del]"]].forEach((([t,n])=>{e=e.replaceAll(t,n)})),t&&(e=`${e} [anchor]${t}[/anchor]`),FcnUtils.appendToComment(`\n[quote]${e}[/quote]\n`),this.closeModal(),fcn_showNotification(fictioneer_tl.notification.suggestionAppendedToComment)}});const fcn_ttsInterface=_$$$("tts-interface");var fcn_utter,fcn_synth,fcn_ttsStack=[],fcn_currentReadingId=-1,fcn_ttsPauseTimestamp=-1,fcn_ttsCurrentText="",fcn_ttsSettings=fcn_getTTSsettings(),fcn_voices=[];if("undefined"!=typeof speechSynthesis&&fcn_ttsInterface){fcn_synth=window.speechSynthesis,(fcn_utter=new SpeechSynthesisUtterance).lang=document.documentElement.lang;const t=setTimeout((()=>{fcn_setupTTS()}),2e3);"onvoiceschanged"in speechSynthesis&&fcn_synth.addEventListener("voiceschanged",(()=>{fcn_setupTTS(),clearTimeout(t)}),{once:!0})}function fcn_setupTTS(){fcn_voices.length>0||(fcn_setUpVoices(),
fcn_updateVolume(fcn_ttsSettings.volume),fcn_updatePitch(fcn_ttsSettings.pitch),fcn_updateRate(fcn_ttsSettings.rate))}function fcn_setTTSsettings(t){fcn_ttsSettings=t,localStorage.setItem("ttsSettings",JSON.stringify(t))}function fcn_getTTSsettings(){const t=FcnUtils.parseJSON(localStorage.getItem("ttsSettings"))??{};return fcn_setTTSsettings(t),t}function fcn_setUpVoices(){const t=fcn_synth.getVoices(),e=_$$$("tts-voice-select");if(!e)return;let n=0;for(let a=0;a<t.length;a++){const s=t[a];fcn_voices.push(s);const i=document.createElement("option");i.value=n,i.innerHTML=`${s.name} (${s.lang})`,e.appendChild(i),n++}fcn_voices.length<1?_$(".tts-settings__voice-selection")?.remove():(e.addEventListener("change",(t=>{fcn_updateVoice(t.currentTarget.value)})),fcn_updateVoice(fcn_ttsSettings.voice))}function fcn_updateVoice(t){if(isNaN(t)||void 0===fcn_voices[t]){let e=fcn_voices.findIndex((t=>"Samantha"===t.name&&("en-US"===t.lang||"en_US"===t.lang)));e<0&&(e=fcn_voices.findIndex((t=>"en-US"===t.lang||"en_US"===t.lang))),t=e>-1?e:0}fcn_utter.voice=fcn_voices[t],_$$$("tts-voice-select").value=t,fcn_ttsSettings.voice=t,fcn_setTTSsettings(fcn_ttsSettings)}function fcn_updateVolume(t){t=isNaN(t)?100:parseInt(t),t=FcnUtils.clamp(0,100,t),_$$$("tts-volume-range").value=t,_$$$("tts-volume-text").value=t,_$$$("tts-volume-reset").classList.toggle("_modified",100!=t),fcn_ttsSettings.volume=t,fcn_setTTSsettings(fcn_ttsSettings),fcn_utter.volume=t/100}function fcn_updatePitch(t){t=isNaN(t)?1:parseFloat(t),t=FcnUtils.clamp(.2,1.8,t),_$$$("tts-pitch-range").value=t,_$$$("tts-pitch-text").value=t,_$$$("tts-pitch-reset").classList.toggle("_modified",1!=t),fcn_ttsSettings.pitch=t,fcn_setTTSsettings(fcn_ttsSettings),fcn_utter.pitch=t}function fcn_updateRate(t){t=isNaN(t)?1:parseFloat(t),t=FcnUtils.clamp(.2,1.8,t),_$$$("tts-rate-range").value=t,_$$$("tts-rate-text").value=t,_$$$("tts-rate-reset").classList.toggle("_modified",1!=t),fcn_ttsSettings.rate=t,fcn_setTTSsettings(fcn_ttsSettings),fcn_utter.rate=t}function fcn_readTextStack(){const t=_$(".current-reading");if(0===fcn_ttsStack.length)return fcn_ttsInterface.classList.add("ended"),t&&t.classList.remove("current-reading"),fcn_currentReadingId=-1,void(fcn_ttsCurrentText="");const e=fcn_ttsStack.shift();fcn_ttsCurrentText=e[1],fcn_currentReadingId!=e[0]&&(fcn_currentReadingId=e[0],t&&t.classList.remove("current-reading"),_$$$(fcn_currentReadingId)?.classList.add("current-reading")),fcn_utter.text=fcn_ttsCurrentText,fcn_utter.addEventListener("end",fcn_readTextStack,{once:!0}),fcn_synth.speak(fcn_utter)}function fcn_cleanUpActions(){_$$(".story__actions > *").forEach((t=>{const e=window.getComputedStyle(t);"none"!==e.display&&"hidden"!==e.visibility||t.remove()}))}function fcn_unsetOauth(t){const e=prompt(t.dataset.warning);e&&e.toLowerCase()==t.dataset.confirm.toLowerCase()&&FcnUtils.remoteAction("fictioneer_ajax_unset_my_oauth",{nonce:t.dataset.nonce,element:_$$$(`oauth-${t.dataset.channel}`),payload:{channel:t.dataset.channel,id:t.dataset.id},callback:(t,e)=>{t.success?(e.classList.remove("_connected"),e.classList.add("_disconnected"),e.querySelector("button").remove(),fcn_showNotification(e.dataset.unset)):e.style.background="var(--notice-warning-background)"},errorCallback:(t,e)=>{e.style.background="var(--notice-warning-background)"}})}function fcn_deleteMyAccount(t){const e=prompt(t.dataset.warning);e&&e.toLowerCase()==t.dataset.confirm.toLowerCase()&&(t.disabled=!0,FcnUtils.remoteAction("fictioneer_ajax_delete_my_account",{nonce:t.dataset.nonce,element:t,payload:{id:t.dataset.id},callback:(t,e)=>{t.success?location.reload():e.innerHTML=t.data.button},errorCallback:(t,e)=>{e.innerHTML=t.status??fictioneer_tl.notification.error}}))}function fcn_dataDeletionPrompt(t){const e=prompt(t.dataset.warning);return!(!e||e.toLowerCase()!=t.dataset.confirm.toLowerCase())}function fcn_clearData(t,e){const n=t.closest(".card");localStorage.removeItem("fcnBookshelfContent"),t.remove(),FcnUtils.remoteAction(e,{nonce:t.dataset.nonce,element:n,callback:(t,e)=>{t.success&&e&&(e.querySelector(".card__content").innerHTML=t.data.success)}})}function fcn_toggleFollow(t,e=null){const n=window.FictioneerApp.Controllers.fictioneerFollows;if(!n)return void fcn_showNotification("Error: Follows Controller not connected.",3,"warning");const a=FcnUtils.userData();("object"!=typeof a.follows.data||null===a.follows.data||Array.isArray(a.follows.data))&&(a.follows.data={}),(e=e??!a.follows.data[t])?a.follows.data[t]={story_id:parseInt(t),timestamp:Date.now()}:delete a.follows.data[t],a.lastLoaded=0,FcnUtils.setUserData(a),n.refreshView(),clearTimeout(n.timeout),n.timeout=setTimeout((()=>{FcnUtils.remoteAction("fictioneer_ajax_toggle_follow",{payload:{set:e,story_id:t}})}),FcnGlobals.debounceRate)}function fcn_toggleCheckmark(t,e=null,n=null){const a=window.FictioneerApp.Controllers.fictioneerCheckmarks;if(!a)return void fcn_showNotification("Error: Checkmarks Controller not connected.",3,"warning");const s=FcnUtils.userData();if(!s.checkmarks)return;let i="story";if((t=parseInt(t??0))<1)return void fcn_showNotification("Error: Invalid story ID.",3,"warning");if(null!==e){if((e=parseInt(e))<1)return void fcn_showNotification("Error: Invalid chapter ID.",3,"warning");i="chapter"}("object"!=typeof s.checkmarks.data||null===s.checkmarks.data||Array.isArray(s.checkmarks.data))&&(s.checkmarks.data={}),s.checkmarks.data[t]||(s.checkmarks.data[t]=[]),null===n&&(n="chapter"===i?!s.checkmarks.data[t]?.includes(e):!s.checkmarks.data[t]?.includes(t));const r="chapter"===i?e:t;n?s.checkmarks.data[t].push(r):(FcnUtils.removeArrayItemOnce(s.checkmarks.data[t],r),"chapter"===i&&FcnUtils.removeArrayItemOnce(s.checkmarks.data[t],t)),s.checkmarks.data[t]=s.checkmarks.data[t].filter(((t,e,n)=>n.indexOf(t)==e)),s.lastLoaded=0,FcnUtils.setUserData(s),a.refreshView(),clearTimeout(a.timeout),a.timeout=setTimeout((()=>{FcnUtils.remoteAction("fictioneer_ajax_set_checkmark",{payload:{update:s.checkmarks.data[t].join(" "),story_id:t}})}),FcnGlobals.debounceRate)}function fcn_toggleReminder(t,e=null){const n=window.FictioneerApp.Controllers.fictioneerReminders;if(!n)return void fcn_showNotification("Error: Reminders Controller not connected.",3,"warning");const a=FcnUtils.userData();("object"!=typeof a.reminders.data||null===a.reminders.data||Array.isArray(a.reminders.data))&&(a.reminders.data={}),(e=e??!a.reminders.data[t])?a.reminders.data[t]={story_id:parseInt(t),timestamp:Date.now()}:delete a.reminders.data[t],a.lastLoaded=0,FcnUtils.setUserData(a),n.refreshView(),clearTimeout(n.timeout),n.timeout=setTimeout((()=>{FcnUtils.remoteAction("fictioneer_ajax_toggle_reminder",{payload:{set:e,story_id:t}})}),FcnGlobals.debounceRate)}function fcn_wrapInTag(t,e,n={}){const a=n.href?' href="'+n.href+'" target="_blank" rel="nofollow noreferrer noopener"':"",s=n.shortcode?["[","]"]:["<",">"],i=t.selectionStart,r=t.selectionEnd,o=s[0]+e+a+s[1],c=s[0]+"/"+e+s[1],l=o+t.value.substring(i,r)+c;t.value=t.value.substring(0,i)+l+t.value.substring(r,t.value.length),t.setSelectionRange(i+o.length,r+o.length),t.focus()}"undefined"!=typeof speechSynthesis&&fcn_ttsInterface&&_$$$("paragraph-tools")&&(_$$$("button-tts-set").addEventListener("click",(t=>{fcn_ttsStack=[],fcn_currentReadingId=-1;const e=_$(".chapter-formatting")?.classList.contains("hide-sensitive")??!1?"sensitive-content":"sensitive-alternative",n=_$$$("button-tts-play"),a=new RegExp(fcn_ttsInterface.dataset.regex,"gm");fcn_synth.speaking&&fcn_utter.removeEventListener("end",fcn_readTextStack),fcn_synth.cancel();const s=new Set(["P","H1","H2","H3","H4","H5","H6"]),i=["skip-tts","inside-epub",e];let r=t.target.closest("p[data-paragraph-id]");for(fcn_ttsStack.push(r);r=r.nextElementSibling;)s.has(r.tagName)&&!i.some((t=>r.classList.contains(t)))&&fcn_ttsStack.push(r);fcn_ttsStack=fcn_ttsStack.flatMap((t=>{const e=[];return FcnUtils.extractTextNodes(t).replace(a,"$1|").split("|").forEach((n=>{const a=n.trim();a.length>0&&e.push([t.id,a])})),e})),fcn_readTextStack(),document.body.classList.add("tts-open"),fcn_ttsInterface.classList.remove("hidden","ended","paused"),fcn_ttsInterface.classList.add("playing"),n.focus(),n.blur()})),_$$$("button-tts-stop")?.addEventListener("click",(()=>{const t=_$(".current-reading");fcn_ttsInterface.classList.add("hidden","ended"),fcn_ttsInterface.classList.remove("playing","paused"),document.body.classList.remove("tts-open"),t&&t.classList.remove("current-reading"),fcn_ttsStack=[],fcn_currentReadingId=-1,fcn_utter.removeEventListener("end",fcn_readTextStack),fcn_synth.cancel()})),_$$$("button-tts-play")?.addEventListener("click",(()=>{fcn_synth.resume(),-1!==fcn_ttsPauseTimestamp&&Date.now()-fcn_ttsPauseTimestamp>1e4&&(fcn_ttsStack.unshift([fcn_currentReadingId,fcn_ttsCurrentText]),fcn_synth.cancel(),fcn_readTextStack(),fcn_ttsPauseTimestamp=-1),fcn_ttsInterface.classList.add("playing"),fcn_ttsInterface.classList.remove("paused")})),_$$$("button-tts-pause")?.addEventListener("click",(()=>{fcn_synth.pause(),fcn_ttsPauseTimestamp=Date.now(),fcn_ttsInterface.classList.remove("playing"),fcn_ttsInterface.classList.add("paused")})),_$$$("button-tts-skip")?.addEventListener("click",(()=>{fcn_utter.removeEventListener("end",fcn_readTextStack),fcn_synth.cancel(),fcn_readTextStack(),fcn_ttsInterface.classList.remove("paused"),fcn_ttsInterface.classList.add("playing")})),_$$$("button-tts-scroll")?.addEventListener("click",(()=>{FcnUtils.scrollTo(_$(`p[id="${fcn_currentReadingId}"]`),128)})),_$$("#tts-volume-range, #tts-volume-text").forEach((t=>{t.addEventListener("input",(t=>{fcn_updateVolume(t.target.value)}))})),_$$$("tts-volume-reset")?.addEventListener("click",(()=>{fcn_updateVolume(100)})),_$$("#tts-pitch-range, #tts-pitch-text").forEach((t=>{t.addEventListener("input",(t=>{fcn_updatePitch(t.target.value)}))})),_$$$("tts-pitch-reset")?.addEventListener("click",(()=>{fcn_updatePitch(1)})),_$$("#tts-rate-range, #tts-rate-text").forEach((t=>{t.addEventListener("input",(t=>{fcn_updateRate(t.target.value)}))})),_$$$("tts-rate-reset")?.addEventListener("click",(()=>{fcn_updateRate(1)})),window.addEventListener("beforeunload",(()=>{fcn_synth.cancel()}))),application.register("fictioneer-story",class extends Stimulus.Controller{static get targets(){return["tabSection","tab","tabContent","commentsPlaceholder","commentsWrapper","commentsList","chapterGroup","filterReel","filterItem"]}static values={id:Number};commentPage=1;connect(){window.FictioneerApp.Controllers.fictioneerStory=this,this.#V(),this.hasFilterReelTarget&&"undefined"!=typeof Splide&&new Splide(this.filterReelTarget).mount()}toggleChapterOrder(){const t=this.#G();t.order="asc"===t.order?"desc":"asc",this.#z(t),this.#V()}toggleChapterView(){const t=this.#G();t.view="list"===t.view?"grid":"list",this.#z(t),this.#V()}unfoldChapters({currentTarget:t}){const e=t.closest(".chapter-group[data-folded]");e&&(e.dataset.folded="true"==e.dataset.folded?"false":"true")}toggleTab({currentTarget:t,params:{tabName:e}}){const n=t;this.tabTargets.forEach((t=>{t.classList.remove("_current")})),this.tabContentTargets.forEach((t=>{t.dataset.tabName===e?t.classList.add("_current"):t.classList.remove("_current")})),this.tabSectionTarget.dataset.current=e,this.hasFilterItemTarget&&this.filterReelTarget.classList.toggle("hidden","chapters"!==e),n.classList.add("_current")}selectFilter({currentTarget:t,params:{groups:e,ids:n}}){const a=t.closest('[data-fictioneer-story-target="filterItem"]');this.hasFilterItemTarget&&this.hasChapterGroupTarget&&(this.filterItemTargets.forEach((t=>{t!=a&&t.classList.remove("selected")})),a.classList.toggle("selected"),this.#W(a,e?e.split(","):[],n?`${n}`.split(","):[]))}loadComments(t){this.hasIdValue&&this.hasCommentsListTarget&&(t.currentTarget.remove(),this.hasCommentsPlaceholderTarget&&this.commentsPlaceholderTarget.classList.remove("hidden"),FcnUtils.aGet({post_id:this.idValue,page:this.commentPage},"get_story_comments").then((t=>{this.hasCommentsPlaceholderTarget&&this.commentsPlaceholderTarget.remove(),t.success?(this.commentsListTarget.innerHTML+=t.data.html,this.commentPage++):t.data?.error&&this.commentsListTarget.appendChild(FcnUtils.buildErrorNotice(t.data.error))})).catch((t=>{this.hasCommentsPlaceholderTarget&&this.commentsPlaceholderTarget.remove(),this.commentsListTarget.appendChild(FcnUtils.buildErrorNotice(t))})))}startEpubDownload(t){t.preventDefault(),this.#Q(t.currentTarget,0)}#W(t,e=[],n=[]){const a=_$$(".chapter-group__list-item");if(!t.classList.contains("selected"))return this.chapterGroupTargets.forEach((t=>t.classList.remove("filtered-in","filtered-out"))),void a.forEach((t=>t.classList.remove("filtered-in","filtered-out")));this.chapterGroupTargets.forEach((t=>t.classList.add("filtered-out"))),this.chapterGroupTargets.forEach((t=>t.classList.remove("filtered-in"))),n.length<1?a.forEach((t=>t.classList.remove("filtered-in","filtered-out"))):(a.forEach((t=>t.classList.add("filtered-out"))),a.forEach((t=>t.classList.remove("filtered-in")))),e.forEach((t=>{const e=_$$$(`chapter-group-${t}`);e&&(e.classList.remove("filtered-out"),e.classList.add("filtered-in"),n.length>0&&e.querySelectorAll(".filtered-out").forEach((t=>t.classList.remove("filtered-out"))),e.classList.contains("_closed")&&fcn().toggleChapterGroup({currentTarget:e}))})),n.length>0&&n.forEach((t=>{const n=_$(`[data-post-id="${t}"]`);if(!n)return;if(e.includes(n.dataset.group))return;n.classList.add("filtered-in"),n.classList.remove("filtered-out");const a=n.closest(".chapter-group");a&&!a.classList.contains("filtered-in")&&(a.classList.add("filtered-in"),a.classList.remove("filtered-out"),a.classList.contains("_closed")&&fcn().toggleChapterGroup({currentTarget:a}))}))}#G(){let t=FcnUtils.parseJSON(localStorage.getItem("fcnStorySettings"))??this.#J();return t.timestamp<1674770712849&&(t=this.#J(),t.timestamp=Date.now()),this.#z(t),t}#J(){return{view:"list",order:"asc",timestamp:1674770712849}}#z(t){"object"==typeof t&&localStorage.setItem("fcnStorySettings",JSON.stringify(t))}#V(){const t=this.#G();"object"==typeof t&&(_$$("[data-view]").forEach((e=>{e.dataset.view=t.view})),_$$("[data-order]").forEach((e=>{e.dataset.order=t.order})))}#Q(t,e=0){!t.classList.contains("ajax-in-progress")&&this.hasIdValue&&(e>3?t.classList.remove("ajax-in-progress"):(t.classList.add("ajax-in-progress"),FcnUtils.aGet({action:"fictioneer_ajax_download_epub",story_id:this.idValue}).then((n=>{n.success?(window.location.href=t.href,setTimeout((()=>t.classList.remove("ajax-in-progress")),2e3)):setTimeout((()=>fcn_startEpubDownload(t,e+1)),2e3)})).catch((e=>{t.classList.remove("ajax-in-progress"),e.status&&e.statusText&&fcn_showNotification(`${e.status}: ${e.statusText}`,5,"warning")}))))}}),document.addEventListener("fcnUserDataReady",(()=>{fcn_cleanUpActions()})),_$$(".button-unset-oauth").forEach((t=>{t.addEventListener("click",(t=>{fcn_unsetOauth(t.currentTarget)}))})),_$$$("button-delete-my-account")?.addEventListener("click",(t=>{fcn_deleteMyAccount(t.currentTarget)})),_$(".button-clear-comments")?.addEventListener("click",(t=>{fcn_dataDeletionPrompt(t.currentTarget)&&fcn_clearData(t.currentTarget,"fictioneer_ajax_clear_my_comments")})),_$(".button-clear-comment-subscriptions")?.addEventListener("click",(t=>{fcn_dataDeletionPrompt(t.currentTarget)&&fcn_clearData(t.currentTarget,"fictioneer_ajax_clear_my_comment_subscriptions")})),_$(".button-clear-checkmarks")?.addEventListener("click",(t=>{if(fcn_dataDeletionPrompt(t.currentTarget)){const e=window.FictioneerApp.Controllers.fictioneerCheckmarks;if(!e)return void fcn_showNotification("Error: Checkmarks Controller not connected.",3,"warning");e.clear(),fcn_clearData(t.currentTarget,"fictioneer_ajax_clear_my_checkmarks",!0)}})),_$(".button-clear-reminders")?.addEventListener("click",(t=>{if(fcn_dataDeletionPrompt(t.currentTarget)){const e=window.FictioneerApp.Controllers.fictioneerReminders;if(!e)return void fcn_showNotification("Error: Reminders Controller not connected.",3,"warning");e.clear(),fcn_clearData(t.currentTarget,"fictioneer_ajax_clear_my_reminders",!0)}})),_$(".button-clear-follows")?.addEventListener("click",(t=>{if(fcn_dataDeletionPrompt(t.currentTarget)){const e=window.FictioneerApp.Controllers.fictioneerFollows;if(!e)return void fcn_showNotification("Error: Follows Controller not connected.",3,"warning");e.clear(),fcn_clearData(t.currentTarget,"fictioneer_ajax_clear_my_follows",!0)}})),_$(".button-clear-bookmarks")?.addEventListener("click",(t=>{if(fcn_dataDeletionPrompt(t.currentTarget)){const e=window.FictioneerApp.Controllers.fictioneerBookmarks,n=_$$$("profile-data-translations")?.dataset;if(!e)return void fcn_showNotification("Error: Bookmarks Controller not connected.",3,"warning");e.clear(),t.currentTarget.closest(".card").querySelector(".card__content").innerHTML=n.clearedSuccess}})),application.register("fictioneer-bookmarks",class extends Stimulus.Controller{static get targets(){return["bookmarkScroll","shortcodeBlock","dataCard","overviewPageIconLink","noBookmarksNote"]}timeout=0;chapterId=_$(".chapter__article")?.id;currentBookmark=null;cardTemplate=_$(".bookmark-small-card-template");initialize(){fcn()?.userReady||!FcnUtils.loggedIn()?this.#n=!0:document.addEventListener("fcnUserDataReady",(()=>{this.#n=!0,this.refreshView(),this.#a()}))}connect(){window.FictioneerApp.Controllers.fictioneerBookmarks=this,this.#n&&(this.refreshView(),this.#a())}data(){return this.bookmarksCachedData=FcnUtils.loggedIn()?this.#X():this.#Y(),this.#K(this.bookmarksCachedData).data}toggle(t,e="none"){if(!this.chapterId)return;const n=this.data(),a=n[this.chapterId];if(a&&a["paragraph-id"]==t)"none"!==e&&e!==a.color?n[this.chapterId].color=e:delete n[this.chapterId];else{Object.keys(n).length>=50&&delete n[Object.keys(n)[0]];const a=_$(`[data-paragraph-id="${t}"]`),s=JSON.parse(_$$$("fictioneer-bookmark-data").textContent.trim());n[this.chapterId]={"paragraph-id":t,progress:100*(FcnUtils.offset(a).top-FcnUtils.offset(a.parentElement).top)/a.parentElement.clientHeight,date:(new Date).toISOString(),color:e,chapter:s.title.trim(),link:s.link,thumb:s.thumbnail,image:s.cover,story:s.storyTitle.trim(),content:FcnUtils.extractTextNodes(a).substring(0,128)+"…"}}this.set(n),this.refreshView()}remove({params:{id:t}}){const e=this.data();delete e[t],this.set(e),this.refreshView()}clear(){this.set({data:{}}),this.refreshView()}set(t){if("object"!=typeof t)return;t=this.#K({data:t});const e=JSON.stringify(t);if(FcnUtils.loggedIn()){const t=fcn().userData();t&&(t.bookmarks=e,fcn().setUserData(t)),this.#Z(e),localStorage.removeItem("fcnChapterBookmarks")}else localStorage.setItem("fcnChapterBookmarks",e)}refreshView(){const t=this.data(),e=Object.keys(t).length;this.hasOverviewPageIconLinkTarget&&this.overviewPageIconLinkTargets.forEach((t=>{t.classList.toggle("hidden",e<1)})),this.refreshChapterBookmark(),this.refreshCards(),this.refreshProfile()}refreshCards(){if(!this.hasShortcodeBlockTarget)return;const t=this.data(),e=Object.keys(t).length<1;this.shortcodeBlockTargets.forEach((t=>{t.classList.toggle("hidden",e)})),_$$(".show-if-bookmarks").forEach((t=>{t.classList.toggle("hidden",e)})),this.hasNoBookmarksNoteTarget&&this.noBookmarksNoteTargets.forEach((t=>{t.classList.toggle("hidden",!e)})),!e&&this.cardTemplate?this.shortcodeBlockTargets.forEach((e=>{const n=e.querySelector("ul"),a=document.createDocumentFragment(),s=Object.entries(t).sort(((t,e)=>new Date(e[1].date)-new Date(t[1].date)));let i=parseInt(e.dataset.count)??8;s.forEach((([t,{color:e,progress:n,link:s,chapter:r,"paragraph-id":o,date:c,image:l,thumb:d,content:h}])=>{if(0==i--)return;const f=this.cardTemplate.content.cloneNode(!0),g=new Date(c).toLocaleDateString(navigator.language??"en-US",{year:"2-digit",month:"short",day:"numeric"});l&&f.querySelector(".bookmark-card__image")?(f.querySelector(".bookmark-card__image").href=l,f.querySelector(".bookmark-card__image img").src=d):f.querySelector(".bookmark-card__image")?.remove(),f.querySelector(".bookmark-card__excerpt").innerHTML+=h,f.querySelector(".bookmark-card").classList.add(`bookmark-${t}`),f.querySelector(".bookmark-card").dataset.color=e,f.querySelector(".bookmark-card__title > a").href=`${s}#paragraph-${o}`,f.querySelector(".bookmark-card__title > a").innerText=r,f.querySelector(".bookmark-card__percentage").innerText=`${n.toFixed(1)} %`,f.querySelector(".bookmark-card__progress").style.width=`calc(${n.toFixed(1)}% - var(--bookmark-progress-offset, 0px))`,f.querySelector("time").innerText=g,f.querySelector(".button-delete-bookmark").setAttribute("data-fictioneer-bookmarks-id-param",t),a.appendChild(f)})),n.innerHTML="",n.appendChild(a)})):this.shortcodeBlockTargets.forEach((t=>{t.querySelector("ul").innerHTML=""}))}refreshProfile(){this.hasDataCardTarget&&(this.dataCardTarget.innerHTML=this.dataCardTarget.innerHTML.replace("%s",Object.keys(this.data()).length))}refreshChapterBookmark(){const t=this.data();if(this.currentBookmark?.classList.remove("current-bookmark"),!this.chapterId||!t[this.chapterId])return;const e=t[this.chapterId]["paragraph-id"],n=_$(`[data-paragraph-id="${e}"]`),a=t[this.chapterId].color??"none";e&&n&&(n.classList.add("current-bookmark"),n.setAttribute("data-bookmark-color",a),this.currentBookmark=n,this.hasBookmarkScrollTarget&&this.bookmarkScrollTargets.forEach((t=>t.removeAttribute("hidden"))))}#n=!1;#c=!1;#Y(){return FcnUtils.parseJSON(localStorage.getItem("fcnChapterBookmarks"))??{data:{}}}#X(){return FcnUtils.parseJSON(FcnUtils.userData()?.bookmarks)??{data:{}}}#K(t){if("object"!=typeof t||!("data"in t)||Array.isArray(t.data)&&0===t.data.length)return{data:{}};const e={};for(const n in t.data)if(n.startsWith("ch-")){const a=this.#tt(t.data[n]);a&&(e[n]=a)}return{data:e}}#tt(t){const e={},n={"paragraph-id":"",progress:0,date:"",color:"",chapter:"",link:"",thumb:"",image:"",story:"",content:""};for(const a in n){if(typeof t[a]!=typeof n[a])return null;e[a]=t[a]}const a=new Date(e.date);return a&&"[object Date]"===Object.prototype.toString.call(a)&&!isNaN(a)||(e.date=(new Date).toISOString()),("number"!=typeof e.progress||e.progress<0)&&(e.progress=0),e}#T(){return JSON.stringify(this.bookmarksCachedData??0)!==JSON.stringify(this.data())}#h(){this.refreshInterval||(this.refreshInterval=setInterval((()=>{!this.#c&&this.#T()&&this.refreshView()}),3e4+1e3*Math.random()))}#a(){this.#h(),this.visibilityStateCheck=()=>{"visible"===document.visibilityState?(this.#c=!1,this.refreshView(),this.#h()):(this.#c=!0,clearInterval(this.refreshInterval),this.refreshInterval=null)},document.addEventListener("visibilitychange",this.visibilityStateCheck)}#Z(t){clearTimeout(this.timeout),this.timeout=setTimeout((()=>{FcnUtils.remoteAction("fictioneer_ajax_save_bookmarks",{payload:{bookmarks:t}})}),FcnGlobals.debounceRate)}}),application.register("fictioneer-follows",class extends Stimulus.Controller{static get targets(){return["toggleButton"]}followsLoaded=!1;timeout=0;initialize(){fcn()?.userReady?this.#n=!0:document.addEventListener("fcnUserDataReady",(()=>{this.refreshView(),this.#n=!0,this.#a()}))}connect(){window.FictioneerApp.Controllers.fictioneerFollows=this,this.#n&&(this.refreshView(),this.#a())}data(){return this.followsCachedData=FcnUtils.userData().follows?.data,Array.isArray(this.followsCachedData)&&0===this.followsCachedData.length&&(this.followsCachedData={}),this.followsCachedData}isFollowed(t){return!(!FcnUtils.loggedIn()||!this.data()?.[t])}toggleFollow({params:{id:t}}){this.#l()&&(fcn_toggleFollow(t,!this.isFollowed(t)),this.refreshView())}clear(){const t=FcnUtils.userData();t.follows={data:{}},fcn().setUserData(t),this.refreshView()}refreshView(){this.toggleButtonTargets.forEach((t=>{const e=t.dataset.storyId;t.classList.toggle("_followed",this.isFollowed(e))})),localStorage.removeItem("fcnBookshelfContent")}#n=!1;#c=!1;#l(){return!!FcnUtils.loggedIn()||(this.#d(),this.#c=!0,!1)}#et(){return this.#l()&&JSON.stringify(this.followsCachedData??0)!==JSON.stringify(this.data())}#h(){this.refreshInterval||(this.refreshInterval=setInterval((()=>{!this.#c&&this.#et()&&this.refreshView()}),3e4+1e3*Math.random()))}#a(){this.#h(),this.visibilityStateCheck=()=>{this.#l()&&("visible"===document.visibilityState?(this.#c=!1,this.refreshView(),this.#h()):(this.#c=!0,clearInterval(this.refreshInterval),this.refreshInterval=null))},document.addEventListener("visibilitychange",this.visibilityStateCheck)}#d(){clearInterval(this.refreshInterval),document.removeEventListener("visibilitychange",this.visibilityStateCheck)}}),application.register("fictioneer-checkmarks",class extends Stimulus.Controller{static get targets(){return["chapterCheck","storyCheck","ribbon"]}timeout=0;initialize(){fcn()?.userReady?this.#n=!0:document.addEventListener("fcnUserDataReady",(()=>{FcnUtils.userData().checkmarks&&(this.refreshView(),this.#n=!0,this.#a())}))}connect(){window.FictioneerApp.Controllers.fictioneerCheckmarks=this,this.#n&&FcnUtils.userData().checkmarks&&(this.refreshView(),this.#a())}data(){return this.checkmarksCachedData=FcnUtils.userData().checkmarks?.data,Array.isArray(this.checkmarksCachedData)&&0===this.checkmarksCachedData.length&&(this.checkmarksCachedData={}),this.checkmarksCachedData}toggleChapter({params:{chapter:t,story:e}}){fcn_toggleCheckmark(e,t)}toggleStory({params:{story:t}}){fcn_toggleCheckmark(t)}clear(){const t=FcnUtils.userData();t.checkmarks={data:{},updated:Date.now()},fcn().setUserData(t),this.refreshView()}refreshView(){const t=this.data();if(!t||Object.keys(t).length<1)return void this.uncheckAll();let e=!1;Object.entries(t).forEach((([t,n])=>{t=parseInt(t),this.hasStoryCheckTarget&&t==this.storyCheckTarget.dataset.fictioneerCheckmarksStoryParam&&(e=n?.includes(t)),this.hasChapterCheckTarget&&(e?this.chapterCheckTargets.forEach((t=>{t.classList.toggle("marked",!0),t.setAttribute("aria-checked",!0)})):this.chapterCheckTargets.forEach((e=>{const a=parseInt(e.dataset.fictioneerCheckmarksChapterParam);if(parseInt(e.dataset.fictioneerCheckmarksStoryParam)===t){const t=n?.includes(a);e.classList.toggle("marked",t),e.setAttribute("aria-checked",t)}}))),this.hasStoryCheckTarget&&(this.storyCheckTarget.classList.toggle("marked",e),this.storyCheckTarget.setAttribute("aria-checked",e)),this.hasRibbonTarget&&this.ribbonTarget.classList.toggle("hidden",!e)})),localStorage.removeItem("fcnBookshelfContent")}uncheckAll(){this.hasChapterCheckTarget&&this.chapterCheckTargets.forEach((t=>{t.classList.toggle("marked",!1),t.setAttribute("aria-checked",!1)})),this.hasStoryCheckTarget&&(this.storyCheckTarget.classList.toggle("marked",!1),this.storyCheckTarget.setAttribute("aria-checked",!1))}#n=!1;#c=!1;#l(){return!!FcnUtils.loggedIn()||(this.#d(),this.#c=!0,!1)}#nt(){return this.#l()&&JSON.stringify(this.checkmarksCachedData??0)!==JSON.stringify(this.data())}#h(){this.refreshInterval||(this.refreshInterval=setInterval((()=>{!this.#c&&this.#nt()&&this.refreshView()}),3e4+1e3*Math.random()))}#a(){this.#h(),this.visibilityStateCheck=()=>{this.#l()&&("visible"===document.visibilityState?(this.#c=!1,this.refreshView(),this.#h()):(this.#c=!0,clearInterval(this.refreshInterval),this.refreshInterval=null))},document.addEventListener("visibilitychange",this.visibilityStateCheck)}#d(){clearInterval(this.refreshInterval),document.removeEventListener("visibilitychange",this.visibilityStateCheck)}}),application.register("fictioneer-reminders",class extends Stimulus.Controller{static get targets(){return["toggleButton"]}remindersLoaded=!1;timeout=0;initialize(){fcn()?.userReady?this.#n=!0:document.addEventListener("fcnUserDataReady",(()=>{this.refreshView(),this.#n=!0,this.#a()}))}connect(){window.FictioneerApp.Controllers.fictioneerReminders=this,this.#n&&(this.refreshView(),this.#a())}data(){return this.remindersCachedData=FcnUtils.userData().reminders?.data,Array.isArray(this.remindersCachedData)&&0===this.remindersCachedData.length&&(this.remindersCachedData={}),this.remindersCachedData}isRemembered(t){return!(!FcnUtils.loggedIn()||!this.data()?.[t])}toggleReminder({params:{id:t}}){this.#l()&&(fcn_toggleReminder(t,!this.isRemembered(t)),this.refreshView())}clear(){const t=FcnUtils.userData();t.reminders={data:{}},fcn().setUserData(t),this.refreshView()}refreshView(){this.toggleButtonTargets.forEach((t=>{const e=t.dataset.storyId;t.classList.toggle("_remembered",this.isRemembered(e))})),localStorage.removeItem("fcnBookshelfContent")}#n=!1;#c=!1;#l(){const t=FcnUtils.loggedIn();return t||(this.#d(),this.#c=!0),t}#at(){return this.#l()&&JSON.stringify(this.remindersCachedData??0)!==JSON.stringify(this.data())}#h(){this.refreshInterval||(this.refreshInterval=setInterval((()=>{!this.#c&&this.#at()&&this.refreshView()}),3e4+1e3*Math.random()))}#a(){this.#h(),this.visibilityStateCheck=()=>{this.#l()&&("visible"===document.visibilityState?(this.#c=!1,this.refreshView(),this.#h()):(this.#c=!0,clearInterval(this.refreshInterval),this.refreshInterval=null))},document.addEventListener("visibilitychange",this.visibilityStateCheck)}#d(){clearInterval(this.refreshInterval),document.removeEventListener("visibilitychange",this.visibilityStateCheck)}}),document.addEventListener("fcnUserDataReady",(()=>{fcn().userData().fingerprint==document.documentElement.dataset.authorFingerprint&&document.body.classList.add("is-post-author")}));const fcn_ajaxCommentForm=_$$$("ajax-comment-form-target");function fcn_setupCommentFormObserver(){const t=new IntersectionObserver((([e])=>{e.isIntersecting&&(fcn_getCommentForm(),t.disconnect())}),{rootMargin:"450px",threshold:1});t.observe(fcn_ajaxCommentForm)}function fcn_getCommentForm(){let t;FcnUtils.aGet({action:"fictioneer_ajax_get_comment_form",post_id:_$$$("comments").dataset.postId,fcn_fast_comment_ajax:1}).then((e=>{if(e.success){const t=document.createElement("div");t.innerHTML=e.data.html;const n=t.querySelector("#comment_post_ID"),a=t.querySelector("#cancel-comment-reply-link"),s=t.querySelector(".logout-link");n&&(n.value=e.data.postId),a&&(a.href="#respond"),s&&(s.href=_$$$("comments").dataset.logoutUrl),fcn_ajaxCommentForm.innerHTML=t.innerHTML,t.remove(),fcn_applyCommentStack(),_$$$("fictioneer-ajax-nonce")?.remove(),document.body.appendChild(FcnUtils.html`${e.data.nonceHtml}`)}else t=FcnUtils.buildErrorNotice(e.data.error)})).catch((e=>{t=FcnUtils.buildErrorNotice(e)})).then((()=>{fcn_ajaxCommentForm.classList.remove("comments-skeleton"),t&&(fcn_ajaxCommentForm.innerHTML="",fcn_ajaxCommentForm.appendChild(t))}))}function fcn_applyCommentStack(t=null){(t=t??_$(FcnGlobals.commentFormSelector))&&("TEXTAREA"==t.tagName?(FcnGlobals.commentStack.forEach((e=>{t.value+=e})),FcnUtils.adjustTextarea(t)):"DIV"==t.tagName&&FcnGlobals.commentStack.forEach((e=>{t.innerHTML+=e})),FcnGlobals.commentStack=[])}fcn_ajaxCommentForm&&document.addEventListener("fcnUserDataReady",(()=>{fcn_setupCommentFormObserver()})),application.register("fictioneer-comment-form",class extends Stimulus.Controller{static get targets(){return["submit","cancel","textarea","privateToggle","emailNotificationToggle","author","email","cookies","privacyPolicy"]}initialize(){this.respond=this.element.closest("#respond"),this.order=this.respond.closest(".fictioneer-comments")?.dataset.order??"desc",this.parent=this.element.querySelector("#comment_parent"),this.addJSTrap()}adjustTextarea(){FcnUtils.adjustTextarea(this.textareaTarget)}toolbarButtons(t){const e=t.target.closest("[data-bbcode]");e&&fcn_wrapInTag(this.textareaTarget,e.dataset.bbcode,{shortcode:!0})}keyComboCodes(t){if(_$(".fictioneer-comment-toolbar")&&"TEXTAREA"===document.activeElement.tagName&&(t.ctrlKey||t.metaKey)){const e=t.key.toLowerCase();if(["b","i","s","q","h","l"].includes(e)){t.preventDefault();const n={q:"quote",h:"spoiler",l:"link"};fcn_wrapInTag(document.activeElement,n[e]||e,{shortcode:!0})}}}addJSTrap(){this.element.appendChild(FcnUtils.html`
      <input type="hidden" name="fictioneer_comment_validator" value="299792458">
    `)}revealFormInputs(){this.respond.querySelectorAll(".fictioneer-respond__form-actions, .fictioneer-respond__form-bottom").forEach((t=>{t.classList.remove("hidden")}))}ajaxSubmit(t){if(Date.now()<FcnGlobals.pageLoadTimestamp+3e3)return;if(this.element.classList.remove("_invalid"),!document.documentElement.dataset.ajaxSubmit)return this.element.reportValidity()?(this.submitTarget.value=this.submitTarget.dataset.disabled,this.submitTarget.classList.add("_disabled"),void setTimeout((()=>{this.submitTarget.value=this.submitTarget.dataset.enabled,this.submitTarget.classList.remove("_disabled")}),2e3)):void this.element.classList.add("_invalid");if(t.preventDefault(),!this.element.reportValidity())return void this.element.classList.add("_invalid");const e=new FormData(this.element),n=Object.fromEntries(e.entries()),a=n.comment_parent??0,s=_$$$(`comment-${a}`),i=this.textareaTarget.value.length>1;let r=!0,o=!0;if(this.textareaTarget.classList.toggle("_error",!i),this.hasPrivacyPolicyTarget&&(o=this.privacyPolicyTarget.checked,this.privacyPolicyTarget.classList.toggle("_error",!o)),this.hasEmailTarget&&this.emailTarget?.value.length>0&&(r=/\S+@\S+\.\S+/.test(this.emailTarget.value),this.emailTarget.classList.toggle("_error",!r)),!i||!o||!r)return;this.element.classList.add("ajax-in-progress"),this.submitTarget.value=this.submitTarget.dataset.disabled,this.submitTarget.disabled=!0;const c={action:"fictioneer_ajax_submit_comment",content:this.textareaTarget.value,depth:s?parseInt(s.dataset.depth)+1:1,fcn_fast_comment_ajax:1,...n};this.hasEmailTarget&&this.emailTarget?.value&&(c.email=this.emailTarget.value),this.hasAuthorTarget&&this.authorTarget?.value&&(c.author=this.authorTarget.value),_$$$("comment-submit-error-notice")?.remove(),FcnUtils.aPost(c).then((t=>{if(t.success&&t.data?.comment){let e=_$(".commentlist"),n="insertBefore";if(e&&!s&&e.firstElementChild){let t=null;if(e.firstElementChild.classList.contains("_sticky"))for(t=e.firstElementChild,e=t,n="insertAfter";t.nextElementSibling&&t.nextElementSibling.classList.contains("_sticky");)t=e.nextElementSibling,e=t}if(e||(e=document.createElement("ol"),e.classList="fictioneer-comments__list commentlist",_$$$("comments").appendChild(e),n="append"),s&&(e=s.querySelector(".children"),n="append",!e)){const t=document.createElement("ol");s.appendChild(t),e=t}let a=document.createElement("div");switch(a.innerHTML=t.data.comment,a=a.firstChild,n){case"append":e.appendChild(a);break;case"insertBefore":e.insertBefore(a,e.firstChild);break;case"insertAfter":e.nextSibling?e.parentNode.insertBefore(a,e.nextSibling):e.parentNode.appendChild(a)}this.textareaTarget.value="",this.textareaTarget.style.height="","0"!=this.parent.value&&this.cancelTarget.click();const i=window.location.protocol+"//"+window.location.host+window.location.pathname;("desc"!=this.order||FcnGlobals.urlParams.corder)&&(FcnGlobals.urlParams.corder=this.order),t.data.commentcode&&(FcnGlobals.urlParams.commentcode=t.data.commentcode);let r=Object.entries(FcnGlobals.urlParams).map((([t,e])=>`${t}=${e}`)).join("&");""!==r&&(r=`?${r}`),history.replaceState({path:i},"",i+r+`#comment-${t.data.comment_id}`),a.scrollIntoView({behavior:"smooth"})}else this.element.insertBefore(FcnUtils.buildErrorNotice(t.data.failure??t.data.error??fictioneer_tl.notification.error,"comment-submit-error-notice",!1),this.element.firstChild),console.error("Error:",t.data.error??t.data.failure??"Unknown")})).catch((t=>{this.element.insertBefore(FcnUtils.buildErrorNotice(`${t.statusText} (${t.status})`,"comment-submit-error-notice"),this.element.firstChild)})).then((()=>{this.element.classList.remove("ajax-in-progress"),this.submitTarget.disabled=!1,this.submitTarget.value=this.submitTarget.dataset.enabled}))}togglePrivate(){this.respond.classList.toggle("_private",this.privateToggleTarget.checked)}}),application.register("fictioneer-comment",class extends Stimulus.Controller{static get targets(){return["modMenuToggle","modMenu","modIcon","editLink","flagButton","deleteButton","editButton","content","inlineEditWrapper","inlineEditTextarea","inlineEditButtons","inlineEditSubmit","editNote"]}static values={id:Number,timestamp:Number,fingerprint:String};comment=this.element.closest(".fictioneer-comment");menuOpen=!1;initialize(){document.addEventListener("fcnLastClicked",(t=>{t.detail?.element?.closest(`[data-fictioneer-comment-id-value="${this.idValue}"]`)||this.#p()})),document.addEventListener("click",(t=>{t.target.closest(`[data-fictioneer-comment-id-value="${this.idValue}"]`)||this.#p()}))}connect(){this.hasModMenuTarget&&(this.editLink=this.modMenuTarget.dataset.editLink),fcn().userData().fingerprint?(this.#st(),this.#it()):document.addEventListener("fcnUserDataReady",(()=>{this.#st(),this.#it()})),this.hasInlineEditTextareaTarget&&this.inlineEditTextareaTarget.addEventListener("input",(()=>{FcnUtils.adjustTextarea(this.inlineEditTextareaTarget)})),document.addEventListener("toggledLastClick",(t=>{!t.detail.force&&this.menuOpen&&this.#p()}))}toggleMenu(t=null){this.hasModMenuTarget&&(!this.menuOpen&&"close"!==t||"open"===t?this.#_():this.#p())}mouseLeave(){this.hasModMenuTarget&&this.menuOpen&&(this.#p(),document.dispatchEvent(new CustomEvent("fcnRemoveLastClicked")))}commentClick(t){t.target.closest('[data-fictioneer-comment-target="modMenuToggle"]')||this.#p()}approve(){this.#rt("approve")}unapprove(){this.#rt("unapprove")}offensive(){this.#rt("offensive")}unoffensive(){this.#rt("unoffensive")}open(){this.#rt("open")}close(){this.#rt("close")}sticky(){this.#rt("sticky")}unsticky(){this.#rt("unsticky")}trash(){this.#rt("trash")}spam(){this.#rt("spam")}flag(){FcnUtils.loggedIn()&&this.hasFlagButtonTarget&&(this.comment.classList.contains("ajax-in-progress")||FcnUtils.remoteAction("fictioneer_ajax_report_comment",{element:this.comment,payload:{id:this.idValue,dubious:this.flagButtonTarget.classList.contains("_dubious")},callback:t=>{t.success&&(this.flagButtonTarget.classList.toggle("on",t.data.flagged),this.flagButtonTarget.classList.remove("_dubious"),t.data.resync&&fcn_showNotification(t.data.resync))}}))}selfDelete(){if(!FcnUtils.loggedIn()||!this.hasDeleteButtonTarget)return;const t=prompt(this.deleteButtonTarget.dataset.dialogMessage);t&&t.toLowerCase()==this.deleteButtonTarget.dataset.dialogConfirm.toLowerCase()&&(this.comment.classList.contains("ajax-in-progress")||FcnUtils.remoteAction("fictioneer_ajax_delete_my_comment",{element:this.comment,payload:{comment_id:this.idValue},callback:(t,e)=>{t.success&&(e.classList.add("_deleted"),this.element.innerHTML=t.data.html)}}))}startEditInline(){const t=_$$$("template-comment-inline-edit-form")?.content.cloneNode(!0);t&&(this.comment.classList.add("_editing"),this.commentEditUndo=this.inlineEditTextareaTarget.value,this.inlineEditWrapperTarget.appendChild(t),this.contentTarget.hidden=!0,this.inlineEditWrapperTarget.hidden=!1,this.inlineEditTextareaTarget.style.height=`${this.inlineEditTextareaTarget.scrollHeight}px`,FcnUtils.adjustTextarea(this.inlineEditTextareaTarget))}cancelEditInline(){this.#ot(!0)}submitEditInline(){this.inlineEditTextareaTarget.value!==this.commentEditUndo?(this.inlineEditSubmitTarget.innerHTML=this.inlineEditSubmitTarget.dataset.disabled,this.inlineEditSubmitTarget.disabled=!0,FcnUtils.remoteAction("fictioneer_ajax_edit_comment",{element:this.inlineEditWrapperTarget,payload:{comment_id:this.idValue,content:this.inlineEditTextareaTarget.value},callback:t=>{if(t.success){this.contentTarget.innerHTML=t.data.content,this.#ot(!1,t.data.raw);let e=this.editNoteTarget;this.hasEditNoteTarget||(e=document.createElement("div")),e.classList.add("fictioneer-comment__edit-note"),e.dataset.fictioneerCommentTarget="editNote",e.innerHTML=t.data.edited,this.contentTarget.parentNode.appendChild(e)}else this.#ot(!0)},errorCallback:()=>{this.#ot(!0)},finalCallback:()=>{this.hasInlineEditSubmitTarget&&(this.inlineEditSubmitTarget.innerHTML=this.inlineEditSubmitTarget.dataset.enabled,this.inlineEditSubmitTarget.disabled=!1)}})):this.#ot(!0)}keyComboCodes(t){if(_$(".fictioneer-comment-toolbar")&&"TEXTAREA"===document.activeElement.tagName&&(t.ctrlKey||t.metaKey)){const e=t.key.toLowerCase();if(["b","i","s","q","h","l"].includes(e)){t.preventDefault();const n={q:"quote",h:"spoiler",l:"link"};fcn_wrapInTag(document.activeElement,n[e]||e,{shortcode:!0})}}}#st(){this.hasDeleteButtonTarget&&this.#ct()&&(this.deleteButtonTarget.hidden=!1)}#it(){let t=parseInt(document.documentElement.dataset.editTime);if(t&&(t=t>0?6e4*t:t,this.hasEditButtonTarget&&this.#ct())){if(t>0&&parseInt(this.timestampValue)+t<Date.now())return;this.editButtonTarget.hidden=!1}}#ct(){const t=fcn().userData().fingerprint;return!(!t||!this.hasFingerprintValue)&&t===this.fingerprintValue}#ot(t=!1,e=null){this.comment.classList.remove("_editing"),this.contentTarget.hidden=!1,this.inlineEditWrapperTarget.hidden=!0,this.hasInlineEditButtonsTarget&&this.inlineEditButtonsTarget.remove(),t&&this.commentEditUndo?this.inlineEditTextareaTarget.value=this.commentEditUndo:e&&(this.inlineEditTextareaTarget.value=e),this.commentEditUndo=null}#_(){const t=_$$$("template-comment-frontend-moderation-menu")?.content.cloneNode(!0);t&&this.hasModMenuTarget&&(this.modMenuTarget.appendChild(t),this.editLinkTarget.href=this.editLink,this.menuOpen=!0)}#p(){if(this.hasModMenuTarget&&this.menuOpen)for(this.menuOpen=!1;this.modMenuTarget.firstChild;)this.modMenuTarget.removeChild(this.modMenuTarget.firstChild)}#lt(){this.modIconTarget.classList="fa-solid fa-triangle-exclamation mod-menu-toggle-icon",this.modIconTarget.style.color="var(--notice-warning-background)",this.modMenuToggleTarget.style.opacity="1"}#rt(t){this.comment.classList.contains("ajax-in-progress")||("trash"!=t&&"spam"!=t||(this.comment.style.height=this.comment.clientHeight+"px"),FcnUtils.remoteAction("fictioneer_ajax_moderate_comment",{element:this.comment,payload:{id:this.idValue,operation:t},callback:t=>{if(t.success){const e=t.data.operation,n={sticky:{action:"add",className:"_sticky"},unsticky:{action:"remove",className:"_sticky"},offensive:{action:"add",className:"_offensive"},unoffensive:{action:"remove",className:"_offensive"},approve:{action:"remove",className:"_unapproved"},unapprove:{action:"add",className:"_unapproved"},open:{action:"remove",className:"_closed"},close:{action:"add",className:"_closed"}};if(e in n){const{action:t,className:a}=n[e];this.comment.classList[t](a)}else"trash"!==e&&"spam"!==e||(this.comment.style.cssText="overflow: hidden; height: 0; margin: 0; opacity: 0;")}else this.#lt()},errorCallback:()=>{this.#lt()},finalCallback:()=>{this.#p(),document.dispatchEvent(new CustomEvent("fcnRemoveLastClicked"))}}))}});const fcn_commentSection=_$("#comments[data-ajax-comments]");function fcn_getCommentSection(t=null,e=null,n=null,a=!1){if(!fcn_commentSection)return;let s,i="",r=_$(FcnGlobals.commentFormSelector);if(r&&(i=r.value),fcn_commentSection.classList.contains("ajax-in-progress"))return;if(fcn_commentSection.classList.add("ajax-in-progress"),e||(e=FcnGlobals.urlParams.pg??1),n||(n=n??fcn_commentSection.dataset.order??"desc"),!fcn_commentSection)return;const o={action:"fictioneer_ajax_get_comment_section",post_id:t??fcn_commentSection.dataset.postId,page:parseInt(e),corder:n,fcn_fast_comment_ajax:1};FcnGlobals.urlParams.commentcode&&(o.commentcode=FcnGlobals.urlParams.commentcode),FcnUtils.aGet(o).then((t=>{if(t.success){e=t.data.page,fcn_commentSection.dataset.page=e;const s=document.createElement("div");if(s.innerHTML=t.data.html,s.querySelector("#comment_post_ID")){s.querySelector("#comment_post_ID").value=t.data.postId,s.querySelector("#cancel-comment-reply-link").href="#respond";const e=s.querySelector(".logout-link");e&&(e.href=fcn_commentSection.dataset.logoutUrl)}fcn_commentSection.innerHTML=s.innerHTML,s.remove(),r=_$(FcnGlobals.commentFormSelector),r&&!t.data.disabled&&(r.value=i,fcn_applyCommentStack(r));const o=location.hash.includes("#comment")?location.hash:".respond",c=document.querySelector(o)??_$$$("respond");a&&c.scrollIntoView({behavior:"smooth"});const l=window.location.protocol+"//"+window.location.host+window.location.pathname;(e>1||FcnGlobals.urlParams.pg)&&(FcnGlobals.urlParams.pg=e),("desc"!=n||FcnGlobals.urlParams.corder)&&(FcnGlobals.urlParams.corder=n);let d=Object.entries(FcnGlobals.urlParams).map((([t,e])=>`${t}=${e}`)).join("&");""!==d&&(d=`?${d}`),window.history.pushState({path:l},"",l+d+location.hash)}else s=FcnUtils.buildErrorNotice(t.data.error)})).catch((t=>{s=FcnUtils.buildErrorNotice(t)})).then((()=>{fcn_commentSection.classList.remove("ajax-in-progress"),s&&(fcn_commentSection.innerHTML="",fcn_commentSection.appendChild(s))}))}function fcn_reloadCommentsPage(t=null){fcn_getCommentSection(null,t,null,!0)}function fcn_jumpToCommentPage(){const t=parseInt(window.prompt(fictioneer_tl.notification.enterPageNumber));t>0&&fcn_reloadCommentsPage(t)}var fct_commentSectionObserver;function fcn_setupCommentSectionObserver(){fct_commentSectionObserver=new IntersectionObserver((([t])=>{t.isIntersecting&&(fcn_getCommentSection(),fct_commentSectionObserver.disconnect())}),{rootMargin:"450px",threshold:1}),fcn_commentSection&&fct_commentSectionObserver.observe(fcn_commentSection)}function fcn_loadCommentEarly(){fcn_commentSection&&location.hash.includes("#comment")&&(_$(FcnGlobals.commentFormSelector)||(fct_commentSectionObserver.disconnect(),fcn_reloadCommentsPage()))}function fcn_toggleCommentOrder(t){const e=t.closest(".fictioneer-comments"),n="desc"==e.dataset.order;e.dataset.order=n?"asc":"desc",t.classList.toggle("_on",!n),t.classList.toggle("_off",n),fcn_reloadCommentsPage(e.dataset.page)}document.addEventListener("fcnUserDataReady",(()=>{fcn_setupCommentSectionObserver()})),document.addEventListener("fcnUserDataReady",(()=>{fcn_loadCommentEarly()})),_$(".fictioneer-comments")?.addEventListener("click",(t=>{if(t.target.closest("button[data-page-jump]"))return void fcn_jumpToCommentPage();const e=t.target.closest("button[data-page]");if(e)return void fcn_reloadCommentsPage(e.dataset.page);const n=t.target.closest("button[data-toggle-order]");n&&fcn_toggleCommentOrder(n)}));const fcn_bookshelfTarget=_$$$("ajax-bookshelf-target");function fcn_getBookshelfContent(){return FcnUtils.parseJSON(localStorage.getItem("fcnBookshelfContent"))??{html:{},count:{}}}function fcn_updateBookshelfView(t=null,e=null,n=null,a=!1){let s=fcn_getBookshelfContent();const i=(t=t??fcn_bookshelfTarget.dataset.action)+(e=e??fcn_bookshelfTarget.dataset.page)+(n=n??fcn_bookshelfTarget.dataset.order);if(!s.timestamp||s.timestamp+6e4<Date.now())return localStorage.removeItem("fcnBookshelfContent"),s={html:{},count:{}},void fcn_fetchBookshelfPart(t,e,n,a);s.html&&s.html[i]?(fcn_bookshelfTarget.innerHTML=s.html[i],fcn_bookshelfTarget.classList.remove("ajax-in-progress"),fcn_bookshelfTarget.dataset.page=e,_$(".item-number").innerHTML=`(${s.count[t]})`,a&&_$$$("main").scrollIntoView({behavior:"smooth"})):fcn_fetchBookshelfPart(t,e,n,a)}function fcn_browseBookshelfPage(t){fcn_bookshelfTarget.classList.add("ajax-in-progress"),fcn_updateBookshelfView(null,t,null,!0),history.pushState({},"",FcnUtils.buildUrl({tab:fcn_bookshelfTarget.dataset.tab,pg:t,order:fcn_bookshelfTarget.dataset.order}).href)}function fcn_fetchBookshelfPart(t,e,n,a=!1){const s=t+e+n,i=fcn_getBookshelfContent();FcnUtils.aGet({action:t,fcn_fast_ajax:1,page:e,order:n}).then((n=>{n.success?(i.timestamp=Date.now(),i.html[s]=n.data.html,i.count[t]=n.data.count,localStorage.setItem("fcnBookshelfContent",JSON.stringify(i)),fcn_bookshelfTarget.innerHTML=n.data.html,fcn_bookshelfTarget.dataset.page=e,_$(".item-number").innerHTML=`(${n.data.count})`):(fcn_bookshelfTarget.innerHTML="",fcn_bookshelfTarget.appendChild(FcnUtils.buildErrorNotice(n.data.error)))})).catch((t=>{_$(".item-number").innerHTML="",fcn_bookshelfTarget.innerHTML="",fcn_bookshelfTarget.appendChild(FcnUtils.buildErrorNotice(`${t.status}: ${t.statusText}`))})).then((()=>{fcn_bookshelfTarget.classList.remove("ajax-in-progress"),a&&_$$$("main").scrollIntoView({behavior:"smooth"})}))}function fcn_validateCss(t){return(t.match(/{/g)||[]).length===(t.match(/}/g)||[]).length&&!t.includes("<")}function fcn_getSkins(){const t=FcnUtils.getCookie("fcnLoggedIn");if(!t)return null;const e={data:{},active:null,fingerprint:t},n=FcnUtils.parseJSON(localStorage.getItem("fcnSkins"))??e;return n?.fingerprint&&t===n.fingerprint?(("object"!=typeof n.data||Array.isArray(n.data))&&(n.data={}),n):e}function fcn_setSkins(t){"object"!=typeof t||null===t||"object"!=typeof t.data||Array.isArray(t.data)?fcn_showNotification(fcn_skinTranslations.invalidJson,3,"warning"):t?.fingerprint&&FcnUtils.getCookie("fcnLoggedIn")===t.fingerprint?localStorage.setItem("fcnSkins",JSON.stringify(t)):fcn_showNotification(fcn_skinTranslations.wrongFingerprint,3,"warning")}function fcn_getSkinInfo(t){const e=t.match(/Name:\s*(.+)/),n=t.match(/Author:\s*(.+)/),a=t.match(/Version:\s*(.+)/);return{name:e?FcnUtils.sanitizeHTML(e[1].trim()):null,author:n?FcnUtils.sanitizeHTML(n[1].trim()):null,version:a?FcnUtils.sanitizeHTML(a[1].trim()):null}}function fcn_toggleSkin(t){const e=t.closest('[data-css-skin-finder="skin-item"]'),n=fcn_getSkins();e.classList.contains("active")?(_$$('[data-css-skin-finder="skin-item"]').forEach((t=>t.classList.remove("active"))),n.active=null):(_$$('[data-css-skin-finder="skin-item"]').forEach((t=>t.classList.remove("active"))),e.classList.add("active"),n.active=t.dataset.skinId),fcn_setSkins(n),fcn_applySkin()}function fcn_deleteSkin(t){const e=t.closest('[data-css-skin-finder="skin-item"]'),n=fcn_getSkins();e.classList.contains("active")&&(n.active=null),delete n.data[t.dataset.skinId],_$('[data-css-skin-target="file"]').value="",fcn_setSkins(n),fcn_renderSkinList(),fcn_applySkin()}function fcn_applySkin(){const t=FcnUtils.getCookie("fcnLoggedIn");if(!t||_$("body.wp-admin"))return;const e=fcn_getSkins();if(_$$$("fictioneer-active-custom-skin")?.remove(),e?.fingerprint===t&&e?.data?.[e.active]?.css){const t=document.createElement("style");t.textContent=e.data[e.active].css,t.id="fictioneer-active-custom-skin",_$("head").appendChild(t)}}function fcn_renderSkinList(){const t=_$('[data-css-skin-target="list"]'),e=FcnUtils.getCookie("fcnLoggedIn");if(!e||!t)return;const n=fcn_getSkins();t.innerHTML="",n?.fingerprint===e?(n?.data&&Object.keys(n.data).length>0&&(Object.entries(n.data).forEach((([e,a])=>{const s=_$('[data-css-skin-target="template"]').content.cloneNode(!0);n.active===e&&s.querySelector('[data-css-skin-finder="skin-item"]').classList.add("active"),s.querySelector('[data-action="click->css-skin#toggle"]').dataset.skinId=e,s.querySelector('[data-action="click->css-skin#delete"]').dataset.skinId=e,s.querySelector('[data-css-skin-finder="name"]').innerText=a.name,s.querySelector('[data-css-skin-finder="version"]').innerText=a.version,s.querySelector('[data-css-skin-finder="author"]').innerText=a.author,t.appendChild(s)})),_$$('[data-action="click->css-skin#toggle"]').forEach((t=>{t.addEventListener("click",(t=>fcn_toggleSkin(t.currentTarget)))})),_$$('[data-action="click->css-skin#delete"]').forEach((t=>{t.addEventListener("click",(t=>fcn_deleteSkin(t.currentTarget)))}))),Object.keys(n.data).length>2?_$('[data-css-skin-target="form"]').style.display="none":_$('[data-css-skin-target="form"]').style.display=""):_$('[data-css-skin-target="form"]').style.display=""}function fcn_uploadSkins(t){if(!FcnUtils.loggedIn()||t.classList.contains("disabled"))return;const e=fcn_getSkins();_$('[data-css-skin-target="action-status-message"]').classList.add("invisible"),FcnUtils.remoteAction("fictioneer_ajax_save_skins",{element:t,payload:{skins:JSON.stringify(e)},callback:t=>{t.success&&(fcn_showNotification(t.data.message,3,"success"),fcn_toggleSkinNotice(_$('[data-css-skin-target="action-status-message"]')))},finalCallback:()=>{_$('[data-css-skin-target="file"]').value=""}})}function fcn_downloadSkins(t){FcnUtils.loggedIn()&&!t.classList.contains("disabled")&&(_$('[data-css-skin-target="action-status-message"]').classList.add("invisible"),FcnUtils.remoteAction("fictioneer_ajax_get_skins",{element:t,callback:t=>{t.success&&(fcn_showNotification(t.data.message,3,"success"),fcn_toggleSkinNotice(_$('[data-css-skin-target="action-status-message"]')),fcn_setSkins(FcnUtils.parseJSON(t.data.skins)),fcn_renderSkinList(),fcn_applySkin())},finalCallback:()=>{_$('[data-css-skin-target="file"]').value=""}}))}function fcn_toggleSkinNotice(t){t.classList.remove("invisible"),setTimeout((()=>{t.classList.add("invisible")}),3e3)}fcn_bookshelfTarget&&document.addEventListener("fcnUserDataReady",(()=>{fcn_updateBookshelfView()})),_$(".bookshelf__list")?.addEventListener("click",(t=>{const e=t.target.closest(".page-numbers[data-page]");e&&fcn_browseBookshelfPage(e.dataset.page)})),fcn_renderSkinList(),_$('[data-css-skin-target="file"]')?.addEventListener("input",(t=>{t.preventDefault();const e=t.currentTarget.files[0],n=fcn_getSkins(),a=FcnUtils.getCookie("fcnLoggedIn");if(Object.keys(n.data).length>2)return void fcn_showNotification(fcn_skinTranslations.tooManySkins,3,"warning");if(n?.fingerprint!==a)return void fcn_showNotification(fcn_skinTranslations.wrongFingerprint,3,"warning");if(!e)return;if(e.size>2e5)return void fcn_showNotification(fcn_skinTranslations.fileTooLarge,3,"warning");if("text/css"!==e.type)return void fcn_showNotification(fcn_skinTranslations.wrongFileType,3,"warning");const s=new FileReader;s.onload=t=>{const e=t.target.result,n=fcn_getSkinInfo(e),a=fcn_getSkins();if(!fcn_validateCss(e))return void fcn_showNotification(fcn_skinTranslations.invalidCss,5,"warning");if(!n.name)return void fcn_showNotification(fcn_skinTranslations.missingMetaData,3,"warning");const s=btoa(n.name);a.data[s]={name:n.name,version:n.version,author:n.author,css:e},fcn_setSkins(a),fcn_renderSkinList()},s.onerror=()=>{console.error(s.error),fcn_showNotification(s.error,3,"warning")},s.readAsText(e)})),_$('[data-action="click->css-skin#upload"]')?.addEventListener("click",(t=>{fcn_uploadSkins(t.currentTarget)})),_$('[data-action="click->css-skin#download"]')?.addEventListener("click",(t=>{fcn_downloadSkins(t.currentTarget)}));