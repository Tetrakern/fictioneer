application.register("fictioneer-chapter",class extends Stimulus.Controller{static get targets(){return["bookmarkScroll","contentWrapper","index"]}static values={id:Number};startClick=0;lastToolsParagraph=null;tools=document.getElementById("paragraph-tools");initialize(){}connect(){window.FictioneerApp.Controllers.fictioneerChapter=this,this.hasIndexTarget&&this.indexTargets.forEach((t=>{t.querySelector(`[data-id="${this.idValue}"]`)?.classList.add("current")}))}clickOutside({detail:{target:t}}){this.lastToolsParagraph&&!t.closest(".selected-paragraph")&&this.closeTools()}scrollDown(){}scrollUp(){}scrollToBookmark(){}openFullscreen(){document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen()}closeFullscreen(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}toggleTools(t){this.lastToolsParagraph?.classList.remove("selected-paragraph"),this.lastToolsParagraph!==t?(this.lastToolsParagraph=t,t.classList.add("selected-paragraph"),t.append(this.tools)):this.closeTools()}closeTools(){this.lastToolsParagraph?.classList.remove("selected-paragraph"),this.lastToolsParagraph=null}fastClick(t){""==window.getSelection().toString()&&(this.startClick=Date.now(),document.addEventListener("mouseup",(()=>{Date.now()<this.startClick+400&&this.#t(t.target)&&this.tools&&this.toggleTools(t.target.closest("p"))}),{once:!0}))}quote(t){const e=t.target.closest("p[data-paragraph-id]");if(!e)return;const n=window.getSelection()?window.getSelection().toString().trim():"",a=`[anchor]${e.id}[/anchor]`;let s=FcnUtils.extractTextNodes(e);if(s.length>16&&n.replace(/\s/g,"").length){const t=Math.ceil(.25*n.length);let e=fictioneer_tl.partial.quoteFragmentPrefix,a=fictioneer_tl.partial.quoteFragmentSuffix;n.startsWith(s.substring(0,t+1))&&(e=""),n.endsWith(s.substring(s.length-t,s.length))&&(a=""),s=`${e}${n}${a}`}fcn_showNotification(fictioneer_tl.notification.quoteAppendedToComment),this.#e(`\n[quote]${s} ${a}[/quote]\n`)}suggest(t){}toggleBookmark({target:t}){fcn_toggleBookmark(t.closest("p[data-paragraph-id]").dataset.paragraphId,t.closest("[data-color]")?.dataset.color??"default"),window.matchMedia("(min-width: 1024px)").matches&&this.closeTools()}copyLink(t){const e=t.target.closest("p[data-paragraph-id]");e&&FcnUtils.copyToClipboard(`${location.protocol}//${location.host}${location.pathname}#${e.id}`,fictioneer_tl.notification.linkCopiedToClipboard)}toggleIndexOrder({currentTarget:t}){const e=t.closest(".chapter-index");e.dataset.order="asc"===e.dataset.order?"desc":"asc"}#e(t){const e=_$(FcnGlobals.commentFormSelector);if(e)switch(e.tagName){case"TEXTAREA":e.value+=t,FcnUtils.adjustTextarea(e);break;case"DIV":e.innerHTML+=t}else FcnGlobals.commentStack.push(t)}#t(t){return!(t.classList.contains("spoiler")||!t.closest("p[data-paragraph-id]")?.textContent.trim().length||!t.closest("p")?.parentElement?.classList.contains("chapter-formatting")||t.closest(".popup-menu-toggle, .skip-tools, .tts-interface, .paragraph-tools__actions, .hidden, .inside-epub, a, button, label, input, textarea, select, option"))}});const fcn_progressBar=_$(".progress__bar"),fcn_chapterContent=_$$$("chapter-content");var fcn_chapterCheckmarkUpdated=!1;function fcn_trackProgress(){fcn_chapterContent&&(fcn_readingProgress(),window.addEventListener("scroll.rAF",FcnUtils.throttle(fcn_readingProgress,1e3/48)))}function fcn_readingProgress(){if(fcn_settingMinimal.checked||!fcn_settingChapterProgressBar.checked)return;const t=fcn_chapterContent.getBoundingClientRect(),e=t.height,n=window.innerHeight,a=e-t.bottom-Math.max(t.top,0)+n;let s=100*a/e;if(document.body.classList.toggle("hasProgressBar",!(s<0||a>e+500)),s=FcnUtils.clamp(0,100,s),fcn_progressBar.style.width=`${s}%`,s>=100&&!fcn_chapterCheckmarkUpdated&&FcnUtils.loggedIn()){const t=document.body.dataset.storyId;if(fcn_chapterCheckmarkUpdated=!0,!t||"function"!=typeof fcn_toggleCheckmark)return;console.log("progress check"),fcn_toggleCheckmark(t,parseInt(document.body.dataset.postId),!0)}}_$("article:not(._password)")&&fcn_trackProgress();const fcn_chapterKeyboardNavigation=t=>{if(["INPUT","TEXTAREA","SELECT","OPTION"].includes(t.target.tagName)||t.target.isContentEditable)return;const e={ArrowLeft:"a.button._navigation._prev",ArrowRight:"a.button._navigation._next"};if(!e[t.code])return;const n=_$(e[t.code]);n?.href&&(window.location.href=`${n.href}#start`)};if(document.addEventListener("keydown",fcn_chapterKeyboardNavigation),"#start"===window.location.hash){history.replaceState(null,document.title,window.location.pathname);const t=_$(".chapter__article");t&&FcnUtils.scrollTo(t,128)}const fcn_chapterFormatting=_$(".chapter-formatting");var fcn_formatting=fcn_getFormatting();function fcn_getFormatting(){let t=FcnUtils.parseJSON(localStorage.getItem("fcnChapterFormatting"))??fcn_defaultFormatting();return Object.keys(t).length<15&&(t=fcn_defaultFormatting()),t.timestamp<1651164557584&&(t=fcn_defaultFormatting(),t.timestamp=Date.now()),fcn_setFormatting(t),t}function fcn_defaultFormatting(){return{"font-saturation":0,"font-color":FcnGlobals.fontColors[0].css,"font-name":FcnGlobals.fonts[0].css,"font-size":100,"letter-spacing":0,"line-height":1.7,"paragraph-spacing":1.5,"site-width":document.documentElement.dataset.siteWidthDefault??"960",indent:!0,"show-sensitive-content":!0,"show-chapter-notes":!0,justify:!1,"show-comments":!0,"show-paragraph-tools":!0,timestamp:1664797604825,...FcnUtils.parseJSON(document.documentElement.dataset.defaultFormatting??"{}")}}function fcn_setFormatting(t){"object"==typeof t&&(fcn_formatting=t,localStorage.setItem("fcnChapterFormatting",JSON.stringify(t)))}function fcn_updateToggle(t,e,n,a={}){a={save:!0,...a};const s=Boolean(t),o=_$(e);if(o&&(o.checked=s,o.closest("label").setAttribute("aria-checked",s)),a.toggleClass&&fcn_chapterFormatting.classList.toggle(a.toggleClass,a.invertClass?!s:s),a.sensitiveContent){const t=_$$$("inline-sensitive-content-toggle");t?.classList.toggle("hide-sensitive",!s),t?.setAttribute("aria-checked",!s)}a.notes&&_$$(".chapter-note-hideable").forEach((t=>{t.classList.toggle("hidden",!s)})),a.comments&&_$$(".chapter-comments-hideable").forEach((t=>{t.classList.toggle("hidden",!s)})),fcn_formatting[n]=s,a.save&&fcn_setFormatting(fcn_formatting)}(()=>{"use strict";const t=_$$$("reader-settings-font-size-text"),e=_$$$("reader-settings-font-size-range"),n=_$$$("reader-settings-font-size-reset");function a(a,s=!0){a=FcnUtils.clamp(50,200,a??100),t.value=a,e.value=a,n.classList.toggle("_modified",100!=a),_$$(".resize-font").forEach((t=>{t.style.fontSize=`${a}%`})),fcn_formatting["font-size"]=a,s&&fcn_setFormatting(fcn_formatting)}function s(){a(this.value)}function o(){a(parseFloat(fcn_formatting["font-size"])+parseFloat(this.dataset.modifier))}n&&(_$$$("reset-font")?.addEventListener("click",(()=>{a(100)})),n?.addEventListener("click",(()=>{a(100)})),e?.addEventListener("input",FcnUtils.throttle(s,1e3/24)),t?.addEventListener("input",s),_$$$("increase-font")?.addEventListener("click",o),_$$$("decrease-font")?.addEventListener("click",o),a(fcn_formatting["font-size"],!1))})(),(()=>{"use strict";const t=_$$$("reader-settings-font-color-reset"),e=_$$$("reader-settings-font-color-select");function n(n,a=!0){n=FcnUtils.clamp(0,FcnGlobals.fontColors.length-1,n),t.classList.toggle("_modified",n>0),e.value=n,fcn_chapterFormatting.style.setProperty("--text-chapter",FcnGlobals.fontColors[n].css),fcn_formatting["font-color"]=FcnGlobals.fontColors[n].css,a&&fcn_setFormatting(fcn_formatting)}t&&(t.onclick=()=>{n(0)},e.onchange=t=>{n(t.target.value)},_$$(".font-color-stepper").forEach((t=>{t.addEventListener("click",(t=>{!function(t=1){let a=(e.selectedIndex+parseInt(t))%FcnGlobals.fontColors.length;a=a<0?FcnGlobals.fontColors.length-1:a,n(a)}(t.currentTarget.value)}))})),n(FcnGlobals.fontColors.findIndex((t=>t.css==fcn_formatting["font-color"])),!1))})(),(()=>{"use strict";const t=_$$$("reader-settings-font-reset"),e=_$$$("reader-settings-font-select");function n(a,s=!0){a=FcnUtils.clamp(0,FcnGlobals.fonts.length-1,a);let o=FcnGlobals.fonts[a].css;FcnGlobals.fonts[a].alt&&(o=`${o}, ${FcnGlobals.fonts[a].alt}`),a<0?n(0):(t.classList.toggle("_modified",a>0),e.value=a,_$$(".chapter-font-family").forEach((t=>{t.style.fontFamily=""===o?"var(--ff-system)":o+", var(--ff-system)"})),fcn_formatting["font-name"]=FcnGlobals.fonts[a].css,s&&fcn_setFormatting(fcn_formatting))}t&&(t.onclick=()=>{n(0)},e.onchange=t=>{n(t.target.value)},_$$(".font-stepper").forEach((t=>{t.addEventListener("click",(t=>{!function(t=1){let a=(e.selectedIndex+parseInt(t))%FcnGlobals.fonts.length;a=a<0?FcnGlobals.fonts.length-1:a,n(a)}(t.currentTarget.value)}))})),n(FcnGlobals.fonts.findIndex((t=>t.css==fcn_formatting["font-name"])),!1))})(),(()=>{"use strict";const t=_$$$("reader-settings-font-saturation-text"),e=_$$$("reader-settings-font-saturation-range"),n=_$$$("reader-settings-font-saturation-reset");function a(a,s=!0){a=FcnUtils.clamp(-1,1,a??0),t.value=parseInt(100*a),e.value=a,n.classList.toggle("_modified",0!=a),fcn_chapterFormatting.style.setProperty("--font-saturation",`(${a>=0?1+a**2:1-a**2} + var(--font-saturation-offset))`),fcn_formatting["font-saturation"]=a,s&&fcn_setFormatting(fcn_formatting)}n&&(n?.addEventListener("click",(()=>{a(0)})),e?.addEventListener("input",FcnUtils.throttle((function(){a(this.value)}),1e3/24)),t?.addEventListener("input",(function(){a(parseInt(this.value)/100)})),a(fcn_formatting["font-saturation"],!1))})(),(()=>{"use strict";const t=_$$$("reader-settings-letter-spacing-text"),e=_$$$("reader-settings-letter-spacing-range"),n=_$$$("reader-settings-letter-spacing-reset"),a=fcn_defaultFormatting()["letter-spacing"];function s(s,o=!0){s=FcnUtils.clamp(-.1,.2,s??a),t.value=s,e.value=s,n.classList.toggle("_modified",s!=a),fcn_chapterFormatting.style.letterSpacing=`calc(${s}em + var(--font-letter-spacing-base))`,fcn_formatting["letter-spacing"]=s,o&&fcn_setFormatting(fcn_formatting)}function o(){s(this.value)}n&&(n?.addEventListener("click",(()=>{s(a)})),e?.addEventListener("input",FcnUtils.throttle(o,1e3/24)),t?.addEventListener("input",o),s(fcn_formatting["letter-spacing"],!1))})(),(()=>{"use strict";const t=_$$$("reader-settings-paragraph-spacing-text"),e=_$$$("reader-settings-paragraph-spacing-range"),n=_$$$("reader-settings-paragraph-spacing-reset"),a=fcn_defaultFormatting()["paragraph-spacing"];function s(s,o=!0){s=FcnUtils.clamp(0,3,s??a),t.value=s,e.value=s,n.classList.toggle("_modified",s!=a),fcn_chapterFormatting.style.setProperty("--paragraph-spacing",`${s}em`),fcn_formatting["paragraph-spacing"]=s,o&&fcn_setFormatting(fcn_formatting)}function o(){s(this.value)}n&&(n?.addEventListener("click",(()=>{s(a)})),e?.addEventListener("input",FcnUtils.throttle(o,1e3/24)),t?.addEventListener("input",o),s(fcn_formatting["paragraph-spacing"],!1))})(),(()=>{"use strict";const t=_$$$("reader-settings-line-height-text"),e=_$$$("reader-settings-line-height-range"),n=_$$$("reader-settings-line-height-reset"),a=fcn_defaultFormatting()["line-height"];function s(s,o=!0){s=FcnUtils.clamp(.8,3,s??a),t.value=s,e.value=s,n.classList.toggle("_modified",s!=a),fcn_chapterFormatting.style.lineHeight=`${s}`,fcn_formatting["line-height"]=s,o&&fcn_setFormatting(fcn_formatting)}function o(){s(this.value)}n&&(n?.addEventListener("click",(()=>{s(a)})),e?.addEventListener("input",FcnUtils.throttle(o,1e3/24)),t?.addEventListener("input",o),s(fcn_formatting["line-height"],!1))})(),(()=>{"use strict";const t=_$$$("reader-settings-site-width-text"),e=_$$$("reader-settings-site-width-range"),n=_$$$("reader-settings-site-width-reset"),a=fcn_defaultFormatting()["site-width"];function s(s,o=!0){const i=_$("main");s=FcnUtils.clamp(640,1920,s??a),t.value=s,e.value=s,n.classList.toggle("_modified",s!=a),i.style.setProperty("--site-width",`${s}px`),i.classList.toggle("_default-width",s==document.documentElement.dataset.siteWidthDefault),i.classList.toggle("_below-1024",s<1024&&s>=768),i.classList.toggle("_below-768",s<768&&s>640),i.classList.toggle("_640-and-below",s<=640),fcn_formatting["site-width"]=s,o&&fcn_setFormatting(fcn_formatting)}function o(){s(this.value)}n&&(n?.addEventListener("click",(()=>{s(a)})),e?.addEventListener("input",FcnUtils.throttle(o,1e3/24)),t?.addEventListener("input",o),s(fcn_formatting["site-width"],!1))})(),_$$("#reader-settings-indent-toggle").forEach((t=>{const e={invertClass:!0,toggleClass:"no-indent"},n="indent";t.onclick=a=>{fcn_updateToggle(a.currentTarget.checked,`#${t.id}`,n,e)},fcn_updateToggle(fcn_formatting[n],`#${t.id}`,n,{save:!1,...e})})),_$$("#reader-settings-justify-toggle").forEach((t=>{const e={toggleClass:"justify"},n="justify";t.onclick=a=>{fcn_updateToggle(a.currentTarget.checked,`#${t.id}`,n,e)},fcn_updateToggle(fcn_formatting[n],`#${t.id}`,n,{save:!1,...e})})),_$$("#reader-settings-paragraph-tools-toggle").forEach((t=>{const e="show-paragraph-tools";t.onclick=n=>{fcn_updateToggle(n.currentTarget.checked,`#${t.id}`,e)},fcn_updateToggle(fcn_formatting[e],`#${t.id}`,e,{save:!1})})),_$$("#reader-settings-chapter-notes-toggle").forEach((t=>{const e={notes:!0},n="show-chapter-notes";t.onclick=a=>{fcn_updateToggle(a.currentTarget.checked,`#${t.id}`,n,e)},fcn_updateToggle(fcn_formatting[n],`#${t.id}`,n,{save:!1,...e})})),_$$("#reader-settings-comments-toggle").forEach((t=>{const e={comments:!0},n="show-comments";t.onclick=a=>{fcn_updateToggle(a.currentTarget.checked,`#${t.id}`,n,e)},fcn_updateToggle(fcn_formatting[n],`#${t.id}`,n,{save:!1,...e})})),_$$("#reader-settings-sensitive-content-toggle").forEach((t=>{const e={toggleClass:"hide-sensitive",invertClass:!0,sensitiveContent:!0},n="show-sensitive-content";t.onclick=a=>{fcn_updateToggle(a.currentTarget.checked,`#${t.id}`,n,e)},fcn_updateToggle(fcn_formatting[n],`#${t.id}`,n,{save:!1,...e})}));